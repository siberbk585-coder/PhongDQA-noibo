<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Cổng Tác Vụ DQA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'primary-blue': '#5aa9ff',
            'sidebar': '#0f172a',
            'sidebar-hover': '#1e293b',
            'muted': '#f8fafc'
          }
        }
      }
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    .spinner{border:2px solid #e5e7eb;border-top:2px solid #3b82f6;border-radius:50%;width:16px;height:16px;animation:spin 1s linear infinite;display:inline-block;vertical-align:middle}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .header-container{background:linear-gradient(135deg,#2563eb 0%,#60a5fa 100%);position:relative;overflow:hidden}
    .header-container::before{content:"";position:absolute;inset:0;background-image:url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffffff' fill-opacity='0.08' fill-rule='evenodd'/%3E%3C/svg%3E");opacity:.4}
    .modal{position:fixed;inset:0;background:rgba(15,23,42,0.35);display:none;align-items:center;justify-content:center;padding:20px;z-index:1000}
    .section-title{display:flex;align-items:center;gap:8px}
    .section-title .badge{background:rgba(90,169,255,.15);color:#1e40af;border:1px solid rgba(90,169,255,.35);padding:2px 8px;border-radius:9999px;font-size:12px;font-weight:600}
    .submit-btn{background:linear-gradient(135deg,#3b82f6 0%,#60a5fa 100%);box-shadow:0 4px 6px rgba(37,99,235,.1),0 1px 3px rgba(37,99,235,.08);transition:transform .2s ease,box-shadow .2s ease,opacity .2s ease,filter .2s ease;border-radius:9999px;position:relative}
    .submit-btn:hover{transform:translateY(-1px);box-shadow:0 7px 14px rgba(37,99,235,.12),0 3px 6px rgba(37,99,235,.08);filter:brightness(1.03)}
    .submit-btn:active{transform:translateY(0);opacity:.95}
    .modal.open{display:flex}
    .toast{position:fixed;right:16px;bottom:16px;background:#0b1324;color:#fff;padding:10px 12px;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.15);opacity:0;transform:translateY(10px);transition:.2s}
    .toast.show{opacity:1;transform:translateY(0)}
    /* Form 5: zebra rows & vertical dividers */
    .table-zebra tbody tr:nth-child(even){ background-color:#f8fafc; }
    .cell-div{ border-left:1px solid #e5e7eb; }
    .table-vdiv{ border-collapse: separate; border-spacing: 0; }
    .table-vdiv th+th, .table-vdiv td+td{ border-left:1px solid #e5e7eb; }
    /* Form 5: ẩn cột Số DONE (có thể bật lại sau) */
    .f5a-col-done{ display:none; }
    /* Drag row highlight */
    .drag-over{ background-color:#e0f2fe !important; }
  </style>
</head>
<body class="bg-muted min-h-screen flex text-gray-800" style="font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'">
  <!-- Sidebar -->
  <aside class="w-64 min-h-screen bg-sidebar text-white flex flex-col py-8 px-4 shadow-lg">
    <h1 class="text-xl font-bold tracking-wide pb-6 border-b border-blue-200 mb-4">Cổng Tác Vụ DQA</h1>
    <nav class="flex flex-col gap-2 mt-2">
      <button class="nav-btn py-2 px-4 rounded transition hover:bg-sidebar-hover text-left text-base" data-target="form1">Form 1 · Tra cứu tác vụ</button>
      <button class="nav-btn py-2 px-4 rounded transition hover:bg-sidebar-hover text-left text-base" data-target="form2">Form 2 · Trả kế hoạch thử nghiệm</button>
      <button class="nav-btn py-2 px-4 rounded transition hover:bg-sidebar-hover text-left text-base" data-target="form3">Form 3 · Giao việc</button>
      <button class="nav-btn py-2 px-4 rounded transition hover:bg-sidebar-hover text-left text-base" data-target="form4">Form 4 · Bảng theo dõi (Doing)</button>
      <button class="nav-btn py-2 px-4 rounded transition hover:bg-sidebar-hover text-left text-base" data-target="form5">Form 5 · Tất cả tác vụ</button>
      <button class="nav-btn py-2 px-4 rounded transition hover:bg-sidebar-hover text-left text-base" data-target="form6">Form 6 · Ý tưởng cải tiến</button>
      <button class="nav-btn py-2 px-4 rounded transition hover:bg-sidebar-hover text-left text-base" data-target="form7">Form 7 · Hướng dẫn sử dụng</button>
    </nav>
  </aside>

  <!-- Main -->
  <main class="flex-1 py-10 flex flex-col items-center min-h-screen overflow-y-auto">
    <div class="header-container relative w-full max-w-6xl rounded-xl overflow-hidden mb-8">
      <div class="relative z-10 p-8 md:p-10">
        <div class="flex items-center space-x-2 mb-3">
          <div class="inline-block px-3 py-1 rounded-full text-xs font-semibold text-white" style="background-color: rgba(255,255,255,0.15); backdrop-filter: blur(5px);">Phòng DQA</div>
        </div>
        <h2 class="text-2xl md:text-3xl lg:text-4xl font-bold text-white mb-1 tracking-tight">Cổng tác vụ DQA - Nội bộ</h2>
        <p class="text-blue-100 text-sm md:text-base">Vui lòng không chia sẻ link cổng tác vụ với người ngoài bộ phận.</p>
      </div>
    </div>

    <!-- Form 1 -->
    <section id="form1" class="w-full max-w-none bg-white p-6 rounded-lg shadow-md">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-blue-800">Form 1 · Tra cứu tác vụ</h2>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Chọn tên</label>
          <div class="flex gap-2">
            <select id="f1-name" class="flex-1 border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white">
              <option value="">— Chọn người —</option>
            </select>
            <button id="f1-search" class="px-4 py-2 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105">Tra cứu</button>
          </div>
          <p class="text-gray-500 text-xs mt-1">Chọn tên và nhấn Tra cứu để gửi yêu cầu và hiển thị tác vụ</p>
        </div>
      </div>
      <div class="mt-2 flex items-center gap-3 flex-wrap">
        <div class="flex items-center gap-2">
          <label class="text-sm text-gray-700">Tháng</label>
          <input id="f1-month" type="month" class="border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
        </div>
      </div>
      <div class="mt-4 overflow-auto max-h-[60vh] border border-gray-200 rounded-lg">
        <table class="min-w-[1600px] w-full text-sm">
          <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
            <tr class="text-left text-gray-700">
              <th class="px-3 py-2 min-w-[160px]">Trả báo cáo</th>
              <th class="px-3 py-2 min-w-[140px]">Tình trạng</th>
              <th class="px-3 py-2 min-w-[140px]">Mã</th>
              <th class="px-3 py-2 min-w-[260px]">Tên tác vụ</th>
              <th class="px-3 py-2 min-w-[160px]">Người yêu cầu</th>
              <th class="px-3 py-2 min-w-[160px]">Người nhận mẫu</th>
              <th class="px-3 py-2 min-w-[120px]">Công chuẩn</th>
              <th class="px-3 py-2 min-w-[140px]">Ngày yêu cầu</th>
              <th class="px-3 py-2 min-w-[140px]">Hạn mong muốn</th>
              <th class="px-3 py-2 min-w-[140px]">Hạn đáp ứng</th>
              <th class="px-3 py-2 min-w-[260px]">Mục đích đánh giá</th>
              <th class="px-3 py-2 min-w-[240px]">Note</th>
              <th class="px-3 py-2 min-w-[240px]">Yêu cầu test đặc biệt</th>
              <th class="px-3 py-2 min-w-[260px]">Form báo cáo đánh giá</th>
              <th class="px-3 py-2 min-w-[220px]">Tên file đính kèm</th>
              <th class="px-3 py-2 min-w-[140px]">Tải đính kèm</th>
              <th class="px-3 py-2 min-w-[140px]">Mã tác vụ</th>
            </tr>
          </thead>
          <tbody id="f1-body" class="divide-y divide-gray-100">
            <tr><td class="px-3 py-3 text-center text-gray-500" colspan="17">Chưa có dữ liệu</td></tr>
          </tbody>
        </table>
      </div>
      <div id="f1-pager" class="mt-2 flex items-center justify-between" style="display:none">
        <div class="text-sm text-gray-600">
          <span id="f1-page-info">Trang 1/1 (0 dòng)</span>
        </div>
        <div class="flex items-center gap-2">
          <label class="text-sm text-gray-600">Hiển thị</label>
          <select id="f1-size" class="border border-blue-300 rounded-lg bg-slate-100 p-1 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white">
            <option value="10">10</option>
            <option value="20" selected>20</option>
            <option value="50">50</option>
          </select>
          <button id="f1-prev" class="px-3 py-1 rounded-lg border border-gray-300 text-gray-700 bg-white hover:bg-gray-50">Trước</button>
          <button id="f1-next" class="px-3 py-1 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105">Sau</button>
        </div>
      </div>

      <!-- Điểm lưu trữ file đính kèm -->
      <div class="mt-4">
        <a id="f1-storage-link" href="https://drive.google.com/drive/folders/1hFChHMjIC4ajY4GNX3dLoczWcZ3B9zzg?usp=sharing" target="_blank" rel="noopener" title="Nhấn để mở và tự động copy liên kết"
           class="inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-blue-200 bg-blue-50/30 text-primary-blue hover:bg-blue-50">
          Điểm lưu trữ file đính kèm
        </a>
        <p class="text-xs text-gray-500 mt-1">Nhấn để mở và copy liên kết.</p>
      </div>
    </section>

    <!-- Form 2 -->
    <section id="form2" class="w-full max-w-7xl bg-white p-6 rounded-lg shadow-md hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-blue-800">Form 2 · Trả form báo cáo</h2>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Chọn tên</label>
          <div class="flex gap-2">
            <select id="f2-name" class="flex-1 border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white">
              <option value="">— Chọn người —</option>
            </select>
            <button id="f2-search" class="px-3 py-2 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105">Tra cứu</button>
          </div>
          <p class="text-gray-500 text-xs mt-1">Chọn tên và nhấn Tra cứu để hiển thị tác vụ cần trả form.</p>
        </div>
      </div>
      <div class="mt-4 overflow-x-auto border border-gray-200 rounded-lg">
        <table class="min-w-[900px] w-full text-sm">
          <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
            <tr class="text-left text-gray-700">
              <th class="px-3 py-2">Mã tác vụ</th>
              <th class="px-3 py-2">Ngày yêu cầu</th>
              <th class="px-3 py-2">Hạn mong muốn</th>
              <th class="px-3 py-2">Hạn đáp ứng</th>
              <th class="px-3 py-2">Mã</th>
              <th class="px-3 py-2">Tên tác vụ</th>
              <th class="px-3 py-2 min-w-[120px]">Nút Trả form</th>
            </tr>
          </thead>
          <tbody id="f2-body" class="divide-y divide-gray-100">
            <tr><td class="px-3 py-3 text-center text-gray-500" colspan="7">Chưa có dữ liệu</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Form 3 -->
    <section id="form3" class="w-full max-w-4xl bg-white p-6 rounded-lg shadow-md hidden">
      <div class="flex items-center justify-between mb-4">
        <div class="section-title">
          <h2 class="text-xl font-semibold text-blue-800">Form 3 · Giao việc</h2>
          <span class="badge">DQA nội bộ</span>
        </div>
      </div>
      <form id="assign-form" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Người yêu cầu <span class="text-gray-400 text-xs">(bắt buộc)</span></label>
            <input id="rq-by" required type="text" placeholder="Nhập tên người yêu cầu" class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Thời gian yêu cầu</label>
            <input id="rq-time" readonly type="text" class="w-full border border-blue-300 rounded-lg bg-gray-200 p-2 text-gray-600"/>
            <p class="text-gray-500 text-xs mt-1">Cố định theo thời gian hệ thống</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Email người yêu cầu</label>
            <input id="rq-by-email" type="email" readonly placeholder="Tự động theo Người yêu cầu" class="w-full border border-blue-300 rounded-lg bg-gray-200 p-2 text-gray-600"/>
            <p class="text-gray-500 text-xs mt-1">Tự động điền theo "Người yêu cầu"</p>
          </div>
        </div>
      <div class="grid grid-cols-1 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Tên tác vụ <span class="text-gray-400 text-xs">(bắt buộc)</span></label>
          <input id="task-name" required type="text" placeholder="Nhập tên tác vụ" class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
        </div>
      </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Người được giao <span class="text-gray-400 text-xs">(bắt buộc)</span></label>
            <select id="f3-assignee" required class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white">
              <option value="">— Chọn người —</option>
            </select>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Công chuẩn <span class="text-gray-400 text-xs">(bắt buộc)</span></label>
            <input id="man-hour" required type="number" step="0.01" min="0" inputmode="decimal" placeholder="VD: 12,5" class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
            <p class="text-gray-500 text-xs mt-1">Cho phép nhập 2 chữ số sau dấu thập phân</p>
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-1">Đầu ra công việc <span class="text-gray-400 text-xs">(bắt buộc)</span></label>
            <input id="output" required type="text" placeholder="Mô tả đầu ra" class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Deadline</label>
            <input id="deadline" type="date" class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Mã Odoo/Jira</label>
            <input id="odoo-jira" type="text" placeholder="VD: ODOO-123 hoặc JIRA-456" class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Tài liệu đính kèm</label>
            <input id="attach" type="file" class="block w-full text-sm file:mr-2 file:py-1 file:px-3 file:rounded-full file:border-0 file:bg-primary-blue file:text-white"/>
            <div id="f3-upload-list" class="mt-2 text-sm"></div>
          </div>
        </div>
        <div class="pt-2 flex items-center gap-3">
          <button type="submit" class="submit-btn px-6 py-2 text-white font-semibold transition">Giao việc</button>
        </div>
      </form>
    </section>

    <!-- Form 4 -->
    <section id="form4" class="w-full max-w-none bg-white p-6 rounded-lg shadow-md hidden">
      <div class="flex items-center justify-between mb-4">
        <div class="section-title">
          <h2 class="text-xl font-semibold text-blue-800">Form 4 · Bảng theo dõi</h2>
        </div>
        <div class="flex items-center gap-2">
          <input type="hidden" id="f4-status" value="Doing" />
          <label class="text-sm text-gray-700">Tháng</label>
          <input id="f4-month" type="month" class="border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
          <button id="f4-search" class="submit-btn px-4 py-2 text-white font-semibold transition">Tra cứu</button>
        </div>
      </div>
      <div class="mb-2 flex items-center gap-2 flex-wrap">
        <button id="f4-btn-all" class="px-3 py-1 rounded-full border border-blue-200 bg-blue-50/30 text-primary-blue hover:bg-blue-50">Tất cả thành viên</button>
        <button id="f4-btn-linh" class="px-3 py-1 rounded-full border border-blue-200 bg-blue-50/30 text-primary-blue hover:bg-blue-50">Nhóm Linh</button>
        <button id="f4-btn-hieu" class="px-3 py-1 rounded-full border border-blue-200 bg-blue-50/30 text-primary-blue hover:bg-blue-50">Nhóm Hiếu</button>
      </div>
      <div id="f4-main-doing" class="mt-4 overflow-auto max-h-[60vh] border border-gray-200 rounded-lg">
        <table class="min-w-[480px] w-full text-sm">
          <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
            <tr id="f4-head-row-static" class="text-left text-gray-700">
              <th class="px-3 py-2 relative">
                <button id="f4-filter-toggle" class="inline-flex items-center gap-1 hover:text-primary-blue">
                  Nhân viên <span class="text-xs">▾</span>
                </button>
                <div id="f4-filter-pop" class="absolute z-20 mt-2 left-0 w-72 bg-white border border-gray-200 rounded-lg shadow-lg p-3 hidden">
                  <div class="flex items-center gap-2 mb-2">
                    <input id="f4-filter-search" type="text" placeholder="Tìm người..." class="flex-1 border border-blue-300 rounded bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
                  </div>
                  <div class="flex items-center justify-between text-xs text-gray-600 mb-2">
                    <div class="flex items-center gap-3">
                      <button id="f4-filter-select-all" class="underline">Chọn tất cả</button>
                      <button id="f4-filter-clear" class="underline">Bỏ chọn</button>
                    </div>
                    <button id="f4-filter-apply" class="px-2 py-1 rounded bg-primary-blue text-white text-xs">Lọc</button>
                  </div>
                  <div id="f4-filter-list" class="max-h-60 overflow-auto space-y-1 text-sm">
                    <label class="flex items-center gap-2" data-name="(Chỗ trống)"><input type="checkbox" value="(Chỗ trống)" class="f4-filter-item h-4 w-4"/><span>(Chỗ trống)</span></label>
                  </div>
                </div>
              </th>
              <th class="px-3 py-2">Tổng công chuẩn</th>
              <th class="px-3 py-2">Số tác vụ</th>
              
            </tr>
          </thead>
          <tbody id="f4-body" class="divide-y divide-gray-100">
            <tr><td class="px-3 py-3 text-center text-gray-500" colspan="3">Chưa có dữ liệu</td></tr>
          </tbody>
        </table>
      </div>
      <!-- Form 4: All tasks table (separate structure) -->
      <div id="f4-main-all" class="mt-4 overflow-auto max-h-[60vh] border border-gray-200 rounded-lg hidden">
        <table class="min-w-[1100px] w-full text-sm">
          <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
            <tr class="text-left text-gray-700">
              <th class="px-3 py-2">Nhân viên</th>
              <th class="px-3 py-2">Công chuẩn đã nhận</th>
              <th class="px-3 py-2">Số tác vụ</th>
              <th class="px-3 py-2">Số DONE</th>
              <th class="px-3 py-2">Vượt tiến độ</th>
              <th class="px-3 py-2">Đúng tiến độ</th>
              <th class="px-3 py-2">Chậm tiến độ</th>
              <th class="px-3 py-2">Tỷ lệ vượt (%)</th>
              <th class="px-3 py-2">Tỷ lệ đúng (%)</th>
              <th class="px-3 py-2">Tỷ lệ chậm (%)</th>
            </tr>
          </thead>
          <tbody id="f4-body-all" class="divide-y divide-gray-100">
            <tr><td class="px-3 py-3 text-center text-gray-500" colspan="10">Chưa có dữ liệu</td></tr>
          </tbody>
        </table>
      </div>
      <!-- Pivot Overdue View -->
      <div id="f4-pivot-wrap" class="mt-4 overflow-auto max-h-[60vh] border border-gray-200 rounded-lg">
        <div class="flex items-center justify-between p-3">
          <div class="text-sm text-gray-700">Bản tổng hợp việc quá hạn theo trạng thái</div>
          <div class="flex items-center gap-2">
            <button id="f4-pivot-refresh" class="px-3 py-1 rounded-lg border border-gray-300 bg-white hover:bg-gray-50">Làm mới</button>
          </div>
        </div>
        <table id="f4-pivot-table" class="min-w-[760px] w-full text-sm">
          <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
            <tr class="text-left text-gray-700">
              <th class="px-3 py-2">Assignee</th>
              <th class="px-3 py-2">Mã</th>
              <th class="px-3 py-2">Tên tác vụ</th>
              <th class="px-3 py-2">Trạng thái</th>
              <th class="px-3 py-2">Ngày yêu cầu</th>
              <th class="px-3 py-2">Hạn mong muốn</th>
              <th class="px-3 py-2">Hạn đáp ứng</th>
            </tr>
          </thead>
          <tbody id="f4-pivot-body" class="divide-y divide-gray-100">
            <tr><td class="px-3 py-3 text-center text-gray-500" colspan="7">Chưa có dữ liệu</td></tr>
          </tbody>
          <tfoot>
            <tr class="bg-blue-50 font-semibold text-blue-900">
              <td class="px-3 py-2" colspan="6">Tổng số tác vụ quá hạn:</td>
              <td class="px-3 py-2" id="f4-pivot-sum-total">0</td>
            </tr>
          </tfoot>
        </table>
        <div class="p-2 text-xs text-gray-500" id="f4-pivot-note"></div>
      </div>
      <div id="f4-chart-container" class="mt-4 h-80" style="display:none">
        <canvas id="f4-chart"></canvas>
      </div>
    </section>

    <!-- Form 5 · Tất cả tác vụ -->
    <section id="form5" class="w-full max-w-none bg-white p-6 rounded-lg shadow-md hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-blue-800">Form 5 · Tất cả tác vụ</h2>
      </div>
      <div class="mt-4 overflow-auto max-h-[60vh] border border-gray-200 rounded-lg">
        <div class="flex items-center gap-2 p-2">
          <label class="text-sm text-gray-700">Tháng</label>
          <input id="f5a-month" type="month" class="border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
          <button id="f5a-search" class="submit-btn px-4 py-2 text-white font-semibold transition">Tra cứu</button>
        </div>
        <table class="min-w-[1100px] w-full text-sm table-zebra table-vdiv">
          <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
            <tr class="text-left text-gray-700">
              <th class="px-3 py-2">Nhân viên</th>
              <th class="px-3 py-2">Công chuẩn đã nhận</th>
              <th class="px-3 py-2 cell-div">Công chuẩn cần nhận</th>
              <th class="px-3 py-2">Số tác vụ trong tháng</th>
              <th class="px-3 py-2 f5a-col-done">Số DONE</th>
              <th class="px-3 py-2">Vượt tiến độ</th>
              <th class="px-3 py-2">Đúng tiến độ</th>
              <th class="px-3 py-2">Chậm tiến độ</th>
              <th class="px-3 py-2">Số N/A</th>
              <th class="px-3 py-2">Tỷ lệ vượt (%)</th>
              <th class="px-3 py-2">Tỷ lệ đúng (%)</th>
              <th class="px-3 py-2">Tỷ lệ chậm (%)</th>
              <th class="px-3 py-2">%N/A</th>
            </tr>
          </thead>
          <tbody id="f5a-body" class="divide-y divide-gray-100">
            <tr><td class="px-3 py-3 text-center text-gray-500" colspan="13">Chưa có dữ liệu</td></tr>
          </tbody>
        </table>
      </div>
      <div class="mt-4 text-sm text-gray-700 flex items-center gap-3">
        <span>Biểu đồ theo PIC</span>
        <div class="flex items-center gap-2">
          <label class="text-xs text-gray-600">Chế độ</label>
          <select id="f5a-mode" class="border border-blue-200 rounded bg-white text-sm px-2 py-1">
            <option value="vertical">Cột dọc</option>
            <option value="horizontal">Thanh ngang</option>
          </select>
        </div>
        <button id="f5a-refresh" class="px-3 py-1 rounded-lg border border-gray-300 text-gray-700 bg-white hover:bg-gray-50">Làm mới</button>
      </div>
      <div class="mt-2">
        <div class="text-xs text-gray-600 mb-1">Tỷ lệ trạng thái</div>
        <div id="f5a-chart-container" class="h-80" style="display:none">
          <canvas id="f5a-chart"></canvas>
        </div>
      </div>
      <div class="mt-4">
        <div class="text-xs text-gray-600 mb-1">Tổng công chuẩn</div>
        <div id="f5a-chart-container-manhour" class="h-80" style="display:none">
          <canvas id="f5a-chart-manhour"></canvas>
        </div>
      </div>
    </section>

    <!-- Form 6 -->
    <section id="form6" class="w-full max-w-none bg-white p-6 rounded-lg shadow-md hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-blue-800">Form 6 · Ý tưởng cải tiến</h2>
        <div class="flex items-center gap-2">
          <button id="f5-open-submit" class="px-4 py-2 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105">Nộp ý tưởng</button>
          <button id="f5-search" class="submit-btn px-4 py-2 text-white font-semibold transition">Tra cứu</button>
        </div>
      </div>

      <div class="flex items-center gap-2 p-2">
        <label class="text-sm text-gray-700">Tháng nộp</label>
        <input id="f6-month" type="month" class="border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
      </div>

      <div class="mt-6 -mx-6">
        <div class="overflow-auto max-h-[60vh] border border-gray-200 rounded-lg bg-white">
          <table class="min-w-[2000px] w-full text-sm">
            <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
              <tr class="text-left text-gray-700">
                <th class="px-3 py-2">Ngày nộp</th>
                <th class="px-3 py-2">Nhân viên</th>
                <th class="px-3 py-2">Tiêu đề ý tưởng</th>
                <th class="px-3 py-2">Vấn đề nhận diện</th>
                <th class="px-3 py-2">Giải pháp</th>
              </tr>
            </thead>
            <tbody id="f5-body" class="divide-y divide-gray-100">
              <tr><td class="px-3 py-3 text-center text-gray-500" colspan="5">Chưa có dữ liệu</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div id="f5-count" class="mt-4 p-3 rounded-lg border border-blue-200 bg-blue-50/30 text-blue-800 cursor-pointer inline-flex items-center gap-2">
        <span>Nhấn để xem số ý tưởng đã nộp</span>
      </div>
      <div class="mt-6">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-lg font-semibold text-blue-800">Thống kê ý tưởng theo nhân viên</h3>
          <span id="f6-agg-note" class="text-xs text-gray-500"></span>
        </div>
        <div class="overflow-auto max-h-[50vh] border border-gray-200 rounded-lg bg-white">
          <table class="min-w-[520px] w-full text-sm">
            <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
              <tr class="text-left text-gray-700">
                <th class="px-3 py-2">Nhân viên</th>
                <th class="px-3 py-2">Số ý tưởng</th>
                <th class="px-3 py-2">Hành động</th>
              </tr>
            </thead>
            <tbody id="f6-agg-body" class="divide-y divide-gray-100">
              <tr><td class="px-3 py-3 text-center text-gray-500" colspan="3">Chưa có dữ liệu</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>
    
    <!-- Form 7 -->
    <section id="form7" class="w-full max-w-none bg-white p-6 rounded-lg shadow-md hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-blue-800">Form 7 · Hướng dẫn sử dụng</h2>
      </div>
      <div class="rounded-lg border border-gray-200 overflow-hidden">
        <iframe src="https://docs.google.com/document/d/17dkhMxqyy2YnSxukHC6y94BSFNfnDQ50/preview" class="w-full" style="height: 80vh;" allow="clipboard-write; fullscreen"></iframe>
      </div>
      <div class="mt-3 text-sm">
        <a href="https://docs.google.com/document/d/17dkhMxqyy2YnSxukHC6y94BSFNfnDQ50/edit?usp=drive_link&ouid=101589232360066908244&rtpof=true&sd=true" target="_blank" rel="noopener" class="text-primary-blue hover:underline">Mở bản đầy đủ (hiện đề mục/thẻ)</a>
      </div>
    </section>
  </main>

  <!-- Upload Modal -->
  <div id="upload-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="upload-title">
    <div class="w-full max-w-lg bg-white rounded-xl border border-gray-200 shadow-xl overflow-hidden">
      <div class="px-4 py-3 bg-gradient-to-b from-blue-50 to-white border-b border-gray-200">
        <h3 id="upload-title" class="text-base font-semibold text-gray-800">Gửi báo cáo</h3>
      </div>
      <div class="p-4 space-y-3">
        <div class="flex flex-wrap gap-2 text-sm">
          <span class="px-3 py-1 rounded-full bg-blue-50 border border-blue-200">Người nộp: <b class="ml-1" id="uploader-name"></b></span>
          <span class="px-3 py-1 rounded-full bg-blue-50 border border-blue-200">Mã: <b class="ml-1" id="uploader-code"></b></span>
          <span class="px-3 py-1 rounded-full bg-blue-50 border border-blue-200">Tác vụ: <b class="ml-1" id="uploader-task"></b></span>
        </div>
        <div id="upload-form2-single">
          <label class="block text-sm font-medium text-gray-700 mb-1">Chọn tệp báo cáo</label>
          <input id="upload-file" type="file" class="block w-full text-sm file:mr-2 file:py-1 file:px-3 file:rounded-full file:border-0 file:bg-primary-blue file:text-white"/>
          <p class="text-xs text-gray-500 mt-1">Tệp sẽ gửi kèm timestamp tại thời điểm gửi.</p>
        </div>
        <div id="upload-form1-split" style="display:none">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Báo cáo PDF hoặc file nén (.zip/.rar/.7z)</label>
            <input id="upload-file-pdfzip" type="file" accept=".pdf,.zip,.rar,.7z" class="block w-full text-sm file:mr-2 file:py-1 file:px-3 file:rounded-full file:border-0 file:bg-indigo-600 file:text-white"/>
            <p class="text-xs text-gray-500 mt-1">Chỉ nhận .pdf hoặc file nén.</p>
          </div>
          <div class="mt-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Báo cáo Excel (.xlsx) hoặc file nén (.zip/.rar/.7z)</label>
            <input id="upload-file-xlsxzip" type="file" accept=".xlsx,.zip,.rar,.7z" class="block w-full text-sm file:mr-2 file:py-1 file:px-3 file:rounded-full file:border-0 file:bg-emerald-600 file:text-white"/>
            <p class="text-xs text-gray-500 mt-1">Chỉ nhận .xlsx hoặc file nén.</p>
          </div>
        </div>
        <div id="bps-option" class="flex items-center gap-2">
          <input id="upload-bps" type="checkbox" class="h-4 w-4" checked>
          <label for="upload-bps" class="text-sm text-gray-700 select-none">Trả báo cáo BPS</label>
        </div>
      </div>
      <div class="px-4 py-3 border-t border-gray-200 flex justify-end gap-2">
        <button id="btn-cancel" class="px-4 py-2 rounded-lg bg-slate-100 text-gray-800">Huỷ</button>
        <button id="btn-send" class="px-4 py-2 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105">Gửi báo cáo</button>
      </div>
    </div>
  </div>

  <div id="detail-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="detail-title">
    <div class="w-full max-w-5xl bg-white rounded-xl border border-gray-200 shadow-xl overflow-hidden">
      <div class="px-4 py-3 bg-gradient-to-b from-blue-50 to-white border-b border-gray-200 flex items-center justify-between">
        <h3 id="detail-title" class="text-base font-semibold text-gray-800">Nhiệm vụ của <span id="detail-name" class="text-primary-blue"></span></h3>
        <button id="detail-close" class="px-3 py-1 rounded-lg bg-slate-100 text-gray-800">Đóng</button>
      </div>
      <div class="p-4">
        <div class="overflow-auto border border-gray-200 rounded-lg" style="max-height:60vh">
          <table class="min-w-[900px] w-full text-sm">
            <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
              <tr class="text-left text-gray-700">
                <th class="px-3 py-2">STT</th>
                <th class="px-3 py-2">Mã</th>
                <th class="px-3 py-2">Tên tác vụ</th>
                <th class="px-3 py-2">Số giờ đánh giá thực tế</th>
                <th class="px-3 py-2">Công chuẩn</th>
                <th class="px-3 py-2">Trạng thái theo công chuẩn</th>
                <th class="px-3 py-2">Hạn mong muốn</th>
                <th class="px-3 py-2">Ngày hoàn thành</th>
                <th class="px-3 py-2">Hiện trạng theo hạn mong muốn</th>
              </tr>
            </thead>
            <tbody id="detail-body" class="divide-y divide-gray-100">
              <tr><td class="px-3 py-3 text-center text-gray-500" colspan="9">Chưa có dữ liệu</td></tr>
            </tbody>
          </table>
        </div>
        <p class="text-xs text-gray-500 mt-2" id="detail-note"></p>
      </div>
    </div>
  </div>

  <!-- Form 5 Submit Modal -->
  <div id="f5-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="f5-modal-title">
    <div class="w-full max-w-3xl bg-white rounded-xl border border-gray-200 shadow-xl overflow-hidden">
      <div class="px-4 py-3 bg-gradient-to-b from-blue-50 to-white border-b border-gray-200">
        <h3 id="f5-modal-title" class="text-base font-semibold text-gray-800">Nộp ý tưởng cải tiến</h3>
      </div>
      <div class="p-4 space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Ngày</label>
            <input id="f5-date" type="date" readonly class="w-full border border-blue-300 rounded-lg bg-gray-200 p-2 text-gray-600"/>
            <p class="text-gray-500 text-xs mt-1">Cố định theo ngày nhập</p>
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-1">Nhân viên</label>
            <select id="f5-employee" class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white">
              <option value="">— Chọn người —</option>
            </select>
          </div>
        </div>
        <div class="grid grid-cols-1 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Tiêu đề ý tưởng</label>
            <input id="f5-title" type="text" placeholder="Nhập tiêu đề" class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Vấn đề nhận diện</label>
            <textarea id="f5-problem" rows="3" placeholder="Mô tả vấn đề" class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Giải pháp</label>
            <textarea id="f5-solution" rows="3" placeholder="Mô tả giải pháp" class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"></textarea>
          </div>
        </div>
      </div>
      <div class="px-4 py-3 border-t border-gray-200 flex justify-end gap-2">
        <button id="f5-btn-cancel" class="px-4 py-2 rounded-lg bg-slate-100 text-gray-800">Huỷ</button>
        <button id="f5-btn-send" class="px-4 py-2 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105">Gửi ý tưởng</button>
      </div>
    </div>
  </div>

  <!-- Form 6: Modal xem ý tưởng theo nhân viên -->
  <div id="f6-ideas-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="f6-ideas-title">
    <div class="w-full max-w-4xl bg-white rounded-xl border border-gray-200 shadow-xl overflow-hidden">
      <div class="px-4 py-3 bg-gradient-to-b from-blue-50 to-white border-b border-gray-200 flex items-center justify-between">
        <h3 id="f6-ideas-title" class="text-base font-semibold text-gray-800">Ý tưởng của <span id="f6-ideas-name" class="text-primary-blue"></span></h3>
        <button id="f6-ideas-close" class="px-3 py-1 rounded-lg bg-slate-100 text-gray-800">Đóng</button>
      </div>
      <div class="p-4">
        <div class="overflow-auto border border-gray-200 rounded-lg" style="max-height:60vh">
          <table class="min-w-[800px] w-full text-sm">
            <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
              <tr class="text-left text-gray-700">
                <th class="px-3 py-2">Ngày nộp</th>
                <th class="px-3 py-2">Tiêu đề</th>
                <th class="px-3 py-2">Vấn đề nhận diện</th>
                <th class="px-3 py-2">Giải pháp</th>
              </tr>
            </thead>
            <tbody id="f6-ideas-body" class="divide-y divide-gray-100">
              <tr><td class="px-3 py-3 text-center text-gray-500" colspan="4">Chưa có dữ liệu</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // Constants
    const WEBHOOK_URL = "https://iatzhxxuk.tino.page/webhook/4cdacd75-92ce-4156-aa79-62fc60f51730";
    const FORM1_UPLOAD_URL = "https://iatzhxxuk.tino.page/webhook/b0bd7f2a-eed4-4fb5-8d39-f3fed54daf3e";
    const FORM2_LOOKUP_URL = "https://iatzhxxuk.tino.page/webhook/e067ccfb-f59b-43f0-b779-b9d1286549f9";
    const FORM2_UPLOAD_URL = "https://iatzhxxuk.tino.page/webhook/2e394d3e-da1a-4577-9063-359a70518527";
    // Endpoint for Form 3 submission (single webhook; send form-data with optional files)
    const FORM3_ENDPOINT = "https://iatzhxxuk.tino.page/webhook/21b742a9-a6b0-4393-9325-bfa470db5917";
    // Endpoints for Form 6 (submit & list)
    const FORM6_SUBMIT_URL = "https://iatzhxxuk.tino.page/webhook/8e42168f-cb7b-44da-ae44-571f1e072d53";
    const FORM6_LIST_URL = "https://iatzhxxuk.tino.page/webhook/7c18c686-7349-4d09-8769-e6a951096e73";
    // Backward-compat aliases for Form 6 handlers referencing FORM5_* names
    const FORM5_SUBMIT_URL = FORM6_SUBMIT_URL;
    const FORM5_LIST_URL = FORM6_LIST_URL;
    // Form 5 All (new single-source endpoint)
    const FORM5_ALL_NEW_URL = "https://iatzhxxuk.tino.page/webhook/2c62c918-413c-49c3-99f6-49466f13c6d6";
    // Version hoá cache để tránh xung đột/hiển thị sai giữa các máy hoặc lần triển khai
    const APP_CACHE_VERSION = "2025-09-25-f5a-v4";
    let F4_CHART = null;
    let F5_LAST_COUNT = 0;
    let F4_PIVOT_BUSY = false;
    let F4_PIVOT_TMO = null;
    // Pivot cache (Form 4): lưu tất cả dòng quá hạn để lọc cục bộ khi chuyển nhóm
    let F4_PIVOT_ROWS_ALL = [];
    let F4_PIVOT_LAST_PARAMS = { from: '', to: '' };
    // Form 5 (All tasks) chart globals
    let F5A_CHART = null;
    let F5A_LAST_ROWS = [];
    let F5A_MODE = 'vertical';
    let F5A_CHART_MAN = null;
    let F5A_BASIS = 'rates';
    let F5A_RAW_ALL = [];
    let F5A_RAW_META = { month: '' };
    // Debug flag: bật/tắt bằng localStorage key "f5a.debug" = '1'
    function f5aIsDebug(){ try{ return (localStorage.getItem('f5a.debug')||'') === '1'; }catch(_){ return false; } }
    // Form 5: Công chuẩn cần nhận (có thể chỉnh tại đây)
    const F5A_NEED_MANHOUR_DEFAULT = 200;
    const F5A_NEED_MANHOUR_BY_NAME = {
      "Bùi Đặng Quốc Huy": 248.40,
      "Phạm Thành Trung Kiên": 248.40,
      "Đỗ Quang Long": 280.80,
      "Nguyễn Hữu Thịnh": 279.60,
      "Lê Văn Sơn": 266.40,
      "Nguyễn Thị Hiền": 246.00,
      "Lại Quốc Lộc": 226.80,
      "Vũ Thị Thanh Hiền": 252.00,
      "Lê Ngọc Ánh": 218.40,
      "Đào Tuấn Kỳ": 259.20,
      "Vũ Thị Hằng": 230.40,
      "Thái Thị Giang": 264.00,
      "Trần Hiếu Nghĩa": 214.80,
      "Phạm Thị Minh": 238.80,
      "Lê Thị Thảo": 247.20,
    };
    function f5aGetNeedManhour(name){
      try{
        const norm = (s)=> String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
        const map = {};
        Object.keys(F5A_NEED_MANHOUR_BY_NAME||{}).forEach(k=>{ map[norm(k)] = Number(F5A_NEED_MANHOUR_BY_NAME[k]); });
        const v = map[norm(name)];
        return (typeof v === 'number' && !isNaN(v)) ? v : F5A_NEED_MANHOUR_DEFAULT;
      }catch(_){ return F5A_NEED_MANHOUR_DEFAULT; }
    }
    // Form 5: whitelist tên hiển thị
    const F5A_WHITELIST = [
      "Đỗ Quang Long",
      "Phạm Thành Trung Kiên",
      "Lê Thị Thảo",
      "Vũ Thị Thanh Hiền",
      "Lại Quốc Lộc",
      "Lê Ngọc Ánh",
      "Lê Văn Sơn",
      "Nguyễn Thị Hiền",
      "Phạm Thị Minh",
    ];
    const F5A_WHITELIST_SET = new Set(F5A_WHITELIST.map(n => (typeof vnLower==='function'? vnLower(n): String(n||'').toLowerCase())));
    function f5aIsWhitelisted(name){
      try{
        const key = (typeof vnLower==='function'? vnLower(name): String(name||'').toLowerCase());
        return F5A_WHITELIST_SET.has(key);
      }catch(_){ return false; }
    }
    // Form 6 (ideas) cache for month filter
    let F6_LAST_ROWS = [];

    // ===== Form 5 (All tasks) - fetch once and aggregate locally =====
    function f5aPickRowsDeep(json){
      if (!json) return [];
      if (Array.isArray(json) && json.length && typeof json[0] === 'object') return json;
      const candidates = ['data','rows','result','records','items','list'];
      for (const k of candidates){ if (Array.isArray(json?.[k]) && json[k].length && typeof json[k][0] === 'object') return json[k]; }
      try{
        const queue=[json]; const seen=new Set();
        while(queue.length){
          const cur = queue.shift(); if(!cur || typeof cur !== 'object' || seen.has(cur)) continue; seen.add(cur);
          for (const v of Object.values(cur)){
            if (Array.isArray(v) && v.length && typeof v[0] === 'object') return v;
            if (v && typeof v === 'object') queue.push(v);
          }
        }
      }catch(_){ }
      return [];
    }

    async function f5aFetchAllOnce(month, fromVal, toVal){
      if (F5A_RAW_ALL && F5A_RAW_ALL.length && F5A_RAW_META && F5A_RAW_META.month === (month||'')) return;
      const makeQs = (withAction, withRange)=>{
        const qs = new URLSearchParams();
        if (withAction) qs.append('action','form5_all');
        if (withRange){
          if (month) qs.append('month', month);
          if (fromVal) qs.append('from', fromVal);
          if (toVal) qs.append('to', toVal);
        }
        qs.append('_ts', Date.now().toString());
        return qs.toString();
      };
      const urls = [];
      const uBase = FORM5_ALL_NEW_URL;
      const uTest = uBase.replace('/webhook/','/webhook-test/');
      [true,false].forEach(withRange=>{
        [true,false].forEach(withAction=>{
          const q = makeQs(withAction, withRange);
          urls.push(`${uBase}${q?`?${q}`:''}`);
          urls.push(`${uTest}${q?`?${q}`:''}`);
        });
      });
      // thêm phương án không query
      urls.push(uBase);
      urls.push(uTest);
      let rows = [];
      for (const u of urls){
        try{
          console.log('Form5 fetch try:', u);
          const r = await fetch(u, { method: 'GET', headers: { 'Accept': 'application/json, text/plain, */*' } });
          const text = await r.text();
          let data = null; try{ data = JSON.parse(text); }catch{ data = null; }
          if (!data && typeof text === 'string'){
            const m = text.match(/\[[\s\S]*\]/);
            if (m) { try { data = JSON.parse(m[0]); } catch(_) { data = null; } }
          }
          const picked = f5aPickRowsDeep(data ?? text);
          if (Array.isArray(picked) && picked.length){ rows = picked; break; }
        }catch(_){ /* next */ }
      }
      // Unwrap n8n format: [{ json: {...} }]
      const unwrapped = Array.isArray(rows) ? rows.map(r=> (r && typeof r==='object' && ('json' in r)) ? r.json : r) : [];
      F5A_RAW_ALL = unwrapped;
      F5A_RAW_META = { month: month || '' };
      try{ LS.set('f5a.lastUpdated', String(Date.now())); updateLastUpdatedNote('f5a-search','f5a.lastUpdated'); }catch(_){ }
    }

    function f5aAggregate(rows, fromVal, toVal){
      // ==== CONFIG (tham khảo Code tổng hợp.txt) ====
      const assigneeKeys = ['Assignee','Phụ trách','Người phụ trách','Người xử lý','employee','nhanvien','nhan_vien','nhân viên','user','name','receiver','recipient','pic','nguoi_phu_trach','người phụ trách'];
      const taskNameKeys = ['Task Name','Tên tác vụ','Task','Công việc','Tên Task','Mã','taskname','ten_tac_vu','ten','title'];
      const scoreKeys = ['Điểm','Score','score'];
      const altScoreKeys = ['Công chuẩn công việc nhận ','Công chuẩn công việc nhận','Công chuẩn','manhour','man_hour','current_manhour','congchuan','cong_chuan','hours'];
      const actualHoursKeys = ['Số giờ đánh giá thực tế','so gio danh gia thuc te','actualhours','actual_hours','gio thuc te','gio_thuc_te','hours_actual'];
      const statusKeys = [
        'Hiện trạng','Trạng thái','Status','status','trangthai','trang_thai','trạng thái',
        // Bổ sung các biến thể cho cột trạng thái theo công chuẩn
        'Trạng thái theo công chuẩn','trang thai theo cong chuan','hiện trạng theo công chuẩn','hien trang theo cong chuan',
        'status_by_man','status_by_manhour','status_manhour','status_by_workload','ht_theo_cong_chuan'
      ];
      // Cột "Hiện trạng theo hạn mong muốn" (đúng/trễ hạn yêu cầu)
      const statusByWishKeys = [
        'Hiện trạng theo hạn mong muốn','hien trang theo han mong muon','trang thai theo han mong muon',
        'status_by_wish','status_wish','statuswish','ht_theo_han_mong_muon'
      ];
      const finishedDateKs = ['Ngày hoàn thành thực tế','Ngày hoàn thành','Ngày đóng','completiondate','completeddate','ngayhoanthanh','ngay_hoan_thanh'];
      const countZeroTasks = true;
      const excludeCanceled = true;
      const minWeight = 0.0001;

      const hasVal = v => v != null && String(v).trim() !== '';
      const normalizeVi = (s)=>{ try{ return String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim(); }catch(_){ return String(s||'').toLowerCase().trim(); } };
      const normKey = (s)=> String(s||'').toLowerCase().replace(/\s+/g,' ').trim();
      const getV = (obj, keys)=>{
        const lower = {};
        Object.keys(obj||{}).forEach(k=>{
          const v = obj[k];
          const k1 = String(k).toLowerCase();
          const k2 = normKey(k);
          lower[k1] = v;
          lower[k2] = v;
        });
        for (const k of keys){
          const cand1 = String(k).toLowerCase();
          const cand2 = normKey(k);
          const v = lower[cand1] ?? lower[cand2];
          if (v !== undefined && hasVal(v)) return v;
        }
        return '';
      };
      function toNum(v){
        if (v == null) return 0;
        let s = String(v).trim();
        if (!s) return 0;
        s = s.replace(/\s|\u00A0/g, '');
        s = s.replace(/[%₫đvnd]/gi, '');
        if (s.includes(',')) s = s.replace(/\./g,'').replace(',', '.');
        else s = s.replace(/\./g,'');
        const n = Number(s);
        return Number.isFinite(n) ? n : 0;
      }
      function getNumberFrom(row, keys){ const v = getV(row, keys); return toNum(v); }
      function getTextFrom(row, keys){ const v = getV(row, keys); return String(v||'').trim(); }
      function isCanceled(row){
        const f = getTextFrom(row, finishedDateKs).toLowerCase();
        const st = getTextFrom(row, statusKeys).toLowerCase();
        return f.includes('cancel') || st.includes('cancel') || st.includes('hủy') || st.includes('huỷ');
      }
      const resultKeys = ['⁉️ Kết quả','ket_qua','kết quả','result'];
      function inRange(v){
        if (!fromVal && !toVal) return true;
        const d = parseDateFlexible(v);
        if (!d) return true;
        const ds = d.toISOString().slice(0,10);
        if (fromVal && ds < fromVal) return false;
        if (toVal && ds > toVal) return false;
        return true;
      }
      const byName = new Map();
      const dbg = { total:0, done:0, both:0, addAhead:0, addOn:0, addLate:0, missWish:0, missMan:0 };
      rows.forEach(row=>{
        // Bỏ qua bản ghi không phải task (thiếu tên task)
        const taskVal = getTextFrom(row, taskNameKeys);
        if (!hasVal(taskVal)) return;
        if (excludeCanceled && isCanceled(row)) return;
        let name = getTextFrom(row, assigneeKeys);
        if (!name || name.toLowerCase() === 'nan') name = 'Chưa phân công';

        const rq = getV(row,[
          'requestdate','ngayyeucau','ngay_yeu_cau','submissiondate','ngaygui','📆 ngày yêu cầu'
        ]);
        const wish = getV(row,['wishdue','hanmongmuon','han_mong_muon','desireddue']);
        const act = getV(row,['actualdue','handapung','han_dap_ung','completiondate']);
        const doneDate = getV(row, finishedDateKs);
        // Lọc theo mốc ngày ưu tiên: Ngày yêu cầu -> Hạn đáp ứng -> Hạn mong muốn -> Ngày hoàn thành
        const refDate = (
          hasVal(rq) ? rq : (
            hasVal(act) ? act : (
              hasVal(wish) ? wish : (
                hasVal(doneDate) ? doneDate : ''
              )
            )
          )
        );
        if (!hasVal(refDate) || !inRange(refDate)) return;

        const weight = getNumberFrom(row, scoreKeys) || getNumberFrom(row, altScoreKeys);
        const resText = getTextFrom(row, resultKeys);
        const statusRaw = getTextFrom(row, statusKeys);
        const hasDoneDate = !!parseDateFlexible(doneDate);
        const normRes = normalizeVi(resText);
        const normStatus = normalizeVi(statusRaw);
        const done = hasDoneDate || /^\s*done\s*$/i.test(resText||'') || /\bdone\b/.test(normRes) || /\bhoan\b|\bdone\b|\bda hoan\b/.test(normStatus);

        let rec = byName.get(name);
        if (!rec) { rec = { name, manhour: 0, count: 0, ahead: 0, ontime: 0, late: 0, na: 0, doneCnt: 0, doneSum: 0, activeCnt: 0, activeSum: 0 }; byName.set(name, rec); }

        const countThis = countZeroTasks ? true : (weight > minWeight);
        if (done) {
          if (countThis) rec.doneCnt += 1;
          rec.doneSum += weight;
        } else {
          if (countThis) rec.activeCnt += 1;
          rec.activeSum += weight;
        }
        rec.count = (rec.doneCnt || 0) + (rec.activeCnt || 0);
        rec.manhour = (rec.doneSum || 0) + (rec.activeSum || 0);
        // Tổng công chuẩn theo mốc tham chiếu refDate (không tính Cancel vì đã loại ở trên)
        try{
          const dRef = parseDateFlexible(refDate || '');
          if (dRef){
            const ds = dRef.toISOString().slice(0,10);
            const inRef = (!fromVal || ds >= fromVal) && (!toVal || ds <= toVal);
            if (inRef){ rec.totalByRef = (rec.totalByRef || 0) + weight; }
          }
        }catch(_){ }

        // Phân loại vượt/đúng/chậm theo cột "Hiện trạng" khi đã Done
        dbg.total++;
        {
          // Xác định điều kiện N/A: có ngày hoàn thành và số giờ thực tế = 0
          const EPS_NA = 1e-4;
          let actualNumForNA = 0;
          try { actualNumForNA = getNumberFrom(row, actualHoursKeys); } catch(_) { actualNumForNA = 0; }
          const isNA = (hasDoneDate && Number.isFinite(actualNumForNA) && Math.abs(actualNumForNA) < EPS_NA);
          let handled = false;
          if (!done) { dbg.missWish++; dbg.missMan++; } // chưa hoàn thành thì thường không có đủ 2 chiều
          // Lấy text nếu có
          const htText = normalizeVi(getTextFrom(row, statusKeys));
          const wishText = normalizeVi(getTextFrom(row, statusByWishKeys));
          let manAhead = htText.includes('vuot tien do');
          let manOn    = htText.includes('dung tien do');
          let manLate  = htText.includes('cham tien do');
          let wishOn   = wishText.includes('dung han');
          let wishLate = wishText.includes('tre han');
          // Fallback: suy ra Đúng/Trễ hạn nếu thiếu text
          if (!(wishOn || wishLate)){
            try{
              const dWish = parseDateFlexible(wish);
              const dDone = parseDateFlexible(doneDate);
              if (dWish && dDone){
                const plus2 = new Date(dWish.getFullYear(), dWish.getMonth(), dWish.getDate()+2);
                if (dDone.getTime() <= plus2.getTime()) wishOn = true; else wishLate = true;
              }
            }catch(_){ }
          }
          // Fallback: suy ra theo công chuẩn nếu thiếu text
          if (!(manAhead || manOn || manLate)){
            try{
              const actualNum = getNumberFrom(row, actualHoursKeys);
              const manNum = weight;
              const EPS = 1e-4;
              // Nếu thực tế = 0 thì coi là thiếu dữ liệu -> không phân loại vào Vượt/Đúng/Chậm
              if (Number.isFinite(actualNum) && Math.abs(actualNum) < EPS) {
                // giữ nguyên manAhead/manOn/manLate = false để đẩy vào N/A
              } else if (Number.isFinite(actualNum) && Number.isFinite(manNum)){
                if (actualNum > manNum + EPS) manLate = true;
                else if (Math.abs(actualNum - manNum) <= EPS) manOn = true;
                else manAhead = true;
              }
            }catch(_){ }
          }
          // Nếu thuộc N/A thì ưu tiên đưa vào N/A và bỏ qua các phân loại khác
          if (isNA){
            rec.na = (rec.na || 0) + 1;
            handled = true;
          }
          if (!handled && (wishOn || wishLate) && (manAhead || manOn || manLate)){
            rec.classifiedCnt = (rec.classifiedCnt || 0) + 1;
            dbg.both++;
            if (wishOn){
              if (manAhead) { rec.ahead += 1; dbg.addAhead++; }
              else if (manOn) { rec.ontime += 1; dbg.addOn++; }
              else if (manLate) { rec.late += 1; dbg.addLate++; }
            } else if (wishLate){
              rec.late += 1; dbg.addLate++;
            }
          } else if (!handled) {
            // Nếu chỉ có phân loại theo công chuẩn (thiếu hạn mong muốn) thì vẫn cộng để tránh đếm thiếu
            if (!wishOn && !wishLate && (manAhead || manOn || manLate)){
              rec.classifiedCnt = (rec.classifiedCnt || 0) + 1;
              if (manAhead) { rec.ahead += 1; dbg.addAhead++; }
              else if (manOn) { rec.ontime += 1; dbg.addOn++; }
              else if (manLate) { rec.late += 1; dbg.addLate++; }
            }
            // Nếu chỉ có Trễ hạn theo hạn mong muốn mà thiếu phân loại theo công chuẩn, vẫn tính là Chậm
            else if (wishLate && !(manAhead||manOn||manLate)){
              rec.classifiedCnt = (rec.classifiedCnt || 0) + 1;
              rec.late += 1; dbg.addLate++;
            } else {
              if (!(wishOn||wishLate)) dbg.missWish++;
              if (!(manAhead||manOn||manLate)) dbg.missMan++;
            }
          }
        }
      });
      const out = Array.from(byName.values());
      out.forEach(r=>{
        const na = Math.max(0, Number(r.na||0));
        const sumClassified = Math.max(0, Number(r.ahead||0) + Number(r.ontime||0) + Number(r.late||0));
        // Mẫu số mới: tổng (Vượt + Đúng + Chậm + N/A)
        const denom = sumClassified + na;
        r.rateAhead = denom ? Math.round((Number(r.ahead||0)*100)/denom) : 0;
        r.rateOntime = denom ? Math.round((Number(r.ontime||0)*100)/denom) : 0;
        r.rateLate = denom ? Math.round((Number(r.late||0)*100)/denom) : 0;
        r.rateNA = denom ? Math.max(0, Math.min(100, Math.round((na*100)/denom))) : 0;
        r.classifiedCnt = sumClassified;
        // Map theo biểu mẫu ngoài (ảnh)
        r["Phụ trách"] = r.name || '';
        const activeSum = Number(r.activeSum||0);
        r["Tổng điểm (đang xử lý)"] = +activeSum.toFixed(2);
        r["Số task đang xử lý"] = Number(r.activeCnt||0);
        const totalPts = Number((r.doneSum||0) + (r.activeSum||0));
        r["Tổng điểm tất cả"] = +totalPts.toFixed(2);
        r["Tổng tác vụ đã xử lý"] = Number((r.doneCnt||0) + (r.activeCnt||0));
        // Tổng công chuẩn theo mốc refDate
        const byRef = Number(r.totalByRef||0);
        r["Tổng công chuẩn"] = +byRef.toFixed(2);
      });
      try{ if (f5aIsDebug()) console.log('[F5A] classify summary:', dbg); }catch(_){ }
      return out;
    }

    // Date-time format helpers
    function toDateSafe(value){
      try{
        if (value instanceof Date && !isNaN(value)) return value;
        const parsed = (typeof parseDateFlexible === 'function') ? parseDateFlexible(value) : null;
        if (parsed && !isNaN(parsed)) return parsed;
        const d = new Date(value);
        return isNaN(d) ? null : d;
      }catch(_){ return null; }
    }
    function formatDdMmYyyy(value){
      try{
        const d = toDateSafe(value);
        if (!d) return '';
        const pad = n=> String(n).padStart(2,'0');
        return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()}`;
      }catch(_){ return ''; }
    }
    function formatDdMmYyyyHHmm(value){
      try{
        const d = toDateSafe(value);
        if (!d) return '';
        const pad = n=> String(n).padStart(2,'0');
        return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
      }catch(_){ return ''; }
    }

    function formatYyyyMm(value){
      try{
        const d = toDateSafe(value);
        if (!d) return '';
        const pad = n=> String(n).padStart(2,'0');
        return `${d.getFullYear()}-${pad(d.getMonth()+1)}`;
      }catch(_){ return ''; }
    }
    // Parse number flexible: supports both comma and dot decimals
    function parseNumberFlexible(value){
      try{
        let s = String(value ?? '').trim();
        if (!s) return NaN;
        s = s.replace(/\s|\u00A0/g,'');
        s = s.replace(/[%₫đvnd]/gi,'');
        if (s.includes(',')) {
          s = s.replace(/\./g,'').replace(',', '.');
        } else {
          s = s.replace(/,/g,'');
        }
        const n = Number(s);
        return Number.isFinite(n) ? n : NaN;
      }catch(_){ return NaN; }
    }
    // Number formatters for display only (do not mutate source data)
    function formatNumberVi(num, min=2, max=2){
      try{
        if (!Number.isFinite(num)) return '';
        return num.toLocaleString('vi-VN', { minimumFractionDigits: min, maximumFractionDigits: max });
      }catch(_){
        try{ return String(num); }catch(__){ return ''; }
      }
    }
    function formatNumberViFromRaw(raw, min=2, max=2){
      try{
        const n = parseNumberFlexible(raw);
        return Number.isFinite(n) ? formatNumberVi(n, min, max) : String(raw||'');
      }catch(_){ return String(raw||''); }
    }

    // Local storage helpers & last-updated note
    const LS = {
      get(k){ try{ return localStorage.getItem(k); }catch(_){ return null; } },
      set(k,v){ try{ localStorage.setItem(k,v); }catch(_){ } },
      getJSON(k){ try{ const s=localStorage.getItem(k); return s? JSON.parse(s): null; }catch(_){ return null; } },
      setJSON(k,obj){ try{ localStorage.setItem(k, JSON.stringify(obj)); }catch(_){ } },
      remove(k){ try{ localStorage.removeItem(k); }catch(_){ } }
    };
    function formatHHmmDdMmYyyy(value){
      try{
        const d = toDateSafe(value);
        if (!d) return '';
        const pad = n=> String(n).padStart(2,'0');
        return `${pad(d.getHours())}:${pad(d.getMinutes())} ${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()}`;
      }catch(_){ return ''; }
    }
    function updateLastUpdatedNote(btnId, tsKey){
      try{
        const btn = document.getElementById(btnId);
        if (!btn) return;
        const parent = btn.parentElement || btn;
        // Ghi chú thời gian
        let note = parent.querySelector('[data-last-updated]');
        if (!note){
          note = document.createElement('span');
          note.setAttribute('data-last-updated','1');
          note.className = 'text-xs text-gray-500 ml-2';
          parent.appendChild(note);
        }
        const tsStr = LS.get(tsKey);
        const ts = Number(tsStr);
        const show = tsStr ? (isNaN(ts) ? '' : `Dữ liệu cập nhật lúc ${formatHHmmDdMmYyyy(new Date(ts))}`) : '';
        note.textContent = show;

        // Dòng hướng dẫn nổi bật bên dưới
        const hintId = `${btnId}-refresh-hint`;
        let hint = document.getElementById(hintId);
        if (!hint){
          hint = document.createElement('div');
          hint.id = hintId;
          hint.className = 'mt-1 text-xs inline-flex items-center gap-1 px-2 py-1 rounded bg-amber-50 border border-amber-200 text-amber-700';
          parent.insertAdjacentElement('afterend', hint);
        }
        hint.innerHTML = `🔄 <span>Nhấn <b>TRA CỨU</b> để cập nhật dữ liệu mới nhất.</span>`;
      }catch(_){ }
    }

    function f4SchedulePivot(delay = 80){
      try { if (F4_PIVOT_TMO) clearTimeout(F4_PIVOT_TMO); } catch(_) {}
      F4_PIVOT_TMO = setTimeout(()=>{ try{ renderF4Pivot(); }catch(_){ } }, delay);
    }

    // Global helper: parse various date formats to Date (YYYY-MM-DD, DD/MM/YYYY, DD-MM-YYYY, YYYY/MM/DD)
    function parseDateFlexible(value){
      if (!value) return null;
      const s = String(value).trim();
      let m = s.match(/^(\d{1,2})[\/\-.](\d{1,2})[\/\-.](\d{2,4})/);
      if (m) {
        const day = parseInt(m[1], 10);
        const month = parseInt(m[2], 10);
        const year = m[3].length === 2 ? parseInt('20' + m[3], 10) : parseInt(m[3], 10);
        const dt = new Date(year, month - 1, day);
        return isNaN(dt) ? null : dt;
      }
      m = s.match(/^(\d{4})[\/\-.](\d{1,2})[\/\-.](\d{1,2})/);
      if (m) {
        const dt = new Date(parseInt(m[1], 10), parseInt(m[2], 10) - 1, parseInt(m[3], 10));
        return isNaN(dt) ? null : dt;
      }
      const dt = new Date(s);
      return isNaN(dt) ? null : dt;
    }

    // Sidebar navigation
    const navBtns = document.querySelectorAll('.nav-btn');
    const sections = ['form1','form2','form3','form4','form5','form6','form7'].map(id=>document.getElementById(id));
    function showSection(id){ sections.forEach(s=>s.classList.toggle('hidden', s.id!==id)); }
    navBtns.forEach((btn)=>{
      btn.onclick=()=>{
        navBtns.forEach(b=>b.classList.remove('bg-primary-blue','font-bold'));
        btn.classList.add('bg-primary-blue','font-bold');
        const target = btn.getAttribute('data-target');
        showSection(target);
        if (target === 'form6') { try { if(!restoreForm6FromCache()){ renderForm5List(); } } catch(_){} }
        if (target === 'form4') {
          try {
            const restored = restoreForm4FromCache();
            f4UpdateGroupButtonsUI();
            f4SchedulePivot();
            // Refresh ngầm: giữ UI hiện có, tải dữ liệu mới không hiển thị spinner
            try { F4_SUPPRESS_LOADING = true; } catch(_) {}
            renderForm4().finally(()=>{ try { F4_SUPPRESS_LOADING = false; } catch(_) {} });
          } catch(_){}
        }
        if (target === 'form5') {
          try {
            const restored = restoreForm5FromCache();
            // Luôn làm mới ngầm để đảm bảo % được tính lại sau khi chuyển form hoặc cập nhật mã
            renderForm5All().catch(()=>{});
          } catch(_){}
        }
      }
    });
    // Default
    navBtns[0].classList.add('bg-primary-blue','font-bold');
    showSection(navBtns[0].getAttribute('data-target'));
    // Hiển thị dòng hướng dẫn dưới các nút Tra cứu của các form khác
    try { updateLastUpdatedNote('f4-search','f4.lastUpdated'); } catch(_){}
    try { updateLastUpdatedNote('f5a-search','f5a.lastUpdated'); } catch(_){}
    try { updateLastUpdatedNote('f5-search','f5.lastUpdated'); } catch(_){}

    // Names
    const FORM1_NAMES = [
      "Bùi Đặng Quốc Huy","Đào Tuấn Kỳ","Đỗ Quang Long","Đỗ Thế Cường","Hà Mỹ Linh","Lại Quốc Lộc",
      "Lê Ngọc Ánh","Lê Thị Thanh Nhàn","Lê Thị Thảo","Lê Văn Sơn","Nguyễn Hữu Thịnh","Nguyễn Thị Hiền",
      "Phạm Thành Trung Kiên","Phạm Thị Minh","Thái Thị Giang","Trần Hiếu Nghĩa","Vũ Thị Hằng","Vũ Thị Thanh Hiền"
    ];
    const FORM2_NAMES = FORM1_NAMES;
    // Danh sách riêng cho Form 3 (Người được giao): loại 3 tên và thêm 3 tên
    const FORM3_ASSIGNEES = (()=>{
      const base = Array.isArray(FORM1_NAMES) ? FORM1_NAMES.slice() : [];
      const exclude = new Set(["Hà Mỹ Linh","Đỗ Thế Cường","Lê Thị Thanh Nhàn"]);
      const add = ["Đào Hoàng Dương","Nguyễn Văn Linh","Nguyễn Văn Hiếu"];
      const filtered = base.filter(n => !exclude.has(n));
      add.forEach(n => { if (filtered.indexOf(n) === -1) filtered.push(n); });
      return filtered;
    })();

    // Dữ liệu tác vụ (khởi tạo rỗng; sẽ nối nguồn thật sau)
    const demoTasksForm1 = {};
    const demoTasksForm2 = {};

    // Fill selects
    function fillSelect(sel, arr){ arr.forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; sel.appendChild(o); }); }
    fillSelect(document.getElementById('f1-name'), FORM1_NAMES);
    fillSelect(document.getElementById('f2-name'), FORM2_NAMES);
    const f3AssigneeSel = document.getElementById('f3-assignee');
    if (f3AssigneeSel) fillSelect(f3AssigneeSel, FORM3_ASSIGNEES);
    const f4PeopleSel = document.getElementById('f4-people');
    if (f4PeopleSel) fillSelect(f4PeopleSel, FORM1_NAMES);
    const f5EmployeeSel = document.getElementById('f5-employee');
    if (f5EmployeeSel) fillSelect(f5EmployeeSel, FORM1_NAMES);

    // Persist selections and show last-updated notes for Form 1 & 2
    (function initPersistSelections(){
      try{
        const f1Sel = document.getElementById('f1-name');
        if (f1Sel){
          const last = LS.get('f1.selectedName');
          if (last && Array.prototype.some.call(f1Sel.options, op=> op.value===last)) f1Sel.value = last;
          f1Sel.addEventListener('change', ()=>{ LS.set('f1.selectedName', f1Sel.value||''); });
          updateLastUpdatedNote('f1-search','f1.lastUpdated');
        }
        const f2Sel = document.getElementById('f2-name');
        if (f2Sel){
          const last2 = LS.get('f2.selectedName');
          if (last2 && Array.prototype.some.call(f2Sel.options, op=> op.value===last2)) f2Sel.value = last2;
          f2Sel.addEventListener('change', ()=>{ LS.set('f2.selectedName', f2Sel.value||''); });
          updateLastUpdatedNote('f2-search','f2.lastUpdated');
        }
      }catch(_){ }
    })();

    // Toast
    const toastEl = document.getElementById('toast');
    function showToast(msg,type='info'){
      toastEl.textContent = msg;
      toastEl.style.background = type==='success' ? '#137a39' : (type==='error' ? '#b42318' : '#0b1324');
      toastEl.classList.add('show');
      setTimeout(()=>toastEl.classList.remove('show'), 2600);
    }

    // Upload modal
    const modal = document.getElementById('upload-modal');
    const fileInput = document.getElementById('upload-file');
    const uploaderName = document.getElementById('uploader-name');
    const uploaderCode = document.getElementById('uploader-code');
    const uploaderTask = document.getElementById('uploader-task');
    let uploadContext = null;
    let isModalSubmitting = false;
    let lastOpenTrigger = null;
    function openUploadModal(ctx){
      uploadContext = ctx || {};
      uploaderName.textContent = ctx?.name || '';
      uploaderCode.textContent = ctx?.code || '';
      uploaderTask.textContent = ctx?.taskName || '';
      // Hide Người nộp pill for Form 2 per request
      try {
        const namePill = uploaderName && uploaderName.parentElement && uploaderName.parentElement.parentElement ? uploaderName.parentElement.parentElement : null;
        if (namePill) namePill.style.display = (ctx && ctx.form === 'Form 2') ? 'none' : '';
        const bpsOption = document.getElementById('bps-option');
        const bpsCheckbox = document.getElementById('upload-bps');
        if (bpsOption) bpsOption.style.display = (ctx && ctx.form === 'Form 2') ? 'none' : '';
        if (bpsCheckbox) bpsCheckbox.checked = (ctx && ctx.form === 'Form 1') ? true : false;
        const singleWrap = document.getElementById('upload-form2-single');
        const splitWrap = document.getElementById('upload-form1-split');
        if (ctx && ctx.form === 'Form 1'){
          if (singleWrap) singleWrap.style.display = 'none';
          if (splitWrap) splitWrap.style.display = '';
        } else {
          if (singleWrap) singleWrap.style.display = '';
          if (splitWrap) splitWrap.style.display = 'none';
        }
      } catch(_) {}
      try { if (ctx && ctx.form === 'Form 2') { sendForm2RowMeta(ctx); } } catch(_) {}
      fileInput.value = '';
      try { document.getElementById('upload-file-pdfzip').value = ''; } catch(_){}
      try { document.getElementById('upload-file-xlsxzip').value = ''; } catch(_){}
      modal.classList.add('open');
      modal.setAttribute('aria-hidden','false');
    }
    function closeUploadModal(){
      modal.classList.remove('open');
      modal.setAttribute('aria-hidden','true');
      // Re-enable last trigger and reset submit button state
      if (lastOpenTrigger) {
        try {
          lastOpenTrigger.disabled = false;
          if (lastOpenTrigger.classList) lastOpenTrigger.classList.remove('opacity-50','pointer-events-none');
        } catch(_) {}
        lastOpenTrigger = null;
      }
      const sendBtn = document.getElementById('btn-send');
      if (sendBtn) {
        sendBtn.disabled = false;
        sendBtn.textContent = 'Gửi báo cáo';
      }
      isModalSubmitting = false;
    }
    document.getElementById('btn-cancel').onclick = closeUploadModal;
    modal.addEventListener('click', (e)=>{ if(e.target===modal) closeUploadModal(); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && modal.classList.contains('open')) closeUploadModal(); });

    function sendForm2RowMeta(ctx){
      try{
        if (!ctx || ctx.form !== 'Form 2') return;
        const p = new URLSearchParams();
        p.append('action','form2_report_open');
        p.append('person_name', ctx.name || '');
        p.append('taskId', ctx.taskId || ctx.code || '');
        p.append('code', ctx.code || '');
        p.append('taskName', ctx.taskName || '');
        const rd = ctx.rowData || {};
        try{
          Object.keys(rd).forEach(k=>{
            const v = rd[k];
            p.append(`row.${k}`, String(v ?? ''));
          });
        }catch(_){ }
        p.append('timestamp', new Date().toISOString());
        fetch(WEBHOOK_URL, { method:'POST', mode:'no-cors', headers:{ 'Content-Type':'application/x-www-form-urlencoded' }, body: p.toString() }).catch(()=>{});
      }catch(_){ }
    }

    document.getElementById('btn-send').onclick = async ()=>{
      if (isModalSubmitting) return;
      const isForm1 = (uploadContext && uploadContext.form === 'Form 1');
      const btn = document.getElementById('btn-send');
      const bpsCheckbox = document.getElementById('upload-bps');
      const bpsChecked = bpsCheckbox ? bpsCheckbox.checked : false;
      function extOf(name){ const m = String(name||'').toLowerCase().match(/\.([a-z0-9]+)$/); return m?m[1]:''; }
      let fd = new FormData();
      if (isForm1) {
        const pdfInput = document.getElementById('upload-file-pdfzip');
        const xlsxInput = document.getElementById('upload-file-xlsxzip');
        const okPdf = ['pdf','zip','rar','7z'];
        const okXlsx = ['xlsx','zip','rar','7z'];
        if (!pdfInput || !pdfInput.files || pdfInput.files.length===0){ showToast('Vui lòng chọn file PDF hoặc file nén.','error'); return; }
        const fPdf = pdfInput.files[0];
        const extPdf = extOf(fPdf.name);
        if (okPdf.indexOf(extPdf)===-1){ showToast('File PDF/Nén không đúng định dạng.','error'); return; }
        let fXlsx = null;
        if (bpsChecked){
          if (!xlsxInput || !xlsxInput.files || xlsxInput.files.length===0){ showToast('Vui lòng chọn file Excel hoặc file nén khi gửi BPS.','error'); return; }
          fXlsx = xlsxInput.files[0];
          const extX = extOf(fXlsx.name);
          if (okXlsx.indexOf(extX)===-1){ showToast('File Excel/Nén không đúng định dạng.','error'); return; }
        }
      isModalSubmitting = true;
      if (btn) { btn.disabled = true; btn.innerHTML = "<span class='spinner mr-2'></span>Đang gửi..."; }
        // Append with original field names
        fd.append('file_pdfzip', fPdf);
        if (fXlsx) fd.append('file_xlsxzip', fXlsx);
        // Extra compatibility: duplicate under common field names
        try { fd.append('file', fPdf); } catch(_){ }
        try { if (fXlsx) fd.append('file2', fXlsx); } catch(_){ }
        try { fd.append('files[]', fPdf); } catch(_){ }
        try { if (fXlsx) fd.append('files[]', fXlsx); } catch(_){ }
        fd.append('upload_type', fXlsx ? 'combined' : 'pdf_only');
        fd.append('file_name', fPdf.name || '');
        if (fXlsx) fd.append('file_name_xlsx', fXlsx.name || '');
        fd.append('timestamp', formatDdMmYyyyHHmm(new Date()));
        if(uploadContext){
          fd.append('nguoi_nop', uploadContext.name||'');
          const taskIdVal = uploadContext.taskId || uploadContext.code || '';
          fd.append('ma_tac_vu', taskIdVal);
          fd.append('ten_tac_vu', uploadContext.taskName||'');
          fd.append('form', uploadContext.form||'Form 1');
        }
        if (bpsCheckbox) { fd.append('is_bps', bpsChecked ? '1' : '0'); }
        try{
          try { showToast(`Sẽ gửi ${fXlsx? '2 tệp' : '1 tệp'}: ${fPdf?.name||''}${fXlsx? (', '+(fXlsx.name||'')) : ''}`,'info'); } catch(_){}
          await fetch(FORM1_UPLOAD_URL,{method:'POST',body:fd, mode: 'no-cors'});
          showToast('Đã gửi báo cáo.','success');
          closeUploadModal();
        } catch(e){
          console.error(e);
          showToast('Gửi thất bại.','error');
          isModalSubmitting = false;
          if (btn) { btn.disabled = false; btn.textContent = 'Gửi báo cáo'; }
        }
        return;
      }
      // Form 2 (giữ nguyên logic upload 1 file)
      if(!fileInput.files || fileInput.files.length===0){ showToast('Vui lòng chọn tệp báo cáo.','error'); return; }
      isModalSubmitting = true;
      if (btn) { btn.disabled = true; btn.innerHTML = "<span class='spinner mr-2'></span>Đang gửi..."; }
      fd.append('file', fileInput.files[0]);
      fd.append('file_name', fileInput.files[0].name || '');
      fd.append('timestamp', formatDdMmYyyyHHmm(new Date()));
      if(uploadContext){
        fd.append('nguoi_nop', uploadContext.name||'');
        const taskIdVal = uploadContext.taskId || uploadContext.code || '';
        fd.append('ma_tac_vu', taskIdVal);
        fd.append('ten_tac_vu', uploadContext.taskName||'');
        fd.append('form', uploadContext.form||'');
      }
      if (bpsCheckbox) { fd.append('is_bps', bpsChecked ? '1' : '0'); }
      try{
        await fetch(FORM2_UPLOAD_URL,{method:'POST',body:fd, mode: 'no-cors'});
        showToast('Đã gửi báo cáo.','success');
        closeUploadModal();
      } catch(e){
        console.error(e);
        showToast('Gửi thất bại.','error');
        isModalSubmitting = false;
        if (btn) { btn.disabled = false; btn.textContent = 'Gửi báo cáo'; }
      }
    };

    

    // Helpers for tables
    function addTd(tr, text){ const td=document.createElement('td'); td.className='px-3 py-2 align-top'; td.textContent=text; tr.appendChild(td); }
    // Enable drag-drop reordering on table body rows
    function enableTableDrag(tbodyId){
      try{
        const tbody = document.getElementById(tbodyId);
        if (!tbody) return;
        let dragging = null;
        const onDragStart = (e)=>{ dragging = e.currentTarget; dragging.classList.add('opacity-50'); try{ e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/plain',''); }catch(_){ } };
        const onDragEnd = ()=>{ try{ if (dragging) dragging.classList.remove('opacity-50'); }catch(_){ } dragging = null; try{ tbody.querySelectorAll('tr').forEach(r=> r.classList.remove('drag-over')); }catch(_){ } };
        const onDragOver = (e)=>{ e.preventDefault(); const row = e.target && e.target.closest ? e.target.closest('tr') : null; if (!row || row === dragging) return; try{ tbody.querySelectorAll('tr').forEach(r=> r.classList.remove('drag-over')); row.classList.add('drag-over'); }catch(_){ } };
        const onDrop = (e)=>{ e.preventDefault(); const row = e.target && e.target.closest ? e.target.closest('tr') : null; if (!row || !dragging || row===dragging) { onDragEnd(); return; } try{ tbody.insertBefore(dragging, row.nextSibling); }catch(_){ } onDragEnd(); };
        tbody.querySelectorAll('tr').forEach(tr=>{ try{ tr.setAttribute('draggable','true'); tr.classList.add('cursor-move','select-none'); tr.removeEventListener('dragstart', onDragStart); tr.addEventListener('dragstart', onDragStart); tr.removeEventListener('dragend', onDragEnd); tr.addEventListener('dragend', onDragEnd); }catch(_){ } });
        try{ tbody.removeEventListener('dragover', onDragOver); tbody.addEventListener('dragover', onDragOver); }catch(_){ }
        try{ tbody.removeEventListener('drop', onDrop); tbody.addEventListener('drop', onDrop); }catch(_){ }
      }catch(_){ }
    }
    // Flexible date parser supporting multiple formats
    function parseDateFlexible(v){
      if(!v) return null;
      const s = String(v).trim();
      // DD/MM/YYYY or DD-MM-YYYY or DD.MM.YYYY
      let m = s.match(/^(\d{1,2})[\/.\-](\d{1,2})[\/.\-](\d{2,4})(?:[ T](\d{1,2}):(\d{2})(?::(\d{2}))?)?/);
      if (m){
        const d = +m[1], mo = +m[2], y = m[3].length===2 ? +('20'+m[3]) : +m[3];
        const hh = m[4] ? +m[4] : 0, mm = m[5] ? +m[5] : 0, ss = m[6] ? +m[6] : 0;
        const dt = new Date(y, mo-1, d, hh, mm, ss);
        return isNaN(dt) ? null : dt;
      }
      // YYYY-MM-DD or YYYY/MM/DD
      m = s.match(/^(\d{4})[\/.\-](\d{1,2})[\/.\-](\d{1,2})(?:[ T](\d{1,2}):(\d{2})(?::(\d{2}))?)?/);
      if (m){
        const y = +m[1], mo = +m[2], d = +m[3];
        const hh = m[4] ? +m[4] : 0, mm = m[5] ? +m[5] : 0, ss = m[6] ? +m[6] : 0;
        const dt = new Date(y, mo-1, d, hh, mm, ss);
        return isNaN(dt) ? null : dt;
      }
      const dt = new Date(s);
      return isNaN(dt) ? null : dt;
    }

    // Form 1: fetch via webhook with query for headers/fields
    let F1_ALL_ROWS = [];
    let F1_PAGE = 1;
    let F1_SIZE = 20;
    // Cache bản rỗng đã chuẩn hoá cho Form 1 để lọc theo tháng với Done/Cancel
    let F1_LAST_ITEMS = [];
    function applyForm1Paging(){
      const body = document.getElementById('f1-body');
      const pager = document.getElementById('f1-pager');
      const total = F1_ALL_ROWS.length;
      if(total === 0){
        body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="17">Không có tác vụ</td></tr>';
        pager.style.display = 'none';
        return;
      }
      pager.style.display = '';
      const maxPage = Math.max(1, Math.ceil(total / F1_SIZE));
      if(F1_PAGE > maxPage) F1_PAGE = maxPage;
      const start = (F1_PAGE - 1) * F1_SIZE;
      const end = Math.min(total, start + F1_SIZE);
      const slice = F1_ALL_ROWS.slice(start, end);
      const pageInfo = document.getElementById('f1-page-info');
      if(pageInfo) pageInfo.textContent = `Trang ${F1_PAGE}/${maxPage} (${total} dòng)`;
      const prev = document.getElementById('f1-prev');
      const next = document.getElementById('f1-next');
      if(prev) prev.disabled = (F1_PAGE <= 1);
      if(next) next.disabled = (F1_PAGE >= maxPage);
      // render rows
      body.innerHTML = '';
      slice.forEach(tr => body.appendChild(tr));
    }

    function formatYyyyMmSafe(v){ try{ const d = toDateSafe(v); if(!d) return ''; const mm=String(d.getMonth()+1).padStart(2,'0'); return `${d.getFullYear()}-${mm}`; }catch(_){ return ''; } }

    function vnLower(s){
      try{ return String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase(); }catch(_){ return String(s||'').toLowerCase(); }
    }

    function applyForm1MonthFilter(){
      try{
        const monthEl = document.getElementById('f1-month');
        const monthVal = monthEl ? (monthEl.value||'').trim() : '';
        const items = Array.isArray(F1_LAST_ITEMS) ? F1_LAST_ITEMS.slice() : [];
        // Done & Cancel: lọc theo tháng (monthVal)
        let partDoneCancel = items.filter(it=> it.isDone || it.isCancel);
        if (monthVal) partDoneCancel = partDoneCancel.filter(it=> it.monthTagReq === monthVal);
        // Doing, Chờ phê duyệt, Chờ phân công, Test bền: luôn hiển thị không phụ thuộc thời gian
        let partTimeRestricted = items.filter(it=> {
          const s = it.statusNorm || '';
          return s.includes('doing') || s.includes('cho phe duyet') || s.includes('cho phan cong') || s.includes('test ben');
        });
        // Ưu tiên nhóm thời gian thực (Doing/Chờ phân công/Test bền) lên trước
        const filtered = partTimeRestricted.concat(partDoneCancel);
        // Render lại tbody và phân trang
        const body = document.getElementById('f1-body');
        const pager = document.getElementById('f1-pager');
        if (!filtered.length){
          if (body) body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="17">Không có tác vụ</td></tr>';
          if (pager) pager.style.display = 'none';
          F1_ALL_ROWS = [];
          return;
        }
        F1_ALL_ROWS = filtered.map(it=> it.rowEl).filter(Boolean);
        F1_PAGE = 1;
        applyForm1Paging();
      }catch(_){ }
    }

    // Render Form 1 từ mảng rows (dùng cho cache)
    function renderForm1FromRows(rows){
      const body = document.getElementById('f1-body');
      if(!rows || !rows.length){ body.innerHTML = "<tr><td colspan='17' class='px-3 py-3 text-center text-gray-500'>Không có tác vụ</td></tr>"; return; }
      const getV = (obj, keys)=>{
        const lower = Object.keys(obj||{}).reduce((acc,k)=>{ acc[k.toLowerCase()] = obj[k]; return acc; },{});
        for(const k of keys){ const v = lower[k.toLowerCase()]; if(v!==undefined) return v; }
        return '';
      };
      function getStatusRank(obj){
        const s = vnLower(getV(obj,['status','trangthai','trang_thai','trạng thái']) || '');
        if (s.includes('doing') || s.includes('dang')) return 0; // ưu tiên cao nhất
        if (s.includes('cho phan cong') || s.includes('test ben')) return 1; // nhóm thứ hai
        return 2; // còn lại
      }
      function getTimeValue(obj){
        const v = getV(obj,[
          'requestdate','ngayyeucau','ngay_yeu_cau','submissiondate','ngaygui','ngày yêu cầu'
        ]) || getV(obj,[
          'actualdue','handapung','han_dap_ung','completiondate','hạn đáp ứng'
        ]) || getV(obj,[
          'wishdue','hanmongmuon','han_mong_muon','desireddue','hạn mong muốn'
        ]);
        const d = parseDateFlexible(v);
        return d ? d.getTime() : 0;
      }
      const rowsSorted = rows.slice().sort((a,b)=>{
        const ra = getStatusRank(a), rb = getStatusRank(b);
        if (ra !== rb) return ra - rb;
        const ta = getTimeValue(a), tb = getTimeValue(b);
        return tb - ta; // mới nhất trước
      });
      F1_ALL_ROWS = [];
      F1_LAST_ITEMS = [];
      rowsSorted.forEach(item=>{
        const tr=document.createElement('tr');
        const tdBtn=document.createElement('td'); tdBtn.className='px-3 py-2';
        const code = getV(item,['code','ma','taskcode','mã']);
        const taskId = getV(item,['taskid','task_id','ma_tac_vu','mã tác vụ','taskcode2','requestid','id']);
        const tname = getV(item,['taskname','ten_tac_vu','ten','name','title','tên tác vụ']);
        const statusText = getV(item,['status','trangthai','trang_thai','trạng thái']);
        const statusLower = (statusText||'').toLowerCase();
        const isDone = statusLower.includes('hoàn') || statusLower.includes('done');
        const isCancelled = statusLower.includes('cancel') || statusLower.includes('hủy') || statusLower.includes('huỷ');
        const isPendingApproval = statusLower.includes('chờ phê duyệt') || statusLower.includes('cho phe duyet');
        const isEmptyStatus = statusLower.trim()==='';
        const isLocked = isDone || isCancelled || isPendingApproval || isEmptyStatus;
        const isDoing = statusLower.includes('doing') || statusLower.includes('đang');
        const wishDue = getV(item,['wishdue','hanmongmuon','han_mong_muon','desireddue','hạn mong muốn']);
        const actualDue = getV(item,['actualdue','handapung','han_dap_ung','completiondate','hạn đáp ứng']);
        const dueStr = actualDue || wishDue || '';
        const dueDate = parseDateFlexible(dueStr);
        if (isDoing && dueDate){
          const today = new Date();
          const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
          const dueDayStart = new Date(dueDate.getFullYear(), dueDate.getMonth(), dueDate.getDate());
          const isSameDay = dueDayStart.getTime() === todayStart.getTime();
          const isPast = dueDayStart.getTime() < todayStart.getTime();
          try { if (isSameDay) { tr.style.backgroundColor = '#fef3c7'; } else if (isPast) { tr.style.backgroundColor = '#fee2e2'; } } catch(_){}
        }
        const labelBtn = document.createElement('button');
        if (isLocked) {
          labelBtn.disabled = true;
          labelBtn.className = 'px-3 py-1 inline-block rounded-lg bg-gray-300 text-gray-500 cursor-not-allowed opacity-60';
          labelBtn.textContent = isCancelled ? 'Đã hủy' : (isDone ? 'Đã hoàn thành' : (isPendingApproval ? 'Chờ phê duyệt' : 'Không thể gửi'));
          labelBtn.title = labelBtn.textContent;
        } else {
          labelBtn.className = 'px-3 py-1 inline-block rounded-lg text-white bg-primary-blue hover:brightness-105 cursor-pointer';
          labelBtn.textContent = 'Trả báo cáo';
          labelBtn.onclick = (e)=>{ e.preventDefault(); if (labelBtn.disabled) return; labelBtn.disabled=true; labelBtn.classList.add('opacity-50','pointer-events-none'); lastOpenTrigger = labelBtn; const name=(document.getElementById('f1-name')?.value||'').trim(); openUploadModal({ form: 'Form 1', name, code, taskId, taskName: tname }); };
        }
        tdBtn.appendChild(labelBtn);
        tr.appendChild(tdBtn);
        const tdStatus=document.createElement('td'); tdStatus.className='px-3 py-2';
        const s=(statusText||'').toLowerCase();
        const badge=document.createElement('span');
        let badgeClass = 'bg-blue-100 text-blue-800';
        if (s.includes('chờ phê duyệt') || s.includes('cho phe duyet')) badgeClass = 'bg-orange-100 text-orange-800';
        else if (s.includes('hoàn') || s.includes('done')) badgeClass = 'bg-green-100 text-green-800';
        else if (s.includes('cancel') || s.includes('hủy') || s.includes('huỷ') || s.includes('chờ') || s.includes('pending')) badgeClass = 'bg-yellow-100 text-yellow-800';
        badge.className='px-2 py-1 rounded text-xs ' + badgeClass; badge.textContent=statusText||''; tdStatus.appendChild(badge); tr.appendChild(tdStatus);
        addTd(tr, code);
        addTd(tr, tname);
        addTd(tr, getV(item,['requester','nguoiyeucau','nguoi_yeu_cau','assigner','người yêu cầu']));
        addTd(tr, getV(item,['receiver','receivername','nguoinhanmau','nguoi_nhan_mau','người nhận mẫu','recipient','assignee','người nhận']));
        addTd(tr, getV(item,[ 'manhour','man_hour','congchuan','cong_chuan','workload','sogio','sogiocong','công chuẩn' ]));
        const requestDateStr = getV(item,['requestdate','ngayyeucau','ngay_yeu_cau','submissiondate','ngaygui','ngày yêu cầu']);
        addTd(tr, requestDateStr);
        addTd(tr, getV(item,['wishdue','hanmongmuon','han_mong_muon','desireddue','hạn mong muốn']));
        addTd(tr, getV(item,['actualdue','handapung','han_dap_ung','completiondate','hạn đáp ứng']));
        addTd(tr, getV(item,['purpose','mucdich','muc_dich','mục đích đánh giá','muc dich danh gia','mucdichdanhgia']));
        addTd(tr, getV(item,['note','ghi_chu','ghichu']));
        addTd(tr, getV(item,['specialtest','yeucau_test_dac_biet','yeu_cau_test_dac_biet']));
        addTd(tr, getV(item,['reportform','form_bao_cao','form_bao_cao_danh_gia']));
        const attachmentName = getV(item,[ 'attachmentfilename','file_name','filename','tenfile','ten_file','tên file','tên file đính kèm','attachment','file' ]);
        addTd(tr, attachmentName);
        const tdDl = document.createElement('td'); tdDl.className='px-3 py-2';
        const url = getV(item,[ 'attachmenturl','attachment_url','fileurl','file_url','downloadurl','download_url','link','url' ]);
        if (url) { const a = document.createElement('a'); a.href = url; a.target = '_blank'; a.rel = 'noopener'; a.className = 'px-3 py-1 inline-block rounded-lg text-white bg-primary-blue hover:brightness-105'; a.textContent = 'Tải về'; tdDl.appendChild(a); }
        else { const btn = document.createElement('button'); btn.disabled = true; btn.className = 'px-3 py-1 inline-block rounded-lg bg-gray-300 text-gray-500 cursor-not-allowed opacity-60'; btn.textContent = 'Không có link'; tdDl.appendChild(btn); }
        tr.appendChild(tdDl);
        addTd(tr, taskId);
        F1_ALL_ROWS.push(tr);
        const statusNorm = vnLower(statusText);
        const monthTagReq = formatYyyyMmSafe(requestDateStr);
        F1_LAST_ITEMS.push({ rowEl: tr, statusNorm, monthTagReq, requestDateRaw: requestDateStr, isDone, isCancel: isCancelled });
      });
      applyForm1Paging();
      try{ applyForm1MonthFilter(); }catch(_){ }
    }

    async function renderForm1(){
      const name = (document.getElementById('f1-name').value || '').trim();
      const body = document.getElementById('f1-body');
      if(!name){ body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="17">Vui lòng chọn tên</td></tr>'; return; }
      body.innerHTML = "<tr><td colspan='17' class='px-3 py-3 text-center text-gray-500'><span class='spinner mr-2'></span>Đang tải...</td></tr>";
      try{
          const headerMapF1 = {
          header_btn: 'Nút nhập gửi báo cáo',
          header_requester: 'Người yêu cầu',
          header_requestDate: 'Ngày yêu cầu',
          header_wishDue: 'Hạn mong muốn',
          header_actualDue: 'Hạn đáp ứng',
          header_code: 'Mã',
          header_taskId: 'Mã tác vụ',
          header_taskName: 'Tên tác vụ',
          header_receiverSample: 'Người nhận mẫu',
          header_manHour: 'Công chuẩn',
          header_purpose: 'Mục đích đánh giá',
          header_note: 'Note',
          header_specialTest: 'Yêu cầu test đặc biệt',
          header_reportForm: 'Form báo cáo đánh giá',
          header_status: 'Trạng thái',
          header_attachmentFileName: 'Tên file đính kèm',
          header_attachmentUrl: 'Tải đính kèm',
          field_requester: 'requester',
          field_requestDate: 'requestDate',
          field_wishDue: 'wishDue',
          field_actualDue: 'actualDue',
          field_code: 'code',
          field_taskId: 'taskId',
          field_taskName: 'taskName',
          field_receiverSample: 'receiverSample',
          field_manHour: 'manHour',
          field_purpose: 'purpose',
          field_note: 'note',
          field_specialTest: 'specialTest',
          field_reportForm: 'reportForm',
          field_status: 'status',
          field_attachmentFileName: 'attachmentFileName',
          field_attachmentUrl: 'attachmentUrl'
        };
        const params = new URLSearchParams({
          ...headerMapF1,
          action: 'form1_lookup',
          person_name: name,
          timestamp: new Date().toISOString()
        });
        const testUrl = `${WEBHOOK_URL}?${params.toString()}`;
        async function fetchJson(url){
          const r = await fetch(url, { method: 'GET' });
          const text = await r.text();
          if(!r.ok) throw new Error(text || `HTTP ${r.status}`);
          let parsed = null; try{ parsed = JSON.parse(text); }catch{ parsed = null; }
          return { parsed, raw: text };
        }
        let data = null; let firstErr = null;
        try{
          const { parsed, raw } = await fetchJson(testUrl);
          if (parsed && parsed.code === 0 && /could not be started/i.test(String(parsed.message||''))) {
            throw new Error('WEBHOOK_TEST_INACTIVE');
          }
          data = parsed ?? raw;
        } catch (e) {
          firstErr = e;
          // Fallback sang production webhook khi test webhook chưa bật lắng nghe
          const prodUrl = testUrl.replace('/webhook-test/', '/webhook/');
          const { parsed, raw } = await fetchJson(prodUrl);
          data = parsed ?? raw;
        }
        function pickRows(json){
          if (!json) return [];
          if (Array.isArray(json)) return json;
          const candidates = ['data','rows','result','records','items','list'];
          for (const k of candidates){ if (Array.isArray(json?.[k])) return json[k]; }
          // Deep search first array of objects
          try{
            const queue = [json];
            const seen = new Set();
            while(queue.length){
              const cur = queue.shift();
              if (!cur || typeof cur !== 'object' || seen.has(cur)) continue;
              seen.add(cur);
              for (const v of Object.values(cur)){
                if (Array.isArray(v) && v.length && typeof v[0] === 'object') return v;
                if (v && typeof v === 'object') queue.push(v);
              }
            }
          }catch(_){ }
          return [];
        }
        const rows = pickRows(data);
        if(!rows.length){ body.innerHTML = "<tr><td colspan='17' class='px-3 py-3 text-center text-gray-500'>Không có tác vụ</td></tr>"; return; }
        // Cache và timestamp
        try{ LS.setJSON('f1.cache', { name, rows }); LS.set('f1.lastUpdated', String(Date.now())); updateLastUpdatedNote('f1-search','f1.lastUpdated'); }catch(_){ }
        renderForm1FromRows(rows);
      }catch(err){
        body.innerHTML = `<tr><td colspan='17' class='px-3 py-3 text-center text-red-600'>Lỗi tải dữ liệu: ${String(err.message||err)}</td></tr>`;
      }
    }
    document.getElementById('f1-name').onchange = ()=>{};
    // Tự khởi tạo từ cache nếu có
    (function initF1FromCache(){
      try{
        const cached = LS.getJSON('f1.cache');
        const cachedName = LS.get('f1.selectedName')||'';
        if (!cached || !cached.rows || !cachedName) return;
        const sel = document.getElementById('f1-name');
        if (sel && (!sel.value)) sel.value = cachedName;
        renderForm1FromRows(cached.rows);
        updateLastUpdatedNote('f1-search','f1.lastUpdated');
      }catch(_){ }
    })();
    const f1SearchBtn = document.getElementById('f1-search');
    if (f1SearchBtn) {
      let f1Busy = false;
      f1SearchBtn.onclick = async (e)=>{
        e.preventDefault();
        if (f1Busy) return;
        f1Busy = true;
        f1SearchBtn.disabled = true;
        const prev = f1SearchBtn.textContent;
        f1SearchBtn.innerHTML = "<span class='spinner mr-2'></span>Đang tải...";
        try { await renderForm1(); }
        finally {
          f1Busy = false;
          f1SearchBtn.disabled = false;
          f1SearchBtn.textContent = prev;
        }
      };
    }
    // Pagination events
    const f1Prev = document.getElementById('f1-prev');
    const f1Next = document.getElementById('f1-next');
    const f1Size = document.getElementById('f1-size');
    if (f1Prev) f1Prev.onclick = (e)=>{ e.preventDefault(); if(F1_PAGE>1){ F1_PAGE--; applyForm1Paging(); } };
    if (f1Next) f1Next.onclick = (e)=>{ e.preventDefault(); F1_PAGE++; applyForm1Paging(); };
    if (f1Size) f1Size.onchange = (e)=>{ F1_SIZE = parseInt(e.target.value||'20',10)||20; F1_PAGE=1; applyForm1Paging(); };
    // Default month and change handler for Form 1 filter (Done/Cancel)
    (function initF1Month(){
      const m = document.getElementById('f1-month');
      if (!m) return;
      const d = new Date();
      const yy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      if (!m.value) m.value = `${yy}-${mm}`;
      if (!m._bound){ m.addEventListener('change', ()=> applyForm1MonthFilter()); m._bound = true; }
    })();

    // Helper: ưu tiên chọn Mã tác vụ theo tiền tố QA.Y/QA.NB
    function pickTaskIdPreferQA(taskId, code){
      try{
        const s1 = String(taskId||'').trim();
        const s2 = String(code||'').trim();
        const re = /^QA\.(?:Y|NB)\./i;
        const has1 = re.test(s1);
        const has2 = re.test(s2);
        if (has1 && has2) return s1;
        if (has1) return s1;
        if (has2) return s2;
        return s1 || s2 || '';
      }catch(_){ return String(taskId||code||'').trim(); }
    }

    // Form 2 rendering
    async function renderForm2(){
      const name = (document.getElementById('f2-name').value || '').trim();
      const body = document.getElementById('f2-body');
      if(!name){ body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="6">Vui lòng chọn tên</td></tr>'; return; }
      body.innerHTML = "<tr><td colspan='6' class='px-3 py-3 text-center text-gray-500'><span class='spinner mr-2'></span>Đang tải...</td></tr>";
      try{
        const headerMapF2 = {
          header_taskId: 'Mã tác vụ',
          header_requestDate: 'Ngày yêu cầu',
          header_wishDue: 'Hạn mong muốn',
          header_actualDue: 'Hạn đáp ứng',
          header_code: 'Mã',
          header_taskName: 'Tên tác vụ',
          field_taskId: 'taskId',
          field_requestDate: 'requestDate',
          field_wishDue: 'wishDue',
          field_actualDue: 'actualDue',
          field_code: 'code',
          field_taskName: 'taskName'
        };
        const params = new URLSearchParams({
          ...headerMapF2,
          action: 'form2_lookup',
          person_name: name,
          timestamp: new Date().toISOString()
        });
        const url = `${FORM2_LOOKUP_URL}?${params.toString()}`;
        const resp = await fetch(url, { method: 'GET' });
        const text = await resp.text();
        if(!resp.ok) throw new Error(text || `HTTP ${resp.status}`);
        let data = null; try{ data = JSON.parse(text);}catch{ data = null; }
        function pickRows(json){
          if (!json) return [];
          if (Array.isArray(json)) return json;
          const candidates = ['data','rows','result','records','items','list'];
          for (const k of candidates){ if (Array.isArray(json?.[k])) return json[k]; }
          try{
            const queue=[json]; const seen=new Set();
            while(queue.length){ const cur=queue.shift(); if(!cur||typeof cur!=='object'||seen.has(cur)) continue; seen.add(cur); for(const v of Object.values(cur)){ if(Array.isArray(v)&&v.length&&typeof v[0]==='object') return v; if(v&&typeof v==='object') queue.push(v);} }
          }catch(_){ }
          return [];
        }
        const rows = pickRows(data);
        if(!rows.length){ body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="6">Không có tác vụ.</td></tr>'; return; }
        const getV = (obj, keys)=>{
          const lower = Object.keys(obj||{}).reduce((acc,k)=>{ acc[k.toLowerCase()] = obj[k]; return acc; },{});
          for(const k of keys){ const v = lower[k.toLowerCase()]; if(v!==undefined) return v; }
          return '';
        };
        // Cache và timestamp
        try{ LS.setJSON('f2.cache', { name, rows }); LS.set('f2.lastUpdated', String(Date.now())); updateLastUpdatedNote('f2-search','f2.lastUpdated'); }catch(_){ }
        body.innerHTML='';
        rows.forEach(item=>{
          const tr=document.createElement('tr');
          const taskId = getV(item,['taskid','task_id','ma_tac_vu','mã tác vụ','requestid','id']);
          const requestDate = getV(item,['requestdate','ngayyeucau','ngay_yeu_cau','submissiondate','ngaygui','ngày yêu cầu']);
          const wishDue = getV(item,['wishdue','hanmongmuon','han_mong_muon','desireddue','hạn mong muốn']);
          const actualDue = getV(item,['actualdue','handapung','han_dap_ung','completiondate','hạn đáp ứng']);
          const code = getV(item,['code','ma','taskcode','mã']);
          const taskName = getV(item,['taskname','ten_tac_vu','ten','name','title','tên tác vụ']);
          const taskIdBest = pickTaskIdPreferQA(taskId, code);
          const rowData = { taskId: taskIdBest, requestDate, wishDue, actualDue, code, taskName };
          addTd(tr, taskIdBest);
          addTd(tr, requestDate);
          addTd(tr, wishDue);
          addTd(tr, actualDue);
          addTd(tr, code);
          addTd(tr, taskName);
          const tdBtn=document.createElement('td'); tdBtn.className='px-3 py-2';
          const btn=document.createElement('button'); btn.className='px-3 py-1 rounded-lg text-white bg-primary-blue hover:brightness-105'; btn.textContent='Trả form báo cáo';
          btn.onclick=(e)=>{
            e.preventDefault();
            if (btn.disabled) return;
            btn.disabled = true;
            btn.classList.add('opacity-50','pointer-events-none');
            lastOpenTrigger = btn;
            openUploadModal({form:'Form 2', name, code, taskId: taskIdBest, taskName, rowData});
          };
          tdBtn.appendChild(btn); tr.appendChild(tdBtn);
          body.appendChild(tr);
        });
      }catch(err){
        body.innerHTML = `<tr><td colspan='6' class='px-3 py-3 text-center text-red-600'>Lỗi tải dữ liệu: ${String(err.message||err)}</td></tr>`;
      }
    }
    document.getElementById('f2-name').onchange = ()=>{};
    // Hiển thị từ cache Form 2 nếu có
    (function initF2FromCache(){
      try{
        const cached = LS.getJSON('f2.cache');
        const name = LS.get('f2.selectedName')||'';
        if (!cached || !Array.isArray(cached.rows) || !name) return;
        const body = document.getElementById('f2-body');
        if (!body) return;
        body.innerHTML='';
        const rows = cached.rows;
        const getV = (obj, keys)=>{ const lower = Object.keys(obj||{}).reduce((acc,k)=>{ acc[k.toLowerCase()] = obj[k]; return acc; },{}); for(const k of keys){ const v = lower[k.toLowerCase()]; if(v!==undefined) return v; } return ''; };
        rows.forEach(item=>{
          const tr=document.createElement('tr');
          const taskId = getV(item,['taskid','task_id','ma_tac_vu','mã tác vụ','requestid','id']);
          const requestDate = getV(item,['requestdate','ngayyeucau','ngay_yeu_cau','submissiondate','ngaygui','ngày yêu cầu']);
          const wishDue = getV(item,['wishdue','hanmongmuon','han_mong_muon','desireddue','hạn mong muốn']);
          const actualDue = getV(item,['actualdue','handapung','han_dap_ung','completiondate','hạn đáp ứng']);
          const code = getV(item,['code','ma','taskcode','mã']);
          const taskName = getV(item,['taskname','ten_tac_vu','ten','name','title','tên tác vụ']);
          const taskIdBest = pickTaskIdPreferQA(taskId, code);
          const rowData = { taskId: taskIdBest, requestDate, wishDue, actualDue, code, taskName };
          addTd(tr, taskIdBest);
          addTd(tr, requestDate);
          addTd(tr, wishDue);
          addTd(tr, actualDue);
          addTd(tr, code);
          addTd(tr, taskName);
          const tdBtn=document.createElement('td'); tdBtn.className='px-3 py-2';
          const btn=document.createElement('button'); btn.className='px-3 py-1 rounded-lg text-white bg-primary-blue hover:brightness-105'; btn.textContent='Trả form báo cáo';
          btn.onclick=(e)=>{ e.preventDefault(); if (btn.disabled) return; btn.disabled = true; btn.classList.add('opacity-50','pointer-events-none'); lastOpenTrigger = btn; openUploadModal({form:'Form 2', name, code, taskId: taskIdBest, taskName, rowData}); };
          tdBtn.appendChild(btn); tr.appendChild(tdBtn);
          body.appendChild(tr);
        });
        updateLastUpdatedNote('f2-search','f2.lastUpdated');
      }catch(_){ }
    })();
    const f2SearchBtn = document.getElementById('f2-search');
    if (f2SearchBtn) {
      let f2Busy = false;
      f2SearchBtn.onclick = async (e)=>{
        e.preventDefault();
        if (f2Busy) return;
        f2Busy = true;
        f2SearchBtn.disabled = true;
        const prev = f2SearchBtn.textContent;
        f2SearchBtn.innerHTML = "<span class='spinner mr-2'></span>Đang tải...";
        try { await renderForm2(); }
        finally {
          f2Busy = false;
          f2SearchBtn.disabled = false;
          f2SearchBtn.textContent = prev;
        }
      };
    }
    // Clear button removed per request

    // Form 3 logic
    function setRqTime(){ const d=new Date(); const el=document.getElementById('rq-time'); if (el) el.value = formatDdMmYyyyHHmm(d); }
    setRqTime();
    // Default Form 4 month = current month
    (function setDefaultF4Month(){
      const m = document.getElementById('f4-month');
      if (!m) return;
      const d = new Date();
      const yy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      if (!m.value) m.value = `${yy}-${mm}`;
    })();
    // Helper: set default date for Form 5 inputs
    function setF5DateDefault(){
      const el = document.getElementById('f5-date');
      if (!el) return;
      const d = new Date();
      const pad = n=>String(n).padStart(2,'0');
      el.value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }

    // Form 3: preview selected file (send with form later via webhook)
    (function setupForm3UploadPreview(){
      const fileInput = document.getElementById('attach');
      const list = document.getElementById('f3-upload-list');
      if (!fileInput || !list) return;
      list.innerHTML = '';
      function renderPreview(file){
        const row = document.createElement('div');
        row.className = "flex items-center justify-between p-2 bg-blue-50 rounded";
        row.innerHTML = `<span>📄<span class="ml-2">${file.name}</span></span><span class="text-xs text-blue-700">Sẽ gửi kèm khi giao việc</span>`;
        list.innerHTML = '';
        list.appendChild(row);
      }
      fileInput.addEventListener('change', function(){
        list.innerHTML = '';
        if (!this.files || this.files.length === 0) return;
        renderPreview(this.files[0]);
      });
    })();

    // Submit Form 3 via webhook endpoint (multipart form-data)
    document.getElementById('assign-form').onsubmit = async (e)=>{
      e.preventDefault();
      const requester = document.getElementById('rq-by').value.trim();
      const requesterEmail = (document.getElementById('rq-by-email')?.value || '').trim();
      const taskName = (document.getElementById('task-name')?.value || '').trim();
      const rqTime = document.getElementById('rq-time').value;
      const manHourRaw = document.getElementById('man-hour').value;
      const output = document.getElementById('output').value.trim();
      const assignee = (document.getElementById('f3-assignee').value || '').trim();
      const deadline = document.getElementById('deadline').value;
      const odooJira = document.getElementById('odoo-jira').value.trim();

      if(!requester || !taskName || !output || !manHourRaw || !assignee){ showToast('Vui lòng điền đủ trường bắt buộc.','error'); return; }
      if(!/^\d+(\.\d{1,2})?$/.test(manHourRaw)){ showToast('Công chuẩn tối đa 2 chữ số thập phân.','error'); return; }

      const btn = e.target.querySelector('button[type="submit"]');
      const prev = btn ? btn.textContent : '';
      if (btn) { btn.disabled = true; btn.innerHTML = "<span class='spinner mr-2'></span>Đang gửi..."; }

      // Generate Reqcode: QA.NB.DDMM-XXXXXX (X: A-Z0-9)
      const Reqcode = (function(){
        const d = new Date();
        const pad = (n)=> String(n).padStart(2,'0');
        const ddmm = pad(d.getDate()) + pad(d.getMonth()+1);
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let rand = '';
        for (let i = 0; i < 6; i++) rand += chars[Math.floor(Math.random()*chars.length)];
        return `QA.NB.${ddmm}-${rand}`;
      })();

      const mapped = {
        requesterName: requester,
        requesterEmail: requesterEmail,
        requestDate: formatDdMmYyyyHHmm(rqTime || new Date()),
        itemName: taskName,
        Score: String(manHourRaw || '').trim(),
        changeReq: output,
        Assignee: assignee,
        desiredDate: deadline ? formatDdMmYyyy(deadline) : '',
        Odoojira: odooJira,
        deptRequest: 'DQA',
        Reqcode: Reqcode
      };

      const fd = new FormData();
      Object.entries(mapped).forEach(([k,v])=> fd.append(k, v));
      // Also append explicitly for form-data pipelines
      try { fd.append('Reqcode', mapped.Reqcode || ''); } catch(_){ }
      const fileEl = document.getElementById('attach');
      if (fileEl && fileEl.files && fileEl.files.length){
        const f = fileEl.files[0];
        try { fd.append('file', f, f.name); } catch(_){ fd.append('file', f); }
      }

      try{
        let resp = await fetch(FORM3_ENDPOINT, { method: 'POST', body: fd });
        if (!resp.ok) {
          // Fallback: send JSON
          const r2 = await fetch(FORM3_ENDPOINT, { method:'POST', headers:{'Content-Type':'application/json','Accept':'application/json'}, body: JSON.stringify({ data: [mapped] }) });
          if (!r2.ok) {
            const t = await r2.text();
            throw new Error(t || `HTTP ${r2.status}`);
          }
        }
        showToast('Đã giao việc và gửi dữ liệu.','success');
        e.target.reset();
        setRqTime();
        try{ const list = document.getElementById('f3-upload-list'); if (list) list.innerHTML = ''; }catch(_){ }
      }catch(err){
        console.error(err);
        showToast('Gửi thất bại.','error');
      }finally{
        if (btn) { btn.disabled = false; btn.textContent = prev || 'Giao việc'; }
      }
    };

    // ===== Form 4: filter popover & selection =====
    let F4_SELECTED_NAMES = new Set();
    let F4_ALL_NAMES = [];
    let F4_SUPPRESS_LOADING = false;

    // Form 4: cache dữ liệu để lọc client-side (không refetch khi bấm nút nhóm)
    let F4_LAST_NORMALIZED = [];
    let F4_LAST_MERGED = [];
    let F4_COUNTS_BY_NAME = new Map();
    let F4_LAST_PARAMS = { status: '', from: '', to: '', month: '' };

    // Predefined groups for Form 4 filters
    // Loại bỏ: Hà Mỹ Linh, Đỗ Thế Cường, Lê Thị Thanh Nhàn
    const F4_EXCLUDED = new Set(["Hà Mỹ Linh","Đỗ Thế Cường","Lê Thị Thanh Nhàn"]);
    const F4_GROUP_LINH = [
      "Bùi Đặng Quốc Huy","Nguyễn Hữu Thịnh","Trần Hiếu Nghĩa","Lại Quốc Lộc",
      "Lê Ngọc Ánh","Lê Văn Sơn","Nguyễn Thị Hiền","Phạm Thị Minh"
    ];
    const F4_GROUP_HIEU = [
      "Đỗ Quang Long","Phạm Thành Trung Kiên","Thái Thị Giang",
      "Vũ Thị Hằng","Đào Tuấn Kỳ","Lê Thị Thảo","Vũ Thị Thanh Hiền"
    ];
    function f4SetGroupSelection(names){
      if (!names || names.length === 0) {
        F4_SELECTED_NAMES.clear();
      } else {
        F4_SELECTED_NAMES = new Set(names);
      }
      // Lọc cục bộ từ cache, không gọi server
      renderForm4Local();
      try { renderF4Pivot(); } catch(_) {}
    }
    function f4UpdateGroupButtonsUI(){
      const btnAll = document.getElementById('f4-btn-all');
      const btnLinh = document.getElementById('f4-btn-linh');
      const btnHieu = document.getElementById('f4-btn-hieu');
      const reset = (btn)=>{ if(!btn) return; btn.classList.remove('bg-primary-blue','text-white'); btn.classList.add('bg-blue-50/30','text-primary-blue'); };
      const active = (btn)=>{ if(!btn) return; btn.classList.add('bg-primary-blue','text-white'); btn.classList.remove('bg-blue-50/30','text-primary-blue'); };
      reset(btnAll); reset(btnLinh); reset(btnHieu);
      const setEq = (a,b)=>{ if(a.size!==b.size) return false; for(const v of a){ if(!b.has(v)) return false; } return true; };
      const setLinh = new Set(F4_GROUP_LINH);
      const setHieu = new Set(F4_GROUP_HIEU);
      if (F4_SELECTED_NAMES.size === 0) active(btnAll);
      else if (setEq(F4_SELECTED_NAMES, setLinh)) active(btnLinh);
      else if (setEq(F4_SELECTED_NAMES, setHieu)) active(btnHieu);
    }

    function f4BuildFilterList(names){
      const list = document.getElementById('f4-filter-list');
      if (!list) return;
      list.innerHTML = '';
      const uniq = Array.from(new Set(names)).sort((a,b)=> a.localeCompare(b,'vi'));
      uniq.forEach(n=>{
        const safe = n.replace(/"/g,'&quot;');
        const checked = (F4_SELECTED_NAMES.size===0) || F4_SELECTED_NAMES.has(n);
        const row = document.createElement('label');
        row.className = 'flex items-center gap-2';
        row.setAttribute('data-name', n);
        row.innerHTML = `<input type="checkbox" value="${safe}" class="f4-filter-item h-4 w-4" ${checked?'checked':''}/><span>${safe}</span>`;
        list.appendChild(row);
      });
    }
    function f4SyncSelectionFromUI(){
      const list = document.getElementById('f4-filter-list');
      if (!list) return;
      const boxes = list.querySelectorAll('input.f4-filter-item');
      const picked = [];
      boxes.forEach(b=>{ if (b.checked) picked.push(b.value); });
      if (picked.length === boxes.length || picked.length === 0) {
        F4_SELECTED_NAMES.clear();
      } else {
        F4_SELECTED_NAMES = new Set(picked);
      }
    }
    (function f4InitFilterPopover(){
      const btn = document.getElementById('f4-filter-toggle');
      const pop = document.getElementById('f4-filter-pop');
      const list = document.getElementById('f4-filter-list');
      const search = document.getElementById('f4-filter-search');
      const selAll = document.getElementById('f4-filter-select-all');
      const clear = document.getElementById('f4-filter-clear');
      const applyBtn = document.getElementById('f4-filter-apply');
      if (!btn || !pop) return;
      btn.addEventListener('click', (e)=>{ e.preventDefault(); pop.classList.toggle('hidden'); if(!pop.classList.contains('hidden')){ try{ search&&search.focus(); }catch(_){} }});
      document.addEventListener('click', (e)=>{ if (!pop || pop.classList.contains('hidden')) return; if (btn.contains(e.target) || pop.contains(e.target)) return; pop.classList.add('hidden'); });
      if (list) list.addEventListener('change', (e)=>{ /* không auto render khi tick */ });
      if (search) search.addEventListener('input', (e)=>{
        const q = (e.target.value||'').toLowerCase().trim();
        pop.querySelectorAll('label[data-name]').forEach(el=>{
          const nm = (el.getAttribute('data-name')||'').toLowerCase();
          el.style.display = nm.includes(q) ? '' : 'none';
        });
      });
      if (selAll) selAll.addEventListener('click',(e)=>{ e.preventDefault(); pop.querySelectorAll('input.f4-filter-item').forEach(cb=> cb.checked=true); });
      if (clear) clear.addEventListener('click',(e)=>{ e.preventDefault(); pop.querySelectorAll('input.f4-filter-item').forEach(cb=> cb.checked=false); });
      if (applyBtn) applyBtn.addEventListener('click',(e)=>{ e.preventDefault(); f4SyncSelectionFromUI(); pop.classList.add('hidden'); renderForm4(); f4SchedulePivot(); f4UpdateGroupButtonsUI(); });
    })();

    // Helper: đếm số tác vụ theo người với filter trạng thái
    async function f4FetchTaskCount(name, statusVal, fromVal, toVal){
      const headerMapF1 = {
        header_code: 'Mã',
        header_taskName: 'Tên tác vụ',
        header_status: 'Trạng thái',
        field_code: 'code',
        field_taskName: 'taskName',
        field_status: 'status'
      };
      const params = new URLSearchParams({
        ...headerMapF1,
        action: 'form1_lookup',
        person_name: name,
        timestamp: new Date().toISOString()
      });
      if (fromVal) params.append('from', fromVal);
      if (toVal) params.append('to', toVal);
      async function fetchJson(url){
        const r = await fetch(url, { method: 'GET' });
        const text = await r.text();
        let parsed = null; try{ parsed = JSON.parse(text); }catch{ parsed = null; }
        return { ok: r.ok, parsed, raw: text, status: r.status };
      }
      function pickRows(json){
        if (!json) return [];
        if (Array.isArray(json)) return json;
        const candidates = ['data','rows','result','records','items','list'];
        for (const k of candidates){ if (Array.isArray(json?.[k])) return json[k]; }
        try{
          const queue=[json]; const seen=new Set();
          while(queue.length){
            const cur=queue.shift(); if(!cur||typeof cur!=='object'||seen.has(cur)) continue; seen.add(cur);
            for (const v of Object.values(cur)){
              if (Array.isArray(v) && v.length && typeof v[0]==='object') return v;
              if (v && typeof v==='object') queue.push(v);
            }
          }
        }catch(_){}
        return [];
      }
      function getV(obj, keys){
        const lower = Object.keys(obj||{}).reduce((acc,k)=>{ acc[k.toLowerCase()] = obj[k]; return acc; },{});
        for(const k of keys){ const v = lower[k.toLowerCase()]; if(v!==undefined) return v; }
        return '';
      }
      try{
        const testUrl = `${WEBHOOK_URL}?${params.toString()}`;
        let first = await fetchJson(testUrl);
        if (!first.ok || (first.parsed && first.parsed.code === 0 && /could not be started/i.test(String(first.parsed.message||'')))){
          const prodUrl = testUrl.replace('/webhook-test/', '/webhook/');
          first = await fetchJson(prodUrl);
        }
        if (!first.ok) return 0;
        let rows = pickRows(first.parsed ?? (first.raw ? JSON.parse(first.raw) : null));
        if (statusVal === 'Doing'){
          rows = rows.filter(item=>{
            const s = String(getV(item,['status','trangthai','trang_thai','trạng thái'])||'').toLowerCase();
            return s.includes('doing') || s.includes('đang');
          });
        }
        return rows.length;
      }catch(_){ return 0; }
    }

    // Form 4 logic: GET Doing data and render two columns
    async function renderForm4(){
      const body = document.getElementById('f4-body');
      const bodyAll = document.getElementById('f4-body-all');
      const chartWrap = document.getElementById('f4-chart-container');
      if (!F4_SUPPRESS_LOADING){
        if (chartWrap) chartWrap.style.display = 'none';
        if (F4_CHART) { try { F4_CHART.destroy(); } catch(_) {} F4_CHART = null; }
      }
      const statusSelEl = document.getElementById('f4-status');
      const statusValPreview = statusSelEl ? statusSelEl.value : 'Doing';
      const colSpan = (statusValPreview === 'All') ? 10 : 3;
      if (!F4_SUPPRESS_LOADING){
        body.innerHTML = `<tr><td colspan='${colSpan}' class='px-3 py-3 text-center text-gray-500'><span class='spinner mr-2'></span>Đang tải...</td></tr>`;
      }
      try{
        const urlTest = 'https://iatzhxxuk.tino.page/webhook/9cdcf54b-f98f-42b8-ab15-824d5b6da050';
        const urlProd = urlTest.replace('/webhook-test/', '/webhook/');
        const params = new URLSearchParams();
        const statusEl = document.getElementById('f4-status');
        const statusVal = (statusEl && statusEl.value) ? statusEl.value : 'Doing';
        params.append('status', statusVal);
        // Date range filter -> from month
        const monthInput = document.getElementById('f4-month');
        const monthVal = (monthInput && monthInput.value) ? monthInput.value : '';
        let fromVal = '';
        let toVal = '';
        if (monthVal) {
          try{
            const [yy, mm] = monthVal.split('-');
            const firstDay = `${yy}-${mm}-01`;
            const lastDate = new Date(Number(yy), Number(mm), 0).getDate();
            const lastDay = `${yy}-${mm}-${String(lastDate).padStart(2,'0')}`;
            fromVal = firstDay; toVal = lastDay;
          }catch(_){ }
        }
        if (fromVal) params.append('from', fromVal);
        if (toVal) params.append('to', toVal);
        // Query mapping for 2 output columns
        params.append('header_employee', 'Nhân viên');
        params.append('header_current_manhour', 'Công chuẩn hiện tại');
        params.append('field_employee', 'employee');
        params.append('field_current_manhour', 'manhour');
        params.append('header_task_count', 'Số tác vụ trong tháng');
        params.append('field_task_count', 'taskCount');
        params.append('_ts', Date.now().toString());
        // Debug: log the exact URL being requested
        try { console.log('Form4 GET (test):', `${urlTest}?${params.toString()}`); } catch(_) {}

        async function fetchJson(url){
          const r = await fetch(url, { method: 'GET' });
          const text = await r.text();
          let parsed = null; try { parsed = JSON.parse(text); } catch { parsed = null; }
          return { ok: r.ok, ct: r.headers.get('content-type')||'', parsed, raw: text, status: r.status };
        }

        let first = await fetchJson(`${urlTest}?${params.toString()}`);
        // Fallback to production webhook if test not active or server error like n8n "Can't determine which item to use"
        if (!first.ok || /could not be started/i.test(String(first.parsed?.message||'')) || /Can't determine which item to use|Can't determine which item to use/i.test(first.raw||'')){
          try { console.warn('Form4 GET fallback -> prod'); } catch(_){ }
          first = await fetchJson(`${urlProd}?${params.toString()}`);
        }
        if(!first.ok){
          throw new Error(first.raw || `HTTP ${first.status}`);
        }
        const data = Array.isArray(first.parsed) || first.parsed ? first.parsed : (first.raw ? JSON.parse(first.raw) : null);
        function pickRowsDeep(json){
          if (!json) return [];
          if (Array.isArray(json) && json.length && typeof json[0] === 'object') return json;
          const candidates = ['data','rows','result','records','items','list'];
          for (const k of candidates){ if (Array.isArray(json?.[k]) && json[k].length && typeof json[k][0] === 'object') return json[k]; }
          try{
            const queue=[json]; const seen=new Set();
            while(queue.length){
              const cur = queue.shift();
              if (!cur || typeof cur !== 'object' || seen.has(cur)) continue;
              seen.add(cur);
              for (const v of Object.values(cur)){
                if (Array.isArray(v) && v.length && typeof v[0] === 'object') return v;
                if (v && typeof v === 'object') queue.push(v);
              }
            }
          }catch(_){ }
          return [];
        }
        const rows = pickRowsDeep(data);
        try{ LS.setJSON('f4.cache', { params: { status: statusVal, from: fromVal, to: toVal, month: monthVal }, rows, ts: Date.now() }); LS.set('f4.lastUpdated', String(Date.now())); }catch(_){ }
        if(!rows.length){ body.innerHTML = "<tr><td colspan='3' class='px-3 py-3 text-center text-gray-500'>Không có dữ liệu</td></tr>"; if(chartWrap) chartWrap.style.display='none'; return; }
        const getV = (obj, keys)=>{
          const lower = Object.keys(obj||{}).reduce((acc,k)=>{ acc[k.toLowerCase()] = obj[k]; return acc; },{});
          for(const k of keys){ const v = lower[k.toLowerCase()]; if(v!==undefined) return v; }
          return '';
        };
        const normalized = rows.map(r=>{
          const name = getV(r,[
            'field_employee','employee','employee_name','nhanvien','nhan_vien','nhân viên','họ tên','ho_ten','user','name',
            'assignee','assignee_name','pic','nguoi_phu_trach','người phụ trách','người nhận','receiver','recipient'
          ]).toString().trim();
          const manRaw = getV(r,[
            'field_current_manhour','manhour','manhour_current','current_manhour','current_manhours','man_hours','man_hour',
            'congchuan','cong_chuan','công chuẩn hiện tại','công chuẩn nhận','công chuẩn tổng tháng','cong_chuan_thang','hours','score'
          ]);
          const man = Number(manRaw);
          const countRaw = getV(r,[
            'field_task_count','taskcount','task_count','count','sotacvu','so_tac_vu','số tác vụ','số tác vụ trong tháng',
            'so_tac_vu_thang','sotacvu_thang','tasks','total_tasks','task_total','so_luong','so_luong_tac_vu','so_dau_muc',
            'so_doing','doing_count','count_doing','so_luong_doing','in_month_count','count_in_month'
          ]);
          const count = Number(countRaw);
          return { name: name || '-', manhour: isNaN(man) ? 0 : man, count: isNaN(count) ? null : count };
        }).filter(x=>x.name && x.name !== '-');
        // Bổ sung mọi nhân sự từ danh sách chuẩn để không bị thiếu tên (vd: "Hà Mỹ Linh")
        const baseNames = Array.isArray(FORM1_NAMES) ? FORM1_NAMES.filter(n=> !F4_EXCLUDED.has(n)) : [];
        const unionNamesRaw = Array.from(new Set([ ...normalized.map(x=>x.name), ...baseNames ]));
        const unionNames = unionNamesRaw.filter(n=> !F4_EXCLUDED.has(n));
        const merged = unionNames.map(n=>{
          const exist = normalized.find(x=>x.name===n);
          return exist ? exist : { name: n, manhour: 0, count: null };
        });
        // Lưu cache để phục vụ lọc cục bộ không cần refetch
        F4_LAST_NORMALIZED = normalized.slice();
        F4_LAST_MERGED = merged.slice();
        F4_LAST_PARAMS = { status: statusVal, from: fromVal, to: toVal, month: monthVal };
        F4_COUNTS_BY_NAME = new Map();
        // Cập nhật danh sách người trong popover
        F4_ALL_NAMES = unionNames;
        f4BuildFilterList(F4_ALL_NAMES);
        // Lọc theo các tên đã chọn (Set rỗng = tất cả)
        const selectedNames = Array.from(F4_SELECTED_NAMES);
        const filtered = selectedNames.length ? merged.filter(x => F4_SELECTED_NAMES.has(x.name)) : merged;
        if (!filtered.length) { body.innerHTML = "<tr><td colspan='3' class='px-3 py-3 text-center text-gray-500'>Không có dữ liệu</td></tr>"; if(chartWrap) chartWrap.style.display='none'; return; }
        const normalizedSorted = filtered.slice().sort((a,b)=> b.manhour - a.manhour);
        // Nếu trạng thái là All, mở rộng cột theo yêu cầu và lấy dữ liệu server
        const isAll = (statusVal === 'All');
        async function fetchStatsFor(name){
          try{
            const qs = new URLSearchParams();
            qs.append('action','form4_employee_stats');
            qs.append('employee', name);
            if (fromVal) qs.append('from', fromVal);
            if (toVal) qs.append('to', toVal);
            const r = await fetch(`${urlTest}?${qs.toString()}`);
            const t = await r.text();
            let j = null; try{ j = JSON.parse(t); }catch{}
            const obj = (j && typeof j==='object') ? j : {};
            const getN = (k)=>{ const v = obj[k]; const n = Number(v); return isNaN(n)?0:n; };
            const done = getN('done');
            const ahead = getN('ahead');
            const ontime = getN('ontime');
            const late = getN('late');
            const rateOntime = getN('rate_ontime');
            const rateLate = getN('rate_late');
            const rateAhead = getN('rate_ahead');
            return { done, ahead, ontime, late, rateOntime, rateLate, rateAhead };
          }catch(_){ return { done:0,ahead:0,ontime:0,late:0,rateOntime:0,rateLate:0,rateAhead:0 }; }
        }
        // Cập nhật header động theo chế độ
        (function updateHeader(){
          const headRow = document.getElementById('f4-head-row');
          if (!headRow) return;
          const isAll = (statusVal === 'All');
          try {
            const mainTable = document.getElementById('f4-main-table');
            if (mainTable) {
              if (isAll) {
                mainTable.classList.add('min-w-[1100px]');
                mainTable.classList.remove('min-w-[480px]');
              } else {
                mainTable.classList.add('min-w-[480px]');
                mainTable.classList.remove('min-w-[1100px]');
              }
            }
          } catch(_) {}
          headRow.innerHTML = `
            <th class="px-3 py-2 relative">
              <button id="f4-filter-toggle" class="inline-flex items-center gap-1 hover:text-primary-blue">Nhân viên <span class="text-xs">▾</span></button>
              <div id="f4-filter-pop" class="absolute z-20 mt-2 left-0 w-72 bg-white border border-gray-200 rounded-lg shadow-lg p-3 hidden">
                <div class="flex items-center gap-2 mb-2">
                  <input id="f4-filter-search" type="text" placeholder="Tìm người..." class="flex-1 border border-blue-300 rounded bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
                </div>
                <div class="flex items-center justify-between text-xs text-gray-600 mb-2">
                  <div class="flex items-center gap-3">
                    <button id="f4-filter-select-all" class="underline">Chọn tất cả</button>
                    <button id="f4-filter-clear" class="underline">Bỏ chọn</button>
                  </div>
                  <button id="f4-filter-apply" class="px-2 py-1 rounded bg-primary-blue text-white text-xs">Lọc</button>
                </div>
                <div id="f4-filter-list" class="max-h-60 overflow-auto space-y-1 text-sm">
                  <label class="flex items-center gap-2" data-name="(Chỗ trống)"><input type="checkbox" value="(Chỗ trống)" class="f4-filter-item h-4 w-4"/><span>(Chỗ trống)</span></label>
                </div>
              </div>
            </th>
            <th class="px-3 py-2">Công chuẩn hiện tại</th>
            <th class="px-3 py-2">Số tác vụ</th>
            ${isAll ? `
              <th class="px-3 py-2">Số DONE</th>
              <th class="px-3 py-2">Vượt tiến độ</th>
              <th class="px-3 py-2">Đúng tiến độ</th>
              <th class="px-3 py-2">Chậm tiến độ</th>
              <th class="px-3 py-2">Tỷ lệ vượt (%)</th>
              <th class="px-3 py-2">Tỷ lệ đúng (%)</th>
              <th class="px-3 py-2">Tỷ lệ chậm (%)</th>
            `: ''}`;
          // re-bind filter popover events
          try { f4InitFilterPopover(); } catch(_) {}
        })();

        const html = await (async ()=>{
          const rowsHtml = [];
          for (const x of normalizedSorted){
            if (!isAll){
              rowsHtml.push(`
                <tr>
             <td class="px-3 py-2">
               <button class="text-primary-blue hover:underline" data-emp="${x.name}">${x.name}</button>
             </td>
             <td class="px-3 py-2">${x.manhour.toFixed(2)}</td>
             <td class="px-3 py-2"><span class="emp-count" data-emp-count="${x.name}">${(x.count==null)?'<span class="spinner"></span>':String(x.count)}</span></td>
                </tr>`);
              continue;
            }
            const st = await fetchStatsFor(x.name);
            rowsHtml.push(`
              <tr>
                <td class="px-3 py-2">${x.name}</td>
                <td class="px-3 py-2">${x.manhour.toFixed(2)}</td>
                <td class="px-3 py-2">${(x.count==null)?'':String(x.count)}</td>
                <td class="px-3 py-2">${(st.done ?? '')}</td>
                <td class="px-3 py-2">${(st.ahead ?? '')}</td>
                <td class="px-3 py-2">${(st.ontime ?? '')}</td>
                <td class="px-3 py-2">${(st.late ?? '')}</td>
                <td class="px-3 py-2">${isNaN(st.rateOntime)?'':(st.rateOntime.toFixed(0)+"%")}</td>
                <td class="px-3 py-2">${isNaN(st.rateLate)?'':(st.rateLate.toFixed(0)+"%")}</td>
                <td class="px-3 py-2">${isNaN(st.rateAhead)?'':(st.rateAhead.toFixed(0)+"%")}</td>
              </tr>`);
          }
          return rowsHtml.join('');
        })();
        if (isAll) {
          if (bodyAll) { bodyAll.innerHTML = html; try{ enableTableDrag('f4-body-all'); }catch(_){ } }
        } else {
        body.innerHTML = html; try{ enableTableDrag('f4-body'); }catch(_){ }
        // Điền số tác vụ bất đồng bộ theo trạng thái hiện tại
        const statusForCount = statusVal;
        const names = normalizedSorted.filter(x=> x.count == null && !F4_COUNTS_BY_NAME.has(x.name)).map(x=>x.name);
        const findCountEl = (n)=>{
          const all = body.querySelectorAll('.emp-count');
          for (const el of all){ if ((el.getAttribute('data-emp-count')||'') === n) return el; }
          return null;
        };
        const promises = names.map(async n=>{
          const c = await f4FetchTaskCount(n, statusForCount, fromVal, toVal);
          const el = findCountEl(n);
          if (el) {
            el.textContent = String(c);
            try { const tr = el.closest('tr'); if (tr) tr.setAttribute('data-task-count', String(c)); } catch(_) {}
          }
          try { F4_COUNTS_BY_NAME.set(n, c); } catch(_) {}
        });
        Promise.allSettled(promises).then(()=>{ try { f4ApplyCountFilter(); } catch(_) {} }).catch(()=>{});
        }
        // Render bar chart
        const labels = normalizedSorted.map(x=> x.name);
        const values = normalizedSorted.map(x=> x.manhour);
        if (chartWrap) chartWrap.style.display = '';
        const canvas = document.getElementById('f4-chart');
        if (canvas && typeof Chart !== 'undefined'){
          const ctx = canvas.getContext('2d');
          if (F4_CHART) { try { F4_CHART.destroy(); } catch(_) {} }
          F4_CHART = new Chart(ctx, {
            type: 'bar',
            data: {
              labels,
              datasets: [{
                label: 'Công chuẩn nhận',
                data: values,
                backgroundColor: 'rgba(90, 169, 255, 0.6)',
                borderColor: '#5aa9ff',
                borderWidth: 1,
                hoverBackgroundColor: 'rgba(59, 130, 246, 0.7)'
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                y: {
                  beginAtZero: true,
                  title: { display: true, text: 'Công chuẩn nhận' }
                },
                x: {
                  title: { display: true, text: 'Nhân viên' },
                  ticks: { autoSkip: false, maxRotation: 45, minRotation: 0 }
                }
              },
              plugins: {
                legend: { display: false },
                tooltip: {
                  callbacks: {
                    label: (ctx)=> ` ${Number(ctx.raw).toFixed(2)}`
                  }
                }
              }
            }
          });
        }
      }catch(err){
        body.innerHTML = `<tr><td colspan='3' class='px-3 py-3 text-center text-red-600'>Lỗi tải dữ liệu: ${String(err.message || err)}</td></tr>`;
        if (chartWrap) chartWrap.style.display = 'none';
        if (F4_CHART) { try { F4_CHART.destroy(); } catch(_) {} F4_CHART = null; }
      }
    }
    function restoreForm4FromCache(){
      try{
        const cached = LS.getJSON('f4.cache');
        if (!cached || !Array.isArray(cached.rows) || !cached.rows.length) return false;
        // kích hoạt UI cơ bản và ghi chú thời gian
        updateLastUpdatedNote('f4-search','f4.lastUpdated');
        // Dùng pipeline render hiện tại: gán rows vào F4_LAST_MERGED để re-render nhanh
        const rows = cached.rows;
        const getV = (obj, keys)=>{ const lower = Object.keys(obj||{}).reduce((a,k)=>{ a[k.toLowerCase()] = obj[k]; return a; },{}); for(const k of keys){ const v = lower[k.toLowerCase()]; if(v!==undefined) return v; } return ''; };
        const normalized = rows.map(r=>({
          name: getV(r,['employee','employee_name','nhanvien','nhân viên','name','assignee','pic']) || '-',
          manhour: Number(getV(r,['manhour','current_manhour','congchuan']))||0,
          count: null
        })).filter(x=>x.name && x.name!=='-');
        F4_LAST_MERGED = normalized;
        renderForm4Local();
        return true;
      }catch(_){ return false; }
    }
    // Render lại Form 4 từ cache khi đổi nhóm (lọc client-side, không refetch)
    function renderForm4Local(){
      try{
        const body = document.getElementById('f4-body');
        const chartWrap = document.getElementById('f4-chart-container');
        if (chartWrap) chartWrap.style.display = 'none';
        if (F4_CHART) { try { F4_CHART.destroy(); } catch(_) {} F4_CHART = null; }
        if (!Array.isArray(F4_LAST_MERGED) || F4_LAST_MERGED.length===0){
          // Chưa có cache -> tải một lần
          return renderForm4();
        }
        const selected = Array.from(F4_SELECTED_NAMES);
        const filtered = selected.length ? F4_LAST_MERGED.filter(x=> F4_SELECTED_NAMES.has(x.name)) : F4_LAST_MERGED.slice();
        if (!filtered.length){ body.innerHTML = "<tr><td colspan='3' class='px-3 py-3 text-center text-gray-500'>Không có dữ liệu</td></tr>"; return; }
        const normalizedSorted = filtered.slice().sort((a,b)=> b.manhour - a.manhour);
        const rowsHtml = [];
        for (const x of normalizedSorted){
          const cached = F4_COUNTS_BY_NAME.get(x.name);
          const baseCnt = (x.count==null) ? cached : x.count;
          const cntText = (baseCnt==null || Number.isNaN(baseCnt)) ? "<span class='spinner'></span>" : String(baseCnt);
          rowsHtml.push(`
            <tr>
              <td class="px-3 py-2">
                <button class="text-primary-blue hover:underline" data-emp="${x.name}">${x.name}</button>
              </td>
              <td class="px-3 py-2">${x.manhour.toFixed(2)}</td>
              <td class="px-3 py-2"><span class="emp-count" data-emp-count="${x.name}">${cntText}</span></td>
            </tr>`);
        }
        body.innerHTML = rowsHtml.join('');
        try{ enableTableDrag('f4-body'); }catch(_){ }
        // Bổ sung: tải số tác vụ bất đồng bộ cho các tên chưa có
        const statusForCount = (F4_LAST_PARAMS && F4_LAST_PARAMS.status) ? F4_LAST_PARAMS.status : 'Doing';
        const fromVal = F4_LAST_PARAMS?.from || '';
        const toVal = F4_LAST_PARAMS?.to || '';
        const namesNeed = normalizedSorted.filter(x=> (x.count==null) && !F4_COUNTS_BY_NAME.has(x.name)).map(x=> x.name);
        const findCountEl = (n)=>{ const all = body.querySelectorAll('.emp-count'); for (const el of all){ if ((el.getAttribute('data-emp-count')||'') === n) return el; } return null; };
        const promises = namesNeed.map(async n=>{ const c = await f4FetchTaskCount(n, statusForCount, fromVal, toVal); const el = findCountEl(n); if (el) { el.textContent = String(c); try { const tr = el.closest('tr'); if (tr) tr.setAttribute('data-task-count', String(c)); } catch(_) {} } try { F4_COUNTS_BY_NAME.set(n, c); } catch(_) {} });
        Promise.allSettled(promises).then(()=>{ try { f4ApplyCountFilter(); } catch(_) {} }).catch(()=>{});
        // Vẽ chart theo dữ liệu đã lọc
        const labels = normalizedSorted.map(x=> x.name);
        const values = normalizedSorted.map(x=> x.manhour);
        if (chartWrap) chartWrap.style.display = '';
        const canvas = document.getElementById('f4-chart');
        if (canvas && typeof Chart !== 'undefined'){
          const ctx = canvas.getContext('2d');
          if (F4_CHART) { try { F4_CHART.destroy(); } catch(_) {} }
          F4_CHART = new Chart(ctx, {
            type: 'bar',
            data: { labels, datasets: [{ label: 'Công chuẩn nhận', data: values, backgroundColor: 'rgba(90, 169, 255, 0.6)', borderColor: '#5aa9ff', borderWidth: 1, hoverBackgroundColor: 'rgba(59, 130, 246, 0.7)' }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, title: { display: true, text: 'Công chuẩn nhận' } }, x: { title: { display: true, text: 'Nhân viên' }, ticks: { autoSkip: false, maxRotation: 45, minRotation: 0 } } }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: (ctx)=> ` ${Number(ctx.raw).toFixed(2)}` } } } }
          });
        }
        try { f4ApplyCountFilter(); } catch(_) {}
      }catch(_){}
    }
    // ===== Form 4: Modal chi tiết theo nhân viên =====
    const detailModal = document.getElementById('detail-modal');
    const detailBody = document.getElementById('detail-body');
    const detailNameEl = document.getElementById('detail-name');
    const detailNote = document.getElementById('detail-note');
    const detailClose = document.getElementById('detail-close');

    function openDetailModal(empName, filter, from, to){
      if (!detailModal) return;
      detailNameEl.textContent = empName || '';
      detailBody.innerHTML = `<tr><td colspan="9" class="px-3 py-3 text-center text-gray-500"><span class="spinner mr-2"></span>Đang tải...</td></tr>`;
      detailNote.textContent = filter === 'Doing' ? 'Chỉ hiển thị tác vụ đang Doing.' : 'Hiển thị tất cả tác vụ.';
      detailModal.classList.add('open');
      detailModal.setAttribute('aria-hidden','false');
      try{
        const isForm5Visible = (function(){
          try{
            const sec5 = document.getElementById('form5');
            return sec5 && !sec5.classList.contains('hidden');
          }catch(_){ return false; }
        })();
        if (isForm5Visible && Array.isArray(F5A_RAW_ALL) && F5A_RAW_ALL.length){
          renderDetailTasksFromF5All(empName, from, to).catch(()=> renderDetailTasks(empName, filter, from, to));
          return;
        }
      }catch(_){ }
      renderDetailTasks(empName, filter, from, to).catch(()=>{});
    }
    function closeDetailModal(){
      if (!detailModal) return;
      detailModal.classList.remove('open');
      detailModal.setAttribute('aria-hidden','true');
    }
    if (detailClose) detailClose.onclick = closeDetailModal;
    if (detailModal) detailModal.addEventListener('click', (e)=>{ if(e.target===detailModal) closeDetailModal(); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && detailModal && detailModal.classList.contains('open')) closeDetailModal(); });

    // Renderer dùng đúng nguồn dữ liệu của Form 5 và thuật toán lọc "Công chuẩn đã nhận"
    async function renderDetailTasksFromF5All(name, from, to){
      try{
        if (!Array.isArray(F5A_RAW_ALL) || !F5A_RAW_ALL.length){
          try{
            const monthGuess = (from || '').slice(0,7);
            await f5aFetchAllOnce(monthGuess || '', from || '', to || '');
          }catch(_){ }
        }
        const rows = Array.isArray(F5A_RAW_ALL) ? F5A_RAW_ALL : [];
        function hasVal(v){ return v != null && String(v).trim() !== ''; }
        const assigneeKeys = ['Assignee','Phụ trách','Người phụ trách','Người xử lý','employee','nhanvien','nhan_vien','nhân viên','user','name','receiver','recipient','pic','nguoi_phu_trach','người phụ trách'];
        const taskNameKeys = ['Task Name','Tên tác vụ','Task','Công việc','Tên Task','Mã','taskname','ten_tac_vu','ten','title'];
        const scoreKeys = ['Điểm','Score','score'];
        const altScoreKeys = ['Công chuẩn công việc nhận ','Công chuẩn công việc nhận','Công chuẩn','manhour','man_hour','current_manhour','congchuan','cong_chuan','hours'];
        const statusKeys = ['Hiện trạng','Trạng thái','Status','status','trangthai','trang_thai','trạng thái'];
        const statusByWishKeys = ['Hiện trạng theo hạn mong muốn','hien trang theo han mong muon','Hiện trạng theo hạn mong muon','status_by_wish','statusbywish','statusWish','status_wish','ht_theo_han_mong_muon'];
        const finishedDateKs = ['Ngày hoàn thành thực tế','Ngày hoàn thành','Ngày đóng','completiondate','completeddate','ngayhoanthanh','ngay_hoan_thanh'];
        function norm(s){ return String(s||'').trim(); }
        function getV(obj, keys){
          const lower = {};
          Object.keys(obj||{}).forEach(k=>{ const v=obj[k]; const k1=String(k).toLowerCase(); const k2=String(k).toLowerCase().replace(/\s+/g,' ').trim(); lower[k1]=v; lower[k2]=v; });
          for (const k of keys){ const c1=String(k).toLowerCase(); const c2=String(k).toLowerCase().replace(/\s+/g,' ').trim(); const v = lower[c1] ?? lower[c2]; if (v!==undefined) return v; }
          return '';
        }
        function toNum(v){ try{ let s=String(v||'').trim(); if(!s) return 0; s=s.replace(/\s|\u00A0/g,''); s=s.replace(/[%₫đvnd]/gi,''); if (s.includes(',')) s=s.replace(/\./g,'').replace(',', '.'); else s=s.replace(/\./g,''); const n=Number(s); return Number.isFinite(n)?n:0; }catch(_){ return 0; } }
        function isCanceled(o){ const f = String(getV(o, finishedDateKs)||'').toLowerCase(); const st = String(getV(o, statusKeys)||'').toLowerCase(); return f.includes('cancel') || st.includes('cancel') || st.includes('hủy') || st.includes('huỷ'); }
        function pickName(o){ let n = norm(getV(o, assigneeKeys)); if (!n || n.toLowerCase()==='nan') n = 'Chưa phân công'; return n; }
        function chooseRefDate(o){
          const rq = getV(o,['requestdate','ngayyeucau','ngay_yeu_cau','submissiondate','ngaygui','📆 ngày yêu cầu']);
          const act = getV(o,['actualdue','handapung','han_dap_ung','completiondate']);
          const wish= getV(o,['wishdue','hanmongmuon','han_mong_muon','desireddue']);
          const done= getV(o, finishedDateKs);
          return hasVal(rq) ? rq : (hasVal(act) ? act : (hasVal(wish) ? wish : (hasVal(done) ? done : '')));
        }
        function inRangeDate(ref){
          if (!hasVal(from) && !hasVal(to)) return true;
          const d = parseDateFlexible(ref);
          if (!d) return false;
          const ds = d.toISOString().slice(0,10);
          if (hasVal(from) && ds < from) return false;
          if (hasVal(to) && ds > to) return false;
          return true;
        }
        const list = [];
        rows.forEach(o=>{
          const tname = norm(getV(o, taskNameKeys));
          if (!tname) return;
          if (isCanceled(o)) return;
          const n = pickName(o);
          if (n !== name) return;
          const ref = chooseRefDate(o);
          if (!inRangeDate(ref)) return;
          const code = norm(getV(o,['code','ma','taskcode','mã']));
          const status = norm(getV(o, statusKeys));
          const man = toNum(getV(o, scoreKeys)) || toNum(getV(o, altScoreKeys));
          const rq = norm(getV(o,['requestdate','ngayyeucau','ngay_yeu_cau','submissiondate','ngaygui','ngày yêu cầu']));
          const wish = norm(getV(o,['wishdue','hanmongmuon','han_mong_muon','desireddue','hạn mong muốn']));
          const act = norm(getV(o,['actualdue','handapung','han_dap_ung','completiondate','hạn đáp ứng']));
          const done = norm(getV(o, finishedDateKs));
          // Số giờ đánh giá thực tế: cố gắng lấy từ các field thường gặp
          const actualHours = norm(getV(o,[ 'so gio danh gia thuc te','số giờ đánh giá thực tế','actualhours','actual_hours','hours_actual','gio_thuc_te','gio thuc te' ]));
          // Chuẩn hóa hiển thị (display only)
          const actualNum = toNum(actualHours);
          const actualHoursDisp = Number.isFinite(actualNum) ? formatNumberVi(actualNum, 2, 2) : (actualHours||'');
          const manDisp = formatNumberVi(Number(man)||0, 2, 2);
          const wishDisp = formatDdMmYyyy(wish);
          let wishPlus2Disp = '';
          try{
            const dW = parseDateFlexible(wish);
            if (dW){
              const plus2 = new Date(dW.getFullYear(), dW.getMonth(), dW.getDate() + 2);
              wishPlus2Disp = formatDdMmYyyy(plus2);
            }
          }catch(_){ }
          const doneDisp = formatDdMmYyyy(done);
          // Hiện trạng theo hạn mong muốn: ưu tiên lấy trực tiếp từ dữ liệu server
          let statusVsWish = norm(getV(o, statusByWishKeys));
          // Fallback nếu server không có cột này
          if (!statusVsWish){
            try{
              const dDone = parseDateFlexible(done);
              const dWish = parseDateFlexible(wish);
              if (dWish && dDone){
                const wishPlus2 = new Date(dWish.getFullYear(), dWish.getMonth(), dWish.getDate() + 2);
                statusVsWish = (dDone.getTime() <= wishPlus2.getTime()) ? 'Đúng hạn yêu cầu' : 'Trễ hạn yêu cầu';
              }
            }catch(_){ }
          }
          // Tính Trạng thái theo công chuẩn dựa trên so sánh số giờ thực tế và công chuẩn (chuẩn hoá dấu thập phân)
          let statusByMan = '';
          const actualIsZero = Number.isFinite(actualNum) && Math.abs(actualNum) < 1e-9;
          try{
            const actualNum = toNum(actualHours);
            const EPS = 1e-4;
            const hasDone = !!parseDateFlexible(done);
            if (actualIsZero) {
              statusByMan = 'Thiếu dữ liệu';
            } else if (hasDone && !isNaN(actualNum) && !isNaN(man)){
              if (actualNum > man + EPS) statusByMan = 'Chậm tiến độ';
              else if (Math.abs(actualNum - man) <= EPS) statusByMan = 'Đúng tiến độ';
              else statusByMan = 'Vượt tiến độ';
            }
          }catch(_){ }
          list.push({ code, tname, status, man, rq, wish, act, done, actualHours, statusVsWish, statusByMan, actualHoursDisp, manDisp, wishDisp, doneDisp, wishPlus2Disp, actualIsZero });
        });
        if (!list.length){
          const hasRange = Boolean((from||'').trim() || (to||'').trim());
          const msg = hasRange ? 'Không có tác vụ trong tháng đã chọn.' : 'Không có tác vụ.';
          detailBody.innerHTML = `<tr><td class="px-3 py-3 text-center text-gray-500" colspan="9">${msg}</td></tr>`;
          return;
        }
        let stt = 0;
        const html = list.map(it=>`
          <tr>
            <td class="px-3 py-2">${++stt}</td>
            <td class="px-3 py-2">${it.code}</td>
            <td class="px-3 py-2">${it.tname}</td>
            <td class="px-3 py-2${it.actualIsZero ? ' bg-amber-100 text-amber-800' : ''}">${it.actualHoursDisp||''}</td>
            <td class="px-3 py-2">${it.manDisp||''}</td>
            <td class="px-3 py-2">${(function(s){ const t=String(s||'').toLowerCase(); let cls='bg-blue-100 text-blue-800'; if(t.includes('thiếu dữ liệu')) cls='bg-amber-100 text-amber-800'; else if(t.includes('vượt tiến độ')) cls='bg-blue-100 text-blue-800'; else if(t.includes('đúng tiến độ')||t.includes('dung tien do')) cls='bg-green-100 text-green-800'; else if(t.includes('chậm tiến độ')||t.includes('cham tien do')) cls='bg-red-100 text-red-800'; else if(t.includes('chờ phê duyệt')||t.includes('cho phe duyet')) cls='bg-orange-100 text-orange-800'; else if(t.includes('cancel')||t.includes('hủy')||t.includes('huỷ')) cls='bg-gray-200 text-gray-700'; else if(t.includes('doing')||t.includes('đang')) cls='bg-blue-100 text-blue-800'; return `<span class=\"px-2 py-1 rounded text-xs ${cls}\">${s||''}</span>`; })(it.statusByMan || it.status)}</td>
            <td class="px-3 py-2">${it.wishDisp||it.wish||''}${it.wishPlus2Disp? `<div class=\"text-xs text-gray-500 mt-0.5\">Hạn +2: ${it.wishPlus2Disp}</div>`:''}</td>
            <td class="px-3 py-2">${it.doneDisp||it.done||''}</td>
            <td class="px-3 py-2">${(function(s){ s=String(s||''); const isOn = /đúng hạn yêu cầu/i.test(s); const isLate = /trễ hạn yêu cầu/i.test(s); if(isOn) return `<span class=\"px-2 py-1 rounded text-xs bg-green-100 text-green-800\">${s}</span>`; if(isLate) return `<span class=\"px-2 py-1 rounded text-xs bg-red-100 text-red-800\">${s}</span>`; return s; })(it.statusVsWish||'')}</td>
          </tr>
        `).join('');
        detailBody.innerHTML = html;
      }catch(_){
        detailBody.innerHTML = `<tr><td class="px-3 py-3 text-center text-red-600" colspan="8">Lỗi hiển thị dữ liệu.</td></tr>`;
      }
    }

    async function renderDetailTasks(name, filter, from, to){
      const headerMapF1 = {
        header_requester: 'Người yêu cầu',
        header_requestDate: 'Ngày yêu cầu',
        header_wishDue: 'Hạn mong muốn',
        header_actualDue: 'Hạn đáp ứng',
        header_code: 'Mã',
        header_taskName: 'Tên tác vụ',
        header_manHour: 'Công chuẩn',
        header_status: 'Trạng thái',
        field_requester: 'requester',
        field_requestDate: 'requestDate',
        field_wishDue: 'wishDue',
        field_actualDue: 'actualDue',
        field_code: 'code',
        field_taskName: 'taskName',
        field_manHour: 'manHour',
        field_status: 'status'
      };
      const params = new URLSearchParams({
        ...headerMapF1,
        action: 'form1_lookup',
        person_name: name,
        timestamp: new Date().toISOString()
      });
      // KHÔNG truyền from/to lên server để tránh lọc sai mốc (server có thể chỉ lọc theo Ngày yêu cầu);
      // Thay vào đó, lọc cục bộ theo tháng bằng logic refDate ở dưới để khớp với "Công chuẩn đã nhận".
      function getV(obj, keys){
        const lower = Object.keys(obj||{}).reduce((acc,k)=>{ acc[k.toLowerCase()] = obj[k]; return acc; },{});
        for(const k of keys){ const v = lower[k.toLowerCase()]; if(v!==undefined) return v; }
        return '';
      }
      async function fetchJson(url){
        const r = await fetch(url, { method: 'GET' });
        const text = await r.text();
        let parsed = null; try{ parsed = JSON.parse(text); }catch{ parsed = null; }
        return { ok: r.ok, parsed, raw: text, status: r.status };
      }
      try{
        const testUrl = `${WEBHOOK_URL}?${params.toString()}`;
        let first = await fetchJson(testUrl);
        if (!first.ok || (first.parsed && first.parsed.code === 0 && /could not be started/i.test(String(first.parsed.message||'')))){
          const prodUrl = testUrl.replace('/webhook-test/', '/webhook/');
          first = await fetchJson(prodUrl);
        }
        if (!first.ok) throw new Error(first.raw || `HTTP ${first.status}`);
        const data = first.parsed ?? (first.raw ? JSON.parse(first.raw) : null);
        function pickRows(json){
          if (!json) return [];
          if (Array.isArray(json)) return json;
          const candidates = ['data','rows','result','records','items','list'];
          for (const k of candidates){ if (Array.isArray(json?.[k])) return json[k]; }
          try{
            const queue=[json]; const seen=new Set();
            while(queue.length){
              const cur=queue.shift(); if(!cur||typeof cur!=='object'||seen.has(cur)) continue; seen.add(cur);
              for (const v of Object.values(cur)){
                if (Array.isArray(v) && v.length && typeof v[0]==='object') return v;
                if (v && typeof v==='object') queue.push(v);
              }
            }
          }catch(_){}
          return [];
        }
        let rows = pickRows(data);
        if (filter === 'Doing'){
          rows = rows.filter(item=>{
            const statusText = String(getV(item,['status','trangthai','trang_thai','trạng thái'])||'');
            const s = statusText.toLowerCase();
            const isDoing = s.includes('doing') || s.includes('đang');
            return isDoing;
          });
        }
        // Lọc cục bộ theo tháng dựa trên mốc tham chiếu refDate (requestDate -> actualDue -> wishDue -> doneDate), loại Cancel
        (function(){
          try{
            const fromVal = (from || '').trim();
            const toVal = (to || '').trim();
            function hasVal(v){ return v != null && String(v).trim() !== ''; }
            function getText(o, keys){
              const lower = Object.keys(o||{}).reduce((acc,k)=>{ acc[k.toLowerCase()] = o[k]; return acc; },{});
              for(const k of keys){ const v = lower[k.toLowerCase()]; if(v!==undefined) return String(v); }
              return '';
            }
            function isCanceledRow(o){
              const st = getText(o,['status','trangthai','trang_thai','trạng thái']).toLowerCase();
              const doneDate = getText(o,['completiondate','completeddate','ngayhoanthanh','ngay_hoan_thanh']);
              return st.includes('cancel') || st.includes('hủy') || st.includes('huỷ') || /cancel/i.test(doneDate||'');
            }
            function chooseRefDate(o){
              const rq = getText(o,['requestdate','ngayyeucau','ngay_yeu_cau','submissiondate','ngaygui','📆 ngày yêu cầu']);
              const act = getText(o,['actualdue','handapung','han_dap_ung','completiondate']);
              const wish= getText(o,['wishdue','hanmongmuon','han_mong_muon','desireddue']);
              const done= getText(o,['completiondate','completeddate','ngayhoanthanh','ngay_hoan_thanh']);
              return hasVal(rq) ? rq : (hasVal(act) ? act : (hasVal(wish) ? wish : (hasVal(done) ? done : '')));
            }
            if (fromVal || toVal){
              rows = rows.filter(o=>{
                if (isCanceledRow(o)) return false;
                const ref = chooseRefDate(o);
                const d = parseDateFlexible(ref);
                if (!d) return false;
                const ds = d.toISOString().slice(0,10);
                if (fromVal && ds < fromVal) return false;
                if (toVal && ds > toVal) return false;
                return true;
              });
            } else {
              rows = rows.filter(o=> !isCanceledRow(o));
            }
          }catch(_){ }
        })();
        if (!rows.length){
          const hasRange = Boolean((from||'').trim() || (to||'').trim());
          const msg = hasRange ? 'Không có tác vụ trong tháng đã chọn.' : `Không có tác vụ${filter==='Doing'?' Doing':''}.`;
          detailBody.innerHTML = `<tr><td class="px-3 py-3 text-center text-gray-500" colspan="9">${msg}</td></tr>`;
          return;
        }
        // Helper parse date (hỗ trợ YYYY-MM-DD, DD/MM/YYYY, DD-MM-YYYY, YYYY/MM/DD, có/không giờ)
        function toDate(v){
          if(!v) return null;
          const s = String(v).trim();
          let m = s.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})/);
          if (m) {
            const d = +m[1], mo = +m[2], y = m[3].length===2 ? +('20'+m[3]) : +m[3];
            const dt = new Date(y, mo-1, d); return isNaN(dt) ? null : dt;
          }
          m = s.match(/^(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})/);
          if (m) {
            const dt = new Date(+m[1], +m[2]-1, +m[3]); return isNaN(dt) ? null : dt;
          }
          const dt = new Date(s);
          return isNaN(dt) ? null : dt;
        }

        let stt = 0;
        const html = rows.map(item=>{
          const code = getV(item,['code','ma','taskcode','mã']);
          const tname = getV(item,['taskname','ten_tac_vu','ten','name','title','tên tác vụ']);
          const status = getV(item,['status','trangthai','trang_thai','trạng thái']);
          const man = getV(item,['manhour','man_hour','congchuan','cong_chuan','workload','sogio','sogiocong','công chuẩn']);
          const rq = getV(item,['📆 ngày yêu cầu','requestdate','ngayyeucau','ngay_yeu_cau','submissiondate','ngaygui','ngày yêu cầu']);
          const wish = getV(item,['wishdue','hanmongmuon','han_mong_muon','desireddue','hạn mong muốn']);
          const act = getV(item,['actualdue','handapung','han_dap_ung','completiondate','hạn đáp ứng']);
          const done = getV(item,['completiondate','completeddate','ngayhoanthanh','ngay_hoan_thanh','completion','done_date','ngày hoàn thành']);
          const actualHours = getV(item,[ 'so gio danh gia thuc te','số giờ đánh giá thực tế','actualhours','actual_hours','hours_actual','gio_thuc_te','gio thuc te' ]);
          // Hiển thị đồng nhất
          const manNum = parseNumberFlexible(man);
          const actualNum = parseNumberFlexible(actualHours);
          const manDisp = Number.isFinite(manNum) ? formatNumberVi(manNum, 2, 2) : String(man||'');
          const actualHoursDisp = Number.isFinite(actualNum) ? formatNumberVi(actualNum, 2, 2) : String(actualHours||'');
          const wishDisp = formatDdMmYyyy(wish);
          const doneDisp = formatDdMmYyyy(done);
          let wishPlus2Disp = '';
          try{
            const dW = toDate(wish);
            if (dW){
              const plus2 = new Date(dW.getFullYear(), dW.getMonth(), dW.getDate() + 2);
              wishPlus2Disp = formatDdMmYyyy(plus2);
            }
          }catch(_){ }
          // Tính Trạng thái theo công chuẩn bằng so sánh số giờ thực tế và công chuẩn (hỗ trợ dấu phẩy/dấu chấm)
          let statusByMan = '';
          try{
            const manNum = parseNumberFlexible(man);
            const actualNum = parseNumberFlexible(actualHours);
            const EPS = 1e-4;
            const hasDone = !!toDate(done);
            if (Number.isFinite(actualNum) && Math.abs(actualNum) < EPS) {
              statusByMan = 'Thiếu dữ liệu';
            } else if (hasDone && !isNaN(actualNum) && !isNaN(manNum)){
              if (actualNum > manNum + EPS) statusByMan = 'Chậm tiến độ';
              else if (Math.abs(actualNum - manNum) <= EPS) statusByMan = 'Đúng tiến độ';
              else statusByMan = 'Vượt tiến độ';
            }
          }catch(_){ }
          let statusVsWish = '';
          try{
            const dDone = toDate(done);
            const dWish = toDate(wish);
            if (dWish && dDone){
              const wishPlus2 = new Date(dWish.getFullYear(), dWish.getMonth(), dWish.getDate() + 2);
              statusVsWish = (dDone.getTime() <= wishPlus2.getTime()) ? 'Đúng hạn yêu cầu' : 'Trễ hạn yêu cầu';
            }
          }catch(_){ }

          // Late completed highlight (yellow)
          const dueForCompare = act || wish || '';
          const isLate = (()=>{ const d1 = toDate(done), d2 = toDate(dueForCompare); return d1 && d2 ? (d1.getTime() > d2.getTime()) : false; })();
          let trClass = isLate ? 'bg-yellow-100' : '';
          // Overdue doing highlight + today highlight (match Form 1)
          const sLower = (status||'').toLowerCase();
          const isDoing = sLower.includes('doing') || sLower.includes('đang');
          const dueDate = parseDateFlexible(dueForCompare);
          if (isDoing && dueDate){
            const today = new Date();
            const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            const dueDayStart = new Date(dueDate.getFullYear(), dueDate.getMonth(), dueDate.getDate());
            const isSameDay = dueDayStart.getTime() === todayStart.getTime();
            const isPast = dueDayStart.getTime() < todayStart.getTime();
            if (isSameDay) trClass = 'bg-yellow-100';
            else if (isPast) trClass = 'bg-red-100';
          }

          return `
            <tr class="${trClass}">
              <td class="px-3 py-2">${++stt}</td>
              <td class="px-3 py-2">${code}</td>
              <td class="px-3 py-2">${tname}</td>
              <td class="px-3 py-2${(function(n){ const EPS=1e-4; return (Number.isFinite(parseNumberFlexible(actualHours)) && Math.abs(parseNumberFlexible(actualHours))<EPS) ? ' bg-amber-100 text-amber-800' : ''; })()}">${actualHoursDisp}</td>
              <td class="px-3 py-2">${manDisp}</td>
              <td class="px-3 py-2">${(function(s){ const t=String(s||'').toLowerCase(); let cls='bg-blue-100 text-blue-800'; if(t.includes('thiếu dữ liệu')) cls='bg-amber-100 text-amber-800'; else if(t.includes('vượt tiến độ')) cls='bg-blue-100 text-blue-800'; else if(t.includes('đúng tiến độ')||t.includes('dung tien do')) cls='bg-green-100 text-green-800'; else if(t.includes('chậm tiến độ')||t.includes('cham tien do')) cls='bg-red-100 text-red-800'; else if(t.includes('chờ phê duyệt')||t.includes('cho phe duyet')) cls='bg-orange-100 text-orange-800'; else if(t.includes('cancel')||t.includes('hủy')||t.includes('huỷ')) cls='bg-gray-200 text-gray-700'; else if(t.includes('doing')||t.includes('đang')) cls='bg-blue-100 text-blue-800'; return `<span class=\"px-2 py-1 rounded text-xs ${cls}\">${s||''}</span>`; })(statusByMan || status)}</td>
              <td class="px-3 py-2">${wishDisp||wish||''}${wishPlus2Disp? `<div class=\"text-xs text-gray-500 mt-0.5\">Hạn +2: ${wishPlus2Disp}</div>`:''}</td>
              <td class="px-3 py-2">${doneDisp||done||''}</td>
              <td class="px-3 py-2">${(function(s){ s=String(s||''); const isOn = /đúng hạn yêu cầu/i.test(s); const isLate = /trễ hạn yêu cầu/i.test(s); if(isOn) return `<span class=\"px-2 py-1 rounded text-xs bg-green-100 text-green-800\">${s}</span>`; if(isLate) return `<span class=\"px-2 py-1 rounded text-xs bg-red-100 text-red-800\">${s}</span>`; return s; })(statusVsWish)}</td>
            </tr>
          `;
        }).join('');
        detailBody.innerHTML = html;
      }catch(err){
        detailBody.innerHTML = `<tr><td class="px-3 py-3 text-center text-red-600" colspan="9">Lỗi tải dữ liệu: ${String(err.message||err)}</td></tr>`;
      }
    }

    // Copy on click and open link for storage (Form 1)
    const f1StorageLink = document.getElementById('f1-storage-link');
    if (f1StorageLink) {
      f1StorageLink.addEventListener('click', async ()=>{
        const url = f1StorageLink.getAttribute('href') || '';
        try { await navigator.clipboard.writeText(url); showToast('Đã copy liên kết.','success'); }
        catch(_) { /* ignore copy error to not block open */ }
      });
    }
    // Trigger fetch only when nhấn Tra cứu ở Form 4
    const f4Btn = document.getElementById('f4-search');
    if (f4Btn) {
      f4Btn.addEventListener('click', (e)=>{ e.preventDefault(); renderForm4(); f4UpdateGroupButtonsUI(); });
    }
    // Pivot handlers
    (function initF4Pivot(){
      const refresh = document.getElementById('f4-pivot-refresh');
      if (refresh) refresh.addEventListener('click', (e)=>{ e.preventDefault(); F4_PIVOT_ROWS_ALL = []; renderF4Pivot(); });
      // auto render once when form loads
      try { renderF4Pivot(); } catch(_) {}
    })();

    // Render detailed list of overdue Doing tasks (mirrors Form 1 highlight)
    async function renderF4Pivot(){
      if (F4_PIVOT_BUSY) return;
      F4_PIVOT_BUSY = true;
      const body = document.getElementById('f4-pivot-body');
      const sumTotal = document.getElementById('f4-pivot-sum-total');
      const note = document.getElementById('f4-pivot-note');
      if (!body) return;
      body.innerHTML = `<tr><td colspan="7" class="px-3 py-3 text-center text-gray-500"><span class='spinner mr-2'></span>Đang tải...</td></tr>`;
      const fromVal = document.getElementById('f4-from')?.value || '';
      const toVal = document.getElementById('f4-to')?.value || '';
      const base = F4_ALL_NAMES && F4_ALL_NAMES.length ? F4_ALL_NAMES : (FORM1_NAMES || []);
      const names = base.filter(n=> !F4_EXCLUDED.has(n));
      const selected = Array.from(F4_SELECTED_NAMES);
      const targetNames = selected.length ? names.filter(n => F4_SELECTED_NAMES.has(n)) : names.slice();

      // Nếu cache chưa có hoặc phạm vi thời gian đổi -> tải và xây cache
      const needRefetch = (!Array.isArray(F4_PIVOT_ROWS_ALL) || !F4_PIVOT_ROWS_ALL.length
        || F4_PIVOT_LAST_PARAMS.from !== fromVal || F4_PIVOT_LAST_PARAMS.to !== toVal);

      if (needRefetch){
        F4_PIVOT_ROWS_ALL = [];
        F4_PIVOT_LAST_PARAMS = { from: fromVal, to: toVal };
        await Promise.all(names.map(async (name)=>{
          try{
            const headerMap = {
              header_requestDate: 'Ngày yêu cầu', header_wishDue: 'Hạn mong muốn', header_actualDue: 'Hạn đáp ứng',
              header_status: 'Trạng thái', header_code: 'Mã', header_taskName: 'Tên tác vụ',
              field_requestDate: 'requestDate', field_wishDue: 'wishDue', field_actualDue: 'actualDue',
              field_status: 'status', field_code: 'code', field_taskName: 'taskName'
            };
            const qs = new URLSearchParams({ ...headerMap, action:'form1_lookup', person_name: name, timestamp: new Date().toISOString() });
            if (fromVal) qs.append('from', fromVal);
            if (toVal) qs.append('to', toVal);
            const u = `${WEBHOOK_URL}?${qs.toString()}`;
            const r = await fetch(u);
            const t = await r.text();
            let json = null; try{ json = JSON.parse(t); }catch{ json = null; }
            let rows = [];
            if (Array.isArray(json)) rows = json; else if (json && typeof json==='object'){
              const keys = ['data','rows','result','records','items','list'];
              for (const k of keys){ if (Array.isArray(json[k])) { rows = json[k]; break; } }
            }
            function getV(o, keys){ const L = Object.keys(o||{}).reduce((a,k)=>{a[k.toLowerCase()]=o[k];return a;},{}); for(const k of keys){ const v=L[k.toLowerCase()]; if(v!==undefined) return v; } return ''; }
            rows.forEach(it=>{
              const statusText = String(getV(it,['status','trangthai','trang_thai','trạng thái'])||'');
              const s = statusText.toLowerCase();
              const isDoing = s.includes('doing') || s.includes('đang');
              if (!isDoing) return;
              const wish = getV(it,['wishdue','hanmongmuon','han_mong_muon','desireddue','hạn mong muốn']);
              const act = getV(it,['actualdue','handapung','han_dap_ung','completiondate','hạn đáp ứng']);
              const due = parseDateFlexible(act || wish || '');
              if (!due) return;
              const now = new Date();
              if (now.getTime() >= due.getTime()){
                F4_PIVOT_ROWS_ALL.push({
                  assignee: name,
                  code: getV(it,['code','ma','taskcode','mã']),
                  taskName: getV(it,['taskname','ten_tac_vu','ten','name','title','tên tác vụ']),
                  status: statusText,
                  requestDate: getV(it,['requestdate','ngayyeucau','ngay_yeu_cau','submissiondate','ngaygui','ngày yêu cầu']),
                  wishDue: wish,
                  actualDue: act
                });
              }
            });
          }catch(_){ /* skip one name */ }
        }));
      }

      // Lọc cục bộ từ cache theo nhóm đang chọn
      let rowsOut = F4_PIVOT_ROWS_ALL.filter(r => targetNames.includes(r.assignee));
      rowsOut.sort((a,b)=>{
        const byName = a.assignee.localeCompare(b.assignee,'vi');
        if (byName !== 0) return byName;
        const da = parseDateFlexible(a.actualDue || a.wishDue || '') || new Date(0);
        const db = parseDateFlexible(b.actualDue || b.wishDue || '') || new Date(0);
        return da.getTime() - db.getTime();
      });

      if (!rowsOut.length){
        body.innerHTML = `<tr><td colspan="7" class="px-3 py-3 text-center text-gray-500">Không có dữ liệu</td></tr>`;
      } else {
        const todayStart = (()=>{ const d=new Date(); return new Date(d.getFullYear(), d.getMonth(), d.getDate()); })();
        function toDate(v){ try{ return parseDateFlexible(v||''); }catch(_){ return null; } }
        body.innerHTML = rowsOut.map(r=>{
          const due = toDate(r.actualDue || r.wishDue || '');
          let trClass = 'bg-red-50';
          if (due){
            const dueStart = new Date(due.getFullYear(), due.getMonth(), due.getDate());
            if (dueStart.getTime() === todayStart.getTime()) trClass = 'bg-yellow-100';
            else if (dueStart.getTime() < todayStart.getTime()) trClass = 'bg-red-100';
          }
          return `<tr class="${trClass}">
          <td class="px-3 py-2">${r.assignee}</td>
          <td class="px-3 py-2">${r.code}</td>
          <td class="px-3 py-2">${r.taskName}</td>
          <td class="px-3 py-2">${r.status}</td>
          <td class="px-3 py-2">${r.requestDate}</td>
          <td class="px-3 py-2">${r.wishDue}</td>
          <td class="px-3 py-2">${r.actualDue}</td>
          </tr>`;
        }).join('');
        try{ enableTableDrag('f4-pivot-body'); }catch(_){ }
      }
      if (sumTotal) sumTotal.textContent = String(rowsOut.length);
      if (note) note.textContent = 'Danh sách tác vụ Doing bị quá hạn (cache cục bộ; nhấn Làm mới để tải lại)';
      F4_PIVOT_BUSY = false;
    }
    // Group filter buttons
    (function initF4GroupButtons(){
      const btnAll = document.getElementById('f4-btn-all');
      const btnLinh = document.getElementById('f4-btn-linh');
      const btnHieu = document.getElementById('f4-btn-hieu');
      if (btnAll) btnAll.addEventListener('click', (e)=>{ e.preventDefault(); f4SetGroupSelection([]); f4UpdateGroupButtonsUI(); f4SchedulePivot(); });
      if (btnLinh) btnLinh.addEventListener('click', (e)=>{ e.preventDefault(); f4SetGroupSelection(F4_GROUP_LINH); f4UpdateGroupButtonsUI(); f4SchedulePivot(); });
      if (btnHieu) btnHieu.addEventListener('click', (e)=>{ e.preventDefault(); f4SetGroupSelection(F4_GROUP_HIEU); f4UpdateGroupButtonsUI(); f4SchedulePivot(); });
      // set initial visual state
      f4UpdateGroupButtonsUI();
    })();
    // Trigger fetch only when nhấn Tra cứu ở Form 6 (ý tưởng)
    const f5Btn = document.getElementById('f5-search');
    if (f5Btn) {
      f5Btn.addEventListener('click', async (e)=>{
        e.preventDefault();
        if (f5Btn.disabled) return;
        const prev = f5Btn.textContent;
        f5Btn.disabled = true;
        f5Btn.innerHTML = "<span class='spinner mr-2'></span>Đang tải...";
        try { await renderForm5List(); }
        finally {
          f5Btn.disabled = false;
          f5Btn.textContent = prev || 'Tra cứu';
        }
      });
    }
    // Default month and change handler for Form 6 filtering
    (function initF6MonthFilter(){
      const m = document.getElementById('f6-month');
      if (!m) return;
      const d = new Date();
      const yy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      if (!m.value) m.value = `${yy}-${mm}`;
      // on change, re-apply local filter if data already loaded
      if (!m._bound){
        m.addEventListener('change', ()=>{
          try{
            if (Array.isArray(F6_LAST_ROWS) && F6_LAST_ROWS.length) {
              if (typeof applyForm6LocalFilter === 'function') applyForm6LocalFilter();
              else renderForm5List();
            }
          }catch(_){ }
        });
        m._bound = true;
      }
    })();
    // Trigger fetch for Form 5 (All tasks)
    const f5aBtn = document.getElementById('f5a-search');
    if (f5aBtn) { f5aBtn.addEventListener('click', async (e)=>{ e.preventDefault(); try{ await renderForm5All(); }catch(_){ } }); }
    // Auto render once when Form 5 first shows
    try {
      setTimeout(()=>{ try{ renderForm5All(); }catch(_){ } }, 300);
      // Rebind khi user thay đổi chế độ biểu đồ để tránh mất handler sau khi chuyển form
      const modeSel = document.getElementById('f5a-mode');
      if (modeSel && !modeSel._bound){
        modeSel.addEventListener('change', ()=>{ try{ renderForm5All(); }catch(_){ } });
        modeSel._bound = true;
      }
      const refreshBtn = document.getElementById('f5a-refresh');
      if (refreshBtn && !refreshBtn._bound){
        refreshBtn.addEventListener('click', (e)=>{ e.preventDefault(); try{ renderForm5All(); }catch(_){ } });
        refreshBtn._bound = true;
      }
    } catch(_) {}
    // Tự động render khi đổi trạng thái
    const f4StatusHidden = document.getElementById('f4-status');
    if (f4StatusHidden) f4StatusHidden.value = 'Doing';
    const f4FromInput = document.getElementById('f4-from');
    const f4ToInput = document.getElementById('f4-to');
    if (f4FromInput) f4FromInput.addEventListener('change', ()=>{ renderForm4(); f4SchedulePivot(); });
    if (f4ToInput) f4ToInput.addEventListener('change', ()=>{ renderForm4(); f4SchedulePivot(); });
    const f4CountFilterInput = document.getElementById('f4-count-filter');
    if (f4CountFilterInput) f4CountFilterInput.addEventListener('input', ()=> f4ApplyCountFilter());
    const f4PeopleSel2 = document.getElementById('f4-people');
    if (f4PeopleSel2) f4PeopleSel2.addEventListener('change', ()=> renderForm4());
    // Click tên nhân viên để xem chi tiết
    const f4Body = document.getElementById('f4-body');
    if (f4Body) {
      f4Body.addEventListener('click', (e)=>{
        const btn = e.target.closest('[data-emp]');
        if (!btn) return;
        const name = btn.getAttribute('data-emp') || '';
        const filter = (document.getElementById('f4-status')?.value === 'Doing') ? 'Doing' : 'All';
        const fromVal = (document.getElementById('f4-from')?.value || '');
        const toVal = (document.getElementById('f4-to')?.value || '');
        if (name) openDetailModal(name, filter, fromVal, toVal);
      });
    }

    // Form 4: filter rows by "số tác vụ" (>= input)
    function f4ApplyCountFilter(){
      const input = document.getElementById('f4-count-filter');
      const body = document.getElementById('f4-body');
      if (!input || !body) return;
      const raw = (input.value || '').trim();
      const threshold = raw === '' ? NaN : parseInt(raw, 10);
      const rows = body.querySelectorAll('tr');
      rows.forEach(tr=>{
        const cEl = tr.querySelector('.emp-count');
        if (!cEl) return;
        const val = parseInt((cEl.textContent || '').trim(), 10);
        if (isNaN(threshold)) {
          tr.style.display = '';
        } else if (isNaN(val)) {
          tr.style.display = '';
        } else {
          tr.style.display = (val >= threshold) ? '' : 'none';
        }
      });
    }

    // ===== Form 5: submit and list ideas =====
    async function renderForm5List(){
      const body = document.getElementById('f5-body');
      const aggBody = document.getElementById('f6-agg-body');
      const aggNote = document.getElementById('f6-agg-note');
      if (!body) return;
      body.innerHTML = "<tr><td colspan='6' class='px-3 py-3 text-center text-gray-500'><span class='spinner mr-2'></span>Đang tải...</td></tr>";
      const headerMapF5 = {
        header_submitDate: 'Ngày nộp',
        header_employee: 'Nhân viên',
        header_title: 'Tiêu đề ý tưởng',
        header_problem: 'Vấn đề nhận diện',
        header_solution: 'Giải pháp',
        field_submitDate: 'submitDate',
        field_employee: 'employee',
        field_title: 'title',
        field_problem: 'problem',
        field_solution: 'solution'
      };
      const params = new URLSearchParams({ ...headerMapF5, action: 'form5_list', _ts: Date.now().toString() });
      async function fetchJson(url){
        const r = await fetch(url, { method: 'GET' });
        const t = await r.text();
        let parsed=null; try{ parsed=JSON.parse(t);}catch{}
        return { ok:r.ok, parsed, raw:t, status:r.status };
      }
      function pickRows(json){
        if (!json) return [];
        if (Array.isArray(json)) return json;
        const cands=['data','rows','result','records','items','list'];
        for (const k of cands){ if (Array.isArray(json?.[k])) return json[k]; }
        try{
          const q=[json], seen=new Set();
          while(q.length){
            const cur=q.shift(); if(!cur||typeof cur!=='object'||seen.has(cur)) continue; seen.add(cur);
            for (const v of Object.values(cur)){ if (Array.isArray(v) && v.length && typeof v[0]==='object') return v; if (v && typeof v==='object') q.push(v); }
          }
        }catch(_){}
        return [];
      }
      let first = await fetchJson(`${FORM5_LIST_URL}?${params.toString()}`);
      if (!first.ok || (first.parsed && first.parsed.code===0 && /could not be started/i.test(String(first.parsed.message||'')))){
        first = await fetchJson(`${FORM5_LIST_URL.replace('/webhook-test/','/webhook/')}?${params.toString()}`);
      }
      if (!first.ok){
        body.innerHTML = `<tr><td colspan='6' class='px-3 py-3 text-center text-red-600'>Lỗi tải: ${String(first.raw||first.status)}</td></tr>`;
        return;
      }
      const rows = pickRows(first.parsed ?? (first.raw ? JSON.parse(first.raw) : null));
      if (!rows.length){
        body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="6">Chưa có dữ liệu</td></tr>';
        F5_LAST_COUNT = 0;
        F6_LAST_ROWS = [];
        if (aggBody) aggBody.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="3">Chưa có dữ liệu</td></tr>';
        if (aggNote) aggNote.textContent = '';
        return;
      }
      const getV = (obj, keys)=>{
        const lower = Object.keys(obj||{}).reduce((a,k)=>{ a[k.toLowerCase()] = obj[k]; return a; },{});
        for (const k of keys){ const v = lower[k.toLowerCase()]; if(v!==undefined) return v; }
        return '';
      };
      // Normalize to cache for client-side month filtering
      F6_LAST_ROWS = rows.map((item)=>({
        submitDate: getV(item,['submitdate','date','submit_date','ngaynop','ngay_nop']),
        employee: getV(item,['employee','nhanvien','nhan_vien','nhân viên']),
        title: getV(item,['title','tieude','tieu_de','tiêu đề ý tưởng']),
        problem: getV(item,['problem','van_de','vande','vấn đề nhận diện']),
        solution: getV(item,['solution','giai_phap','giaiphap','giải pháp'])
      }));
      // Local filter + render
      window.applyForm6LocalFilter = function(){
        try{
          const monthEl = document.getElementById('f6-month');
          const monthVal = monthEl ? (monthEl.value || '').trim() : '';
          let list = Array.isArray(F6_LAST_ROWS) ? F6_LAST_ROWS.slice() : [];
          if (monthVal) list = list.filter(r => formatYyyyMm(r.submitDate) === monthVal);
          if (!list.length){
            body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="5">Không có dữ liệu</td></tr>';
            if (aggBody) aggBody.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="3">Không có dữ liệu</td></tr>';
            if (aggNote) aggNote.textContent = '';
            return;
          }
          const html2 = list.map(r=>`
            <tr>
              <td class="px-3 py-2">${r.submitDate}</td>
              <td class="px-3 py-2">${r.employee}</td>
              <td class="px-3 py-2">${r.title}</td>
              <td class="px-3 py-2">${r.problem}</td>
              <td class="px-3 py-2">${r.solution}</td>
            </tr>
          `).join('');
          body.innerHTML = html2;
          try{ enableTableDrag('f5-body'); }catch(_){ }

          // Aggregate by employee and render f6-agg-body
          try{
            const counts = new Map();
            list.forEach(r=>{ const name = String(r.employee||'').trim()||'(Chưa rõ)'; counts.set(name, (counts.get(name)||0)+1); });
            const items = Array.from(counts.entries()).map(([name, cnt])=>({ name, cnt })).sort((a,b)=> b.cnt - a.cnt || a.name.localeCompare(b.name,'vi'));
            const rowsHtml = items.map(it=>`
              <tr>
                <td class="px-3 py-2">${it.name}</td>
                <td class="px-3 py-2">${it.cnt}</td>
                <td class="px-3 py-2"><button class="px-3 py-1 rounded-lg text-white bg-primary-blue hover:brightness-105" data-f6-view="${it.name.replace(/"/g,'&quot;')}">Xem</button></td>
              </tr>
            `).join('');
            if (aggBody) aggBody.innerHTML = rowsHtml || '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="3">Không có dữ liệu</td></tr>';
            if (aggNote) {
              const monthTxt = monthVal ? `tháng ${monthVal}` : 'tất cả thời gian';
              aggNote.textContent = `Đếm theo ${monthTxt}`;
            }
          }catch(_){ }
        }catch(_){ }
      };
      // initial render
      try{ applyForm6LocalFilter(); }catch(_){ }
      F5_LAST_COUNT = F6_LAST_ROWS.length;
      try{ LS.setJSON('f6.cache', { rows: F6_LAST_ROWS, ts: Date.now() }); LS.set('f6.lastUpdated', String(Date.now())); }catch(_){ }
    }

    // Form 6: Modal helpers
    (function initF6IdeasModal(){
      const modal = document.getElementById('f6-ideas-modal');
      const closeBtn = document.getElementById('f6-ideas-close');
      if (closeBtn) closeBtn.addEventListener('click', (e)=>{ e.preventDefault(); try{ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); }catch(_){ } });
      if (modal) modal.addEventListener('click', (e)=>{ if(e.target===modal){ try{ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); }catch(_){ } } });
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && modal && modal.classList.contains('open')){ try{ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); }catch(_){ } } });
    })();

    function openF6IdeasModal(empName, ideas){
      try{
        const modal = document.getElementById('f6-ideas-modal');
        const nameEl = document.getElementById('f6-ideas-name');
        const body = document.getElementById('f6-ideas-body');
        if (!modal || !nameEl || !body) return;
        nameEl.textContent = empName || '';
        if (!Array.isArray(ideas) || !ideas.length){
          body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="4">Không có dữ liệu</td></tr>';
        } else {
          const rows = ideas.map(r=>`
            <tr>
              <td class="px-3 py-2">${r.submitDate||''}</td>
              <td class="px-3 py-2">${r.title||''}</td>
              <td class="px-3 py-2">${r.problem||''}</td>
              <td class="px-3 py-2">${r.solution||''}</td>
            </tr>
          `).join('');
          body.innerHTML = rows;
        }
        modal.classList.add('open');
        modal.setAttribute('aria-hidden','false');
      }catch(_){ }
    }
    function restoreForm6FromCache(){
      try{
        const cached = LS.getJSON('f6.cache');
        if (!cached || !Array.isArray(cached.rows) || !cached.rows.length) return false;
        const body = document.getElementById('f5-body');
        if (!body) return false;
        F6_LAST_ROWS = cached.rows.slice();
        if (typeof applyForm6LocalFilter === 'function') applyForm6LocalFilter();
        updateLastUpdatedNote('f5-search','f6.lastUpdated');
        return true;
      }catch(_){ return false; }
    }

    (function setupForm5(){
      const openBtn = document.getElementById('f5-open-submit');
      const modal = document.getElementById('f5-modal');
      const sendBtn = document.getElementById('f5-btn-send');
      const cancelBtn = document.getElementById('f5-btn-cancel');
      const countBox = document.getElementById('f5-count');
      const aggBody = document.getElementById('f6-agg-body');

      function openF5Modal(){
        try { setF5DateDefault(); } catch(_){}
        // reset inputs
        try{ (document.getElementById('f5-title')||{}).value=''; }catch(_){ }
        try{ (document.getElementById('f5-problem')||{}).value=''; }catch(_){ }
        try{ (document.getElementById('f5-solution')||{}).value=''; }catch(_){ }
        if (modal){ modal.classList.add('open'); modal.setAttribute('aria-hidden','false'); }
      }
      function closeF5Modal(){ if (modal){ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); } }
      if (openBtn) openBtn.addEventListener('click', (e)=>{ e.preventDefault(); openF5Modal(); });
      if (cancelBtn) cancelBtn.addEventListener('click', (e)=>{ e.preventDefault(); closeF5Modal(); });
      if (modal) modal.addEventListener('click', (e)=>{ if(e.target===modal) closeF5Modal(); });
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && modal && modal.classList.contains('open')) closeF5Modal(); });

      async function submitF5(){
        const date = (document.getElementById('f5-date')?.value||'').trim();
        const emp = (document.getElementById('f5-employee')?.value||'').trim();
        const title = (document.getElementById('f5-title')?.value||'').trim();
        const prob = (document.getElementById('f5-problem')?.value||'').trim();
        const sol = (document.getElementById('f5-solution')?.value||'').trim();
        if (!date || !emp || !title || !prob || !sol){ showToast('Vui lòng điền đủ tất cả trường.','error'); return; }
        const prev = sendBtn ? sendBtn.textContent : '';
        if (sendBtn){ sendBtn.disabled = true; sendBtn.innerHTML = "<span class='spinner mr-2'></span>Đang gửi..."; }
        // Build payload (send both submitDate and date for compatibility)
        const toDMY = (v)=>{ try{ return formatDdMmYyyy(v); }catch(_){ return String(v||''); } };
        const p = new URLSearchParams({
          submitDate: date,
          date: date,
          submit_date: date,
          ngay_nop: date,
          ngayNop: date,
          ngayNopDMY: toDMY(date),
          employee: emp,
          title,
          problem: prob,
          solution: sol,
          _ts: Date.now().toString()
        });
        async function tryPost(url){
          try{
            const r = await fetch(url, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: p.toString() });
            const t = await r.text().catch(()=>"");
            return { ok: r.ok, raw: t };
          }catch(err){ return { ok:false, raw: String(err||'') }; }
        }
        async function tryPostNoCors(url){
          try{
            await fetch(url, { method:'POST', mode:'no-cors', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: p.toString() });
            // opaque response cannot be inspected; treat as success if resolved
            return { ok: true, raw: '' };
          }catch(err){ return { ok:false, raw: String(err||'') }; }
        }
        async function tryGet(url){
          try{
            const r = await fetch(`${url}?${p.toString()}`, { method:'GET' });
            const t = await r.text();
            return { ok: r.ok, raw: t };
          }catch(err){ return { ok:false, raw: String(err||'') }; }
        }
        try{
          // 1) POST no-cors to test URL (avoid CORS false negatives)
          let r = await tryPostNoCors(FORM5_SUBMIT_URL);
          // 2) If above failed (network), try normal POST test URL
          if (!r.ok) r = await tryPost(FORM5_SUBMIT_URL);
          // 3) Fallback GET test URL
          if (!r.ok || /could not be started/i.test(r.raw||'')) r = await tryGet(FORM5_SUBMIT_URL);
          // 4) Fallback POST prod URL
          if (!r.ok || /could not be started/i.test(r.raw||'')) r = await tryPost(FORM5_SUBMIT_URL.replace('/webhook-test/','/webhook/'));
          // 5) Fallback GET prod URL
          if (!r.ok || /could not be started/i.test(r.raw||'')) r = await tryGet(FORM5_SUBMIT_URL.replace('/webhook-test/','/webhook/'));
          if (!r.ok) throw new Error(r.raw||'Gửi thất bại');
          showToast('Đã gửi ý tưởng.','success');
          closeF5Modal();
          // Làm mới bảng sau 3 giây để backend kịp ghi dữ liệu
          setTimeout(()=>{ try{ renderForm5List(); }catch(_){} }, 3000);
        }catch(err){
          showToast('Gửi thất bại.','error');
        }finally{
          if (sendBtn){ sendBtn.disabled=false; sendBtn.textContent = prev || 'Gửi ý tưởng'; }
        }
      }
      if (sendBtn) sendBtn.addEventListener('click', (e)=>{ e.preventDefault(); submitF5(); });

      if (countBox){
        countBox.addEventListener('click', ()=>{
          countBox.innerHTML = `<span>📊</span><span>Số ý tưởng đã nộp: <b>${F5_LAST_COUNT}</b></span>`;
        });
      }

      // Delegate click on "Xem" buttons in aggregate table
      if (aggBody){
        aggBody.addEventListener('click', (e)=>{
          const btn = e.target && e.target.closest ? e.target.closest('[data-f6-view]') : null;
          if (!btn) return;
          const name = btn.getAttribute('data-f6-view') || '';
          try {
            const list = Array.isArray(F6_LAST_ROWS) ? F6_LAST_ROWS.slice() : [];
            const monthEl = document.getElementById('f6-month');
            const monthVal = monthEl ? (monthEl.value || '').trim() : '';
            const filtered = list.filter(r=> (!monthVal || formatYyyyMm(r.submitDate) === monthVal) && String(r.employee||'').trim() === name);
            openF6IdeasModal(name, filtered);
          } catch(_) {}
        });
      }
    })();

    // Map tên -> email cho Form 3 (tự động điền)
    const REQUESTER_EMAIL = (()=>{
      const normalize = s => String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,' ').trim().toLowerCase();
      const raw = {
        "Bùi Đặng Quốc Huy":"huy.bui@karofi.vn",
        "Đào Hoàng Dương":"duong.dao@karofi.vn",
        "Đỗ Quang Long":"long.do@karofi.vn",
        "Nguyễn Văn Hiếu":"hieu.nguyen2@karofi.vn",
        "Nguyễn Hữu Thịnh":"thinh.nguyen2@karofi.vn",
        "Nguyễn Văn Hiếu":"hieu.nguyen2@karofi.vn",
        "Nguyễn Văn Linh":"linh.nguyen@karofi.vn",
        "Phạm Thành Trung Kiên":"kien.pham1@karofi.vn",
        "Thái Thị Giang":"giang.thai@karofi.vn",
        "Trần Hiếu Nghĩa":"nghia.tran@karofi.vn",
        "Vũ Thị Hằng":"hang.vu@karofi.vn",
        "Đào Tuấn Kỳ":"ky.dao@karofi.vn",
        "Nguyễn Văn Linh":"linh.nguyen@karofi.vn",
        "Lại Quốc Lộc":"loc.lai@karofi.vn",
        "Lê Ngọc Ánh":"anh.le1@karofi.vn",
        "Lê Thị Thanh Nhàn":"nhan.le@karofi.vn",
        "Lê Thị Thảo":"thao.le@karofi.vn",
        "Lê Văn Sơn":"son.le2@karofi.vn",
        "Nguyễn Thị Hiền":"hien.nguyen1@karofi.vn",
        "Phạm Thị Minh":"minh.pham1@karofi.vn",
        "Vũ Duy Minh":"minh.vu@karofi.com",
        "Vũ Thị Thanh Hiền":"hien.vu2@karofi.vn"
      };
      const map = {};
      Object.keys(raw).forEach(k => map[normalize(k)] = raw[k]);
      return { get: (name)=> map[normalize(name)] || '' };
    })();
    function syncRequesterEmail(){
      const nameEl = document.getElementById('rq-by');
      const emailEl = document.getElementById('rq-by-email');
      if (!nameEl || !emailEl) return;
      emailEl.value = REQUESTER_EMAIL.get(nameEl.value||'');
    }
    (function initRequesterEmail(){
      const nameEl = document.getElementById('rq-by');
      if (!nameEl) return;
      nameEl.addEventListener('input', syncRequesterEmail);
      nameEl.addEventListener('change', syncRequesterEmail);
      syncRequesterEmail();
    })();

    async function renderForm5All(){
      const body = document.getElementById('f5a-body');
      if (!body) return;
      body.innerHTML = "<tr><td colspan='10' class='px-3 py-3 text-center text-gray-500'><span class='spinner mr-2'></span>Đang tải...</td></tr>";
      const chartWrap = document.getElementById('f5a-chart-container');
      const chartCanvas = document.getElementById('f5a-chart');
      const chartWrapMan = document.getElementById('f5a-chart-container-manhour');
      const chartCanvasMan = document.getElementById('f5a-chart-manhour');
      function destroyChart(){ try{ if (F5A_CHART) { F5A_CHART.destroy(); F5A_CHART = null; } }catch(_){}
        try{ if (F5A_CHART_MAN) { F5A_CHART_MAN.destroy(); F5A_CHART_MAN = null; } }catch(_){}
      }
      function renderStackedChart(rows){
        try{
          try{ window.F5A_RENDER_CHART = (r)=>{ try{ renderStackedChart(r || F5A_LAST_ROWS || []); }catch(_){ } }; }catch(_){ }
          if (!Array.isArray(rows) || !rows.length || !chartCanvas) { if(chartWrap) chartWrap.style.display='none'; destroyChart(); return; }
          // Chọn chế độ dữ liệu: rates (cũ) hoặc manhour (mới)
          const basisSel = document.getElementById('f5a-basis');
          const basis = basisSel ? (basisSel.value || 'rates') : 'rates';
          if (basis === 'manhour'){
            const labels = rows.map(r=> r.name);
            const isHorizontal = (F5A_MODE === 'horizontal');
            if (chartWrap) {
              chartWrap.style.display = '';
              const baseH = 420;
              chartWrap.style.height = isHorizontal ? Math.max(baseH, 28*labels.length + 100) + 'px' : baseH + 'px';
            }
            const ctx = chartCanvas.getContext('2d');
            destroyChart();
            const dataMan = rows.map(r=> Number(r.manhour)||0);
            const valueLabelsPlugin = {
              id: 'valueLabels',
              afterDatasetsDraw(chart){
                const { ctx } = chart;
                const isHorizontal = chart.options.indexAxis === 'y';
                const meta = chart.getDatasetMeta(0);
                if (!meta || !meta.data) return;
                ctx.save();
                meta.data.forEach((bar, i)=>{
                  const val = Number(chart.data.datasets[0].data?.[i]) || 0;
                  if (val <= 0) return;
                  const x = isHorizontal ? (bar.x + 12) : bar.x;
                  const y = isHorizontal ? bar.y : (bar.y - 6);
                  ctx.fillStyle = '#0b1324';
                  ctx.font = 'bold 12px Inter, Arial';
                  ctx.textAlign = 'center';
                  ctx.textBaseline = 'bottom';
                  ctx.fillText(val.toFixed(2), x, y);
                });
                ctx.restore();
              }
            };
            F5A_CHART = new Chart(ctx, {
              type: 'bar',
              data: { labels, datasets: [{ label: 'Công chuẩn hiện tại', data: dataMan, backgroundColor: 'rgba(90, 169, 255, 0.6)', borderColor: '#5aa9ff', borderWidth: 1 }] },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: isHorizontal ? 'y' : 'x',
                scales: {
                  x: { ticks: { autoSkip: false, maxRotation: isHorizontal?0:20, minRotation: 0, font: { size: 11 } }, grid: { display: false }, title: { display: true, text: isHorizontal? 'Công chuẩn' : 'Nhân viên' } },
                  y: { beginAtZero: true, ticks: { precision:0 }, grid: { color: 'rgba(0,0,0,0.06)', borderDash:[4,3] }, title: { display: true, text: isHorizontal? 'Nhân viên' : 'Công chuẩn' } }
                },
                plugins: { legend: { display: false } }
              },
              plugins: [valueLabelsPlugin]
            });
            try { setTimeout(()=>{ chartWrap && chartWrap.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); }, 100); } catch(_) {}
            F5A_LAST_ROWS = rows;
            const modeSel = document.getElementById('f5a-mode');
            if (modeSel){ modeSel.value = F5A_MODE; modeSel.onchange = ()=>{ F5A_MODE = modeSel.value || 'vertical'; renderStackedChart(F5A_LAST_ROWS); }; }
            if (basisSel){ basisSel.value = basis; basisSel.onchange = ()=> renderStackedChart(F5A_LAST_ROWS); }
            try{ window.F5A_RENDER_CHART = (r)=>{ try{ renderStackedChart(r || F5A_LAST_ROWS || []); }catch(_){ } }; }catch(_){ }
            return;
          }
          // Fallback tính tỷ lệ nếu chưa có % nhưng có số lượng
          const normalized = rows.map(r=>{
            const a = Number(r.rateAhead)||0, o = Number(r.rateOntime)||0, l = Number(r.rateLate)||0;
            if ((a+o+l) > 0) return { ...r, rateAhead:a, rateOntime:o, rateLate:l };
            const ca = Number(r.ahead)||0, co = Number(r.ontime)||0, cl = Number(r.late)||0;
            const sum = ca + co + cl;
            if (sum > 0) return { ...r, rateAhead: Math.round(ca*100/sum), rateOntime: Math.round(co*100/sum), rateLate: Math.round(cl*100/sum) };
            return { ...r };
          });
          const labels = normalized.map(r=> r.name);
          const counts   = normalized.map(r=> isNaN(r.count)?0:Number(r.count));
          // Tính số lượng theo trạng thái, nếu thiếu thì suy ra từ % * tổng count
          const cntOn  = normalized.map((r,i)=>{ const c=counts[i]; const v=Number(r.ontime)||Math.round((Number(r.rateOntime)||0)*c/100); return v; });
          const cntLate= normalized.map((r,i)=>{ const c=counts[i]; const v=Number(r.late)||Math.round((Number(r.rateLate)||0)*c/100); return v; });
          const cntAhead=normalized.map((r,i)=>{ const c=counts[i]; const v=Number(r.ahead)||Math.round((Number(r.rateAhead)||0)*c/100); return v; });
          // Tính phần trăm để hiển thị nhãn
          const pctOn   = normalized.map((r,i)=>{ const c=counts[i]||1; return Math.round((cntOn[i]||0)*100/c); });
          const pctLate = normalized.map((r,i)=>{ const c=counts[i]||1; return Math.round((cntLate[i]||0)*100/c); });
          const pctAhead= normalized.map((r,i)=>{ const c=counts[i]||1; return Math.round((cntAhead[i]||0)*100/c); });
          const maxCount = Math.max(1, ...counts);
          const isHorizontal = (F5A_MODE === 'horizontal');
          if (chartWrap) { chartWrap.style.display = ''; chartWrap.style.height = (isHorizontal ? Math.max(440, 28*labels.length + 100) : 440) + 'px'; }
          if (chartWrapMan) { chartWrapMan.style.display = ''; chartWrapMan.style.height = 420 + 'px'; }
          const ctx = chartCanvas.getContext('2d');
          destroyChart();
          const stackedLabelsPlugin = {
            id: 'stackedLabels',
            afterDatasetsDraw(chart){
              const { ctx, chartArea } = chart;
              ctx.save();
              const isHorizontal = chart.options.indexAxis === 'y';
              chart.data.datasets.forEach((ds, dsIdx)=>{
                const meta = chart.getDatasetMeta(dsIdx);
                if (!meta || meta.hidden || !meta.data || (ds.type && ds.type !== 'bar')) return;
                const inSameStack = (other)=> (other.stack || '') === (ds.stack || '');
                meta.data.forEach((bar, i)=>{
                  const val = Number(ds.data?.[i]) || 0;
                  if (val <= 0) return;
                  let total = 0;
                  chart.data.datasets.forEach((ods, j)=>{
                    const m = chart.getDatasetMeta(j);
                    if (!m || m.hidden || (ods.type && ods.type !== 'bar')) return;
                    if (!inSameStack(ods)) return;
                    total += Number(ods.data?.[i]) || 0;
                  });
                  if (!total) return;
                  const percent = Math.round((val * 100) / total);
                  const x = bar.x !== undefined ? bar.x : (bar.tooltipPosition ? bar.tooltipPosition().x : 0);
                  const y = bar.y !== undefined ? bar.y : (bar.tooltipPosition ? bar.tooltipPosition().y : 0);
                  const base = bar.base !== undefined ? bar.base : (isHorizontal ? chart.scales.x.getPixelForValue(0) : chart.scales.y.getPixelForValue(0));
                  const midX = isHorizontal ? (x + base) / 2 : x;
                  const midY = isHorizontal ? y : (y + base) / 2;
                  ctx.fillStyle = '#000000';
                  ctx.font = 'bold 12px Inter, Arial';
                  ctx.textAlign = 'center';
                  ctx.textBaseline = 'middle';
                  ctx.fillText(`${percent}%`, midX, Math.min(midY, chartArea.bottom - 4));
                });
              });
              ctx.restore();
            }
          };
          const stackTotalsPlugin = {
            id: 'stackTotals',
            afterDatasetsDraw(chart){
              const { ctx } = chart;
              const isHorizontal = chart.options.indexAxis === 'y';
              const datasets = chart.data.datasets || [];
              const labels = chart.data.labels || [];
              ctx.save();
              for (let i=0; i<labels.length; i++){
                let total = 0;
                let anchor = null;
                datasets.forEach((ds, idx)=>{
                  const meta = chart.getDatasetMeta(idx);
                  if (!meta || meta.hidden || (ds.type && ds.type !== 'bar')) return;
                  if ((ds.stack || '') !== 'rates') return;
                  const val = Number(ds.data?.[i]) || 0;
                  total += val;
                  if (!anchor) anchor = meta.data?.[i] || null;
                });
                if (!anchor || !total) continue;
                const scale = isHorizontal ? chart.scales.x : chart.scales.y;
                const pos = scale.getPixelForValue(total);
                const x = isHorizontal ? (pos + 12) : anchor.x;
                const y = isHorizontal ? anchor.y : (pos - 6);
                ctx.fillStyle = '#0b1324';
                ctx.font = 'bold 12px Inter, Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'bottom';
                ctx.fillText(String(total), x, y);
              }
              ctx.restore();
            }
          };
          const COLOR_ON = 'rgba(134,239,172,0.85)';      // green-300
          const COLOR_LATE = 'rgba(254,202,202,0.9)';     // red-200
          const COLOR_AHEAD = 'rgba(147,197,253,0.9)';    // blue-300
          const BORDER_SEG = '#e5e7eb';                   // slate-200
          const barT = isHorizontal ? 20 : 26;
          const catPct = isHorizontal ? 0.75 : 0.9;
          const barPct = isHorizontal ? 0.9 : 0.95;
          F5A_CHART = new Chart(ctx, {
            type: 'bar',
            data: {
              labels,
              datasets: [
                { label: 'Vượt tiến độ', data: cntAhead, backgroundColor: COLOR_AHEAD, borderColor:BORDER_SEG, borderWidth:1, stack: 'rates', barThickness:barT, maxBarThickness:barT+8, categoryPercentage:catPct, barPercentage:barPct },
                { label: 'Đúng tiến độ', data: cntOn, backgroundColor: COLOR_ON, borderColor:BORDER_SEG, borderWidth:1, stack: 'rates', barThickness:barT, maxBarThickness:barT+8, categoryPercentage:catPct, barPercentage:barPct },
                { label: 'Chậm tiến độ', data: cntLate, backgroundColor: COLOR_LATE, borderColor:BORDER_SEG, borderWidth:1, stack: 'rates', barThickness:barT, maxBarThickness:barT+8, categoryPercentage:catPct, barPercentage:barPct }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              indexAxis: isHorizontal ? 'y' : 'x',
              scales: {
                x: { stacked: true, ticks: { autoSkip: false, maxRotation: isHorizontal?0:20, minRotation: 0, font: { size: 11 } }, grid: { display: false } },
                y: { stacked: true, beginAtZero: true, suggestedMax: Math.ceil(maxCount*1.15), ticks: { precision:0 }, grid: { color: 'rgba(0,0,0,0.06)', borderDash:[4,3] }, title: { display: true, text: 'Số tác vụ' } }
              },
              plugins: {
                stackedLabels: {},
                legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 11 } } },
                tooltip: {
                  callbacks: {
                    label: (ctx)=>{
                      const dsLabel = ctx.dataset.label || '';
                      const value = ctx.parsed[isHorizontal?'x':'y'];
                      const total = counts[ctx.dataIndex] || 0;
                      const pct = total ? Math.round(value*100/total) : 0;
                      return ` ${dsLabel}: ${value} (${pct}%)`;
                    }
                  }
                }
              },
              plugins: [stackedLabelsPlugin, stackTotalsPlugin]
            }
          });
          try { setTimeout(()=>{ chartWrap && chartWrap.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); }, 100); } catch(_) {}
          // lưu lại rows (giữ đủ thuộc tính, kể cả manhour) để đổi chế độ
          F5A_LAST_ROWS = rows;
          const modeSel = document.getElementById('f5a-mode');
          if (modeSel){
            modeSel.value = F5A_MODE;
            modeSel.onchange = ()=>{ F5A_MODE = modeSel.value || 'vertical'; renderStackedChart(F5A_LAST_ROWS); };
          }
          // Render chart manhour song song
          try {
            const manRows = ((F5A_LAST_ROWS && Array.isArray(F5A_LAST_ROWS)) ? F5A_LAST_ROWS : normalized).slice().sort((a,b)=> Number(b.manhour||0) - Number(a.manhour||0));
            const labels2 = manRows.map(r=> r.name);
            const ctxMan = chartCanvasMan ? chartCanvasMan.getContext('2d') : null;
            if (ctxMan){
              const dataMan = manRows.map(r=> Number(r.manhour)||0);
              try{ if (F5A_CHART_MAN) { F5A_CHART_MAN.destroy(); } }catch(_){ }
              const valueLabelsPlugin2 = {
                id: 'valueLabels2',
                afterDatasetsDraw(chart){
                  const { ctx } = chart; const meta = chart.getDatasetMeta(0); if (!meta||!meta.data) return;
                  ctx.save(); meta.data.forEach((bar,i)=>{ const v=Number(chart.data.datasets[0].data?.[i])||0; if(v<=0) return; const x=bar.x; const y=(bar.y-6); ctx.fillStyle='#0b1324'; ctx.font='bold 12px Inter, Arial'; ctx.textAlign='center'; ctx.textBaseline='bottom'; ctx.fillText(v.toFixed(2), x, y); }); ctx.restore();
                }
              };
              F5A_CHART_MAN = new Chart(ctxMan, {
                type: 'bar',
                data: { labels: labels2, datasets: [{ label: 'Công chuẩn hiện tại', data: dataMan, backgroundColor: 'rgba(90, 169, 255, 0.6)', borderColor: '#5aa9ff', borderWidth: 1 }] },
                options: { responsive:true, maintainAspectRatio:false, indexAxis: 'x', scales: { x:{ ticks:{ autoSkip:false, maxRotation:20, minRotation:0, font:{ size:11 } }, grid:{ display:false }, title:{ display:true, text: 'Nhân viên' } }, y:{ beginAtZero:true, ticks:{ precision:0 }, grid:{ color:'rgba(0,0,0,0.06)', borderDash:[4,3] }, title:{ display:true, text: 'Công chuẩn' } } }, plugins: { legend:{ display:false } } },
                plugins: [valueLabelsPlugin2]
              });
            }
          } catch(_) {}
        }catch(_){ if(chartWrap) chartWrap.style.display='none'; }
      }
      try{
        const monthInput = document.getElementById('f5a-month');
        const monthVal = (monthInput && monthInput.value) ? monthInput.value : '';
        const toNumeric = (v)=>{ const s=String(v??''); const n=parseFloat(s.replace(/[^0-9.+-]/g,'')); return isNaN(n)?0:n; };
        let fromVal = '';
        let toVal = '';
        if (monthVal) {
          try{
            const [yy, mm] = monthVal.split('-');
            const firstDay = `${yy}-${mm}-01`;
            const lastDate = new Date(Number(yy), Number(mm), 0).getDate();
            const lastDay = `${yy}-${mm}-${String(lastDate).padStart(2,'0')}`;
            fromVal = firstDay; toVal = lastDay;
          }catch(_){ }
        }
        // Fetch once from the new single-source endpoint, then aggregate locally
        await f5aFetchAllOnce(monthVal, fromVal, toVal);
        const aggregated = f5aAggregate(F5A_RAW_ALL || [], fromVal, toVal);
        try{ LS.setJSON('f5a.cache', { version: APP_CACHE_VERSION, month: monthVal, rows: aggregated, ts: Date.now() }); LS.set('f5a.lastUpdated', String(Date.now())); updateLastUpdatedNote('f5a-search','f5a.lastUpdated'); }catch(_){ }
        // Sau khi render, giữ một bản sao trong biến toàn cục để các lần render lại nhanh không phụ thuộc cache/bộ nhớ ngoài
        try { F5A_LAST_ROWS = Array.isArray(aggregated) ? aggregated.slice() : []; } catch(_) {}
        // Lọc theo whitelist tên
        const filtered = Array.isArray(aggregated) ? aggregated.filter(item => f5aIsWhitelisted(item['Phụ trách'] || item.name || '')) : [];
        if (!filtered.length){
          body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="13">Không có dữ liệu</td></tr>';
          if (chartWrap) chartWrap.style.display = 'none';
          if (chartWrapMan) chartWrapMan.style.display = 'none';
            return;
          }
        const sorted = filtered.slice().sort((a,b)=> Number(b["Tổng công chuẩn"]||b.manhour||0) - Number(a["Tổng công chuẩn"]||a.manhour||0));
        const html = sorted.map(item=>{
          // Dùng các trường theo ảnh: Phụ trách, Tổng điểm (đang xử lý), Số task đang xử lý, Tổng điểm tất cả, Tổng tác vụ đã xử lý
          const name = item['Phụ trách'] || item.name || '';
          const man = Number(((item['Tổng công chuẩn'] ?? item['Tổng điểm (đang xử lý)'] ?? item.manhour) || 0));
          const count = Number(((item['Tổng tác vụ đã xử lý'] ?? item.count) || 0));
          const ahead = Number(item.ahead||0);
          const ontime = Number(item.ontime||0);
          const late = Number(item.late||0);
          const rAhead = Number(item.rateAhead||0);
          const rOn = Number(item.rateOntime||0);
          const rLate = Number(item.rateLate||0);
          const rNA = Number(item.rateNA||0);
          const clsCnt = Number(item.classifiedCnt|| (ahead+ontime+late));
          const need = f5aGetNeedManhour(name);
                return `
                  <tr>
                    <td class="px-3 py-2 cursor-pointer" data-f5a-emp="${name}"><span class="text-primary-blue hover:underline">${name}</span></td>
              <td class="px-3 py-2">${man.toFixed(2)}</td>
              <td class="px-3 py-2 cell-div">${need}</td>
              <td class="px-3 py-2">${count}</td>
              <td class="px-3 py-2 f5a-col-done">${Number(item.doneCnt || (ahead + ontime + late))}</td>
              <td class="px-3 py-2">${ahead}</td>
              <td class="px-3 py-2">${ontime}</td>
              <td class="px-3 py-2">${late}</td>
              <td class="px-3 py-2">${Number(item.na||0)}</td>
              <td class="px-3 py-2">${rAhead.toFixed(0)}%</td>
              <td class="px-3 py-2">${rOn.toFixed(0)}%</td>
              <td class="px-3 py-2">${rLate.toFixed(0)}%</td>
              <td class="px-3 py-2">${rNA.toFixed(0)}%</td>
                  </tr>`;
              }).join('');
              body.innerHTML = html;
              try{ enableTableDrag('f5a-body'); }catch(_){ }
        // Chart
        F5A_LAST_ROWS = sorted;
        renderStackedChart(sorted);
      }catch(err){
        body.innerHTML = `<tr><td colspan='12' class='px-3 py-3 text-center text-red-600'>Lỗi tải dữ liệu: ${String(err.message||err)}</td></tr>`;
        if (chartWrap) chartWrap.style.display = 'none';
      }
    }
    function restoreForm5FromCache(){
      try{
        const cached = LS.getJSON('f5a.cache');
        if (!cached || cached.version !== APP_CACHE_VERSION || !Array.isArray(cached.rows) || !cached.rows.length) return false;
        // Chỉ khôi phục khi trùng tháng hiện đang chọn; nếu input trống thì gán theo cache
        const monthInput = document.getElementById('f5a-month');
        const wantMonth = monthInput ? (monthInput.value || '').trim() : '';
        if (wantMonth && cached.month && cached.month !== wantMonth) return false;
        if (!wantMonth && cached.month && monthInput) { try { monthInput.value = cached.month; } catch(_){} }
        updateLastUpdatedNote('f5a-search','f5a.lastUpdated');
        const body = document.getElementById('f5a-body');
        if (!body) return false;
        const baseRows = Array.isArray(cached.rows) ? cached.rows.slice() : [];
        const filtered = baseRows.filter(item => f5aIsWhitelisted(item['Phụ trách'] || item.name || ''));
        if (!filtered.length){
          body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="12">Không có dữ liệu</td></tr>';
          try{ const chartWrap = document.getElementById('f5a-chart-container'); if(chartWrap) chartWrap.style.display='none'; }catch(_){ }
          return true;
        }
        const sorted = filtered.slice().sort((a,b)=> Number(b["Tổng công chuẩn"]||b.manhour||0) - Number(a["Tổng công chuẩn"]||a.manhour||0));
        const html = sorted.map(item=>{
          const name = item['Phụ trách'] || item.name || '';
          const man = Number(((item['Tổng công chuẩn'] ?? item['Tổng điểm (đang xử lý)'] ?? item.manhour) || 0));
          const count = Number(((item['Tổng tác vụ đã xử lý'] ?? item.count) || 0));
          const ahead = Number(item.ahead||0);
          const ontime = Number(item.ontime||0);
          const late = Number(item.late||0);
          const rAhead = Number(item.rateAhead||0);
          const rOn = Number(item.rateOntime||0);
          const rLate = Number(item.rateLate||0);
          const rNA = Number(item.rateNA||0);
          const need = f5aGetNeedManhour(name);
          return `<tr>
              <td class="px-3 py-2 cursor-pointer" data-f5a-emp="${name}"><span class="text-primary-blue hover:underline">${name}</span></td>
              <td class="px-3 py-2">${man.toFixed(2)}</td>
              <td class="px-3 py-2 cell-div">${need}</td>
              <td class="px-3 py-2">${count}</td>
              <td class="px-3 py-2 f5a-col-done">${Number(item.doneCnt || (ahead + ontime + late))}</td>
              <td class="px-3 py-2">${ahead}</td>
              <td class="px-3 py-2">${ontime}</td>
              <td class="px-3 py-2">${late}</td>
              <td class="px-3 py-2">${rAhead.toFixed(0)}%</td>
              <td class="px-3 py-2">${rOn.toFixed(0)}%</td>
              <td class="px-3 py-2">${rLate.toFixed(0)}%</td>
              <td class="px-3 py-2">${rNA.toFixed(0)}%</td>
            </tr>`; }).join('');
        body.innerHTML = html;
        try{ enableTableDrag('f5a-body'); }catch(_){ }
        F5A_LAST_ROWS = sorted;
        try{ const chartWrap = document.getElementById('f5a-chart-container'); if(chartWrap) chartWrap.style.display='none'; }catch(_){ }
        return true;
      }catch(_){ return false; }
    }
    // Nút làm mới lựa chọn biểu đồ Form 5
    (function initF5aRefresh(){
      const btn = document.getElementById('f5a-refresh');
      if (!btn) return;
      btn.addEventListener('click', (e)=>{ e.preventDefault(); try{ if (window.F5A_RENDER_CHART) { window.F5A_RENDER_CHART(); } else { try{ renderStackedChart(F5A_LAST_ROWS||[]); }catch(_){ } } }catch(_){ } });
    })();
    // Default Form 4 month = current month (đã có ở trên)
    // Thêm default cho Form 5 (All tasks)
    (function setDefaultF5aMonth(){
      const m = document.getElementById('f5a-month');
      if (!m) return;
      const d = new Date();
      const yy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      if (!m.value) m.value = `${yy}-${mm}`;
    })();
    // Click tên nhân viên tại Form 5 để mở bảng chi tiết tác vụ đã tính trong "Công chuẩn đã nhận"
    (function initF5aNameClick(){
      const body = document.getElementById('f5a-body');
      if (!body) return;
      body.addEventListener('click', (e)=>{
        const cell = e.target && e.target.closest ? e.target.closest('[data-f5a-emp]') : null;
        if (!cell) return;
        const name = cell.getAttribute('data-f5a-emp') || '';
        const monthInput = document.getElementById('f5a-month');
        const monthVal = (monthInput && monthInput.value) ? monthInput.value : '';
        let fromVal = '', toVal = '';
        if (monthVal) {
          try{
            const parts = monthVal.split('-');
            const yy = Number(parts[0]);
            const mm = Number(parts[1]);
            const firstDay = `${yy}-${String(mm).padStart(2,'0')}-01`;
            const lastDate = new Date(yy, mm, 0).getDate();
            const lastDay = `${yy}-${String(mm).padStart(2,'0')}-${String(lastDate).padStart(2,'0')}`;
            fromVal = firstDay; toVal = lastDay;
          }catch(_){ }
        }
        if (name) openDetailModal(name, 'All', fromVal, toVal);
      });
    })();
  </script>
</body>
</html>





