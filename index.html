<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>C·ªïng T√°c V·ª• DQA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'primary-blue': '#5aa9ff',
            'sidebar': '#0f172a',
            'sidebar-hover': '#1e293b',
            'muted': '#f8fafc'
          }
        }
      }
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    .spinner{border:2px solid #e5e7eb;border-top:2px solid #3b82f6;border-radius:50%;width:16px;height:16px;animation:spin 1s linear infinite;display:inline-block;vertical-align:middle}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .header-container{background:linear-gradient(135deg,#2563eb 0%,#60a5fa 100%);position:relative;overflow:hidden}
    .header-container::before{content:"";position:absolute;inset:0;background-image:url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffffff' fill-opacity='0.08' fill-rule='evenodd'/%3E%3C/svg%3E");opacity:.4}
    .modal{position:fixed;inset:0;background:rgba(15,23,42,0.35);display:none;align-items:center;justify-content:center;padding:20px;z-index:1000}
    .section-title{display:flex;align-items:center;gap:8px}
    .section-title .badge{background:rgba(90,169,255,.15);color:#1e40af;border:1px solid rgba(90,169,255,.35);padding:2px 8px;border-radius:9999px;font-size:12px;font-weight:600}
    .submit-btn{background:linear-gradient(135deg,#3b82f6 0%,#60a5fa 100%);box-shadow:0 4px 6px rgba(37,99,235,.1),0 1px 3px rgba(37,99,235,.08);transition:transform .2s ease,box-shadow .2s ease,opacity .2s ease,filter .2s ease;border-radius:9999px;position:relative}
    .submit-btn:hover{transform:translateY(-1px);box-shadow:0 7px 14px rgba(37,99,235,.12),0 3px 6px rgba(37,99,235,.08);filter:brightness(1.03)}
    .submit-btn:active{transform:translateY(0);opacity:.95}
    .modal.open{display:flex}
    .toast{position:fixed;right:16px;bottom:16px;background:#0b1324;color:#fff;padding:10px 12px;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.15);opacity:0;transform:translateY(10px);transition:.2s}
    .toast.show{opacity:1;transform:translateY(0)}
    /* Form 5: zebra rows & vertical dividers */
    .table-zebra tbody tr:nth-child(even){ background-color:#f8fafc; }
    .cell-div{ border-left:1px solid #e5e7eb; }
    .table-vdiv{ border-collapse: separate; border-spacing: 0; }
    .table-vdiv th+th, .table-vdiv td+td{ border-left:1px solid #e5e7eb; }
    /* Drag row highlight */
    .drag-over{ background-color:#e0f2fe !important; }
  </style>
</head>
<body class="bg-muted min-h-screen flex text-gray-800" style="font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'">
  <!-- Sidebar -->
  <aside class="w-64 min-h-screen bg-sidebar text-white flex flex-col py-8 px-4 shadow-lg">
    <h1 class="text-xl font-bold tracking-wide pb-6 border-b border-blue-200 mb-4">C·ªïng T√°c V·ª• DQA</h1>
    <nav class="flex flex-col gap-2 mt-2">
      <button class="nav-btn py-2 px-4 rounded transition hover:bg-sidebar-hover text-left text-base" data-target="form1">Form 1 ¬∑ Tra c·ª©u t√°c v·ª•</button>
      <button class="nav-btn py-2 px-4 rounded transition hover:bg-sidebar-hover text-left text-base" data-target="form2">Form 2 ¬∑ Tr·∫£ form b√°o c√°o</button>
      <button class="nav-btn py-2 px-4 rounded transition hover:bg-sidebar-hover text-left text-base" data-target="form3">Form 3 ¬∑ Giao vi·ªác</button>
      <button class="nav-btn py-2 px-4 rounded transition hover:bg-sidebar-hover text-left text-base" data-target="form4">Form 4 ¬∑ B·∫£ng theo d√µi (Doing)</button>
      <button class="nav-btn py-2 px-4 rounded transition hover:bg-sidebar-hover text-left text-base" data-target="form5">Form 5 ¬∑ T·∫•t c·∫£ t√°c v·ª•</button>
      <button class="nav-btn py-2 px-4 rounded transition hover:bg-sidebar-hover text-left text-base" data-target="form6">Form 6 ¬∑ √ù t∆∞·ªüng c·∫£i ti·∫øn</button>
      <button class="nav-btn py-2 px-4 rounded transition hover:bg-sidebar-hover text-left text-base" data-target="form7">Form 7 ¬∑ H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng</button>
    </nav>
  </aside>

  <!-- Main -->
  <main class="flex-1 py-10 flex flex-col items-center min-h-screen overflow-y-auto">
    <div class="header-container relative w-full max-w-6xl rounded-xl overflow-hidden mb-8">
      <div class="relative z-10 p-8 md:p-10">
        <div class="flex items-center space-x-2 mb-3">
          <div class="inline-block px-3 py-1 rounded-full text-xs font-semibold text-white" style="background-color: rgba(255,255,255,0.15); backdrop-filter: blur(5px);">Ph√≤ng DQA</div>
        </div>
        <h2 class="text-2xl md:text-3xl lg:text-4xl font-bold text-white mb-1 tracking-tight">C·ªïng t√°c v·ª• DQA - N·ªôi b·ªô</h2>
        <p class="text-blue-100 text-sm md:text-base">Vui l√≤ng kh√¥ng chia s·∫ª link c·ªïng t√°c v·ª• v·ªõi ng∆∞·ªùi ngo√†i b·ªô ph·∫≠n.</p>
      </div>
    </div>

    <!-- Form 1 -->
    <section id="form1" class="w-full max-w-none bg-white p-6 rounded-lg shadow-md">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-blue-800">Form 1 ¬∑ Tra c·ª©u t√°c v·ª•</h2>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Ch·ªçn t√™n</label>
          <div class="flex gap-2">
            <select id="f1-name" class="flex-1 border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white">
              <option value="">‚Äî Ch·ªçn ng∆∞·ªùi ‚Äî</option>
            </select>
            <button id="f1-search" class="px-4 py-2 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105">Tra c·ª©u</button>
          </div>
          <p class="text-gray-500 text-xs mt-1">Ch·ªçn t√™n v√† nh·∫•n Tra c·ª©u ƒë·ªÉ g·ª≠i y√™u c·∫ßu v√† hi·ªÉn th·ªã t√°c v·ª•</p>
        </div>
      </div>
      <div class="mt-2 flex items-center gap-3 flex-wrap">
        <div class="flex items-center gap-2">
          <label class="text-sm text-gray-700">Th√°ng</label>
          <input id="f1-month" type="month" class="border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
        </div>
      </div>
      <div class="mt-4 overflow-auto max-h-[60vh] border border-gray-200 rounded-lg">
        <table class="min-w-[1600px] w-full text-sm">
          <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
            <tr class="text-left text-gray-700">
              <th class="px-3 py-2 min-w-[160px]">Tr·∫£ b√°o c√°o</th>
              <th class="px-3 py-2 min-w-[140px]">T√¨nh tr·∫°ng</th>
              <th class="px-3 py-2 min-w-[140px]">M√£</th>
              <th class="px-3 py-2 min-w-[260px]">T√™n t√°c v·ª•</th>
              <th class="px-3 py-2 min-w-[160px]">Ng∆∞·ªùi y√™u c·∫ßu</th>
              <th class="px-3 py-2 min-w-[160px]">Ng∆∞·ªùi nh·∫≠n m·∫´u</th>
              <th class="px-3 py-2 min-w-[120px]">C√¥ng chu·∫©n</th>
              <th class="px-3 py-2 min-w-[140px]">Ng√†y y√™u c·∫ßu</th>
              <th class="px-3 py-2 min-w-[140px]">H·∫°n mong mu·ªën</th>
              <th class="px-3 py-2 min-w-[140px]">H·∫°n ƒë√°p ·ª©ng</th>
              <th class="px-3 py-2 min-w-[260px]">M·ª•c ƒë√≠ch ƒë√°nh gi√°</th>
              <th class="px-3 py-2 min-w-[240px]">Note</th>
              <th class="px-3 py-2 min-w-[240px]">Y√™u c·∫ßu test ƒë·∫∑c bi·ªát</th>
              <th class="px-3 py-2 min-w-[260px]">Form b√°o c√°o ƒë√°nh gi√°</th>
              <th class="px-3 py-2 min-w-[220px]">T√™n file ƒë√≠nh k√®m</th>
              <th class="px-3 py-2 min-w-[140px]">T·∫£i ƒë√≠nh k√®m</th>
              <th class="px-3 py-2 min-w-[140px]">M√£ t√°c v·ª•</th>
            </tr>
          </thead>
          <tbody id="f1-body" class="divide-y divide-gray-100">
            <tr><td class="px-3 py-3 text-center text-gray-500" colspan="17">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
          </tbody>
        </table>
      </div>
      <div id="f1-pager" class="mt-2 flex items-center justify-between" style="display:none">
        <div class="text-sm text-gray-600">
          <span id="f1-page-info">Trang 1/1 (0 d√≤ng)</span>
        </div>
        <div class="flex items-center gap-2">
          <label class="text-sm text-gray-600">Hi·ªÉn th·ªã</label>
          <select id="f1-size" class="border border-blue-300 rounded-lg bg-slate-100 p-1 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white">
            <option value="10">10</option>
            <option value="20" selected>20</option>
            <option value="50">50</option>
          </select>
          <button id="f1-prev" class="px-3 py-1 rounded-lg border border-gray-300 text-gray-700 bg-white hover:bg-gray-50">Tr∆∞·ªõc</button>
          <button id="f1-next" class="px-3 py-1 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105">Sau</button>
        </div>
      </div>

      <!-- ƒêi·ªÉm l∆∞u tr·ªØ file ƒë√≠nh k√®m -->
      <div class="mt-4">
        <a id="f1-storage-link" href="https://drive.google.com/drive/folders/1hFChHMjIC4ajY4GNX3dLoczWcZ3B9zzg?usp=sharing" target="_blank" rel="noopener" title="Nh·∫•n ƒë·ªÉ m·ªü v√† t·ª± ƒë·ªông copy li√™n k·∫øt"
           class="inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-blue-200 bg-blue-50/30 text-primary-blue hover:bg-blue-50">
          ƒêi·ªÉm l∆∞u tr·ªØ file ƒë√≠nh k√®m
        </a>
        <p class="text-xs text-gray-500 mt-1">Nh·∫•n ƒë·ªÉ m·ªü v√† copy li√™n k·∫øt.</p>
      </div>
    </section>

    <!-- Form 2 -->
    <section id="form2" class="w-full max-w-7xl bg-white p-6 rounded-lg shadow-md hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-blue-800">Form 2 ¬∑ Tr·∫£ form b√°o c√°o</h2>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Ch·ªçn t√™n</label>
          <div class="flex gap-2">
            <select id="f2-name" class="flex-1 border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white">
              <option value="">‚Äî Ch·ªçn ng∆∞·ªùi ‚Äî</option>
            </select>
            <button id="f2-search" class="px-3 py-2 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105">Tra c·ª©u</button>
          </div>
          <p class="text-gray-500 text-xs mt-1">Ch·ªçn t√™n v√† nh·∫•n Tra c·ª©u ƒë·ªÉ hi·ªÉn th·ªã t√°c v·ª• c·∫ßn tr·∫£ form.</p>
        </div>
      </div>
      <div class="mt-4 overflow-x-auto border border-gray-200 rounded-lg">
        <table class="min-w-[900px] w-full text-sm">
          <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
            <tr class="text-left text-gray-700">
              <th class="px-3 py-2">Ng√†y y√™u c·∫ßu</th>
              <th class="px-3 py-2">H·∫°n mong mu·ªën</th>
              <th class="px-3 py-2">H·∫°n ƒë√°p ·ª©ng</th>
              <th class="px-3 py-2">M√£</th>
              <th class="px-3 py-2">T√™n t√°c v·ª•</th>
              <th class="px-3 py-2 min-w-[120px]">N√∫t Tr·∫£ form</th>
            </tr>
          </thead>
          <tbody id="f2-body" class="divide-y divide-gray-100">
            <tr><td class="px-3 py-3 text-center text-gray-500" colspan="6">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Form 3 -->
    <section id="form3" class="w-full max-w-4xl bg-white p-6 rounded-lg shadow-md hidden">
      <div class="flex items-center justify-between mb-4">
        <div class="section-title">
          <h2 class="text-xl font-semibold text-blue-800">Form 3 ¬∑ Giao vi·ªác</h2>
          <span class="badge">DQA n·ªôi b·ªô</span>
        </div>
      </div>
      <form id="assign-form" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Ng∆∞·ªùi y√™u c·∫ßu <span class="text-gray-400 text-xs">(b·∫Øt bu·ªôc)</span></label>
            <input id="rq-by" required type="text" placeholder="Nh·∫≠p t√™n ng∆∞·ªùi y√™u c·∫ßu" class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Th·ªùi gian y√™u c·∫ßu</label>
            <input id="rq-time" readonly type="text" class="w-full border border-blue-300 rounded-lg bg-gray-200 p-2 text-gray-600"/>
            <p class="text-gray-500 text-xs mt-1">C·ªë ƒë·ªãnh theo th·ªùi gian h·ªá th·ªëng</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Email ng∆∞·ªùi y√™u c·∫ßu</label>
            <input id="rq-by-email" type="email" readonly placeholder="T·ª± ƒë·ªông theo Ng∆∞·ªùi y√™u c·∫ßu" class="w-full border border-blue-300 rounded-lg bg-gray-200 p-2 text-gray-600"/>
            <p class="text-gray-500 text-xs mt-1">T·ª± ƒë·ªông ƒëi·ªÅn theo "Ng∆∞·ªùi y√™u c·∫ßu"</p>
          </div>
        </div>
      <div class="grid grid-cols-1 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">T√™n t√°c v·ª• <span class="text-gray-400 text-xs">(b·∫Øt bu·ªôc)</span></label>
          <input id="task-name" required type="text" placeholder="Nh·∫≠p t√™n t√°c v·ª•" class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
        </div>
      </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Ng∆∞·ªùi ƒë∆∞·ª£c giao <span class="text-gray-400 text-xs">(b·∫Øt bu·ªôc)</span></label>
            <select id="f3-assignee" required class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white">
              <option value="">‚Äî Ch·ªçn ng∆∞·ªùi ‚Äî</option>
            </select>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">C√¥ng chu·∫©n <span class="text-gray-400 text-xs">(b·∫Øt bu·ªôc)</span></label>
            <input id="man-hour" required type="number" step="0.01" min="0" inputmode="decimal" placeholder="VD: 12,5" class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
            <p class="text-gray-500 text-xs mt-1">Cho ph√©p nh·∫≠p 2 ch·ªØ s·ªë sau d·∫•u th·∫≠p ph√¢n</p>
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-1">ƒê·∫ßu ra c√¥ng vi·ªác <span class="text-gray-400 text-xs">(b·∫Øt bu·ªôc)</span></label>
            <input id="output" required type="text" placeholder="M√¥ t·∫£ ƒë·∫ßu ra" class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Deadline</label>
            <input id="deadline" type="date" class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">M√£ Odoo/Jira</label>
            <input id="odoo-jira" type="text" placeholder="VD: ODOO-123 ho·∫∑c JIRA-456" class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">T√†i li·ªáu ƒë√≠nh k√®m</label>
            <input id="attach" type="file" class="block w-full text-sm file:mr-2 file:py-1 file:px-3 file:rounded-full file:border-0 file:bg-primary-blue file:text-white"/>
            <div id="f3-upload-list" class="mt-2 text-sm"></div>
          </div>
        </div>
        <div class="pt-2 flex items-center gap-3">
          <button type="submit" class="submit-btn px-6 py-2 text-white font-semibold transition">Giao vi·ªác</button>
        </div>
      </form>
    </section>

    <!-- Form 4 -->
    <section id="form4" class="w-full max-w-none bg-white p-6 rounded-lg shadow-md hidden">
      <div class="flex items-center justify-between mb-4">
        <div class="section-title">
          <h2 class="text-xl font-semibold text-blue-800">Form 4 ¬∑ B·∫£ng theo d√µi</h2>
        </div>
        <div class="flex items-center gap-2">
          <input type="hidden" id="f4-status" value="Doing" />
          <label class="text-sm text-gray-700">Th√°ng</label>
          <input id="f4-month" type="month" class="border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
          <button id="f4-search" class="submit-btn px-4 py-2 text-white font-semibold transition">Tra c·ª©u</button>
        </div>
      </div>
      <div class="mb-2 flex items-center gap-2 flex-wrap">
        <button id="f4-btn-all" class="px-3 py-1 rounded-full border border-blue-200 bg-blue-50/30 text-primary-blue hover:bg-blue-50">T·∫•t c·∫£ th√†nh vi√™n</button>
        <button id="f4-btn-linh" class="px-3 py-1 rounded-full border border-blue-200 bg-blue-50/30 text-primary-blue hover:bg-blue-50">Nh√≥m Linh</button>
        <button id="f4-btn-hieu" class="px-3 py-1 rounded-full border border-blue-200 bg-blue-50/30 text-primary-blue hover:bg-blue-50">Nh√≥m Hi·∫øu</button>
      </div>
      <div id="f4-main-doing" class="mt-4 overflow-auto max-h-[60vh] border border-gray-200 rounded-lg">
        <table class="min-w-[480px] w-full text-sm">
          <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
            <tr id="f4-head-row-static" class="text-left text-gray-700">
              <th class="px-3 py-2 relative">
                <button id="f4-filter-toggle" class="inline-flex items-center gap-1 hover:text-primary-blue">
                  Nh√¢n vi√™n <span class="text-xs">‚ñæ</span>
                </button>
                <div id="f4-filter-pop" class="absolute z-20 mt-2 left-0 w-72 bg-white border border-gray-200 rounded-lg shadow-lg p-3 hidden">
                  <div class="flex items-center gap-2 mb-2">
                    <input id="f4-filter-search" type="text" placeholder="T√¨m ng∆∞·ªùi..." class="flex-1 border border-blue-300 rounded bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
                  </div>
                  <div class="flex items-center justify-between text-xs text-gray-600 mb-2">
                    <div class="flex items-center gap-3">
                      <button id="f4-filter-select-all" class="underline">Ch·ªçn t·∫•t c·∫£</button>
                      <button id="f4-filter-clear" class="underline">B·ªè ch·ªçn</button>
                    </div>
                    <button id="f4-filter-apply" class="px-2 py-1 rounded bg-primary-blue text-white text-xs">L·ªçc</button>
                  </div>
                  <div id="f4-filter-list" class="max-h-60 overflow-auto space-y-1 text-sm">
                    <label class="flex items-center gap-2" data-name="(Ch·ªó tr·ªëng)"><input type="checkbox" value="(Ch·ªó tr·ªëng)" class="f4-filter-item h-4 w-4"/><span>(Ch·ªó tr·ªëng)</span></label>
                  </div>
                </div>
              </th>
              <th class="px-3 py-2">T·ªïng c√¥ng chu·∫©n</th>
              <th class="px-3 py-2">S·ªë t√°c v·ª•</th>
              
            </tr>
          </thead>
          <tbody id="f4-body" class="divide-y divide-gray-100">
            <tr><td class="px-3 py-3 text-center text-gray-500" colspan="3">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
          </tbody>
        </table>
      </div>
      <!-- Form 4: All tasks table (separate structure) -->
      <div id="f4-main-all" class="mt-4 overflow-auto max-h-[60vh] border border-gray-200 rounded-lg hidden">
        <table class="min-w-[1100px] w-full text-sm">
          <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
            <tr class="text-left text-gray-700">
              <th class="px-3 py-2">Nh√¢n vi√™n</th>
              <th class="px-3 py-2">C√¥ng chu·∫©n hi·ªán t·∫°i</th>
              <th class="px-3 py-2">S·ªë t√°c v·ª•</th>
              <th class="px-3 py-2">S·ªë DONE</th>
              <th class="px-3 py-2">V∆∞·ª£t ti·∫øn ƒë·ªô</th>
              <th class="px-3 py-2">ƒê√∫ng ti·∫øn ƒë·ªô</th>
              <th class="px-3 py-2">Ch·∫≠m ti·∫øn ƒë·ªô</th>
              <th class="px-3 py-2">T·ª∑ l·ªá v∆∞·ª£t (%)</th>
              <th class="px-3 py-2">T·ª∑ l·ªá ƒë√∫ng (%)</th>
              <th class="px-3 py-2">T·ª∑ l·ªá ch·∫≠m (%)</th>
            </tr>
          </thead>
          <tbody id="f4-body-all" class="divide-y divide-gray-100">
            <tr><td class="px-3 py-3 text-center text-gray-500" colspan="10">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
          </tbody>
        </table>
      </div>
      <!-- Pivot Overdue View -->
      <div id="f4-pivot-wrap" class="mt-4 overflow-auto max-h-[60vh] border border-gray-200 rounded-lg">
        <div class="flex items-center justify-between p-3">
          <div class="text-sm text-gray-700">B·∫£n t·ªïng h·ª£p vi·ªác qu√° h·∫°n theo tr·∫°ng th√°i</div>
          <div class="flex items-center gap-2">
            <button id="f4-pivot-refresh" class="px-3 py-1 rounded-lg border border-gray-300 bg-white hover:bg-gray-50">L√†m m·ªõi</button>
          </div>
        </div>
        <table id="f4-pivot-table" class="min-w-[760px] w-full text-sm">
          <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
            <tr class="text-left text-gray-700">
              <th class="px-3 py-2">Assignee</th>
              <th class="px-3 py-2">M√£</th>
              <th class="px-3 py-2">T√™n t√°c v·ª•</th>
              <th class="px-3 py-2">Tr·∫°ng th√°i</th>
              <th class="px-3 py-2">Ng√†y y√™u c·∫ßu</th>
              <th class="px-3 py-2">H·∫°n mong mu·ªën</th>
              <th class="px-3 py-2">H·∫°n ƒë√°p ·ª©ng</th>
            </tr>
          </thead>
          <tbody id="f4-pivot-body" class="divide-y divide-gray-100">
            <tr><td class="px-3 py-3 text-center text-gray-500" colspan="7">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
          </tbody>
          <tfoot>
            <tr class="bg-blue-50 font-semibold text-blue-900">
              <td class="px-3 py-2" colspan="6">T·ªïng s·ªë t√°c v·ª• qu√° h·∫°n:</td>
              <td class="px-3 py-2" id="f4-pivot-sum-total">0</td>
            </tr>
          </tfoot>
        </table>
        <div class="p-2 text-xs text-gray-500" id="f4-pivot-note"></div>
      </div>
      <div id="f4-chart-container" class="mt-4 h-80" style="display:none">
        <canvas id="f4-chart"></canvas>
      </div>
    </section>

    <!-- Form 5 ¬∑ T·∫•t c·∫£ t√°c v·ª• -->
    <section id="form5" class="w-full max-w-none bg-white p-6 rounded-lg shadow-md hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-blue-800">Form 5 ¬∑ T·∫•t c·∫£ t√°c v·ª•</h2>
      </div>
      <div class="mt-4 overflow-auto max-h-[60vh] border border-gray-200 rounded-lg">
        <div class="flex items-center gap-2 p-2">
          <label class="text-sm text-gray-700">Th√°ng</label>
          <input id="f5a-month" type="month" class="border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
          <button id="f5a-search" class="submit-btn px-4 py-2 text-white font-semibold transition">Tra c·ª©u</button>
        </div>
        <table class="min-w-[1100px] w-full text-sm table-zebra table-vdiv">
          <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
            <tr class="text-left text-gray-700">
              <th class="px-3 py-2">Nh√¢n vi√™n</th>
              <th class="px-3 py-2">C√¥ng chu·∫©n hi·ªán t·∫°i</th>
              <th class="px-3 py-2 cell-div">C√¥ng chu·∫©n c·∫ßn nh·∫≠n</th>
              <th class="px-3 py-2">S·ªë t√°c v·ª• trong th√°ng</th>
              <th class="px-3 py-2">S·ªë DONE</th>
              <th class="px-3 py-2">V∆∞·ª£t ti·∫øn ƒë·ªô</th>
              <th class="px-3 py-2">ƒê√∫ng ti·∫øn ƒë·ªô</th>
              <th class="px-3 py-2">Ch·∫≠m ti·∫øn ƒë·ªô</th>
              <th class="px-3 py-2">T·ª∑ l·ªá v∆∞·ª£t (%)</th>
              <th class="px-3 py-2">T·ª∑ l·ªá ƒë√∫ng (%)</th>
              <th class="px-3 py-2">T·ª∑ l·ªá ch·∫≠m (%)</th>
            </tr>
          </thead>
          <tbody id="f5a-body" class="divide-y divide-gray-100">
            <tr><td class="px-3 py-3 text-center text-gray-500" colspan="11">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
          </tbody>
        </table>
      </div>
      <div class="mt-4 text-sm text-gray-700 flex items-center gap-3">
        <span>Bi·ªÉu ƒë·ªì theo PIC</span>
        <div class="flex items-center gap-2">
          <label class="text-xs text-gray-600">Ch·∫ø ƒë·ªô</label>
          <select id="f5a-mode" class="border border-blue-200 rounded bg-white text-sm px-2 py-1">
            <option value="vertical">C·ªôt d·ªçc</option>
            <option value="horizontal">Thanh ngang</option>
          </select>
        </div>
        <button id="f5a-refresh" class="px-3 py-1 rounded-lg border border-gray-300 text-gray-700 bg-white hover:bg-gray-50">L√†m m·ªõi</button>
      </div>
      <div class="mt-2">
        <div class="text-xs text-gray-600 mb-1">T·ª∑ l·ªá tr·∫°ng th√°i</div>
        <div id="f5a-chart-container" class="h-80" style="display:none">
          <canvas id="f5a-chart"></canvas>
        </div>
      </div>
      <div class="mt-4">
        <div class="text-xs text-gray-600 mb-1">T·ªïng c√¥ng chu·∫©n</div>
        <div id="f5a-chart-container-manhour" class="h-80" style="display:none">
          <canvas id="f5a-chart-manhour"></canvas>
        </div>
      </div>
    </section>

    <!-- Form 6 -->
    <section id="form6" class="w-full max-w-none bg-white p-6 rounded-lg shadow-md hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-blue-800">Form 6 ¬∑ √ù t∆∞·ªüng c·∫£i ti·∫øn</h2>
        <div class="flex items-center gap-2">
          <button id="f5-open-submit" class="px-4 py-2 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105">N·ªôp √Ω t∆∞·ªüng</button>
          <button id="f5-search" class="submit-btn px-4 py-2 text-white font-semibold transition">Tra c·ª©u</button>
        </div>
      </div>

      <div class="flex items-center gap-2 p-2">
        <label class="text-sm text-gray-700">Th√°ng n·ªôp</label>
        <input id="f6-month" type="month" class="border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
      </div>

      <div class="mt-6 -mx-6">
        <div class="overflow-auto max-h-[60vh] border border-gray-200 rounded-lg bg-white">
          <table class="min-w-[2000px] w-full text-sm">
            <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
              <tr class="text-left text-gray-700">
                <th class="px-3 py-2">Ng√†y n·ªôp</th>
                <th class="px-3 py-2">Nh√¢n vi√™n</th>
                <th class="px-3 py-2">Ti√™u ƒë·ªÅ √Ω t∆∞·ªüng</th>
                <th class="px-3 py-2">V·∫•n ƒë·ªÅ nh·∫≠n di·ªán</th>
                <th class="px-3 py-2">Gi·∫£i ph√°p</th>
              </tr>
            </thead>
            <tbody id="f5-body" class="divide-y divide-gray-100">
              <tr><td class="px-3 py-3 text-center text-gray-500" colspan="5">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div id="f5-count" class="mt-4 p-3 rounded-lg border border-blue-200 bg-blue-50/30 text-blue-800 cursor-pointer inline-flex items-center gap-2">
        <span>Nh·∫•n ƒë·ªÉ xem s·ªë √Ω t∆∞·ªüng ƒë√£ n·ªôp</span>
      </div>
    </section>
    
    <!-- Form 7 -->
    <section id="form7" class="w-full max-w-none bg-white p-6 rounded-lg shadow-md hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-blue-800">Form 7 ¬∑ H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng</h2>
      </div>
      <div class="rounded-lg border border-gray-200 overflow-hidden">
        <iframe src="https://docs.google.com/document/d/17dkhMxqyy2YnSxukHC6y94BSFNfnDQ50/preview" class="w-full" style="height: 80vh;" allow="clipboard-write; fullscreen"></iframe>
      </div>
      <div class="mt-3 text-sm">
        <a href="https://docs.google.com/document/d/17dkhMxqyy2YnSxukHC6y94BSFNfnDQ50/edit?usp=drive_link&ouid=101589232360066908244&rtpof=true&sd=true" target="_blank" rel="noopener" class="text-primary-blue hover:underline">M·ªü b·∫£n ƒë·∫ßy ƒë·ªß (hi·ªán ƒë·ªÅ m·ª•c/th·∫ª)</a>
      </div>
    </section>
  </main>

  <!-- Upload Modal -->
  <div id="upload-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="upload-title">
    <div class="w-full max-w-lg bg-white rounded-xl border border-gray-200 shadow-xl overflow-hidden">
      <div class="px-4 py-3 bg-gradient-to-b from-blue-50 to-white border-b border-gray-200">
        <h3 id="upload-title" class="text-base font-semibold text-gray-800">G·ª≠i b√°o c√°o</h3>
      </div>
      <div class="p-4 space-y-3">
        <div class="flex flex-wrap gap-2 text-sm">
          <span class="px-3 py-1 rounded-full bg-blue-50 border border-blue-200">Ng∆∞·ªùi n·ªôp: <b class="ml-1" id="uploader-name"></b></span>
          <span class="px-3 py-1 rounded-full bg-blue-50 border border-blue-200">M√£: <b class="ml-1" id="uploader-code"></b></span>
          <span class="px-3 py-1 rounded-full bg-blue-50 border border-blue-200">T√°c v·ª•: <b class="ml-1" id="uploader-task"></b></span>
        </div>
        <div id="upload-form2-single">
          <label class="block text-sm font-medium text-gray-700 mb-1">Ch·ªçn t·ªáp b√°o c√°o</label>
          <input id="upload-file" type="file" class="block w-full text-sm file:mr-2 file:py-1 file:px-3 file:rounded-full file:border-0 file:bg-primary-blue file:text-white"/>
          <p class="text-xs text-gray-500 mt-1">T·ªáp s·∫Ω g·ª≠i k√®m timestamp t·∫°i th·ªùi ƒëi·ªÉm g·ª≠i.</p>
        </div>
        <div id="upload-form1-split" style="display:none">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">B√°o c√°o PDF ho·∫∑c file n√©n (.zip/.rar/.7z)</label>
            <input id="upload-file-pdfzip" type="file" accept=".pdf,.zip,.rar,.7z" class="block w-full text-sm file:mr-2 file:py-1 file:px-3 file:rounded-full file:border-0 file:bg-indigo-600 file:text-white"/>
            <p class="text-xs text-gray-500 mt-1">Ch·ªâ nh·∫≠n .pdf ho·∫∑c file n√©n.</p>
          </div>
          <div class="mt-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">B√°o c√°o Excel (.xlsx) ho·∫∑c file n√©n (.zip/.rar/.7z)</label>
            <input id="upload-file-xlsxzip" type="file" accept=".xlsx,.zip,.rar,.7z" class="block w-full text-sm file:mr-2 file:py-1 file:px-3 file:rounded-full file:border-0 file:bg-emerald-600 file:text-white"/>
            <p class="text-xs text-gray-500 mt-1">Ch·ªâ nh·∫≠n .xlsx ho·∫∑c file n√©n.</p>
          </div>
        </div>
        <div id="bps-option" class="flex items-center gap-2">
          <input id="upload-bps" type="checkbox" class="h-4 w-4" checked>
          <label for="upload-bps" class="text-sm text-gray-700 select-none">Tr·∫£ b√°o c√°o BPS</label>
        </div>
      </div>
      <div class="px-4 py-3 border-t border-gray-200 flex justify-end gap-2">
        <button id="btn-cancel" class="px-4 py-2 rounded-lg bg-slate-100 text-gray-800">Hu·ª∑</button>
        <button id="btn-send" class="px-4 py-2 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105">G·ª≠i b√°o c√°o</button>
      </div>
    </div>
  </div>

  <div id="detail-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="detail-title">
    <div class="w-full max-w-5xl bg-white rounded-xl border border-gray-200 shadow-xl overflow-hidden">
      <div class="px-4 py-3 bg-gradient-to-b from-blue-50 to-white border-b border-gray-200 flex items-center justify-between">
        <h3 id="detail-title" class="text-base font-semibold text-gray-800">Nhi·ªám v·ª• c·ªßa <span id="detail-name" class="text-primary-blue"></span></h3>
        <button id="detail-close" class="px-3 py-1 rounded-lg bg-slate-100 text-gray-800">ƒê√≥ng</button>
      </div>
      <div class="p-4">
        <div class="overflow-x-auto border border-gray-200 rounded-lg">
          <table class="min-w-[900px] w-full text-sm">
            <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
              <tr class="text-left text-gray-700">
                <th class="px-3 py-2">M√£</th>
                <th class="px-3 py-2">T√™n t√°c v·ª•</th>
                <th class="px-3 py-2">Tr·∫°ng th√°i</th>
                <th class="px-3 py-2">C√¥ng chu·∫©n</th>
                <th class="px-3 py-2">Ng√†y y√™u c·∫ßu</th>
                <th class="px-3 py-2">H·∫°n mong mu·ªën</th>
                <th class="px-3 py-2">H·∫°n ƒë√°p ·ª©ng</th>
                <th class="px-3 py-2">Ng√†y ho√†n th√†nh</th>
              </tr>
            </thead>
            <tbody id="detail-body" class="divide-y divide-gray-100">
              <tr><td class="px-3 py-3 text-center text-gray-500" colspan="8">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
            </tbody>
          </table>
        </div>
        <p class="text-xs text-gray-500 mt-2" id="detail-note"></p>
      </div>
    </div>
  </div>

  <!-- Form 5 Submit Modal -->
  <div id="f5-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="f5-modal-title">
    <div class="w-full max-w-3xl bg-white rounded-xl border border-gray-200 shadow-xl overflow-hidden">
      <div class="px-4 py-3 bg-gradient-to-b from-blue-50 to-white border-b border-gray-200">
        <h3 id="f5-modal-title" class="text-base font-semibold text-gray-800">N·ªôp √Ω t∆∞·ªüng c·∫£i ti·∫øn</h3>
      </div>
      <div class="p-4 space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Ng√†y</label>
            <input id="f5-date" type="date" readonly class="w-full border border-blue-300 rounded-lg bg-gray-200 p-2 text-gray-600"/>
            <p class="text-gray-500 text-xs mt-1">C·ªë ƒë·ªãnh theo ng√†y nh·∫≠p</p>
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-1">Nh√¢n vi√™n</label>
            <select id="f5-employee" class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white">
              <option value="">‚Äî Ch·ªçn ng∆∞·ªùi ‚Äî</option>
            </select>
          </div>
        </div>
        <div class="grid grid-cols-1 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Ti√™u ƒë·ªÅ √Ω t∆∞·ªüng</label>
            <input id="f5-title" type="text" placeholder="Nh·∫≠p ti√™u ƒë·ªÅ" class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">V·∫•n ƒë·ªÅ nh·∫≠n di·ªán</label>
            <textarea id="f5-problem" rows="3" placeholder="M√¥ t·∫£ v·∫•n ƒë·ªÅ" class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Gi·∫£i ph√°p</label>
            <textarea id="f5-solution" rows="3" placeholder="M√¥ t·∫£ gi·∫£i ph√°p" class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"></textarea>
          </div>
        </div>
      </div>
      <div class="px-4 py-3 border-t border-gray-200 flex justify-end gap-2">
        <button id="f5-btn-cancel" class="px-4 py-2 rounded-lg bg-slate-100 text-gray-800">Hu·ª∑</button>
        <button id="f5-btn-send" class="px-4 py-2 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105">G·ª≠i √Ω t∆∞·ªüng</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // Constants
    const WEBHOOK_URL = "https://iatzhxxuk.tino.page/webhook/4cdacd75-92ce-4156-aa79-62fc60f51730";
    const FORM1_UPLOAD_URL = "https://iatzhxxuk.tino.page/webhook/b0bd7f2a-eed4-4fb5-8d39-f3fed54daf3e";
    const FORM2_LOOKUP_URL = "https://iatzhxxuk.tino.page/webhook/e067ccfb-f59b-43f0-b779-b9d1286549f9";
    const FORM2_UPLOAD_URL = "https://iatzhxxuk.tino.page/webhook/2e394d3e-da1a-4577-9063-359a70518527";
    // Endpoint for Form 3 submission (single webhook; send form-data with optional files)
    const FORM3_ENDPOINT = "https://iatzhxxuk.tino.page/webhook/21b742a9-a6b0-4393-9325-bfa470db5917";
    // Endpoints for Form 6 (submit & list)
    const FORM6_SUBMIT_URL = "https://iatzhxxuk.tino.page/webhook/8e42168f-cb7b-44da-ae44-571f1e072d53";
    const FORM6_LIST_URL = "https://iatzhxxuk.tino.page/webhook/7c18c686-7349-4d09-8769-e6a951096e73";
    // Backward-compat aliases for Form 6 handlers referencing FORM5_* names
    const FORM5_SUBMIT_URL = FORM6_SUBMIT_URL;
    const FORM5_LIST_URL = FORM6_LIST_URL;
    // Form 5 All (new single-source endpoint)
    const FORM5_ALL_NEW_URL = "https://iatzhxxuk.tino.page/webhook/2c62c918-413c-49c3-99f6-49466f13c6d6";
    let F4_CHART = null;
    let F5_LAST_COUNT = 0;
    let F4_PIVOT_BUSY = false;
    let F4_PIVOT_TMO = null;
    // Pivot cache (Form 4): l∆∞u t·∫•t c·∫£ d√≤ng qu√° h·∫°n ƒë·ªÉ l·ªçc c·ª•c b·ªô khi chuy·ªÉn nh√≥m
    let F4_PIVOT_ROWS_ALL = [];
    let F4_PIVOT_LAST_PARAMS = { from: '', to: '' };
    // Form 5 (All tasks) chart globals
    let F5A_CHART = null;
    let F5A_LAST_ROWS = [];
    let F5A_MODE = 'vertical';
    let F5A_CHART_MAN = null;
    let F5A_BASIS = 'rates';
    let F5A_RAW_ALL = [];
    let F5A_RAW_META = { month: '' };
    // Form 5: C√¥ng chu·∫©n c·∫ßn nh·∫≠n (c√≥ th·ªÉ ch·ªânh t·∫°i ƒë√¢y)
    const F5A_NEED_MANHOUR_DEFAULT = 200;
    const F5A_NEED_MANHOUR_BY_NAME = {
      "B√πi ƒê·∫∑ng Qu·ªëc Huy": 250.00,
      "Ph·∫°m Th√†nh Trung Ki√™n": 250.00,
      "ƒê·ªó Quang Long": 250.00,
      "Nguy·ªÖn H·ªØu Th·ªãnh": 250.00,
      "L√™ VƒÉn S∆°n": 250.00,
      "Nguy·ªÖn Th·ªã Hi·ªÅn": 250.00,
      "L·∫°i Qu·ªëc L·ªôc": 250.00,
      "V≈© Th·ªã Thanh Hi·ªÅn": 250.00,
      "L√™ Ng·ªçc √Ånh": 250.00,
      "ƒê√†o Tu·∫•n K·ª≥": 250.00,
      "V≈© Th·ªã H·∫±ng": 250.00,
      "Th√°i Th·ªã Giang": 250.00,
      "Tr·∫ßn Hi·∫øu Nghƒ©a": 250.00,
      "Ph·∫°m Th·ªã Minh": 250.00
    };
    function f5aGetNeedManhour(name){
      try{
        const norm = (s)=> String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
        const map = {};
        Object.keys(F5A_NEED_MANHOUR_BY_NAME||{}).forEach(k=>{ map[norm(k)] = Number(F5A_NEED_MANHOUR_BY_NAME[k]); });
        const v = map[norm(name)];
        return (typeof v === 'number' && !isNaN(v)) ? v : F5A_NEED_MANHOUR_DEFAULT;
      }catch(_){ return F5A_NEED_MANHOUR_DEFAULT; }
    }
    // Form 6 (ideas) cache for month filter
    let F6_LAST_ROWS = [];

    // ===== Form 5 (All tasks) - fetch once and aggregate locally =====
    function f5aPickRowsDeep(json){
      if (!json) return [];
      if (Array.isArray(json) && json.length && typeof json[0] === 'object') return json;
      const candidates = ['data','rows','result','records','items','list'];
      for (const k of candidates){ if (Array.isArray(json?.[k]) && json[k].length && typeof json[k][0] === 'object') return json[k]; }
      try{
        const queue=[json]; const seen=new Set();
        while(queue.length){
          const cur = queue.shift(); if(!cur || typeof cur !== 'object' || seen.has(cur)) continue; seen.add(cur);
          for (const v of Object.values(cur)){
            if (Array.isArray(v) && v.length && typeof v[0] === 'object') return v;
            if (v && typeof v === 'object') queue.push(v);
          }
        }
      }catch(_){ }
      return [];
    }

    async function f5aFetchAllOnce(month, fromVal, toVal){
      if (F5A_RAW_ALL && F5A_RAW_ALL.length && F5A_RAW_META && F5A_RAW_META.month === (month||'')) return;
      const makeQs = (withAction, withRange)=>{
        const qs = new URLSearchParams();
        if (withAction) qs.append('action','form5_all');
        if (withRange){
          if (month) qs.append('month', month);
          if (fromVal) qs.append('from', fromVal);
          if (toVal) qs.append('to', toVal);
        }
        qs.append('_ts', Date.now().toString());
        return qs.toString();
      };
      const urls = [];
      const uBase = FORM5_ALL_NEW_URL;
      const uTest = uBase.replace('/webhook/','/webhook-test/');
      [true,false].forEach(withRange=>{
        [true,false].forEach(withAction=>{
          const q = makeQs(withAction, withRange);
          urls.push(`${uBase}${q?`?${q}`:''}`);
          urls.push(`${uTest}${q?`?${q}`:''}`);
        });
      });
      // th√™m ph∆∞∆°ng √°n kh√¥ng query
      urls.push(uBase);
      urls.push(uTest);
      let rows = [];
      for (const u of urls){
        try{
          console.log('Form5 fetch try:', u);
          const r = await fetch(u, { method: 'GET', headers: { 'Accept': 'application/json, text/plain, */*' } });
          const text = await r.text();
          let data = null; try{ data = JSON.parse(text); }catch{ data = null; }
          if (!data && typeof text === 'string'){
            const m = text.match(/\[[\s\S]*\]/);
            if (m) { try { data = JSON.parse(m[0]); } catch(_) { data = null; } }
          }
          const picked = f5aPickRowsDeep(data ?? text);
          if (Array.isArray(picked) && picked.length){ rows = picked; break; }
        }catch(_){ /* next */ }
      }
      // Unwrap n8n format: [{ json: {...} }]
      const unwrapped = Array.isArray(rows) ? rows.map(r=> (r && typeof r==='object' && ('json' in r)) ? r.json : r) : [];
      F5A_RAW_ALL = unwrapped;
      F5A_RAW_META = { month: month || '' };
      try{ LS.set('f5a.lastUpdated', String(Date.now())); updateLastUpdatedNote('f5a-search','f5a.lastUpdated'); }catch(_){ }
    }

    function f5aAggregate(rows, fromVal, toVal){
      // ==== CONFIG (tham kh·∫£o Code t·ªïng h·ª£p.txt) ====
      const assigneeKeys = ['Assignee','Ph·ª• tr√°ch','Ng∆∞·ªùi ph·ª• tr√°ch','Ng∆∞·ªùi x·ª≠ l√Ω','employee','nhanvien','nhan_vien','nh√¢n vi√™n','user','name','receiver','recipient','pic','nguoi_phu_trach','ng∆∞·ªùi ph·ª• tr√°ch'];
      const taskNameKeys = ['Task Name','T√™n t√°c v·ª•','Task','C√¥ng vi·ªác','T√™n Task','M√£','taskname','ten_tac_vu','ten','title'];
      const scoreKeys = ['ƒêi·ªÉm','Score','score'];
      const altScoreKeys = ['C√¥ng chu·∫©n c√¥ng vi·ªác nh·∫≠n ','C√¥ng chu·∫©n c√¥ng vi·ªác nh·∫≠n','C√¥ng chu·∫©n','manhour','man_hour','current_manhour','congchuan','cong_chuan','hours'];
      const statusKeys = ['Hi·ªán tr·∫°ng','Tr·∫°ng th√°i','Status','status','trangthai','trang_thai','tr·∫°ng th√°i'];
      const finishedDateKs = ['Ng√†y ho√†n th√†nh th·ª±c t·∫ø','Ng√†y ho√†n th√†nh','Ng√†y ƒë√≥ng','completiondate','completeddate','ngayhoanthanh','ngay_hoan_thanh'];
      const countZeroTasks = true;
      const excludeCanceled = true;
      const minWeight = 0.0001;

      const hasVal = v => v != null && String(v).trim() !== '';
      const normKey = (s)=> String(s||'').toLowerCase().replace(/\s+/g,' ').trim();
      const getV = (obj, keys)=>{
        const lower = {};
        Object.keys(obj||{}).forEach(k=>{
          const v = obj[k];
          const k1 = String(k).toLowerCase();
          const k2 = normKey(k);
          lower[k1] = v;
          lower[k2] = v;
        });
        for (const k of keys){
          const cand1 = String(k).toLowerCase();
          const cand2 = normKey(k);
          const v = lower[cand1] ?? lower[cand2];
          if (v !== undefined && hasVal(v)) return v;
        }
        return '';
      };
      function toNum(v){
        if (v == null) return 0;
        let s = String(v).trim();
        if (!s) return 0;
        s = s.replace(/\s|\u00A0/g, '');
        s = s.replace(/[%‚Ç´ƒëvnd]/gi, '');
        if (s.includes(',')) s = s.replace(/\./g,'').replace(',', '.');
        else s = s.replace(/\./g,'');
        const n = Number(s);
        return Number.isFinite(n) ? n : 0;
      }
      function getNumberFrom(row, keys){ const v = getV(row, keys); return toNum(v); }
      function getTextFrom(row, keys){ const v = getV(row, keys); return String(v||'').trim(); }
      function isCanceled(row){
        const f = getTextFrom(row, finishedDateKs).toLowerCase();
        const st = getTextFrom(row, statusKeys).toLowerCase();
        return f.includes('cancel') || st.includes('cancel') || st.includes('h·ªßy') || st.includes('hu·ª∑');
      }
      const resultKeys = ['‚ÅâÔ∏è K·∫øt qu·∫£','ket_qua','k·∫øt qu·∫£','result'];
      function inRange(v){
        if (!fromVal && !toVal) return true;
        const d = parseDateFlexible(v);
        if (!d) return true;
        const ds = d.toISOString().slice(0,10);
        if (fromVal && ds < fromVal) return false;
        if (toVal && ds > toVal) return false;
        return true;
      }
      const byName = new Map();
      rows.forEach(row=>{
        // B·ªè qua b·∫£n ghi kh√¥ng ph·∫£i task (thi·∫øu t√™n task)
        const taskVal = getTextFrom(row, taskNameKeys);
        if (!hasVal(taskVal)) return;
        if (excludeCanceled && isCanceled(row)) return;
        let name = getTextFrom(row, assigneeKeys);
        if (!name || name.toLowerCase() === 'nan') name = 'Ch∆∞a ph√¢n c√¥ng';

        const rq = getV(row,[
          'requestdate','ngayyeucau','ngay_yeu_cau','submissiondate','ngaygui','üìÜ ng√†y y√™u c·∫ßu'
        ]);
        const wish = getV(row,['wishdue','hanmongmuon','han_mong_muon','desireddue']);
        const act = getV(row,['actualdue','handapung','han_dap_ung','completiondate']);
        const doneDate = getV(row, finishedDateKs);
        // Ch·ªâ l·ªçc theo \"üìÜ Ng√†y y√™u c·∫ßu\"
        const refDate = rq;
        if (!hasVal(refDate) || !inRange(refDate)) return;

        const weight = getNumberFrom(row, scoreKeys) || getNumberFrom(row, altScoreKeys);
        const resText = getTextFrom(row, resultKeys);
        const done = /^\s*done\s*$/i.test(resText || '');

        let rec = byName.get(name);
        if (!rec) { rec = { name, manhour: 0, count: 0, ahead: 0, ontime: 0, late: 0, doneCnt: 0, doneSum: 0, activeCnt: 0, activeSum: 0 }; byName.set(name, rec); }

        const countThis = countZeroTasks ? true : (weight > minWeight);
        if (done) {
          if (countThis) rec.doneCnt += 1;
          rec.doneSum += weight;
        } else {
          if (countThis) rec.activeCnt += 1;
          rec.activeSum += weight;
        }
        rec.count = (rec.doneCnt || 0) + (rec.activeCnt || 0);
        rec.manhour = (rec.doneSum || 0) + (rec.activeSum || 0);
        // T·ªïng c√¥ng chu·∫©n theo m·ªëc Ng√†y y√™u c·∫ßu (kh√¥ng t√≠nh Cancel v√¨ ƒë√£ lo·∫°i ·ªü tr√™n)
        try{
          const dRq = parseDateFlexible(rq || '');
          if (dRq){
            const ds = dRq.toISOString().slice(0,10);
            const inRq = (!fromVal || ds >= fromVal) && (!toVal || ds <= toVal);
            if (inRq){ rec.totalByRq = (rec.totalByRq || 0) + weight; }
          }
        }catch(_){ }

        // Ph√¢n lo·∫°i v∆∞·ª£t/ƒë√∫ng/ch·∫≠m theo c·ªôt "Hi·ªán tr·∫°ng" khi ƒë√£ Done
        if (done){
          const ht = String(getTextFrom(row, statusKeys)||'').toLowerCase();
          if (ht.includes('v∆∞·ª£t ti·∫øn ƒë·ªô')) rec.ahead += 1;
          else if (ht.includes('ƒë√∫ng ti·∫øn ƒë·ªô') || ht.includes('dung tien do')) rec.ontime += 1;
          else if (ht.includes('ch·∫≠m ti·∫øn ƒë·ªô') || ht.includes('cham tien do')) rec.late += 1;
        }
      });
      const out = Array.from(byName.values());
      out.forEach(r=>{
        const sum = Math.max(0, Number(r.ahead||0) + Number(r.ontime||0) + Number(r.late||0));
        const denom = Number(r.doneCnt||0) > 0 ? Number(r.doneCnt) : sum;
        r.rateAhead = denom ? Math.round((Number(r.ahead||0)*100)/denom) : 0;
        r.rateOntime = denom ? Math.round((Number(r.ontime||0)*100)/denom) : 0;
        r.rateLate = denom ? Math.round((Number(r.late||0)*100)/denom) : 0;
        // Map theo bi·ªÉu m·∫´u ngo√†i (·∫£nh)
        r["Ph·ª• tr√°ch"] = r.name || '';
        const activeSum = Number(r.activeSum||0);
        r["T·ªïng ƒëi·ªÉm (ƒëang x·ª≠ l√Ω)"] = +activeSum.toFixed(2);
        r["S·ªë task ƒëang x·ª≠ l√Ω"] = Number(r.activeCnt||0);
        const totalPts = Number((r.doneSum||0) + (r.activeSum||0));
        r["T·ªïng ƒëi·ªÉm t·∫•t c·∫£"] = +totalPts.toFixed(2);
        r["T·ªïng t√°c v·ª• ƒë√£ x·ª≠ l√Ω"] = Number((r.doneCnt||0) + (r.activeCnt||0));
        // T·ªïng c√¥ng chu·∫©n theo m·ªëc Ng√†y y√™u c·∫ßu
        const byRq = Number(r.totalByRq||0);
        r["T·ªïng c√¥ng chu·∫©n"] = +byRq.toFixed(2);
      });
      return out;
    }

    // Date-time format helpers
    function toDateSafe(value){
      try{
        if (value instanceof Date && !isNaN(value)) return value;
        const parsed = (typeof parseDateFlexible === 'function') ? parseDateFlexible(value) : null;
        if (parsed && !isNaN(parsed)) return parsed;
        const d = new Date(value);
        return isNaN(d) ? null : d;
      }catch(_){ return null; }
    }
    function formatDdMmYyyy(value){
      try{
        const d = toDateSafe(value);
        if (!d) return '';
        const pad = n=> String(n).padStart(2,'0');
        return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()}`;
      }catch(_){ return ''; }
    }
    function formatDdMmYyyyHHmm(value){
      try{
        const d = toDateSafe(value);
        if (!d) return '';
        const pad = n=> String(n).padStart(2,'0');
        return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
      }catch(_){ return ''; }
    }

    function formatYyyyMm(value){
      try{
        const d = toDateSafe(value);
        if (!d) return '';
        const pad = n=> String(n).padStart(2,'0');
        return `${d.getFullYear()}-${pad(d.getMonth()+1)}`;
      }catch(_){ return ''; }
    }

    // Local storage helpers & last-updated note
    const LS = {
      get(k){ try{ return localStorage.getItem(k); }catch(_){ return null; } },
      set(k,v){ try{ localStorage.setItem(k,v); }catch(_){ } },
      getJSON(k){ try{ const s=localStorage.getItem(k); return s? JSON.parse(s): null; }catch(_){ return null; } },
      setJSON(k,obj){ try{ localStorage.setItem(k, JSON.stringify(obj)); }catch(_){ } },
      remove(k){ try{ localStorage.removeItem(k); }catch(_){ } }
    };
    function formatHHmmDdMmYyyy(value){
      try{
        const d = toDateSafe(value);
        if (!d) return '';
        const pad = n=> String(n).padStart(2,'0');
        return `${pad(d.getHours())}:${pad(d.getMinutes())} ${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()}`;
      }catch(_){ return ''; }
    }
    function updateLastUpdatedNote(btnId, tsKey){
      try{
        const btn = document.getElementById(btnId);
        if (!btn) return;
        const parent = btn.parentElement || btn;
        let note = parent.querySelector('[data-last-updated]');
        if (!note){
          note = document.createElement('span');
          note.setAttribute('data-last-updated','1');
          note.className = 'text-xs text-gray-500 ml-2';
          parent.appendChild(note);
        }
        const tsStr = LS.get(tsKey);
        if (!tsStr){ note.textContent = ''; return; }
        const ts = Number(tsStr);
        const show = isNaN(ts) ? '' : `D·ªØ li·ªáu c·∫≠p nh·∫≠t l√∫c ${formatHHmmDdMmYyyy(new Date(ts))}`;
        note.textContent = show;
      }catch(_){ }
    }

    function f4SchedulePivot(delay = 80){
      try { if (F4_PIVOT_TMO) clearTimeout(F4_PIVOT_TMO); } catch(_) {}
      F4_PIVOT_TMO = setTimeout(()=>{ try{ renderF4Pivot(); }catch(_){ } }, delay);
    }

    // Global helper: parse various date formats to Date (YYYY-MM-DD, DD/MM/YYYY, DD-MM-YYYY, YYYY/MM/DD)
    function parseDateFlexible(value){
      if (!value) return null;
      const s = String(value).trim();
      let m = s.match(/^(\d{1,2})[\/\-.](\d{1,2})[\/\-.](\d{2,4})/);
      if (m) {
        const day = parseInt(m[1], 10);
        const month = parseInt(m[2], 10);
        const year = m[3].length === 2 ? parseInt('20' + m[3], 10) : parseInt(m[3], 10);
        const dt = new Date(year, month - 1, day);
        return isNaN(dt) ? null : dt;
      }
      m = s.match(/^(\d{4})[\/\-.](\d{1,2})[\/\-.](\d{1,2})/);
      if (m) {
        const dt = new Date(parseInt(m[1], 10), parseInt(m[2], 10) - 1, parseInt(m[3], 10));
        return isNaN(dt) ? null : dt;
      }
      const dt = new Date(s);
      return isNaN(dt) ? null : dt;
    }

    // Sidebar navigation
    const navBtns = document.querySelectorAll('.nav-btn');
    const sections = ['form1','form2','form3','form4','form5','form6','form7'].map(id=>document.getElementById(id));
    function showSection(id){ sections.forEach(s=>s.classList.toggle('hidden', s.id!==id)); }
    navBtns.forEach((btn)=>{
      btn.onclick=()=>{
        navBtns.forEach(b=>b.classList.remove('bg-primary-blue','font-bold'));
        btn.classList.add('bg-primary-blue','font-bold');
        const target = btn.getAttribute('data-target');
        showSection(target);
        if (target === 'form6') { try { if(!restoreForm6FromCache()){ renderForm5List(); } } catch(_){} }
        if (target === 'form4') { try { if(!restoreForm4FromCache()){ /* ch·ªù b·∫•m Tra c·ª©u */ } f4SchedulePivot(); } catch(_){} }
        if (target === 'form5') { try { if(!restoreForm5FromCache()){ /* ch·ªù b·∫•m Tra c·ª©u */ } } catch(_){} }
      }
    });
    // Default
    navBtns[0].classList.add('bg-primary-blue','font-bold');
    showSection(navBtns[0].getAttribute('data-target'));

    // Names
    const FORM1_NAMES = [
      "B√πi ƒê·∫∑ng Qu·ªëc Huy","ƒê√†o Tu·∫•n K·ª≥","ƒê·ªó Quang Long","ƒê·ªó Th·∫ø C∆∞·ªùng","H√† M·ªπ Linh","L·∫°i Qu·ªëc L·ªôc",
      "L√™ Ng·ªçc √Ånh","L√™ Th·ªã Thanh Nh√†n","L√™ Th·ªã Th·∫£o","L√™ VƒÉn S∆°n","Nguy·ªÖn H·ªØu Th·ªãnh","Nguy·ªÖn Th·ªã Hi·ªÅn",
      "Ph·∫°m Th√†nh Trung Ki√™n","Ph·∫°m Th·ªã Minh","Th√°i Th·ªã Giang","Tr·∫ßn Hi·∫øu Nghƒ©a","V≈© Th·ªã H·∫±ng","V≈© Th·ªã Thanh Hi·ªÅn"
    ];
    const FORM2_NAMES = FORM1_NAMES;
    // Danh s√°ch ri√™ng cho Form 3 (Ng∆∞·ªùi ƒë∆∞·ª£c giao): lo·∫°i 3 t√™n v√† th√™m 3 t√™n
    const FORM3_ASSIGNEES = (()=>{
      const base = Array.isArray(FORM1_NAMES) ? FORM1_NAMES.slice() : [];
      const exclude = new Set(["H√† M·ªπ Linh","ƒê·ªó Th·∫ø C∆∞·ªùng","L√™ Th·ªã Thanh Nh√†n"]);
      const add = ["ƒê√†o Ho√†ng D∆∞∆°ng","Nguy·ªÖn VƒÉn Linh","Nguy·ªÖn VƒÉn Hi·∫øu"];
      const filtered = base.filter(n => !exclude.has(n));
      add.forEach(n => { if (filtered.indexOf(n) === -1) filtered.push(n); });
      return filtered;
    })();

    // D·ªØ li·ªáu t√°c v·ª• (kh·ªüi t·∫°o r·ªóng; s·∫Ω n·ªëi ngu·ªìn th·∫≠t sau)
    const demoTasksForm1 = {};
    const demoTasksForm2 = {};

    // Fill selects
    function fillSelect(sel, arr){ arr.forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; sel.appendChild(o); }); }
    fillSelect(document.getElementById('f1-name'), FORM1_NAMES);
    fillSelect(document.getElementById('f2-name'), FORM2_NAMES);
    const f3AssigneeSel = document.getElementById('f3-assignee');
    if (f3AssigneeSel) fillSelect(f3AssigneeSel, FORM3_ASSIGNEES);
    const f4PeopleSel = document.getElementById('f4-people');
    if (f4PeopleSel) fillSelect(f4PeopleSel, FORM1_NAMES);
    const f5EmployeeSel = document.getElementById('f5-employee');
    if (f5EmployeeSel) fillSelect(f5EmployeeSel, FORM1_NAMES);

    // Persist selections and show last-updated notes for Form 1 & 2
    (function initPersistSelections(){
      try{
        const f1Sel = document.getElementById('f1-name');
        if (f1Sel){
          const last = LS.get('f1.selectedName');
          if (last && Array.prototype.some.call(f1Sel.options, op=> op.value===last)) f1Sel.value = last;
          f1Sel.addEventListener('change', ()=>{ LS.set('f1.selectedName', f1Sel.value||''); });
          updateLastUpdatedNote('f1-search','f1.lastUpdated');
        }
        const f2Sel = document.getElementById('f2-name');
        if (f2Sel){
          const last2 = LS.get('f2.selectedName');
          if (last2 && Array.prototype.some.call(f2Sel.options, op=> op.value===last2)) f2Sel.value = last2;
          f2Sel.addEventListener('change', ()=>{ LS.set('f2.selectedName', f2Sel.value||''); });
          updateLastUpdatedNote('f2-search','f2.lastUpdated');
        }
      }catch(_){ }
    })();

    // Toast
    const toastEl = document.getElementById('toast');
    function showToast(msg,type='info'){
      toastEl.textContent = msg;
      toastEl.style.background = type==='success' ? '#137a39' : (type==='error' ? '#b42318' : '#0b1324');
      toastEl.classList.add('show');
      setTimeout(()=>toastEl.classList.remove('show'), 2600);
    }

    // Upload modal
    const modal = document.getElementById('upload-modal');
    const fileInput = document.getElementById('upload-file');
    const uploaderName = document.getElementById('uploader-name');
    const uploaderCode = document.getElementById('uploader-code');
    const uploaderTask = document.getElementById('uploader-task');
    let uploadContext = null;
    let isModalSubmitting = false;
    let lastOpenTrigger = null;
    function openUploadModal(ctx){
      uploadContext = ctx || {};
      uploaderName.textContent = ctx?.name || '';
      uploaderCode.textContent = ctx?.code || '';
      uploaderTask.textContent = ctx?.taskName || '';
      // Hide Ng∆∞·ªùi n·ªôp pill for Form 2 per request
      try {
        const namePill = uploaderName && uploaderName.parentElement && uploaderName.parentElement.parentElement ? uploaderName.parentElement.parentElement : null;
        if (namePill) namePill.style.display = (ctx && ctx.form === 'Form 2') ? 'none' : '';
        const bpsOption = document.getElementById('bps-option');
        const bpsCheckbox = document.getElementById('upload-bps');
        if (bpsOption) bpsOption.style.display = (ctx && ctx.form === 'Form 2') ? 'none' : '';
        if (bpsCheckbox) bpsCheckbox.checked = (ctx && ctx.form === 'Form 1') ? true : false;
        const singleWrap = document.getElementById('upload-form2-single');
        const splitWrap = document.getElementById('upload-form1-split');
        if (ctx && ctx.form === 'Form 1'){
          if (singleWrap) singleWrap.style.display = 'none';
          if (splitWrap) splitWrap.style.display = '';
        } else {
          if (singleWrap) singleWrap.style.display = '';
          if (splitWrap) splitWrap.style.display = 'none';
        }
      } catch(_) {}
      fileInput.value = '';
      try { document.getElementById('upload-file-pdfzip').value = ''; } catch(_){}
      try { document.getElementById('upload-file-xlsxzip').value = ''; } catch(_){}
      modal.classList.add('open');
      modal.setAttribute('aria-hidden','false');
    }
    function closeUploadModal(){
      modal.classList.remove('open');
      modal.setAttribute('aria-hidden','true');
      // Re-enable last trigger and reset submit button state
      if (lastOpenTrigger) {
        try {
          lastOpenTrigger.disabled = false;
          if (lastOpenTrigger.classList) lastOpenTrigger.classList.remove('opacity-50','pointer-events-none');
        } catch(_) {}
        lastOpenTrigger = null;
      }
      const sendBtn = document.getElementById('btn-send');
      if (sendBtn) {
        sendBtn.disabled = false;
        sendBtn.textContent = 'G·ª≠i b√°o c√°o';
      }
      isModalSubmitting = false;
    }
    document.getElementById('btn-cancel').onclick = closeUploadModal;
    modal.addEventListener('click', (e)=>{ if(e.target===modal) closeUploadModal(); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && modal.classList.contains('open')) closeUploadModal(); });

    document.getElementById('btn-send').onclick = async ()=>{
      if (isModalSubmitting) return;
      const isForm1 = (uploadContext && uploadContext.form === 'Form 1');
      const btn = document.getElementById('btn-send');
      const bpsCheckbox = document.getElementById('upload-bps');
      const bpsChecked = bpsCheckbox ? bpsCheckbox.checked : false;
      function extOf(name){ const m = String(name||'').toLowerCase().match(/\.([a-z0-9]+)$/); return m?m[1]:''; }
      let fd = new FormData();
      if (isForm1) {
        const pdfInput = document.getElementById('upload-file-pdfzip');
        const xlsxInput = document.getElementById('upload-file-xlsxzip');
        const okPdf = ['pdf','zip','rar','7z'];
        const okXlsx = ['xlsx','zip','rar','7z'];
        if (!pdfInput || !pdfInput.files || pdfInput.files.length===0){ showToast('Vui l√≤ng ch·ªçn file PDF ho·∫∑c file n√©n.','error'); return; }
        const fPdf = pdfInput.files[0];
        const extPdf = extOf(fPdf.name);
        if (okPdf.indexOf(extPdf)===-1){ showToast('File PDF/N√©n kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng.','error'); return; }
        let fXlsx = null;
        if (bpsChecked){
          if (!xlsxInput || !xlsxInput.files || xlsxInput.files.length===0){ showToast('Vui l√≤ng ch·ªçn file Excel ho·∫∑c file n√©n khi g·ª≠i BPS.','error'); return; }
          fXlsx = xlsxInput.files[0];
          const extX = extOf(fXlsx.name);
          if (okXlsx.indexOf(extX)===-1){ showToast('File Excel/N√©n kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng.','error'); return; }
        }
      isModalSubmitting = true;
      if (btn) { btn.disabled = true; btn.innerHTML = "<span class='spinner mr-2'></span>ƒêang g·ª≠i..."; }
        // Append with original field names
        fd.append('file_pdfzip', fPdf);
        if (fXlsx) fd.append('file_xlsxzip', fXlsx);
        // Extra compatibility: duplicate under common field names
        try { fd.append('file', fPdf); } catch(_){ }
        try { if (fXlsx) fd.append('file2', fXlsx); } catch(_){ }
        try { fd.append('files[]', fPdf); } catch(_){ }
        try { if (fXlsx) fd.append('files[]', fXlsx); } catch(_){ }
        fd.append('upload_type', fXlsx ? 'combined' : 'pdf_only');
        fd.append('file_name', fPdf.name || '');
        if (fXlsx) fd.append('file_name_xlsx', fXlsx.name || '');
        fd.append('timestamp', formatDdMmYyyyHHmm(new Date()));
        if(uploadContext){
          fd.append('nguoi_nop', uploadContext.name||'');
          const taskIdVal = uploadContext.taskId || uploadContext.code || '';
          fd.append('ma_tac_vu', taskIdVal);
          fd.append('ten_tac_vu', uploadContext.taskName||'');
          fd.append('form', uploadContext.form||'Form 1');
        }
        if (bpsCheckbox) { fd.append('is_bps', bpsChecked ? '1' : '0'); }
        try{
          try { showToast(`S·∫Ω g·ª≠i ${fXlsx? '2 t·ªáp' : '1 t·ªáp'}: ${fPdf?.name||''}${fXlsx? (', '+(fXlsx.name||'')) : ''}`,'info'); } catch(_){}
          await fetch(FORM1_UPLOAD_URL,{method:'POST',body:fd, mode: 'no-cors'});
          showToast('ƒê√£ g·ª≠i b√°o c√°o.','success');
          closeUploadModal();
        } catch(e){
          console.error(e);
          showToast('G·ª≠i th·∫•t b·∫°i.','error');
          isModalSubmitting = false;
          if (btn) { btn.disabled = false; btn.textContent = 'G·ª≠i b√°o c√°o'; }
        }
        return;
      }
      // Form 2 (gi·ªØ nguy√™n logic upload 1 file)
      if(!fileInput.files || fileInput.files.length===0){ showToast('Vui l√≤ng ch·ªçn t·ªáp b√°o c√°o.','error'); return; }
      isModalSubmitting = true;
      if (btn) { btn.disabled = true; btn.innerHTML = "<span class='spinner mr-2'></span>ƒêang g·ª≠i..."; }
      fd.append('file', fileInput.files[0]);
      fd.append('file_name', fileInput.files[0].name || '');
      fd.append('timestamp', formatDdMmYyyyHHmm(new Date()));
      if(uploadContext){
        fd.append('nguoi_nop', uploadContext.name||'');
        const taskIdVal = uploadContext.taskId || uploadContext.code || '';
        fd.append('ma_tac_vu', taskIdVal);
        fd.append('ten_tac_vu', uploadContext.taskName||'');
        fd.append('form', uploadContext.form||'');
      }
      if (bpsCheckbox) { fd.append('is_bps', bpsChecked ? '1' : '0'); }
      try{
        await fetch(FORM2_UPLOAD_URL,{method:'POST',body:fd, mode: 'no-cors'});
        showToast('ƒê√£ g·ª≠i b√°o c√°o.','success');
        closeUploadModal();
      } catch(e){
        console.error(e);
        showToast('G·ª≠i th·∫•t b·∫°i.','error');
        isModalSubmitting = false;
        if (btn) { btn.disabled = false; btn.textContent = 'G·ª≠i b√°o c√°o'; }
      }
    };

    

    // Helpers for tables
    function addTd(tr, text){ const td=document.createElement('td'); td.className='px-3 py-2 align-top'; td.textContent=text; tr.appendChild(td); }
    // Enable drag-drop reordering on table body rows
    function enableTableDrag(tbodyId){
      try{
        const tbody = document.getElementById(tbodyId);
        if (!tbody) return;
        let dragging = null;
        const onDragStart = (e)=>{ dragging = e.currentTarget; dragging.classList.add('opacity-50'); try{ e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/plain',''); }catch(_){ } };
        const onDragEnd = ()=>{ try{ if (dragging) dragging.classList.remove('opacity-50'); }catch(_){ } dragging = null; try{ tbody.querySelectorAll('tr').forEach(r=> r.classList.remove('drag-over')); }catch(_){ } };
        const onDragOver = (e)=>{ e.preventDefault(); const row = e.target && e.target.closest ? e.target.closest('tr') : null; if (!row || row === dragging) return; try{ tbody.querySelectorAll('tr').forEach(r=> r.classList.remove('drag-over')); row.classList.add('drag-over'); }catch(_){ } };
        const onDrop = (e)=>{ e.preventDefault(); const row = e.target && e.target.closest ? e.target.closest('tr') : null; if (!row || !dragging || row===dragging) { onDragEnd(); return; } try{ tbody.insertBefore(dragging, row.nextSibling); }catch(_){ } onDragEnd(); };
        tbody.querySelectorAll('tr').forEach(tr=>{ try{ tr.setAttribute('draggable','true'); tr.classList.add('cursor-move','select-none'); tr.removeEventListener('dragstart', onDragStart); tr.addEventListener('dragstart', onDragStart); tr.removeEventListener('dragend', onDragEnd); tr.addEventListener('dragend', onDragEnd); }catch(_){ } });
        try{ tbody.removeEventListener('dragover', onDragOver); tbody.addEventListener('dragover', onDragOver); }catch(_){ }
        try{ tbody.removeEventListener('drop', onDrop); tbody.addEventListener('drop', onDrop); }catch(_){ }
      }catch(_){ }
    }
    // Flexible date parser supporting multiple formats
    function parseDateFlexible(v){
      if(!v) return null;
      const s = String(v).trim();
      // DD/MM/YYYY or DD-MM-YYYY or DD.MM.YYYY
      let m = s.match(/^(\d{1,2})[\/.\-](\d{1,2})[\/.\-](\d{2,4})(?:[ T](\d{1,2}):(\d{2})(?::(\d{2}))?)?/);
      if (m){
        const d = +m[1], mo = +m[2], y = m[3].length===2 ? +('20'+m[3]) : +m[3];
        const hh = m[4] ? +m[4] : 0, mm = m[5] ? +m[5] : 0, ss = m[6] ? +m[6] : 0;
        const dt = new Date(y, mo-1, d, hh, mm, ss);
        return isNaN(dt) ? null : dt;
      }
      // YYYY-MM-DD or YYYY/MM/DD
      m = s.match(/^(\d{4})[\/.\-](\d{1,2})[\/.\-](\d{1,2})(?:[ T](\d{1,2}):(\d{2})(?::(\d{2}))?)?/);
      if (m){
        const y = +m[1], mo = +m[2], d = +m[3];
        const hh = m[4] ? +m[4] : 0, mm = m[5] ? +m[5] : 0, ss = m[6] ? +m[6] : 0;
        const dt = new Date(y, mo-1, d, hh, mm, ss);
        return isNaN(dt) ? null : dt;
      }
      const dt = new Date(s);
      return isNaN(dt) ? null : dt;
    }

    // Form 1: fetch via webhook with query for headers/fields
    let F1_ALL_ROWS = [];
    let F1_PAGE = 1;
    let F1_SIZE = 20;
    // Cache b·∫£n r·ªóng ƒë√£ chu·∫©n ho√° cho Form 1 ƒë·ªÉ l·ªçc theo th√°ng v·ªõi Done/Cancel
    let F1_LAST_ITEMS = [];
    function applyForm1Paging(){
      const body = document.getElementById('f1-body');
      const pager = document.getElementById('f1-pager');
      const total = F1_ALL_ROWS.length;
      if(total === 0){
        body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="17">Kh√¥ng c√≥ t√°c v·ª•</td></tr>';
        pager.style.display = 'none';
        return;
      }
      pager.style.display = '';
      const maxPage = Math.max(1, Math.ceil(total / F1_SIZE));
      if(F1_PAGE > maxPage) F1_PAGE = maxPage;
      const start = (F1_PAGE - 1) * F1_SIZE;
      const end = Math.min(total, start + F1_SIZE);
      const slice = F1_ALL_ROWS.slice(start, end);
      const pageInfo = document.getElementById('f1-page-info');
      if(pageInfo) pageInfo.textContent = `Trang ${F1_PAGE}/${maxPage} (${total} d√≤ng)`;
      const prev = document.getElementById('f1-prev');
      const next = document.getElementById('f1-next');
      if(prev) prev.disabled = (F1_PAGE <= 1);
      if(next) next.disabled = (F1_PAGE >= maxPage);
      // render rows
      body.innerHTML = '';
      slice.forEach(tr => body.appendChild(tr));
    }

    function formatYyyyMmSafe(v){ try{ const d = toDateSafe(v); if(!d) return ''; const mm=String(d.getMonth()+1).padStart(2,'0'); return `${d.getFullYear()}-${mm}`; }catch(_){ return ''; } }

    function vnLower(s){
      try{ return String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase(); }catch(_){ return String(s||'').toLowerCase(); }
    }

    function applyForm1MonthFilter(){
      try{
        const monthEl = document.getElementById('f1-month');
        const monthVal = monthEl ? (monthEl.value||'').trim() : '';
        const items = Array.isArray(F1_LAST_ITEMS) ? F1_LAST_ITEMS.slice() : [];
        // Done & Cancel: l·ªçc theo th√°ng (monthVal)
        let partDoneCancel = items.filter(it=> it.isDone || it.isCancel);
        if (monthVal) partDoneCancel = partDoneCancel.filter(it=> it.monthTagReq === monthVal);
        // Doing, Ch·ªù ph√™ duy·ªát, Ch·ªù ph√¢n c√¥ng, Test b·ªÅn: lu√¥n hi·ªÉn th·ªã kh√¥ng ph·ª• thu·ªôc th·ªùi gian
        let partTimeRestricted = items.filter(it=> {
          const s = it.statusNorm || '';
          return s.includes('doing') || s.includes('cho phe duyet') || s.includes('cho phan cong') || s.includes('test ben');
        });
        // ∆Øu ti√™n nh√≥m th·ªùi gian th·ª±c (Doing/Ch·ªù ph√¢n c√¥ng/Test b·ªÅn) l√™n tr∆∞·ªõc
        const filtered = partTimeRestricted.concat(partDoneCancel);
        // Render l·∫°i tbody v√† ph√¢n trang
        const body = document.getElementById('f1-body');
        const pager = document.getElementById('f1-pager');
        if (!filtered.length){
          if (body) body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="17">Kh√¥ng c√≥ t√°c v·ª•</td></tr>';
          if (pager) pager.style.display = 'none';
          F1_ALL_ROWS = [];
          return;
        }
        F1_ALL_ROWS = filtered.map(it=> it.rowEl).filter(Boolean);
        F1_PAGE = 1;
        applyForm1Paging();
      }catch(_){ }
    }

    // Render Form 1 t·ª´ m·∫£ng rows (d√πng cho cache)
    function renderForm1FromRows(rows){
      const body = document.getElementById('f1-body');
      if(!rows || !rows.length){ body.innerHTML = "<tr><td colspan='17' class='px-3 py-3 text-center text-gray-500'>Kh√¥ng c√≥ t√°c v·ª•</td></tr>"; return; }
      const getV = (obj, keys)=>{
        const lower = Object.keys(obj||{}).reduce((acc,k)=>{ acc[k.toLowerCase()] = obj[k]; return acc; },{});
        for(const k of keys){ const v = lower[k.toLowerCase()]; if(v!==undefined) return v; }
        return '';
      };
      function getStatusRank(obj){
        const s = vnLower(getV(obj,['status','trangthai','trang_thai','tr·∫°ng th√°i']) || '');
        if (s.includes('doing') || s.includes('dang')) return 0; // ∆∞u ti√™n cao nh·∫•t
        if (s.includes('cho phan cong') || s.includes('test ben')) return 1; // nh√≥m th·ª© hai
        return 2; // c√≤n l·∫°i
      }
      function getTimeValue(obj){
        const v = getV(obj,[
          'requestdate','ngayyeucau','ngay_yeu_cau','submissiondate','ngaygui','ng√†y y√™u c·∫ßu'
        ]) || getV(obj,[
          'actualdue','handapung','han_dap_ung','completiondate','h·∫°n ƒë√°p ·ª©ng'
        ]) || getV(obj,[
          'wishdue','hanmongmuon','han_mong_muon','desireddue','h·∫°n mong mu·ªën'
        ]);
        const d = parseDateFlexible(v);
        return d ? d.getTime() : 0;
      }
      const rowsSorted = rows.slice().sort((a,b)=>{
        const ra = getStatusRank(a), rb = getStatusRank(b);
        if (ra !== rb) return ra - rb;
        const ta = getTimeValue(a), tb = getTimeValue(b);
        return tb - ta; // m·ªõi nh·∫•t tr∆∞·ªõc
      });
      F1_ALL_ROWS = [];
      F1_LAST_ITEMS = [];
      rowsSorted.forEach(item=>{
        const tr=document.createElement('tr');
        const tdBtn=document.createElement('td'); tdBtn.className='px-3 py-2';
        const code = getV(item,['code','ma','taskcode','m√£']);
        const taskId = getV(item,['taskid','task_id','ma_tac_vu','m√£ t√°c v·ª•','taskcode2','requestid','id']);
        const tname = getV(item,['taskname','ten_tac_vu','ten','name','title','t√™n t√°c v·ª•']);
        const statusText = getV(item,['status','trangthai','trang_thai','tr·∫°ng th√°i']);
        const statusLower = (statusText||'').toLowerCase();
        const isDone = statusLower.includes('ho√†n') || statusLower.includes('done');
        const isCancelled = statusLower.includes('cancel') || statusLower.includes('h·ªßy') || statusLower.includes('hu·ª∑');
        const isPendingApproval = statusLower.includes('ch·ªù ph√™ duy·ªát') || statusLower.includes('cho phe duyet');
        const isEmptyStatus = statusLower.trim()==='';
        const isLocked = isDone || isCancelled || isPendingApproval || isEmptyStatus;
        const isDoing = statusLower.includes('doing') || statusLower.includes('ƒëang');
        const wishDue = getV(item,['wishdue','hanmongmuon','han_mong_muon','desireddue','h·∫°n mong mu·ªën']);
        const actualDue = getV(item,['actualdue','handapung','han_dap_ung','completiondate','h·∫°n ƒë√°p ·ª©ng']);
        const dueStr = actualDue || wishDue || '';
        const dueDate = parseDateFlexible(dueStr);
        if (isDoing && dueDate){
          const today = new Date();
          const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
          const dueDayStart = new Date(dueDate.getFullYear(), dueDate.getMonth(), dueDate.getDate());
          const isSameDay = dueDayStart.getTime() === todayStart.getTime();
          const isPast = dueDayStart.getTime() < todayStart.getTime();
          try { if (isSameDay) { tr.style.backgroundColor = '#fef3c7'; } else if (isPast) { tr.style.backgroundColor = '#fee2e2'; } } catch(_){}
        }
        const labelBtn = document.createElement('button');
        if (isLocked) {
          labelBtn.disabled = true;
          labelBtn.className = 'px-3 py-1 inline-block rounded-lg bg-gray-300 text-gray-500 cursor-not-allowed opacity-60';
          labelBtn.textContent = isCancelled ? 'ƒê√£ h·ªßy' : (isDone ? 'ƒê√£ ho√†n th√†nh' : (isPendingApproval ? 'Ch·ªù ph√™ duy·ªát' : 'Kh√¥ng th·ªÉ g·ª≠i'));
          labelBtn.title = labelBtn.textContent;
        } else {
          labelBtn.className = 'px-3 py-1 inline-block rounded-lg text-white bg-primary-blue hover:brightness-105 cursor-pointer';
          labelBtn.textContent = 'Tr·∫£ b√°o c√°o';
          labelBtn.onclick = (e)=>{ e.preventDefault(); if (labelBtn.disabled) return; labelBtn.disabled=true; labelBtn.classList.add('opacity-50','pointer-events-none'); lastOpenTrigger = labelBtn; const name=(document.getElementById('f1-name')?.value||'').trim(); openUploadModal({ form: 'Form 1', name, code, taskId, taskName: tname }); };
        }
        tdBtn.appendChild(labelBtn);
        tr.appendChild(tdBtn);
        const tdStatus=document.createElement('td'); tdStatus.className='px-3 py-2';
        const s=(statusText||'').toLowerCase();
        const badge=document.createElement('span');
        let badgeClass = 'bg-blue-100 text-blue-800';
        if (s.includes('ch·ªù ph√™ duy·ªát') || s.includes('cho phe duyet')) badgeClass = 'bg-orange-100 text-orange-800';
        else if (s.includes('ho√†n') || s.includes('done')) badgeClass = 'bg-green-100 text-green-800';
        else if (s.includes('cancel') || s.includes('h·ªßy') || s.includes('hu·ª∑') || s.includes('ch·ªù') || s.includes('pending')) badgeClass = 'bg-yellow-100 text-yellow-800';
        badge.className='px-2 py-1 rounded text-xs ' + badgeClass; badge.textContent=statusText||''; tdStatus.appendChild(badge); tr.appendChild(tdStatus);
        addTd(tr, code);
        addTd(tr, tname);
        addTd(tr, getV(item,['requester','nguoiyeucau','nguoi_yeu_cau','assigner','ng∆∞·ªùi y√™u c·∫ßu']));
        addTd(tr, getV(item,['receiver','receivername','nguoinhanmau','nguoi_nhan_mau','ng∆∞·ªùi nh·∫≠n m·∫´u','recipient','assignee','ng∆∞·ªùi nh·∫≠n']));
        addTd(tr, getV(item,[ 'manhour','man_hour','congchuan','cong_chuan','workload','sogio','sogiocong','c√¥ng chu·∫©n' ]));
        const requestDateStr = getV(item,['requestdate','ngayyeucau','ngay_yeu_cau','submissiondate','ngaygui','ng√†y y√™u c·∫ßu']);
        addTd(tr, requestDateStr);
        addTd(tr, getV(item,['wishdue','hanmongmuon','han_mong_muon','desireddue','h·∫°n mong mu·ªën']));
        addTd(tr, getV(item,['actualdue','handapung','han_dap_ung','completiondate','h·∫°n ƒë√°p ·ª©ng']));
        addTd(tr, getV(item,['purpose','mucdich','muc_dich','m·ª•c ƒë√≠ch ƒë√°nh gi√°','muc dich danh gia','mucdichdanhgia']));
        addTd(tr, getV(item,['note','ghi_chu','ghichu']));
        addTd(tr, getV(item,['specialtest','yeucau_test_dac_biet','yeu_cau_test_dac_biet']));
        addTd(tr, getV(item,['reportform','form_bao_cao','form_bao_cao_danh_gia']));
        const attachmentName = getV(item,[ 'attachmentfilename','file_name','filename','tenfile','ten_file','t√™n file','t√™n file ƒë√≠nh k√®m','attachment','file' ]);
        addTd(tr, attachmentName);
        const tdDl = document.createElement('td'); tdDl.className='px-3 py-2';
        const url = getV(item,[ 'attachmenturl','attachment_url','fileurl','file_url','downloadurl','download_url','link','url' ]);
        if (url) { const a = document.createElement('a'); a.href = url; a.target = '_blank'; a.rel = 'noopener'; a.className = 'px-3 py-1 inline-block rounded-lg text-white bg-primary-blue hover:brightness-105'; a.textContent = 'T·∫£i v·ªÅ'; tdDl.appendChild(a); }
        else { const btn = document.createElement('button'); btn.disabled = true; btn.className = 'px-3 py-1 inline-block rounded-lg bg-gray-300 text-gray-500 cursor-not-allowed opacity-60'; btn.textContent = 'Kh√¥ng c√≥ link'; tdDl.appendChild(btn); }
        tr.appendChild(tdDl);
        addTd(tr, taskId);
        F1_ALL_ROWS.push(tr);
        const statusNorm = vnLower(statusText);
        const monthTagReq = formatYyyyMmSafe(requestDateStr);
        F1_LAST_ITEMS.push({ rowEl: tr, statusNorm, monthTagReq, requestDateRaw: requestDateStr, isDone, isCancel: isCancelled });
      });
      applyForm1Paging();
      try{ applyForm1MonthFilter(); }catch(_){ }
    }

    async function renderForm1(){
      const name = (document.getElementById('f1-name').value || '').trim();
      const body = document.getElementById('f1-body');
      if(!name){ body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="17">Vui l√≤ng ch·ªçn t√™n</td></tr>'; return; }
      body.innerHTML = "<tr><td colspan='17' class='px-3 py-3 text-center text-gray-500'><span class='spinner mr-2'></span>ƒêang t·∫£i...</td></tr>";
      try{
          const headerMapF1 = {
          header_btn: 'N√∫t nh·∫≠p g·ª≠i b√°o c√°o',
          header_requester: 'Ng∆∞·ªùi y√™u c·∫ßu',
          header_requestDate: 'Ng√†y y√™u c·∫ßu',
          header_wishDue: 'H·∫°n mong mu·ªën',
          header_actualDue: 'H·∫°n ƒë√°p ·ª©ng',
          header_code: 'M√£',
          header_taskId: 'M√£ t√°c v·ª•',
          header_taskName: 'T√™n t√°c v·ª•',
          header_receiverSample: 'Ng∆∞·ªùi nh·∫≠n m·∫´u',
          header_manHour: 'C√¥ng chu·∫©n',
          header_purpose: 'M·ª•c ƒë√≠ch ƒë√°nh gi√°',
          header_note: 'Note',
          header_specialTest: 'Y√™u c·∫ßu test ƒë·∫∑c bi·ªát',
          header_reportForm: 'Form b√°o c√°o ƒë√°nh gi√°',
          header_status: 'Tr·∫°ng th√°i',
          header_attachmentFileName: 'T√™n file ƒë√≠nh k√®m',
          header_attachmentUrl: 'T·∫£i ƒë√≠nh k√®m',
          field_requester: 'requester',
          field_requestDate: 'requestDate',
          field_wishDue: 'wishDue',
          field_actualDue: 'actualDue',
          field_code: 'code',
          field_taskId: 'taskId',
          field_taskName: 'taskName',
          field_receiverSample: 'receiverSample',
          field_manHour: 'manHour',
          field_purpose: 'purpose',
          field_note: 'note',
          field_specialTest: 'specialTest',
          field_reportForm: 'reportForm',
          field_status: 'status',
          field_attachmentFileName: 'attachmentFileName',
          field_attachmentUrl: 'attachmentUrl'
        };
        const params = new URLSearchParams({
          ...headerMapF1,
          action: 'form1_lookup',
          person_name: name,
          timestamp: new Date().toISOString()
        });
        const testUrl = `${WEBHOOK_URL}?${params.toString()}`;
        async function fetchJson(url){
          const r = await fetch(url, { method: 'GET' });
          const text = await r.text();
          if(!r.ok) throw new Error(text || `HTTP ${r.status}`);
          let parsed = null; try{ parsed = JSON.parse(text); }catch{ parsed = null; }
          return { parsed, raw: text };
        }
        let data = null; let firstErr = null;
        try{
          const { parsed, raw } = await fetchJson(testUrl);
          if (parsed && parsed.code === 0 && /could not be started/i.test(String(parsed.message||''))) {
            throw new Error('WEBHOOK_TEST_INACTIVE');
          }
          data = parsed ?? raw;
        } catch (e) {
          firstErr = e;
          // Fallback sang production webhook khi test webhook ch∆∞a b·∫≠t l·∫Øng nghe
          const prodUrl = testUrl.replace('/webhook-test/', '/webhook/');
          const { parsed, raw } = await fetchJson(prodUrl);
          data = parsed ?? raw;
        }
        function pickRows(json){
          if (!json) return [];
          if (Array.isArray(json)) return json;
          const candidates = ['data','rows','result','records','items','list'];
          for (const k of candidates){ if (Array.isArray(json?.[k])) return json[k]; }
          // Deep search first array of objects
          try{
            const queue = [json];
            const seen = new Set();
            while(queue.length){
              const cur = queue.shift();
              if (!cur || typeof cur !== 'object' || seen.has(cur)) continue;
              seen.add(cur);
              for (const v of Object.values(cur)){
                if (Array.isArray(v) && v.length && typeof v[0] === 'object') return v;
                if (v && typeof v === 'object') queue.push(v);
              }
            }
          }catch(_){ }
          return [];
        }
        const rows = pickRows(data);
        if(!rows.length){ body.innerHTML = "<tr><td colspan='17' class='px-3 py-3 text-center text-gray-500'>Kh√¥ng c√≥ t√°c v·ª•</td></tr>"; return; }
        // Cache v√† timestamp
        try{ LS.setJSON('f1.cache', { name, rows }); LS.set('f1.lastUpdated', String(Date.now())); updateLastUpdatedNote('f1-search','f1.lastUpdated'); }catch(_){ }
        renderForm1FromRows(rows);
      }catch(err){
        body.innerHTML = `<tr><td colspan='17' class='px-3 py-3 text-center text-red-600'>L·ªói t·∫£i d·ªØ li·ªáu: ${String(err.message||err)}</td></tr>`;
      }
    }
    document.getElementById('f1-name').onchange = ()=>{};
    // T·ª± kh·ªüi t·∫°o t·ª´ cache n·∫øu c√≥
    (function initF1FromCache(){
      try{
        const cached = LS.getJSON('f1.cache');
        const cachedName = LS.get('f1.selectedName')||'';
        if (!cached || !cached.rows || !cachedName) return;
        const sel = document.getElementById('f1-name');
        if (sel && (!sel.value)) sel.value = cachedName;
        renderForm1FromRows(cached.rows);
        updateLastUpdatedNote('f1-search','f1.lastUpdated');
      }catch(_){ }
    })();
    const f1SearchBtn = document.getElementById('f1-search');
    if (f1SearchBtn) {
      let f1Busy = false;
      f1SearchBtn.onclick = async (e)=>{
        e.preventDefault();
        if (f1Busy) return;
        f1Busy = true;
        f1SearchBtn.disabled = true;
        const prev = f1SearchBtn.textContent;
        f1SearchBtn.innerHTML = "<span class='spinner mr-2'></span>ƒêang t·∫£i...";
        try { await renderForm1(); }
        finally {
          f1Busy = false;
          f1SearchBtn.disabled = false;
          f1SearchBtn.textContent = prev;
        }
      };
    }
    // Pagination events
    const f1Prev = document.getElementById('f1-prev');
    const f1Next = document.getElementById('f1-next');
    const f1Size = document.getElementById('f1-size');
    if (f1Prev) f1Prev.onclick = (e)=>{ e.preventDefault(); if(F1_PAGE>1){ F1_PAGE--; applyForm1Paging(); } };
    if (f1Next) f1Next.onclick = (e)=>{ e.preventDefault(); F1_PAGE++; applyForm1Paging(); };
    if (f1Size) f1Size.onchange = (e)=>{ F1_SIZE = parseInt(e.target.value||'20',10)||20; F1_PAGE=1; applyForm1Paging(); };
    // Default month and change handler for Form 1 filter (Done/Cancel)
    (function initF1Month(){
      const m = document.getElementById('f1-month');
      if (!m) return;
      const d = new Date();
      const yy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      if (!m.value) m.value = `${yy}-${mm}`;
      if (!m._bound){ m.addEventListener('change', ()=> applyForm1MonthFilter()); m._bound = true; }
    })();

    // Form 2 rendering
    async function renderForm2(){
      const name = (document.getElementById('f2-name').value || '').trim();
      const body = document.getElementById('f2-body');
      if(!name){ body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="6">Vui l√≤ng ch·ªçn t√™n</td></tr>'; return; }
      body.innerHTML = "<tr><td colspan='6' class='px-3 py-3 text-center text-gray-500'><span class='spinner mr-2'></span>ƒêang t·∫£i...</td></tr>";
      try{
        const headerMapF2 = {
          header_requestDate: 'Ng√†y y√™u c·∫ßu',
          header_wishDue: 'H·∫°n mong mu·ªën',
          header_actualDue: 'H·∫°n ƒë√°p ·ª©ng',
          header_code: 'M√£',
          header_taskName: 'T√™n t√°c v·ª•',
          field_requestDate: 'requestDate',
          field_wishDue: 'wishDue',
          field_actualDue: 'actualDue',
          field_code: 'code',
          field_taskName: 'taskName'
        };
        const params = new URLSearchParams({
          ...headerMapF2,
          action: 'form2_lookup',
          person_name: name,
          timestamp: new Date().toISOString()
        });
        const url = `${FORM2_LOOKUP_URL}?${params.toString()}`;
        const resp = await fetch(url, { method: 'GET' });
        const text = await resp.text();
        if(!resp.ok) throw new Error(text || `HTTP ${resp.status}`);
        let data = null; try{ data = JSON.parse(text);}catch{ data = null; }
        function pickRows(json){
          if (!json) return [];
          if (Array.isArray(json)) return json;
          const candidates = ['data','rows','result','records','items','list'];
          for (const k of candidates){ if (Array.isArray(json?.[k])) return json[k]; }
          try{
            const queue=[json]; const seen=new Set();
            while(queue.length){ const cur=queue.shift(); if(!cur||typeof cur!=='object'||seen.has(cur)) continue; seen.add(cur); for(const v of Object.values(cur)){ if(Array.isArray(v)&&v.length&&typeof v[0]==='object') return v; if(v&&typeof v==='object') queue.push(v);} }
          }catch(_){ }
          return [];
        }
        const rows = pickRows(data);
        if(!rows.length){ body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="6">Kh√¥ng c√≥ t√°c v·ª•.</td></tr>'; return; }
        const getV = (obj, keys)=>{
          const lower = Object.keys(obj||{}).reduce((acc,k)=>{ acc[k.toLowerCase()] = obj[k]; return acc; },{});
          for(const k of keys){ const v = lower[k.toLowerCase()]; if(v!==undefined) return v; }
          return '';
        };
        // Cache v√† timestamp
        try{ LS.setJSON('f2.cache', { name, rows }); LS.set('f2.lastUpdated', String(Date.now())); updateLastUpdatedNote('f2-search','f2.lastUpdated'); }catch(_){ }
        body.innerHTML='';
        rows.forEach(item=>{
          const tr=document.createElement('tr');
          const requestDate = getV(item,['requestdate','ngayyeucau','ngay_yeu_cau','submissiondate','ngaygui','ng√†y y√™u c·∫ßu']);
          const wishDue = getV(item,['wishdue','hanmongmuon','han_mong_muon','desireddue','h·∫°n mong mu·ªën']);
          const actualDue = getV(item,['actualdue','handapung','han_dap_ung','completiondate','h·∫°n ƒë√°p ·ª©ng']);
          const code = getV(item,['code','ma','taskcode','m√£']);
          const taskName = getV(item,['taskname','ten_tac_vu','ten','name','title','t√™n t√°c v·ª•']);
          addTd(tr, requestDate);
          addTd(tr, wishDue);
          addTd(tr, actualDue);
          addTd(tr, code);
          addTd(tr, taskName);
          const tdBtn=document.createElement('td'); tdBtn.className='px-3 py-2';
          const btn=document.createElement('button'); btn.className='px-3 py-1 rounded-lg text-white bg-primary-blue hover:brightness-105'; btn.textContent='Tr·∫£ form b√°o c√°o';
          btn.onclick=(e)=>{
            e.preventDefault();
            if (btn.disabled) return;
            btn.disabled = true;
            btn.classList.add('opacity-50','pointer-events-none');
            lastOpenTrigger = btn;
            openUploadModal({form:'Form 2', name, code, taskName});
          };
          tdBtn.appendChild(btn); tr.appendChild(tdBtn);
          body.appendChild(tr);
        });
      }catch(err){
        body.innerHTML = `<tr><td colspan='6' class='px-3 py-3 text-center text-red-600'>L·ªói t·∫£i d·ªØ li·ªáu: ${String(err.message||err)}</td></tr>`;
      }
    }
    document.getElementById('f2-name').onchange = ()=>{};
    // Hi·ªÉn th·ªã t·ª´ cache Form 2 n·∫øu c√≥
    (function initF2FromCache(){
      try{
        const cached = LS.getJSON('f2.cache');
        const name = LS.get('f2.selectedName')||'';
        if (!cached || !Array.isArray(cached.rows) || !name) return;
        const body = document.getElementById('f2-body');
        if (!body) return;
        body.innerHTML='';
        const rows = cached.rows;
        const getV = (obj, keys)=>{ const lower = Object.keys(obj||{}).reduce((acc,k)=>{ acc[k.toLowerCase()] = obj[k]; return acc; },{}); for(const k of keys){ const v = lower[k.toLowerCase()]; if(v!==undefined) return v; } return ''; };
        rows.forEach(item=>{
          const tr=document.createElement('tr');
          const requestDate = getV(item,['requestdate','ngayyeucau','ngay_yeu_cau','submissiondate','ngaygui','ng√†y y√™u c·∫ßu']);
          const wishDue = getV(item,['wishdue','hanmongmuon','han_mong_muon','desireddue','h·∫°n mong mu·ªën']);
          const actualDue = getV(item,['actualdue','handapung','han_dap_ung','completiondate','h·∫°n ƒë√°p ·ª©ng']);
          const code = getV(item,['code','ma','taskcode','m√£']);
          const taskName = getV(item,['taskname','ten_tac_vu','ten','name','title','t√™n t√°c v·ª•']);
          addTd(tr, requestDate);
          addTd(tr, wishDue);
          addTd(tr, actualDue);
          addTd(tr, code);
          addTd(tr, taskName);
          const tdBtn=document.createElement('td'); tdBtn.className='px-3 py-2';
          const btn=document.createElement('button'); btn.className='px-3 py-1 rounded-lg text-white bg-primary-blue hover:brightness-105'; btn.textContent='Tr·∫£ form b√°o c√°o';
          btn.onclick=(e)=>{ e.preventDefault(); if (btn.disabled) return; btn.disabled = true; btn.classList.add('opacity-50','pointer-events-none'); lastOpenTrigger = btn; openUploadModal({form:'Form 2', name, code, taskName}); };
          tdBtn.appendChild(btn); tr.appendChild(tdBtn);
          body.appendChild(tr);
        });
        updateLastUpdatedNote('f2-search','f2.lastUpdated');
      }catch(_){ }
    })();
    const f2SearchBtn = document.getElementById('f2-search');
    if (f2SearchBtn) {
      let f2Busy = false;
      f2SearchBtn.onclick = async (e)=>{
        e.preventDefault();
        if (f2Busy) return;
        f2Busy = true;
        f2SearchBtn.disabled = true;
        const prev = f2SearchBtn.textContent;
        f2SearchBtn.innerHTML = "<span class='spinner mr-2'></span>ƒêang t·∫£i...";
        try { await renderForm2(); }
        finally {
          f2Busy = false;
          f2SearchBtn.disabled = false;
          f2SearchBtn.textContent = prev;
        }
      };
    }
    // Clear button removed per request

    // Form 3 logic
    function setRqTime(){ const d=new Date(); const el=document.getElementById('rq-time'); if (el) el.value = formatDdMmYyyyHHmm(d); }
    setRqTime();
    // Default Form 4 month = current month
    (function setDefaultF4Month(){
      const m = document.getElementById('f4-month');
      if (!m) return;
      const d = new Date();
      const yy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      if (!m.value) m.value = `${yy}-${mm}`;
    })();
    // Helper: set default date for Form 5 inputs
    function setF5DateDefault(){
      const el = document.getElementById('f5-date');
      if (!el) return;
      const d = new Date();
      const pad = n=>String(n).padStart(2,'0');
      el.value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }

    // Form 3: preview selected file (send with form later via webhook)
    (function setupForm3UploadPreview(){
      const fileInput = document.getElementById('attach');
      const list = document.getElementById('f3-upload-list');
      if (!fileInput || !list) return;
      list.innerHTML = '';
      function renderPreview(file){
        const row = document.createElement('div');
        row.className = "flex items-center justify-between p-2 bg-blue-50 rounded";
        row.innerHTML = `<span>üìÑ<span class="ml-2">${file.name}</span></span><span class="text-xs text-blue-700">S·∫Ω g·ª≠i k√®m khi giao vi·ªác</span>`;
        list.innerHTML = '';
        list.appendChild(row);
      }
      fileInput.addEventListener('change', function(){
        list.innerHTML = '';
        if (!this.files || this.files.length === 0) return;
        renderPreview(this.files[0]);
      });
    })();

    // Submit Form 3 via webhook endpoint (multipart form-data)
    document.getElementById('assign-form').onsubmit = async (e)=>{
      e.preventDefault();
      const requester = document.getElementById('rq-by').value.trim();
      const requesterEmail = (document.getElementById('rq-by-email')?.value || '').trim();
      const taskName = (document.getElementById('task-name')?.value || '').trim();
      const rqTime = document.getElementById('rq-time').value;
      const manHourRaw = document.getElementById('man-hour').value;
      const output = document.getElementById('output').value.trim();
      const assignee = (document.getElementById('f3-assignee').value || '').trim();
      const deadline = document.getElementById('deadline').value;
      const odooJira = document.getElementById('odoo-jira').value.trim();

      if(!requester || !taskName || !output || !manHourRaw || !assignee){ showToast('Vui l√≤ng ƒëi·ªÅn ƒë·ªß tr∆∞·ªùng b·∫Øt bu·ªôc.','error'); return; }
      if(!/^\d+(\.\d{1,2})?$/.test(manHourRaw)){ showToast('C√¥ng chu·∫©n t·ªëi ƒëa 2 ch·ªØ s·ªë th·∫≠p ph√¢n.','error'); return; }

      const btn = e.target.querySelector('button[type="submit"]');
      const prev = btn ? btn.textContent : '';
      if (btn) { btn.disabled = true; btn.innerHTML = "<span class='spinner mr-2'></span>ƒêang g·ª≠i..."; }

      const mapped = {
        requesterName: requester,
        requesterEmail: requesterEmail,
        requestDate: formatDdMmYyyyHHmm(rqTime || new Date()),
        itemName: taskName,
        Score: String(manHourRaw || '').trim(),
        changeReq: output,
        Assignee: assignee,
        desiredDate: deadline ? formatDdMmYyyy(deadline) : '',
        Odoojira: odooJira,
        deptRequest: 'DQA'
      };

      const fd = new FormData();
      Object.entries(mapped).forEach(([k,v])=> fd.append(k, v));
      const fileEl = document.getElementById('attach');
      if (fileEl && fileEl.files && fileEl.files.length){
        const f = fileEl.files[0];
        try { fd.append('file', f, f.name); } catch(_){ fd.append('file', f); }
      }

      try{
        let resp = await fetch(FORM3_ENDPOINT, { method: 'POST', body: fd });
        if (!resp.ok) {
          // Fallback: send JSON
          const r2 = await fetch(FORM3_ENDPOINT, { method:'POST', headers:{'Content-Type':'application/json','Accept':'application/json'}, body: JSON.stringify({ data: [mapped] }) });
          if (!r2.ok) {
            const t = await r2.text();
            throw new Error(t || `HTTP ${r2.status}`);
          }
        }
        showToast('ƒê√£ giao vi·ªác v√† g·ª≠i d·ªØ li·ªáu.','success');
        e.target.reset();
        setRqTime();
        try{ const list = document.getElementById('f3-upload-list'); if (list) list.innerHTML = ''; }catch(_){ }
      }catch(err){
        console.error(err);
        showToast('G·ª≠i th·∫•t b·∫°i.','error');
      }finally{
        if (btn) { btn.disabled = false; btn.textContent = prev || 'Giao vi·ªác'; }
      }
    };

    // ===== Form 4: filter popover & selection =====
    let F4_SELECTED_NAMES = new Set();
    let F4_ALL_NAMES = [];

    // Form 4: cache d·ªØ li·ªáu ƒë·ªÉ l·ªçc client-side (kh√¥ng refetch khi b·∫•m n√∫t nh√≥m)
    let F4_LAST_NORMALIZED = [];
    let F4_LAST_MERGED = [];
    let F4_COUNTS_BY_NAME = new Map();
    let F4_LAST_PARAMS = { status: '', from: '', to: '', month: '' };

    // Predefined groups for Form 4 filters
    // Lo·∫°i b·ªè: H√† M·ªπ Linh, ƒê·ªó Th·∫ø C∆∞·ªùng, L√™ Th·ªã Thanh Nh√†n
    const F4_EXCLUDED = new Set(["H√† M·ªπ Linh","ƒê·ªó Th·∫ø C∆∞·ªùng","L√™ Th·ªã Thanh Nh√†n"]);
    const F4_GROUP_LINH = [
      "B√πi ƒê·∫∑ng Qu·ªëc Huy","Nguy·ªÖn H·ªØu Th·ªãnh","Tr·∫ßn Hi·∫øu Nghƒ©a","L·∫°i Qu·ªëc L·ªôc",
      "L√™ Ng·ªçc √Ånh","L√™ VƒÉn S∆°n","Nguy·ªÖn Th·ªã Hi·ªÅn","Ph·∫°m Th·ªã Minh"
    ];
    const F4_GROUP_HIEU = [
      "ƒê·ªó Quang Long","Ph·∫°m Th√†nh Trung Ki√™n","Th√°i Th·ªã Giang",
      "V≈© Th·ªã H·∫±ng","ƒê√†o Tu·∫•n K·ª≥","L√™ Th·ªã Th·∫£o","V≈© Th·ªã Thanh Hi·ªÅn"
    ];
    function f4SetGroupSelection(names){
      if (!names || names.length === 0) {
        F4_SELECTED_NAMES.clear();
      } else {
        F4_SELECTED_NAMES = new Set(names);
      }
      // L·ªçc c·ª•c b·ªô t·ª´ cache, kh√¥ng g·ªçi server
      renderForm4Local();
      try { renderF4Pivot(); } catch(_) {}
    }
    function f4UpdateGroupButtonsUI(){
      const btnAll = document.getElementById('f4-btn-all');
      const btnLinh = document.getElementById('f4-btn-linh');
      const btnHieu = document.getElementById('f4-btn-hieu');
      const reset = (btn)=>{ if(!btn) return; btn.classList.remove('bg-primary-blue','text-white'); btn.classList.add('bg-blue-50/30','text-primary-blue'); };
      const active = (btn)=>{ if(!btn) return; btn.classList.add('bg-primary-blue','text-white'); btn.classList.remove('bg-blue-50/30','text-primary-blue'); };
      reset(btnAll); reset(btnLinh); reset(btnHieu);
      const setEq = (a,b)=>{ if(a.size!==b.size) return false; for(const v of a){ if(!b.has(v)) return false; } return true; };
      const setLinh = new Set(F4_GROUP_LINH);
      const setHieu = new Set(F4_GROUP_HIEU);
      if (F4_SELECTED_NAMES.size === 0) active(btnAll);
      else if (setEq(F4_SELECTED_NAMES, setLinh)) active(btnLinh);
      else if (setEq(F4_SELECTED_NAMES, setHieu)) active(btnHieu);
    }

    function f4BuildFilterList(names){
      const list = document.getElementById('f4-filter-list');
      if (!list) return;
      list.innerHTML = '';
      const uniq = Array.from(new Set(names)).sort((a,b)=> a.localeCompare(b,'vi'));
      uniq.forEach(n=>{
        const safe = n.replace(/"/g,'&quot;');
        const checked = (F4_SELECTED_NAMES.size===0) || F4_SELECTED_NAMES.has(n);
        const row = document.createElement('label');
        row.className = 'flex items-center gap-2';
        row.setAttribute('data-name', n);
        row.innerHTML = `<input type="checkbox" value="${safe}" class="f4-filter-item h-4 w-4" ${checked?'checked':''}/><span>${safe}</span>`;
        list.appendChild(row);
      });
    }
    function f4SyncSelectionFromUI(){
      const list = document.getElementById('f4-filter-list');
      if (!list) return;
      const boxes = list.querySelectorAll('input.f4-filter-item');
      const picked = [];
      boxes.forEach(b=>{ if (b.checked) picked.push(b.value); });
      if (picked.length === boxes.length || picked.length === 0) {
        F4_SELECTED_NAMES.clear();
      } else {
        F4_SELECTED_NAMES = new Set(picked);
      }
    }
    (function f4InitFilterPopover(){
      const btn = document.getElementById('f4-filter-toggle');
      const pop = document.getElementById('f4-filter-pop');
      const list = document.getElementById('f4-filter-list');
      const search = document.getElementById('f4-filter-search');
      const selAll = document.getElementById('f4-filter-select-all');
      const clear = document.getElementById('f4-filter-clear');
      const applyBtn = document.getElementById('f4-filter-apply');
      if (!btn || !pop) return;
      btn.addEventListener('click', (e)=>{ e.preventDefault(); pop.classList.toggle('hidden'); if(!pop.classList.contains('hidden')){ try{ search&&search.focus(); }catch(_){} }});
      document.addEventListener('click', (e)=>{ if (!pop || pop.classList.contains('hidden')) return; if (btn.contains(e.target) || pop.contains(e.target)) return; pop.classList.add('hidden'); });
      if (list) list.addEventListener('change', (e)=>{ /* kh√¥ng auto render khi tick */ });
      if (search) search.addEventListener('input', (e)=>{
        const q = (e.target.value||'').toLowerCase().trim();
        pop.querySelectorAll('label[data-name]').forEach(el=>{
          const nm = (el.getAttribute('data-name')||'').toLowerCase();
          el.style.display = nm.includes(q) ? '' : 'none';
        });
      });
      if (selAll) selAll.addEventListener('click',(e)=>{ e.preventDefault(); pop.querySelectorAll('input.f4-filter-item').forEach(cb=> cb.checked=true); });
      if (clear) clear.addEventListener('click',(e)=>{ e.preventDefault(); pop.querySelectorAll('input.f4-filter-item').forEach(cb=> cb.checked=false); });
      if (applyBtn) applyBtn.addEventListener('click',(e)=>{ e.preventDefault(); f4SyncSelectionFromUI(); pop.classList.add('hidden'); renderForm4(); f4SchedulePivot(); f4UpdateGroupButtonsUI(); });
    })();

    // Helper: ƒë·∫øm s·ªë t√°c v·ª• theo ng∆∞·ªùi v·ªõi filter tr·∫°ng th√°i
    async function f4FetchTaskCount(name, statusVal, fromVal, toVal){
      const headerMapF1 = {
        header_code: 'M√£',
        header_taskName: 'T√™n t√°c v·ª•',
        header_status: 'Tr·∫°ng th√°i',
        field_code: 'code',
        field_taskName: 'taskName',
        field_status: 'status'
      };
      const params = new URLSearchParams({
        ...headerMapF1,
        action: 'form1_lookup',
        person_name: name,
        timestamp: new Date().toISOString()
      });
      if (fromVal) params.append('from', fromVal);
      if (toVal) params.append('to', toVal);
      async function fetchJson(url){
        const r = await fetch(url, { method: 'GET' });
        const text = await r.text();
        let parsed = null; try{ parsed = JSON.parse(text); }catch{ parsed = null; }
        return { ok: r.ok, parsed, raw: text, status: r.status };
      }
      function pickRows(json){
        if (!json) return [];
        if (Array.isArray(json)) return json;
        const candidates = ['data','rows','result','records','items','list'];
        for (const k of candidates){ if (Array.isArray(json?.[k])) return json[k]; }
        try{
          const queue=[json]; const seen=new Set();
          while(queue.length){
            const cur=queue.shift(); if(!cur||typeof cur!=='object'||seen.has(cur)) continue; seen.add(cur);
            for (const v of Object.values(cur)){
              if (Array.isArray(v) && v.length && typeof v[0]==='object') return v;
              if (v && typeof v==='object') queue.push(v);
            }
          }
        }catch(_){}
        return [];
      }
      function getV(obj, keys){
        const lower = Object.keys(obj||{}).reduce((acc,k)=>{ acc[k.toLowerCase()] = obj[k]; return acc; },{});
        for(const k of keys){ const v = lower[k.toLowerCase()]; if(v!==undefined) return v; }
        return '';
      }
      try{
        const testUrl = `${WEBHOOK_URL}?${params.toString()}`;
        let first = await fetchJson(testUrl);
        if (!first.ok || (first.parsed && first.parsed.code === 0 && /could not be started/i.test(String(first.parsed.message||'')))){
          const prodUrl = testUrl.replace('/webhook-test/', '/webhook/');
          first = await fetchJson(prodUrl);
        }
        if (!first.ok) return 0;
        let rows = pickRows(first.parsed ?? (first.raw ? JSON.parse(first.raw) : null));
        if (statusVal === 'Doing'){
          rows = rows.filter(item=>{
            const s = String(getV(item,['status','trangthai','trang_thai','tr·∫°ng th√°i'])||'').toLowerCase();
            return s.includes('doing') || s.includes('ƒëang');
          });
        }
        return rows.length;
      }catch(_){ return 0; }
    }

    // Form 4 logic: GET Doing data and render two columns
    async function renderForm4(){
      const body = document.getElementById('f4-body');
      const bodyAll = document.getElementById('f4-body-all');
      const chartWrap = document.getElementById('f4-chart-container');
      if (chartWrap) chartWrap.style.display = 'none';
      if (F4_CHART) { try { F4_CHART.destroy(); } catch(_) {} F4_CHART = null; }
      const statusSelEl = document.getElementById('f4-status');
      const statusValPreview = statusSelEl ? statusSelEl.value : 'Doing';
      const colSpan = (statusValPreview === 'All') ? 10 : 3;
      body.innerHTML = `<tr><td colspan='${colSpan}' class='px-3 py-3 text-center text-gray-500'><span class='spinner mr-2'></span>ƒêang t·∫£i...</td></tr>`;
      try{
        const urlTest = 'https://iatzhxxuk.tino.page/webhook/9cdcf54b-f98f-42b8-ab15-824d5b6da050';
        const urlProd = urlTest.replace('/webhook-test/', '/webhook/');
        const params = new URLSearchParams();
        const statusEl = document.getElementById('f4-status');
        const statusVal = (statusEl && statusEl.value) ? statusEl.value : 'Doing';
        params.append('status', statusVal);
        // Date range filter -> from month
        const monthInput = document.getElementById('f4-month');
        const monthVal = (monthInput && monthInput.value) ? monthInput.value : '';
        let fromVal = '';
        let toVal = '';
        if (monthVal) {
          try{
            const [yy, mm] = monthVal.split('-');
            const firstDay = `${yy}-${mm}-01`;
            const lastDate = new Date(Number(yy), Number(mm), 0).getDate();
            const lastDay = `${yy}-${mm}-${String(lastDate).padStart(2,'0')}`;
            fromVal = firstDay; toVal = lastDay;
          }catch(_){ }
        }
        if (fromVal) params.append('from', fromVal);
        if (toVal) params.append('to', toVal);
        // Query mapping for 2 output columns
        params.append('header_employee', 'Nh√¢n vi√™n');
        params.append('header_current_manhour', 'C√¥ng chu·∫©n hi·ªán t·∫°i');
        params.append('field_employee', 'employee');
        params.append('field_current_manhour', 'manhour');
        params.append('header_task_count', 'S·ªë t√°c v·ª• trong th√°ng');
        params.append('field_task_count', 'taskCount');
        params.append('_ts', Date.now().toString());
        // Debug: log the exact URL being requested
        try { console.log('Form4 GET (test):', `${urlTest}?${params.toString()}`); } catch(_) {}

        async function fetchJson(url){
          const r = await fetch(url, { method: 'GET' });
          const text = await r.text();
          let parsed = null; try { parsed = JSON.parse(text); } catch { parsed = null; }
          return { ok: r.ok, ct: r.headers.get('content-type')||'', parsed, raw: text, status: r.status };
        }

        let first = await fetchJson(`${urlTest}?${params.toString()}`);
        // Fallback to production webhook if test not active or server error like n8n "Can't determine which item to use"
        if (!first.ok || /could not be started/i.test(String(first.parsed?.message||'')) || /Can't determine which item to use|Can't determine which item to use/i.test(first.raw||'')){
          try { console.warn('Form4 GET fallback -> prod'); } catch(_){ }
          first = await fetchJson(`${urlProd}?${params.toString()}`);
        }
        if(!first.ok){
          throw new Error(first.raw || `HTTP ${first.status}`);
        }
        const data = Array.isArray(first.parsed) || first.parsed ? first.parsed : (first.raw ? JSON.parse(first.raw) : null);
        function pickRowsDeep(json){
          if (!json) return [];
          if (Array.isArray(json) && json.length && typeof json[0] === 'object') return json;
          const candidates = ['data','rows','result','records','items','list'];
          for (const k of candidates){ if (Array.isArray(json?.[k]) && json[k].length && typeof json[k][0] === 'object') return json[k]; }
          try{
            const queue=[json]; const seen=new Set();
            while(queue.length){
              const cur = queue.shift();
              if (!cur || typeof cur !== 'object' || seen.has(cur)) continue;
              seen.add(cur);
              for (const v of Object.values(cur)){
                if (Array.isArray(v) && v.length && typeof v[0] === 'object') return v;
                if (v && typeof v === 'object') queue.push(v);
              }
            }
          }catch(_){ }
          return [];
        }
        const rows = pickRowsDeep(data);
        try{ LS.setJSON('f4.cache', { params: { status: statusVal, from: fromVal, to: toVal, month: monthVal }, rows, ts: Date.now() }); LS.set('f4.lastUpdated', String(Date.now())); }catch(_){ }
        if(!rows.length){ body.innerHTML = "<tr><td colspan='3' class='px-3 py-3 text-center text-gray-500'>Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>"; if(chartWrap) chartWrap.style.display='none'; return; }
        const getV = (obj, keys)=>{
          const lower = Object.keys(obj||{}).reduce((acc,k)=>{ acc[k.toLowerCase()] = obj[k]; return acc; },{});
          for(const k of keys){ const v = lower[k.toLowerCase()]; if(v!==undefined) return v; }
          return '';
        };
        const normalized = rows.map(r=>{
          const name = getV(r,[
            'field_employee','employee','employee_name','nhanvien','nhan_vien','nh√¢n vi√™n','h·ªç t√™n','ho_ten','user','name',
            'assignee','assignee_name','pic','nguoi_phu_trach','ng∆∞·ªùi ph·ª• tr√°ch','ng∆∞·ªùi nh·∫≠n','receiver','recipient'
          ]).toString().trim();
          const manRaw = getV(r,[
            'field_current_manhour','manhour','manhour_current','current_manhour','current_manhours','man_hours','man_hour',
            'congchuan','cong_chuan','c√¥ng chu·∫©n hi·ªán t·∫°i','c√¥ng chu·∫©n nh·∫≠n','c√¥ng chu·∫©n t·ªïng th√°ng','cong_chuan_thang','hours','score'
          ]);
          const man = Number(manRaw);
          const countRaw = getV(r,[
            'field_task_count','taskcount','task_count','count','sotacvu','so_tac_vu','s·ªë t√°c v·ª•','s·ªë t√°c v·ª• trong th√°ng',
            'so_tac_vu_thang','sotacvu_thang','tasks','total_tasks','task_total','so_luong','so_luong_tac_vu','so_dau_muc',
            'so_doing','doing_count','count_doing','so_luong_doing','in_month_count','count_in_month'
          ]);
          const count = Number(countRaw);
          return { name: name || '-', manhour: isNaN(man) ? 0 : man, count: isNaN(count) ? null : count };
        }).filter(x=>x.name && x.name !== '-');
        // B·ªï sung m·ªçi nh√¢n s·ª± t·ª´ danh s√°ch chu·∫©n ƒë·ªÉ kh√¥ng b·ªã thi·∫øu t√™n (vd: "H√† M·ªπ Linh")
        const baseNames = Array.isArray(FORM1_NAMES) ? FORM1_NAMES.filter(n=> !F4_EXCLUDED.has(n)) : [];
        const unionNamesRaw = Array.from(new Set([ ...normalized.map(x=>x.name), ...baseNames ]));
        const unionNames = unionNamesRaw.filter(n=> !F4_EXCLUDED.has(n));
        const merged = unionNames.map(n=>{
          const exist = normalized.find(x=>x.name===n);
          return exist ? exist : { name: n, manhour: 0, count: null };
        });
        // L∆∞u cache ƒë·ªÉ ph·ª•c v·ª• l·ªçc c·ª•c b·ªô kh√¥ng c·∫ßn refetch
        F4_LAST_NORMALIZED = normalized.slice();
        F4_LAST_MERGED = merged.slice();
        F4_LAST_PARAMS = { status: statusVal, from: fromVal, to: toVal, month: monthVal };
        F4_COUNTS_BY_NAME = new Map();
        // C·∫≠p nh·∫≠t danh s√°ch ng∆∞·ªùi trong popover
        F4_ALL_NAMES = unionNames;
        f4BuildFilterList(F4_ALL_NAMES);
        // L·ªçc theo c√°c t√™n ƒë√£ ch·ªçn (Set r·ªóng = t·∫•t c·∫£)
        const selectedNames = Array.from(F4_SELECTED_NAMES);
        const filtered = selectedNames.length ? merged.filter(x => F4_SELECTED_NAMES.has(x.name)) : merged;
        if (!filtered.length) { body.innerHTML = "<tr><td colspan='3' class='px-3 py-3 text-center text-gray-500'>Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>"; if(chartWrap) chartWrap.style.display='none'; return; }
        const normalizedSorted = filtered.slice().sort((a,b)=> b.manhour - a.manhour);
        // N·∫øu tr·∫°ng th√°i l√† All, m·ªü r·ªông c·ªôt theo y√™u c·∫ßu v√† l·∫•y d·ªØ li·ªáu server
        const isAll = (statusVal === 'All');
        async function fetchStatsFor(name){
          try{
            const qs = new URLSearchParams();
            qs.append('action','form4_employee_stats');
            qs.append('employee', name);
            if (fromVal) qs.append('from', fromVal);
            if (toVal) qs.append('to', toVal);
            const r = await fetch(`${urlTest}?${qs.toString()}`);
            const t = await r.text();
            let j = null; try{ j = JSON.parse(t); }catch{}
            const obj = (j && typeof j==='object') ? j : {};
            const getN = (k)=>{ const v = obj[k]; const n = Number(v); return isNaN(n)?0:n; };
            const done = getN('done');
            const ahead = getN('ahead');
            const ontime = getN('ontime');
            const late = getN('late');
            const rateOntime = getN('rate_ontime');
            const rateLate = getN('rate_late');
            const rateAhead = getN('rate_ahead');
            return { done, ahead, ontime, late, rateOntime, rateLate, rateAhead };
          }catch(_){ return { done:0,ahead:0,ontime:0,late:0,rateOntime:0,rateLate:0,rateAhead:0 }; }
        }
        // C·∫≠p nh·∫≠t header ƒë·ªông theo ch·∫ø ƒë·ªô
        (function updateHeader(){
          const headRow = document.getElementById('f4-head-row');
          if (!headRow) return;
          const isAll = (statusVal === 'All');
          try {
            const mainTable = document.getElementById('f4-main-table');
            if (mainTable) {
              if (isAll) {
                mainTable.classList.add('min-w-[1100px]');
                mainTable.classList.remove('min-w-[480px]');
              } else {
                mainTable.classList.add('min-w-[480px]');
                mainTable.classList.remove('min-w-[1100px]');
              }
            }
          } catch(_) {}
          headRow.innerHTML = `
            <th class="px-3 py-2 relative">
              <button id="f4-filter-toggle" class="inline-flex items-center gap-1 hover:text-primary-blue">Nh√¢n vi√™n <span class="text-xs">‚ñæ</span></button>
              <div id="f4-filter-pop" class="absolute z-20 mt-2 left-0 w-72 bg-white border border-gray-200 rounded-lg shadow-lg p-3 hidden">
                <div class="flex items-center gap-2 mb-2">
                  <input id="f4-filter-search" type="text" placeholder="T√¨m ng∆∞·ªùi..." class="flex-1 border border-blue-300 rounded bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
                </div>
                <div class="flex items-center justify-between text-xs text-gray-600 mb-2">
                  <div class="flex items-center gap-3">
                    <button id="f4-filter-select-all" class="underline">Ch·ªçn t·∫•t c·∫£</button>
                    <button id="f4-filter-clear" class="underline">B·ªè ch·ªçn</button>
                  </div>
                  <button id="f4-filter-apply" class="px-2 py-1 rounded bg-primary-blue text-white text-xs">L·ªçc</button>
                </div>
                <div id="f4-filter-list" class="max-h-60 overflow-auto space-y-1 text-sm">
                  <label class="flex items-center gap-2" data-name="(Ch·ªó tr·ªëng)"><input type="checkbox" value="(Ch·ªó tr·ªëng)" class="f4-filter-item h-4 w-4"/><span>(Ch·ªó tr·ªëng)</span></label>
                </div>
              </div>
            </th>
            <th class="px-3 py-2">C√¥ng chu·∫©n hi·ªán t·∫°i</th>
            <th class="px-3 py-2">S·ªë t√°c v·ª•</th>
            ${isAll ? `
              <th class="px-3 py-2">S·ªë DONE</th>
              <th class="px-3 py-2">V∆∞·ª£t ti·∫øn ƒë·ªô</th>
              <th class="px-3 py-2">ƒê√∫ng ti·∫øn ƒë·ªô</th>
              <th class="px-3 py-2">Ch·∫≠m ti·∫øn ƒë·ªô</th>
              <th class="px-3 py-2">T·ª∑ l·ªá v∆∞·ª£t (%)</th>
              <th class="px-3 py-2">T·ª∑ l·ªá ƒë√∫ng (%)</th>
              <th class="px-3 py-2">T·ª∑ l·ªá ch·∫≠m (%)</th>
            `: ''}`;
          // re-bind filter popover events
          try { f4InitFilterPopover(); } catch(_) {}
        })();

        const html = await (async ()=>{
          const rowsHtml = [];
          for (const x of normalizedSorted){
            if (!isAll){
              rowsHtml.push(`
                <tr>
             <td class="px-3 py-2">
               <button class="text-primary-blue hover:underline" data-emp="${x.name}">${x.name}</button>
             </td>
             <td class="px-3 py-2">${x.manhour.toFixed(2)}</td>
             <td class="px-3 py-2"><span class="emp-count" data-emp-count="${x.name}">${(x.count==null)?'<span class="spinner"></span>':String(x.count)}</span></td>
                </tr>`);
              continue;
            }
            const st = await fetchStatsFor(x.name);
            rowsHtml.push(`
              <tr>
                <td class="px-3 py-2">${x.name}</td>
                <td class="px-3 py-2">${x.manhour.toFixed(2)}</td>
                <td class="px-3 py-2">${(x.count==null)?'':String(x.count)}</td>
                <td class="px-3 py-2">${(st.done ?? '')}</td>
                <td class="px-3 py-2">${(st.ahead ?? '')}</td>
                <td class="px-3 py-2">${(st.ontime ?? '')}</td>
                <td class="px-3 py-2">${(st.late ?? '')}</td>
                <td class="px-3 py-2">${isNaN(st.rateOntime)?'':(st.rateOntime.toFixed(0)+"%")}</td>
                <td class="px-3 py-2">${isNaN(st.rateLate)?'':(st.rateLate.toFixed(0)+"%")}</td>
                <td class="px-3 py-2">${isNaN(st.rateAhead)?'':(st.rateAhead.toFixed(0)+"%")}</td>
              </tr>`);
          }
          return rowsHtml.join('');
        })();
        if (isAll) {
          if (bodyAll) { bodyAll.innerHTML = html; try{ enableTableDrag('f4-body-all'); }catch(_){ } }
        } else {
        body.innerHTML = html; try{ enableTableDrag('f4-body'); }catch(_){ }
        // ƒêi·ªÅn s·ªë t√°c v·ª• b·∫•t ƒë·ªìng b·ªô theo tr·∫°ng th√°i hi·ªán t·∫°i
        const statusForCount = statusVal;
        const names = normalizedSorted.filter(x=> x.count == null && !F4_COUNTS_BY_NAME.has(x.name)).map(x=>x.name);
        const findCountEl = (n)=>{
          const all = body.querySelectorAll('.emp-count');
          for (const el of all){ if ((el.getAttribute('data-emp-count')||'') === n) return el; }
          return null;
        };
        const promises = names.map(async n=>{
          const c = await f4FetchTaskCount(n, statusForCount, fromVal, toVal);
          const el = findCountEl(n);
          if (el) {
            el.textContent = String(c);
            try { const tr = el.closest('tr'); if (tr) tr.setAttribute('data-task-count', String(c)); } catch(_) {}
          }
          try { F4_COUNTS_BY_NAME.set(n, c); } catch(_) {}
        });
        Promise.allSettled(promises).then(()=>{ try { f4ApplyCountFilter(); } catch(_) {} }).catch(()=>{});
        }
        // Render bar chart
        const labels = normalizedSorted.map(x=> x.name);
        const values = normalizedSorted.map(x=> x.manhour);
        if (chartWrap) chartWrap.style.display = '';
        const canvas = document.getElementById('f4-chart');
        if (canvas && typeof Chart !== 'undefined'){
          const ctx = canvas.getContext('2d');
          if (F4_CHART) { try { F4_CHART.destroy(); } catch(_) {} }
          F4_CHART = new Chart(ctx, {
            type: 'bar',
            data: {
              labels,
              datasets: [{
                label: 'C√¥ng chu·∫©n nh·∫≠n',
                data: values,
                backgroundColor: 'rgba(90, 169, 255, 0.6)',
                borderColor: '#5aa9ff',
                borderWidth: 1,
                hoverBackgroundColor: 'rgba(59, 130, 246, 0.7)'
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                y: {
                  beginAtZero: true,
                  title: { display: true, text: 'C√¥ng chu·∫©n nh·∫≠n' }
                },
                x: {
                  title: { display: true, text: 'Nh√¢n vi√™n' },
                  ticks: { autoSkip: false, maxRotation: 45, minRotation: 0 }
                }
              },
              plugins: {
                legend: { display: false },
                tooltip: {
                  callbacks: {
                    label: (ctx)=> ` ${Number(ctx.raw).toFixed(2)}`
                  }
                }
              }
            }
          });
        }
      }catch(err){
        body.innerHTML = `<tr><td colspan='3' class='px-3 py-3 text-center text-red-600'>L·ªói t·∫£i d·ªØ li·ªáu: ${String(err.message || err)}</td></tr>`;
        if (chartWrap) chartWrap.style.display = 'none';
        if (F4_CHART) { try { F4_CHART.destroy(); } catch(_) {} F4_CHART = null; }
      }
    }
    function restoreForm4FromCache(){
      try{
        const cached = LS.getJSON('f4.cache');
        if (!cached || !Array.isArray(cached.rows) || !cached.rows.length) return false;
        // k√≠ch ho·∫°t UI c∆° b·∫£n v√† ghi ch√∫ th·ªùi gian
        updateLastUpdatedNote('f4-search','f4.lastUpdated');
        // D√πng pipeline render hi·ªán t·∫°i: g√°n rows v√†o F4_LAST_MERGED ƒë·ªÉ re-render nhanh
        const rows = cached.rows;
        const getV = (obj, keys)=>{ const lower = Object.keys(obj||{}).reduce((a,k)=>{ a[k.toLowerCase()] = obj[k]; return a; },{}); for(const k of keys){ const v = lower[k.toLowerCase()]; if(v!==undefined) return v; } return ''; };
        const normalized = rows.map(r=>({
          name: getV(r,['employee','employee_name','nhanvien','nh√¢n vi√™n','name','assignee','pic']) || '-',
          manhour: Number(getV(r,['manhour','current_manhour','congchuan']))||0,
          count: null
        })).filter(x=>x.name && x.name!=='-');
        F4_LAST_MERGED = normalized;
        renderForm4Local();
        return true;
      }catch(_){ return false; }
    }
    // Render l·∫°i Form 4 t·ª´ cache khi ƒë·ªïi nh√≥m (l·ªçc client-side, kh√¥ng refetch)
    function renderForm4Local(){
      try{
        const body = document.getElementById('f4-body');
        const chartWrap = document.getElementById('f4-chart-container');
        if (chartWrap) chartWrap.style.display = 'none';
        if (F4_CHART) { try { F4_CHART.destroy(); } catch(_) {} F4_CHART = null; }
        if (!Array.isArray(F4_LAST_MERGED) || F4_LAST_MERGED.length===0){
          // Ch∆∞a c√≥ cache -> t·∫£i m·ªôt l·∫ßn
          return renderForm4();
        }
        const selected = Array.from(F4_SELECTED_NAMES);
        const filtered = selected.length ? F4_LAST_MERGED.filter(x=> F4_SELECTED_NAMES.has(x.name)) : F4_LAST_MERGED.slice();
        if (!filtered.length){ body.innerHTML = "<tr><td colspan='3' class='px-3 py-3 text-center text-gray-500'>Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>"; return; }
        const normalizedSorted = filtered.slice().sort((a,b)=> b.manhour - a.manhour);
        const rowsHtml = [];
        for (const x of normalizedSorted){
          const cached = F4_COUNTS_BY_NAME.get(x.name);
          const baseCnt = (x.count==null) ? cached : x.count;
          const cntText = (baseCnt==null || Number.isNaN(baseCnt)) ? "<span class='spinner'></span>" : String(baseCnt);
          rowsHtml.push(`
            <tr>
              <td class="px-3 py-2">
                <button class="text-primary-blue hover:underline" data-emp="${x.name}">${x.name}</button>
              </td>
              <td class="px-3 py-2">${x.manhour.toFixed(2)}</td>
              <td class="px-3 py-2"><span class="emp-count" data-emp-count="${x.name}">${cntText}</span></td>
            </tr>`);
        }
        body.innerHTML = rowsHtml.join('');
        try{ enableTableDrag('f4-body'); }catch(_){ }
        // B·ªï sung: t·∫£i s·ªë t√°c v·ª• b·∫•t ƒë·ªìng b·ªô cho c√°c t√™n ch∆∞a c√≥
        const statusForCount = (F4_LAST_PARAMS && F4_LAST_PARAMS.status) ? F4_LAST_PARAMS.status : 'Doing';
        const fromVal = F4_LAST_PARAMS?.from || '';
        const toVal = F4_LAST_PARAMS?.to || '';
        const namesNeed = normalizedSorted.filter(x=> (x.count==null) && !F4_COUNTS_BY_NAME.has(x.name)).map(x=> x.name);
        const findCountEl = (n)=>{ const all = body.querySelectorAll('.emp-count'); for (const el of all){ if ((el.getAttribute('data-emp-count')||'') === n) return el; } return null; };
        const promises = namesNeed.map(async n=>{ const c = await f4FetchTaskCount(n, statusForCount, fromVal, toVal); const el = findCountEl(n); if (el) { el.textContent = String(c); try { const tr = el.closest('tr'); if (tr) tr.setAttribute('data-task-count', String(c)); } catch(_) {} } try { F4_COUNTS_BY_NAME.set(n, c); } catch(_) {} });
        Promise.allSettled(promises).then(()=>{ try { f4ApplyCountFilter(); } catch(_) {} }).catch(()=>{});
        // V·∫Ω chart theo d·ªØ li·ªáu ƒë√£ l·ªçc
        const labels = normalizedSorted.map(x=> x.name);
        const values = normalizedSorted.map(x=> x.manhour);
        if (chartWrap) chartWrap.style.display = '';
        const canvas = document.getElementById('f4-chart');
        if (canvas && typeof Chart !== 'undefined'){
          const ctx = canvas.getContext('2d');
          if (F4_CHART) { try { F4_CHART.destroy(); } catch(_) {} }
          F4_CHART = new Chart(ctx, {
            type: 'bar',
            data: { labels, datasets: [{ label: 'C√¥ng chu·∫©n nh·∫≠n', data: values, backgroundColor: 'rgba(90, 169, 255, 0.6)', borderColor: '#5aa9ff', borderWidth: 1, hoverBackgroundColor: 'rgba(59, 130, 246, 0.7)' }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, title: { display: true, text: 'C√¥ng chu·∫©n nh·∫≠n' } }, x: { title: { display: true, text: 'Nh√¢n vi√™n' }, ticks: { autoSkip: false, maxRotation: 45, minRotation: 0 } } }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: (ctx)=> ` ${Number(ctx.raw).toFixed(2)}` } } } }
          });
        }
        try { f4ApplyCountFilter(); } catch(_) {}
      }catch(_){}
    }
    // ===== Form 4: Modal chi ti·∫øt theo nh√¢n vi√™n =====
    const detailModal = document.getElementById('detail-modal');
    const detailBody = document.getElementById('detail-body');
    const detailNameEl = document.getElementById('detail-name');
    const detailNote = document.getElementById('detail-note');
    const detailClose = document.getElementById('detail-close');

    function openDetailModal(empName, filter, from, to){
      if (!detailModal) return;
      detailNameEl.textContent = empName || '';
      detailBody.innerHTML = `<tr><td colspan="8" class="px-3 py-3 text-center text-gray-500"><span class="spinner mr-2"></span>ƒêang t·∫£i...</td></tr>`;
      detailNote.textContent = filter === 'Doing' ? 'Ch·ªâ hi·ªÉn th·ªã t√°c v·ª• ƒëang Doing.' : 'Hi·ªÉn th·ªã t·∫•t c·∫£ t√°c v·ª•.';
      detailModal.classList.add('open');
      detailModal.setAttribute('aria-hidden','false');
      renderDetailTasks(empName, filter, from, to).catch(()=>{});
    }
    function closeDetailModal(){
      if (!detailModal) return;
      detailModal.classList.remove('open');
      detailModal.setAttribute('aria-hidden','true');
    }
    if (detailClose) detailClose.onclick = closeDetailModal;
    if (detailModal) detailModal.addEventListener('click', (e)=>{ if(e.target===detailModal) closeDetailModal(); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && detailModal && detailModal.classList.contains('open')) closeDetailModal(); });

    async function renderDetailTasks(name, filter, from, to){
      const headerMapF1 = {
        header_requester: 'Ng∆∞·ªùi y√™u c·∫ßu',
        header_requestDate: 'Ng√†y y√™u c·∫ßu',
        header_wishDue: 'H·∫°n mong mu·ªën',
        header_actualDue: 'H·∫°n ƒë√°p ·ª©ng',
        header_code: 'M√£',
        header_taskName: 'T√™n t√°c v·ª•',
        header_manHour: 'C√¥ng chu·∫©n',
        header_status: 'Tr·∫°ng th√°i',
        field_requester: 'requester',
        field_requestDate: 'requestDate',
        field_wishDue: 'wishDue',
        field_actualDue: 'actualDue',
        field_code: 'code',
        field_taskName: 'taskName',
        field_manHour: 'manHour',
        field_status: 'status'
      };
      const params = new URLSearchParams({
        ...headerMapF1,
        action: 'form1_lookup',
        person_name: name,
        timestamp: new Date().toISOString()
      });
      if (from) params.append('from', from);
      if (to) params.append('to', to);
      function getV(obj, keys){
        const lower = Object.keys(obj||{}).reduce((acc,k)=>{ acc[k.toLowerCase()] = obj[k]; return acc; },{});
        for(const k of keys){ const v = lower[k.toLowerCase()]; if(v!==undefined) return v; }
        return '';
      }
      async function fetchJson(url){
        const r = await fetch(url, { method: 'GET' });
        const text = await r.text();
        let parsed = null; try{ parsed = JSON.parse(text); }catch{ parsed = null; }
        return { ok: r.ok, parsed, raw: text, status: r.status };
      }
      try{
        const testUrl = `${WEBHOOK_URL}?${params.toString()}`;
        let first = await fetchJson(testUrl);
        if (!first.ok || (first.parsed && first.parsed.code === 0 && /could not be started/i.test(String(first.parsed.message||'')))){
          const prodUrl = testUrl.replace('/webhook-test/', '/webhook/');
          first = await fetchJson(prodUrl);
        }
        if (!first.ok) throw new Error(first.raw || `HTTP ${first.status}`);
        const data = first.parsed ?? (first.raw ? JSON.parse(first.raw) : null);
        function pickRows(json){
          if (!json) return [];
          if (Array.isArray(json)) return json;
          const candidates = ['data','rows','result','records','items','list'];
          for (const k of candidates){ if (Array.isArray(json?.[k])) return json[k]; }
          try{
            const queue=[json]; const seen=new Set();
            while(queue.length){
              const cur=queue.shift(); if(!cur||typeof cur!=='object'||seen.has(cur)) continue; seen.add(cur);
              for (const v of Object.values(cur)){
                if (Array.isArray(v) && v.length && typeof v[0]==='object') return v;
                if (v && typeof v==='object') queue.push(v);
              }
            }
          }catch(_){}
          return [];
        }
        let rows = pickRows(data);
        if (filter === 'Doing'){
          rows = rows.filter(item=>{
            const statusText = String(getV(item,['status','trangthai','trang_thai','tr·∫°ng th√°i'])||'');
            const s = statusText.toLowerCase();
            const isDoing = s.includes('doing') || s.includes('ƒëang');
            return isDoing;
          });
        }
        if (!rows.length){
          detailBody.innerHTML = `<tr><td class="px-3 py-3 text-center text-gray-500" colspan="8">Kh√¥ng c√≥ t√°c v·ª•${filter==='Doing'?' Doing':''}.</td></tr>`;
          return;
        }
        // Helper parse date (h·ªó tr·ª£ YYYY-MM-DD, DD/MM/YYYY, DD-MM-YYYY, YYYY/MM/DD, c√≥/kh√¥ng gi·ªù)
        function toDate(v){
          if(!v) return null;
          const s = String(v).trim();
          let m = s.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})/);
          if (m) {
            const d = +m[1], mo = +m[2], y = m[3].length===2 ? +('20'+m[3]) : +m[3];
            const dt = new Date(y, mo-1, d); return isNaN(dt) ? null : dt;
          }
          m = s.match(/^(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})/);
          if (m) {
            const dt = new Date(+m[1], +m[2]-1, +m[3]); return isNaN(dt) ? null : dt;
          }
          const dt = new Date(s);
          return isNaN(dt) ? null : dt;
        }

        const html = rows.map(item=>{
          const code = getV(item,['code','ma','taskcode','m√£']);
          const tname = getV(item,['taskname','ten_tac_vu','ten','name','title','t√™n t√°c v·ª•']);
          const status = getV(item,['status','trangthai','trang_thai','tr·∫°ng th√°i']);
          const man = getV(item,['manhour','man_hour','congchuan','cong_chuan','workload','sogio','sogiocong','c√¥ng chu·∫©n']);
          const rq = getV(item,['requestdate','ngayyeucau','ngay_yeu_cau','submissiondate','ngaygui','ng√†y y√™u c·∫ßu']);
          const wish = getV(item,['wishdue','hanmongmuon','han_mong_muon','desireddue','h·∫°n mong mu·ªën']);
          const act = getV(item,['actualdue','handapung','han_dap_ung','completiondate','h·∫°n ƒë√°p ·ª©ng']);
          const done = getV(item,['completiondate','completeddate','ngayhoanthanh','ngay_hoan_thanh','completion','done_date','ng√†y ho√†n th√†nh']);

          // Late completed highlight (yellow)
          const dueForCompare = act || wish || '';
          const isLate = (()=>{ const d1 = toDate(done), d2 = toDate(dueForCompare); return d1 && d2 ? (d1.getTime() > d2.getTime()) : false; })();
          let trClass = isLate ? 'bg-yellow-100' : '';
          // Overdue doing highlight + today highlight (match Form 1)
          const sLower = (status||'').toLowerCase();
          const isDoing = sLower.includes('doing') || sLower.includes('ƒëang');
          const dueDate = parseDateFlexible(dueForCompare);
          if (isDoing && dueDate){
            const today = new Date();
            const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            const dueDayStart = new Date(dueDate.getFullYear(), dueDate.getMonth(), dueDate.getDate());
            const isSameDay = dueDayStart.getTime() === todayStart.getTime();
            const isPast = dueDayStart.getTime() < todayStart.getTime();
            if (isSameDay) trClass = 'bg-yellow-100';
            else if (isPast) trClass = 'bg-red-100';
          }

          return `
            <tr class="${trClass}">
              <td class="px-3 py-2">${code}</td>
              <td class="px-3 py-2">${tname}</td>
              <td class="px-3 py-2">${status}</td>
              <td class="px-3 py-2">${man}</td>
              <td class="px-3 py-2">${rq}</td>
              <td class="px-3 py-2">${wish}</td>
              <td class="px-3 py-2">${act}</td>
              <td class="px-3 py-2">${done}</td>
            </tr>
          `;
        }).join('');
        detailBody.innerHTML = html;
      }catch(err){
        detailBody.innerHTML = `<tr><td class="px-3 py-3 text-center text-red-600" colspan="8">L·ªói t·∫£i d·ªØ li·ªáu: ${String(err.message||err)}</td></tr>`;
      }
    }

    // Copy on click and open link for storage (Form 1)
    const f1StorageLink = document.getElementById('f1-storage-link');
    if (f1StorageLink) {
      f1StorageLink.addEventListener('click', async ()=>{
        const url = f1StorageLink.getAttribute('href') || '';
        try { await navigator.clipboard.writeText(url); showToast('ƒê√£ copy li√™n k·∫øt.','success'); }
        catch(_) { /* ignore copy error to not block open */ }
      });
    }
    // Trigger fetch only when nh·∫•n Tra c·ª©u ·ªü Form 4
    const f4Btn = document.getElementById('f4-search');
    if (f4Btn) {
      f4Btn.addEventListener('click', (e)=>{ e.preventDefault(); renderForm4(); f4UpdateGroupButtonsUI(); });
    }
    // Pivot handlers
    (function initF4Pivot(){
      const refresh = document.getElementById('f4-pivot-refresh');
      if (refresh) refresh.addEventListener('click', (e)=>{ e.preventDefault(); F4_PIVOT_ROWS_ALL = []; renderF4Pivot(); });
      // auto render once when form loads
      try { renderF4Pivot(); } catch(_) {}
    })();

    // Render detailed list of overdue Doing tasks (mirrors Form 1 highlight)
    async function renderF4Pivot(){
      if (F4_PIVOT_BUSY) return;
      F4_PIVOT_BUSY = true;
      const body = document.getElementById('f4-pivot-body');
      const sumTotal = document.getElementById('f4-pivot-sum-total');
      const note = document.getElementById('f4-pivot-note');
      if (!body) return;
      body.innerHTML = `<tr><td colspan="7" class="px-3 py-3 text-center text-gray-500"><span class='spinner mr-2'></span>ƒêang t·∫£i...</td></tr>`;
      const fromVal = document.getElementById('f4-from')?.value || '';
      const toVal = document.getElementById('f4-to')?.value || '';
      const base = F4_ALL_NAMES && F4_ALL_NAMES.length ? F4_ALL_NAMES : (FORM1_NAMES || []);
      const names = base.filter(n=> !F4_EXCLUDED.has(n));
      const selected = Array.from(F4_SELECTED_NAMES);
      const targetNames = selected.length ? names.filter(n => F4_SELECTED_NAMES.has(n)) : names.slice();

      // N·∫øu cache ch∆∞a c√≥ ho·∫∑c ph·∫°m vi th·ªùi gian ƒë·ªïi -> t·∫£i v√† x√¢y cache
      const needRefetch = (!Array.isArray(F4_PIVOT_ROWS_ALL) || !F4_PIVOT_ROWS_ALL.length
        || F4_PIVOT_LAST_PARAMS.from !== fromVal || F4_PIVOT_LAST_PARAMS.to !== toVal);

      if (needRefetch){
        F4_PIVOT_ROWS_ALL = [];
        F4_PIVOT_LAST_PARAMS = { from: fromVal, to: toVal };
        await Promise.all(names.map(async (name)=>{
          try{
            const headerMap = {
              header_requestDate: 'Ng√†y y√™u c·∫ßu', header_wishDue: 'H·∫°n mong mu·ªën', header_actualDue: 'H·∫°n ƒë√°p ·ª©ng',
              header_status: 'Tr·∫°ng th√°i', header_code: 'M√£', header_taskName: 'T√™n t√°c v·ª•',
              field_requestDate: 'requestDate', field_wishDue: 'wishDue', field_actualDue: 'actualDue',
              field_status: 'status', field_code: 'code', field_taskName: 'taskName'
            };
            const qs = new URLSearchParams({ ...headerMap, action:'form1_lookup', person_name: name, timestamp: new Date().toISOString() });
            if (fromVal) qs.append('from', fromVal);
            if (toVal) qs.append('to', toVal);
            const u = `${WEBHOOK_URL}?${qs.toString()}`;
            const r = await fetch(u);
            const t = await r.text();
            let json = null; try{ json = JSON.parse(t); }catch{ json = null; }
            let rows = [];
            if (Array.isArray(json)) rows = json; else if (json && typeof json==='object'){
              const keys = ['data','rows','result','records','items','list'];
              for (const k of keys){ if (Array.isArray(json[k])) { rows = json[k]; break; } }
            }
            function getV(o, keys){ const L = Object.keys(o||{}).reduce((a,k)=>{a[k.toLowerCase()]=o[k];return a;},{}); for(const k of keys){ const v=L[k.toLowerCase()]; if(v!==undefined) return v; } return ''; }
            rows.forEach(it=>{
              const statusText = String(getV(it,['status','trangthai','trang_thai','tr·∫°ng th√°i'])||'');
              const s = statusText.toLowerCase();
              const isDoing = s.includes('doing') || s.includes('ƒëang');
              if (!isDoing) return;
              const wish = getV(it,['wishdue','hanmongmuon','han_mong_muon','desireddue','h·∫°n mong mu·ªën']);
              const act = getV(it,['actualdue','handapung','han_dap_ung','completiondate','h·∫°n ƒë√°p ·ª©ng']);
              const due = parseDateFlexible(act || wish || '');
              if (!due) return;
              const now = new Date();
              if (now.getTime() >= due.getTime()){
                F4_PIVOT_ROWS_ALL.push({
                  assignee: name,
                  code: getV(it,['code','ma','taskcode','m√£']),
                  taskName: getV(it,['taskname','ten_tac_vu','ten','name','title','t√™n t√°c v·ª•']),
                  status: statusText,
                  requestDate: getV(it,['requestdate','ngayyeucau','ngay_yeu_cau','submissiondate','ngaygui','ng√†y y√™u c·∫ßu']),
                  wishDue: wish,
                  actualDue: act
                });
              }
            });
          }catch(_){ /* skip one name */ }
        }));
      }

      // L·ªçc c·ª•c b·ªô t·ª´ cache theo nh√≥m ƒëang ch·ªçn
      let rowsOut = F4_PIVOT_ROWS_ALL.filter(r => targetNames.includes(r.assignee));
      rowsOut.sort((a,b)=>{
        const byName = a.assignee.localeCompare(b.assignee,'vi');
        if (byName !== 0) return byName;
        const da = parseDateFlexible(a.actualDue || a.wishDue || '') || new Date(0);
        const db = parseDateFlexible(b.actualDue || b.wishDue || '') || new Date(0);
        return da.getTime() - db.getTime();
      });

      if (!rowsOut.length){
        body.innerHTML = `<tr><td colspan="7" class="px-3 py-3 text-center text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>`;
      } else {
        const todayStart = (()=>{ const d=new Date(); return new Date(d.getFullYear(), d.getMonth(), d.getDate()); })();
        function toDate(v){ try{ return parseDateFlexible(v||''); }catch(_){ return null; } }
        body.innerHTML = rowsOut.map(r=>{
          const due = toDate(r.actualDue || r.wishDue || '');
          let trClass = 'bg-red-50';
          if (due){
            const dueStart = new Date(due.getFullYear(), due.getMonth(), due.getDate());
            if (dueStart.getTime() === todayStart.getTime()) trClass = 'bg-yellow-100';
            else if (dueStart.getTime() < todayStart.getTime()) trClass = 'bg-red-100';
          }
          return `<tr class="${trClass}">
          <td class="px-3 py-2">${r.assignee}</td>
          <td class="px-3 py-2">${r.code}</td>
          <td class="px-3 py-2">${r.taskName}</td>
          <td class="px-3 py-2">${r.status}</td>
          <td class="px-3 py-2">${r.requestDate}</td>
          <td class="px-3 py-2">${r.wishDue}</td>
          <td class="px-3 py-2">${r.actualDue}</td>
          </tr>`;
        }).join('');
        try{ enableTableDrag('f4-pivot-body'); }catch(_){ }
      }
      if (sumTotal) sumTotal.textContent = String(rowsOut.length);
      if (note) note.textContent = 'Danh s√°ch t√°c v·ª• Doing b·ªã qu√° h·∫°n (cache c·ª•c b·ªô; nh·∫•n L√†m m·ªõi ƒë·ªÉ t·∫£i l·∫°i)';
      F4_PIVOT_BUSY = false;
    }
    // Group filter buttons
    (function initF4GroupButtons(){
      const btnAll = document.getElementById('f4-btn-all');
      const btnLinh = document.getElementById('f4-btn-linh');
      const btnHieu = document.getElementById('f4-btn-hieu');
      if (btnAll) btnAll.addEventListener('click', (e)=>{ e.preventDefault(); f4SetGroupSelection([]); f4UpdateGroupButtonsUI(); f4SchedulePivot(); });
      if (btnLinh) btnLinh.addEventListener('click', (e)=>{ e.preventDefault(); f4SetGroupSelection(F4_GROUP_LINH); f4UpdateGroupButtonsUI(); f4SchedulePivot(); });
      if (btnHieu) btnHieu.addEventListener('click', (e)=>{ e.preventDefault(); f4SetGroupSelection(F4_GROUP_HIEU); f4UpdateGroupButtonsUI(); f4SchedulePivot(); });
      // set initial visual state
      f4UpdateGroupButtonsUI();
    })();
    // Trigger fetch only when nh·∫•n Tra c·ª©u ·ªü Form 6 (√Ω t∆∞·ªüng)
    const f5Btn = document.getElementById('f5-search');
    if (f5Btn) {
      f5Btn.addEventListener('click', async (e)=>{
        e.preventDefault();
        if (f5Btn.disabled) return;
        const prev = f5Btn.textContent;
        f5Btn.disabled = true;
        f5Btn.innerHTML = "<span class='spinner mr-2'></span>ƒêang t·∫£i...";
        try { await renderForm5List(); }
        finally {
          f5Btn.disabled = false;
          f5Btn.textContent = prev || 'Tra c·ª©u';
        }
      });
    }
    // Default month and change handler for Form 6 filtering
    (function initF6MonthFilter(){
      const m = document.getElementById('f6-month');
      if (!m) return;
      const d = new Date();
      const yy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      if (!m.value) m.value = `${yy}-${mm}`;
      // on change, re-apply local filter if data already loaded
      if (!m._bound){
        m.addEventListener('change', ()=>{
          try{
            if (Array.isArray(F6_LAST_ROWS) && F6_LAST_ROWS.length) {
              if (typeof applyForm6LocalFilter === 'function') applyForm6LocalFilter();
              else renderForm5List();
            }
          }catch(_){ }
        });
        m._bound = true;
      }
    })();
    // Trigger fetch for Form 5 (All tasks)
    const f5aBtn = document.getElementById('f5a-search');
    if (f5aBtn) { f5aBtn.addEventListener('click', async (e)=>{ e.preventDefault(); try{ await renderForm5All(); }catch(_){ } }); }
    // Auto render once when Form 5 first shows
    try { setTimeout(()=>{ try{ renderForm5All(); }catch(_){ } }, 300); } catch(_) {}
    // T·ª± ƒë·ªông render khi ƒë·ªïi tr·∫°ng th√°i
    const f4StatusHidden = document.getElementById('f4-status');
    if (f4StatusHidden) f4StatusHidden.value = 'Doing';
    const f4FromInput = document.getElementById('f4-from');
    const f4ToInput = document.getElementById('f4-to');
    if (f4FromInput) f4FromInput.addEventListener('change', ()=>{ renderForm4(); f4SchedulePivot(); });
    if (f4ToInput) f4ToInput.addEventListener('change', ()=>{ renderForm4(); f4SchedulePivot(); });
    const f4CountFilterInput = document.getElementById('f4-count-filter');
    if (f4CountFilterInput) f4CountFilterInput.addEventListener('input', ()=> f4ApplyCountFilter());
    const f4PeopleSel2 = document.getElementById('f4-people');
    if (f4PeopleSel2) f4PeopleSel2.addEventListener('change', ()=> renderForm4());
    // Click t√™n nh√¢n vi√™n ƒë·ªÉ xem chi ti·∫øt
    const f4Body = document.getElementById('f4-body');
    if (f4Body) {
      f4Body.addEventListener('click', (e)=>{
        const btn = e.target.closest('[data-emp]');
        if (!btn) return;
        const name = btn.getAttribute('data-emp') || '';
        const filter = (document.getElementById('f4-status')?.value === 'Doing') ? 'Doing' : 'All';
        const fromVal = (document.getElementById('f4-from')?.value || '');
        const toVal = (document.getElementById('f4-to')?.value || '');
        if (name) openDetailModal(name, filter, fromVal, toVal);
      });
    }

    // Form 4: filter rows by "s·ªë t√°c v·ª•" (>= input)
    function f4ApplyCountFilter(){
      const input = document.getElementById('f4-count-filter');
      const body = document.getElementById('f4-body');
      if (!input || !body) return;
      const raw = (input.value || '').trim();
      const threshold = raw === '' ? NaN : parseInt(raw, 10);
      const rows = body.querySelectorAll('tr');
      rows.forEach(tr=>{
        const cEl = tr.querySelector('.emp-count');
        if (!cEl) return;
        const val = parseInt((cEl.textContent || '').trim(), 10);
        if (isNaN(threshold)) {
          tr.style.display = '';
        } else if (isNaN(val)) {
          tr.style.display = '';
        } else {
          tr.style.display = (val >= threshold) ? '' : 'none';
        }
      });
    }

    // ===== Form 5: submit and list ideas =====
    async function renderForm5List(){
      const body = document.getElementById('f5-body');
      if (!body) return;
      body.innerHTML = "<tr><td colspan='6' class='px-3 py-3 text-center text-gray-500'><span class='spinner mr-2'></span>ƒêang t·∫£i...</td></tr>";
      const headerMapF5 = {
        header_submitDate: 'Ng√†y n·ªôp',
        header_employee: 'Nh√¢n vi√™n',
        header_title: 'Ti√™u ƒë·ªÅ √Ω t∆∞·ªüng',
        header_problem: 'V·∫•n ƒë·ªÅ nh·∫≠n di·ªán',
        header_solution: 'Gi·∫£i ph√°p',
        field_submitDate: 'submitDate',
        field_employee: 'employee',
        field_title: 'title',
        field_problem: 'problem',
        field_solution: 'solution'
      };
      const params = new URLSearchParams({ ...headerMapF5, action: 'form5_list', _ts: Date.now().toString() });
      async function fetchJson(url){
        const r = await fetch(url, { method: 'GET' });
        const t = await r.text();
        let parsed=null; try{ parsed=JSON.parse(t);}catch{}
        return { ok:r.ok, parsed, raw:t, status:r.status };
      }
      function pickRows(json){
        if (!json) return [];
        if (Array.isArray(json)) return json;
        const cands=['data','rows','result','records','items','list'];
        for (const k of cands){ if (Array.isArray(json?.[k])) return json[k]; }
        try{
          const q=[json], seen=new Set();
          while(q.length){
            const cur=q.shift(); if(!cur||typeof cur!=='object'||seen.has(cur)) continue; seen.add(cur);
            for (const v of Object.values(cur)){ if (Array.isArray(v) && v.length && typeof v[0]==='object') return v; if (v && typeof v==='object') q.push(v); }
          }
        }catch(_){}
        return [];
      }
      let first = await fetchJson(`${FORM5_LIST_URL}?${params.toString()}`);
      if (!first.ok || (first.parsed && first.parsed.code===0 && /could not be started/i.test(String(first.parsed.message||'')))){
        first = await fetchJson(`${FORM5_LIST_URL.replace('/webhook-test/','/webhook/')}?${params.toString()}`);
      }
      if (!first.ok){
        body.innerHTML = `<tr><td colspan='6' class='px-3 py-3 text-center text-red-600'>L·ªói t·∫£i: ${String(first.raw||first.status)}</td></tr>`;
        return;
      }
      const rows = pickRows(first.parsed ?? (first.raw ? JSON.parse(first.raw) : null));
      if (!rows.length){
        body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="6">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
        F5_LAST_COUNT = 0;
        F6_LAST_ROWS = [];
        return;
      }
      const getV = (obj, keys)=>{
        const lower = Object.keys(obj||{}).reduce((a,k)=>{ a[k.toLowerCase()] = obj[k]; return a; },{});
        for (const k of keys){ const v = lower[k.toLowerCase()]; if(v!==undefined) return v; }
        return '';
      };
      // Normalize to cache for client-side month filtering
      F6_LAST_ROWS = rows.map((item)=>({
        submitDate: getV(item,['submitdate','date','submit_date','ngaynop','ngay_nop']),
        employee: getV(item,['employee','nhanvien','nhan_vien','nh√¢n vi√™n']),
        title: getV(item,['title','tieude','tieu_de','ti√™u ƒë·ªÅ √Ω t∆∞·ªüng']),
        problem: getV(item,['problem','van_de','vande','v·∫•n ƒë·ªÅ nh·∫≠n di·ªán']),
        solution: getV(item,['solution','giai_phap','giaiphap','gi·∫£i ph√°p'])
      }));
      // Local filter + render
      window.applyForm6LocalFilter = function(){
        try{
          const monthEl = document.getElementById('f6-month');
          const monthVal = monthEl ? (monthEl.value || '').trim() : '';
          let list = Array.isArray(F6_LAST_ROWS) ? F6_LAST_ROWS.slice() : [];
          if (monthVal) list = list.filter(r => formatYyyyMm(r.submitDate) === monthVal);
          if (!list.length){
            body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="5">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
            return;
          }
          const html2 = list.map(r=>`
            <tr>
              <td class="px-3 py-2">${r.submitDate}</td>
              <td class="px-3 py-2">${r.employee}</td>
              <td class="px-3 py-2">${r.title}</td>
              <td class="px-3 py-2">${r.problem}</td>
              <td class="px-3 py-2">${r.solution}</td>
            </tr>
          `).join('');
          body.innerHTML = html2;
          try{ enableTableDrag('f5-body'); }catch(_){ }
        }catch(_){ }
      };
      // initial render
      try{ applyForm6LocalFilter(); }catch(_){ }
      F5_LAST_COUNT = F6_LAST_ROWS.length;
      try{ LS.setJSON('f6.cache', { rows: F6_LAST_ROWS, ts: Date.now() }); LS.set('f6.lastUpdated', String(Date.now())); }catch(_){ }
    }
    function restoreForm6FromCache(){
      try{
        const cached = LS.getJSON('f6.cache');
        if (!cached || !Array.isArray(cached.rows) || !cached.rows.length) return false;
        const body = document.getElementById('f5-body');
        if (!body) return false;
        F6_LAST_ROWS = cached.rows.slice();
        if (typeof applyForm6LocalFilter === 'function') applyForm6LocalFilter();
        updateLastUpdatedNote('f5-search','f6.lastUpdated');
        return true;
      }catch(_){ return false; }
    }

    (function setupForm5(){
      const openBtn = document.getElementById('f5-open-submit');
      const modal = document.getElementById('f5-modal');
      const sendBtn = document.getElementById('f5-btn-send');
      const cancelBtn = document.getElementById('f5-btn-cancel');
      const countBox = document.getElementById('f5-count');

      function openF5Modal(){
        try { setF5DateDefault(); } catch(_){}
        // reset inputs
        try{ (document.getElementById('f5-title')||{}).value=''; }catch(_){ }
        try{ (document.getElementById('f5-problem')||{}).value=''; }catch(_){ }
        try{ (document.getElementById('f5-solution')||{}).value=''; }catch(_){ }
        if (modal){ modal.classList.add('open'); modal.setAttribute('aria-hidden','false'); }
      }
      function closeF5Modal(){ if (modal){ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); } }
      if (openBtn) openBtn.addEventListener('click', (e)=>{ e.preventDefault(); openF5Modal(); });
      if (cancelBtn) cancelBtn.addEventListener('click', (e)=>{ e.preventDefault(); closeF5Modal(); });
      if (modal) modal.addEventListener('click', (e)=>{ if(e.target===modal) closeF5Modal(); });
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && modal && modal.classList.contains('open')) closeF5Modal(); });

      async function submitF5(){
        const date = (document.getElementById('f5-date')?.value||'').trim();
        const emp = (document.getElementById('f5-employee')?.value||'').trim();
        const title = (document.getElementById('f5-title')?.value||'').trim();
        const prob = (document.getElementById('f5-problem')?.value||'').trim();
        const sol = (document.getElementById('f5-solution')?.value||'').trim();
        if (!date || !emp || !title || !prob || !sol){ showToast('Vui l√≤ng ƒëi·ªÅn ƒë·ªß t·∫•t c·∫£ tr∆∞·ªùng.','error'); return; }
        const prev = sendBtn ? sendBtn.textContent : '';
        if (sendBtn){ sendBtn.disabled = true; sendBtn.innerHTML = "<span class='spinner mr-2'></span>ƒêang g·ª≠i..."; }
        // Build payload (send both submitDate and date for compatibility)
        const toDMY = (v)=>{ try{ return formatDdMmYyyy(v); }catch(_){ return String(v||''); } };
        const p = new URLSearchParams({
          submitDate: date,
          date: date,
          submit_date: date,
          ngay_nop: date,
          ngayNop: date,
          ngayNopDMY: toDMY(date),
          employee: emp,
          title,
          problem: prob,
          solution: sol,
          _ts: Date.now().toString()
        });
        async function tryPost(url){
          try{
            const r = await fetch(url, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: p.toString() });
            const t = await r.text().catch(()=>"");
            return { ok: r.ok, raw: t };
          }catch(err){ return { ok:false, raw: String(err||'') }; }
        }
        async function tryPostNoCors(url){
          try{
            await fetch(url, { method:'POST', mode:'no-cors', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: p.toString() });
            // opaque response cannot be inspected; treat as success if resolved
            return { ok: true, raw: '' };
          }catch(err){ return { ok:false, raw: String(err||'') }; }
        }
        async function tryGet(url){
          try{
            const r = await fetch(`${url}?${p.toString()}`, { method:'GET' });
            const t = await r.text();
            return { ok: r.ok, raw: t };
          }catch(err){ return { ok:false, raw: String(err||'') }; }
        }
        try{
          // 1) POST no-cors to test URL (avoid CORS false negatives)
          let r = await tryPostNoCors(FORM5_SUBMIT_URL);
          // 2) If above failed (network), try normal POST test URL
          if (!r.ok) r = await tryPost(FORM5_SUBMIT_URL);
          // 3) Fallback GET test URL
          if (!r.ok || /could not be started/i.test(r.raw||'')) r = await tryGet(FORM5_SUBMIT_URL);
          // 4) Fallback POST prod URL
          if (!r.ok || /could not be started/i.test(r.raw||'')) r = await tryPost(FORM5_SUBMIT_URL.replace('/webhook-test/','/webhook/'));
          // 5) Fallback GET prod URL
          if (!r.ok || /could not be started/i.test(r.raw||'')) r = await tryGet(FORM5_SUBMIT_URL.replace('/webhook-test/','/webhook/'));
          if (!r.ok) throw new Error(r.raw||'G·ª≠i th·∫•t b·∫°i');
          showToast('ƒê√£ g·ª≠i √Ω t∆∞·ªüng.','success');
          closeF5Modal();
          // L√†m m·ªõi b·∫£ng sau 3 gi√¢y ƒë·ªÉ backend k·ªãp ghi d·ªØ li·ªáu
          setTimeout(()=>{ try{ renderForm5List(); }catch(_){} }, 3000);
        }catch(err){
          showToast('G·ª≠i th·∫•t b·∫°i.','error');
        }finally{
          if (sendBtn){ sendBtn.disabled=false; sendBtn.textContent = prev || 'G·ª≠i √Ω t∆∞·ªüng'; }
        }
      }
      if (sendBtn) sendBtn.addEventListener('click', (e)=>{ e.preventDefault(); submitF5(); });

      if (countBox){
        countBox.addEventListener('click', ()=>{
          countBox.innerHTML = `<span>üìä</span><span>S·ªë √Ω t∆∞·ªüng ƒë√£ n·ªôp: <b>${F5_LAST_COUNT}</b></span>`;
        });
      }
    })();

    // Map t√™n -> email cho Form 3 (t·ª± ƒë·ªông ƒëi·ªÅn)
    const REQUESTER_EMAIL = (()=>{
      const normalize = s => String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,' ').trim().toLowerCase();
      const raw = {
        "B√πi ƒê·∫∑ng Qu·ªëc Huy":"huy.bui@karofi.vn",
        "ƒê√†o Ho√†ng D∆∞∆°ng":"duong.dao@karofi.vn",
        "ƒê·ªó Quang Long":"long.do@karofi.vn",
        "Nguy·ªÖn VƒÉn Hi·∫øu":"hieu.nguyen2@karofi.vn",
        "Nguy·ªÖn H·ªØu Th·ªãnh":"thinh.nguyen2@karofi.vn",
        "Nguy·ªÖn VƒÉn Hi·∫øu":"hieu.nguyen2@karofi.vn",
        "Nguy·ªÖn VƒÉn Linh":"linh.nguyen@karofi.vn",
        "Ph·∫°m Th√†nh Trung Ki√™n":"kien.pham1@karofi.vn",
        "Th√°i Th·ªã Giang":"giang.thai@karofi.vn",
        "Tr·∫ßn Hi·∫øu Nghƒ©a":"nghia.tran@karofi.vn",
        "V≈© Th·ªã H·∫±ng":"hang.vu@karofi.vn",
        "ƒê√†o Tu·∫•n K·ª≥":"ky.dao@karofi.vn",
        "Nguy·ªÖn VƒÉn Linh":"linh.nguyen@karofi.vn",
        "L·∫°i Qu·ªëc L·ªôc":"loc.lai@karofi.vn",
        "L√™ Ng·ªçc √Ånh":"anh.le1@karofi.vn",
        "L√™ Th·ªã Thanh Nh√†n":"nhan.le@karofi.vn",
        "L√™ Th·ªã Th·∫£o":"thao.le@karofi.vn",
        "L√™ VƒÉn S∆°n":"son.le2@karofi.vn",
        "Nguy·ªÖn Th·ªã Hi·ªÅn":"hien.nguyen1@karofi.vn",
        "Ph·∫°m Th·ªã Minh":"minh.pham1@karofi.vn",
        "V≈© Duy Minh":"minh.vu@karofi.com",
        "V≈© Th·ªã Thanh Hi·ªÅn":"hien.vu2@karofi.vn"
      };
      const map = {};
      Object.keys(raw).forEach(k => map[normalize(k)] = raw[k]);
      return { get: (name)=> map[normalize(name)] || '' };
    })();
    function syncRequesterEmail(){
      const nameEl = document.getElementById('rq-by');
      const emailEl = document.getElementById('rq-by-email');
      if (!nameEl || !emailEl) return;
      emailEl.value = REQUESTER_EMAIL.get(nameEl.value||'');
    }
    (function initRequesterEmail(){
      const nameEl = document.getElementById('rq-by');
      if (!nameEl) return;
      nameEl.addEventListener('input', syncRequesterEmail);
      nameEl.addEventListener('change', syncRequesterEmail);
      syncRequesterEmail();
    })();

    async function renderForm5All(){
      const body = document.getElementById('f5a-body');
      if (!body) return;
      body.innerHTML = "<tr><td colspan='11' class='px-3 py-3 text-center text-gray-500'><span class='spinner mr-2'></span>ƒêang t·∫£i...</td></tr>";
      const chartWrap = document.getElementById('f5a-chart-container');
      const chartCanvas = document.getElementById('f5a-chart');
      const chartWrapMan = document.getElementById('f5a-chart-container-manhour');
      const chartCanvasMan = document.getElementById('f5a-chart-manhour');
      function destroyChart(){ try{ if (F5A_CHART) { F5A_CHART.destroy(); F5A_CHART = null; } }catch(_){}
        try{ if (F5A_CHART_MAN) { F5A_CHART_MAN.destroy(); F5A_CHART_MAN = null; } }catch(_){}
      }
      function renderStackedChart(rows){
        try{
          try{ window.F5A_RENDER_CHART = (r)=>{ try{ renderStackedChart(r || F5A_LAST_ROWS || []); }catch(_){ } }; }catch(_){ }
          if (!Array.isArray(rows) || !rows.length || !chartCanvas) { if(chartWrap) chartWrap.style.display='none'; destroyChart(); return; }
          // Ch·ªçn ch·∫ø ƒë·ªô d·ªØ li·ªáu: rates (c≈©) ho·∫∑c manhour (m·ªõi)
          const basisSel = document.getElementById('f5a-basis');
          const basis = basisSel ? (basisSel.value || 'rates') : 'rates';
          if (basis === 'manhour'){
            const labels = rows.map(r=> r.name);
            const isHorizontal = (F5A_MODE === 'horizontal');
            if (chartWrap) {
              chartWrap.style.display = '';
              const baseH = 420;
              chartWrap.style.height = isHorizontal ? Math.max(baseH, 28*labels.length + 100) + 'px' : baseH + 'px';
            }
            const ctx = chartCanvas.getContext('2d');
            destroyChart();
            const dataMan = rows.map(r=> Number(r.manhour)||0);
            const valueLabelsPlugin = {
              id: 'valueLabels',
              afterDatasetsDraw(chart){
                const { ctx } = chart;
                const isHorizontal = chart.options.indexAxis === 'y';
                const meta = chart.getDatasetMeta(0);
                if (!meta || !meta.data) return;
                ctx.save();
                meta.data.forEach((bar, i)=>{
                  const val = Number(chart.data.datasets[0].data?.[i]) || 0;
                  if (val <= 0) return;
                  const x = isHorizontal ? (bar.x + 12) : bar.x;
                  const y = isHorizontal ? bar.y : (bar.y - 6);
                  ctx.fillStyle = '#0b1324';
                  ctx.font = 'bold 12px Inter, Arial';
                  ctx.textAlign = 'center';
                  ctx.textBaseline = 'bottom';
                  ctx.fillText(val.toFixed(2), x, y);
                });
                ctx.restore();
              }
            };
            F5A_CHART = new Chart(ctx, {
              type: 'bar',
              data: { labels, datasets: [{ label: 'C√¥ng chu·∫©n hi·ªán t·∫°i', data: dataMan, backgroundColor: 'rgba(90, 169, 255, 0.6)', borderColor: '#5aa9ff', borderWidth: 1 }] },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: isHorizontal ? 'y' : 'x',
                scales: {
                  x: { ticks: { autoSkip: false, maxRotation: isHorizontal?0:20, minRotation: 0, font: { size: 11 } }, grid: { display: false }, title: { display: true, text: isHorizontal? 'C√¥ng chu·∫©n' : 'Nh√¢n vi√™n' } },
                  y: { beginAtZero: true, ticks: { precision:0 }, grid: { color: 'rgba(0,0,0,0.06)', borderDash:[4,3] }, title: { display: true, text: isHorizontal? 'Nh√¢n vi√™n' : 'C√¥ng chu·∫©n' } }
                },
                plugins: { legend: { display: false } }
              },
              plugins: [valueLabelsPlugin]
            });
            try { setTimeout(()=>{ chartWrap && chartWrap.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); }, 100); } catch(_) {}
            F5A_LAST_ROWS = rows;
            const modeSel = document.getElementById('f5a-mode');
            if (modeSel){ modeSel.value = F5A_MODE; modeSel.onchange = ()=>{ F5A_MODE = modeSel.value || 'vertical'; renderStackedChart(F5A_LAST_ROWS); }; }
            if (basisSel){ basisSel.value = basis; basisSel.onchange = ()=> renderStackedChart(F5A_LAST_ROWS); }
            try{ window.F5A_RENDER_CHART = (r)=>{ try{ renderStackedChart(r || F5A_LAST_ROWS || []); }catch(_){ } }; }catch(_){ }
            return;
          }
          // Fallback t√≠nh t·ª∑ l·ªá n·∫øu ch∆∞a c√≥ % nh∆∞ng c√≥ s·ªë l∆∞·ª£ng
          const normalized = rows.map(r=>{
            const a = Number(r.rateAhead)||0, o = Number(r.rateOntime)||0, l = Number(r.rateLate)||0;
            if ((a+o+l) > 0) return { ...r, rateAhead:a, rateOntime:o, rateLate:l };
            const ca = Number(r.ahead)||0, co = Number(r.ontime)||0, cl = Number(r.late)||0;
            const sum = ca + co + cl;
            if (sum > 0) return { ...r, rateAhead: Math.round(ca*100/sum), rateOntime: Math.round(co*100/sum), rateLate: Math.round(cl*100/sum) };
            return { ...r };
          });
          const labels = normalized.map(r=> r.name);
          const counts   = normalized.map(r=> isNaN(r.count)?0:Number(r.count));
          // T√≠nh s·ªë l∆∞·ª£ng theo tr·∫°ng th√°i, n·∫øu thi·∫øu th√¨ suy ra t·ª´ % * t·ªïng count
          const cntOn  = normalized.map((r,i)=>{ const c=counts[i]; const v=Number(r.ontime)||Math.round((Number(r.rateOntime)||0)*c/100); return v; });
          const cntLate= normalized.map((r,i)=>{ const c=counts[i]; const v=Number(r.late)||Math.round((Number(r.rateLate)||0)*c/100); return v; });
          const cntAhead=normalized.map((r,i)=>{ const c=counts[i]; const v=Number(r.ahead)||Math.round((Number(r.rateAhead)||0)*c/100); return v; });
          // T√≠nh ph·∫ßn trƒÉm ƒë·ªÉ hi·ªÉn th·ªã nh√£n
          const pctOn   = normalized.map((r,i)=>{ const c=counts[i]||1; return Math.round((cntOn[i]||0)*100/c); });
          const pctLate = normalized.map((r,i)=>{ const c=counts[i]||1; return Math.round((cntLate[i]||0)*100/c); });
          const pctAhead= normalized.map((r,i)=>{ const c=counts[i]||1; return Math.round((cntAhead[i]||0)*100/c); });
          const maxCount = Math.max(1, ...counts);
          const isHorizontal = (F5A_MODE === 'horizontal');
          if (chartWrap) { chartWrap.style.display = ''; chartWrap.style.height = (isHorizontal ? Math.max(440, 28*labels.length + 100) : 440) + 'px'; }
          if (chartWrapMan) { chartWrapMan.style.display = ''; chartWrapMan.style.height = 420 + 'px'; }
          const ctx = chartCanvas.getContext('2d');
          destroyChart();
          const stackedLabelsPlugin = {
            id: 'stackedLabels',
            afterDatasetsDraw(chart){
              const { ctx, chartArea } = chart;
              ctx.save();
              const isHorizontal = chart.options.indexAxis === 'y';
              chart.data.datasets.forEach((ds, dsIdx)=>{
                const meta = chart.getDatasetMeta(dsIdx);
                if (!meta || meta.hidden || !meta.data || (ds.type && ds.type !== 'bar')) return;
                const inSameStack = (other)=> (other.stack || '') === (ds.stack || '');
                meta.data.forEach((bar, i)=>{
                  const val = Number(ds.data?.[i]) || 0;
                  if (val <= 0) return;
                  let total = 0;
                  chart.data.datasets.forEach((ods, j)=>{
                    const m = chart.getDatasetMeta(j);
                    if (!m || m.hidden || (ods.type && ods.type !== 'bar')) return;
                    if (!inSameStack(ods)) return;
                    total += Number(ods.data?.[i]) || 0;
                  });
                  if (!total) return;
                  const percent = Math.round((val * 100) / total);
                  const x = bar.x !== undefined ? bar.x : (bar.tooltipPosition ? bar.tooltipPosition().x : 0);
                  const y = bar.y !== undefined ? bar.y : (bar.tooltipPosition ? bar.tooltipPosition().y : 0);
                  const base = bar.base !== undefined ? bar.base : (isHorizontal ? chart.scales.x.getPixelForValue(0) : chart.scales.y.getPixelForValue(0));
                  const midX = isHorizontal ? (x + base) / 2 : x;
                  const midY = isHorizontal ? y : (y + base) / 2;
                  ctx.fillStyle = '#000000';
                  ctx.font = 'bold 12px Inter, Arial';
                  ctx.textAlign = 'center';
                  ctx.textBaseline = 'middle';
                  ctx.fillText(`${percent}%`, midX, Math.min(midY, chartArea.bottom - 4));
                });
              });
              ctx.restore();
            }
          };
          const stackTotalsPlugin = {
            id: 'stackTotals',
            afterDatasetsDraw(chart){
              const { ctx } = chart;
              const isHorizontal = chart.options.indexAxis === 'y';
              const datasets = chart.data.datasets || [];
              const labels = chart.data.labels || [];
              ctx.save();
              for (let i=0; i<labels.length; i++){
                let total = 0;
                let anchor = null;
                datasets.forEach((ds, idx)=>{
                  const meta = chart.getDatasetMeta(idx);
                  if (!meta || meta.hidden || (ds.type && ds.type !== 'bar')) return;
                  if ((ds.stack || '') !== 'rates') return;
                  const val = Number(ds.data?.[i]) || 0;
                  total += val;
                  if (!anchor) anchor = meta.data?.[i] || null;
                });
                if (!anchor || !total) continue;
                const scale = isHorizontal ? chart.scales.x : chart.scales.y;
                const pos = scale.getPixelForValue(total);
                const x = isHorizontal ? (pos + 12) : anchor.x;
                const y = isHorizontal ? anchor.y : (pos - 6);
                ctx.fillStyle = '#0b1324';
                ctx.font = 'bold 12px Inter, Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'bottom';
                ctx.fillText(String(total), x, y);
              }
              ctx.restore();
            }
          };
          const COLOR_ON = 'rgba(134,239,172,0.85)';      // green-300
          const COLOR_LATE = 'rgba(254,202,202,0.9)';     // red-200
          const COLOR_AHEAD = 'rgba(147,197,253,0.9)';    // blue-300
          const BORDER_SEG = '#e5e7eb';                   // slate-200
          const barT = isHorizontal ? 20 : 26;
          const catPct = isHorizontal ? 0.75 : 0.9;
          const barPct = isHorizontal ? 0.9 : 0.95;
          F5A_CHART = new Chart(ctx, {
            type: 'bar',
            data: {
              labels,
              datasets: [
                { label: 'V∆∞·ª£t ti·∫øn ƒë·ªô', data: cntAhead, backgroundColor: COLOR_AHEAD, borderColor:BORDER_SEG, borderWidth:1, stack: 'rates', barThickness:barT, maxBarThickness:barT+8, categoryPercentage:catPct, barPercentage:barPct },
                { label: 'ƒê√∫ng ti·∫øn ƒë·ªô', data: cntOn, backgroundColor: COLOR_ON, borderColor:BORDER_SEG, borderWidth:1, stack: 'rates', barThickness:barT, maxBarThickness:barT+8, categoryPercentage:catPct, barPercentage:barPct },
                { label: 'Ch·∫≠m ti·∫øn ƒë·ªô', data: cntLate, backgroundColor: COLOR_LATE, borderColor:BORDER_SEG, borderWidth:1, stack: 'rates', barThickness:barT, maxBarThickness:barT+8, categoryPercentage:catPct, barPercentage:barPct }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              indexAxis: isHorizontal ? 'y' : 'x',
              scales: {
                x: { stacked: true, ticks: { autoSkip: false, maxRotation: isHorizontal?0:20, minRotation: 0, font: { size: 11 } }, grid: { display: false } },
                y: { stacked: true, beginAtZero: true, suggestedMax: Math.ceil(maxCount*1.15), ticks: { precision:0 }, grid: { color: 'rgba(0,0,0,0.06)', borderDash:[4,3] }, title: { display: true, text: 'S·ªë t√°c v·ª•' } }
              },
              plugins: {
                stackedLabels: {},
                legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 11 } } },
                tooltip: {
                  callbacks: {
                    label: (ctx)=>{
                      const dsLabel = ctx.dataset.label || '';
                      const value = ctx.parsed[isHorizontal?'x':'y'];
                      const total = counts[ctx.dataIndex] || 0;
                      const pct = total ? Math.round(value*100/total) : 0;
                      return ` ${dsLabel}: ${value} (${pct}%)`;
                    }
                  }
                }
              },
              plugins: [stackedLabelsPlugin, stackTotalsPlugin]
            }
          });
          try { setTimeout(()=>{ chartWrap && chartWrap.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); }, 100); } catch(_) {}
          // l∆∞u l·∫°i rows (gi·ªØ ƒë·ªß thu·ªôc t√≠nh, k·ªÉ c·∫£ manhour) ƒë·ªÉ ƒë·ªïi ch·∫ø ƒë·ªô
          F5A_LAST_ROWS = rows;
          const modeSel = document.getElementById('f5a-mode');
          if (modeSel){
            modeSel.value = F5A_MODE;
            modeSel.onchange = ()=>{ F5A_MODE = modeSel.value || 'vertical'; renderStackedChart(F5A_LAST_ROWS); };
          }
          // Render chart manhour song song
          try {
            const manRows = ((F5A_LAST_ROWS && Array.isArray(F5A_LAST_ROWS)) ? F5A_LAST_ROWS : normalized).slice().sort((a,b)=> Number(b.manhour||0) - Number(a.manhour||0));
            const labels2 = manRows.map(r=> r.name);
            const ctxMan = chartCanvasMan ? chartCanvasMan.getContext('2d') : null;
            if (ctxMan){
              const dataMan = manRows.map(r=> Number(r.manhour)||0);
              try{ if (F5A_CHART_MAN) { F5A_CHART_MAN.destroy(); } }catch(_){ }
              const valueLabelsPlugin2 = {
                id: 'valueLabels2',
                afterDatasetsDraw(chart){
                  const { ctx } = chart; const meta = chart.getDatasetMeta(0); if (!meta||!meta.data) return;
                  ctx.save(); meta.data.forEach((bar,i)=>{ const v=Number(chart.data.datasets[0].data?.[i])||0; if(v<=0) return; const x=bar.x; const y=(bar.y-6); ctx.fillStyle='#0b1324'; ctx.font='bold 12px Inter, Arial'; ctx.textAlign='center'; ctx.textBaseline='bottom'; ctx.fillText(v.toFixed(2), x, y); }); ctx.restore();
                }
              };
              F5A_CHART_MAN = new Chart(ctxMan, {
                type: 'bar',
                data: { labels: labels2, datasets: [{ label: 'C√¥ng chu·∫©n hi·ªán t·∫°i', data: dataMan, backgroundColor: 'rgba(90, 169, 255, 0.6)', borderColor: '#5aa9ff', borderWidth: 1 }] },
                options: { responsive:true, maintainAspectRatio:false, indexAxis: 'x', scales: { x:{ ticks:{ autoSkip:false, maxRotation:20, minRotation:0, font:{ size:11 } }, grid:{ display:false }, title:{ display:true, text: 'Nh√¢n vi√™n' } }, y:{ beginAtZero:true, ticks:{ precision:0 }, grid:{ color:'rgba(0,0,0,0.06)', borderDash:[4,3] }, title:{ display:true, text: 'C√¥ng chu·∫©n' } } }, plugins: { legend:{ display:false } } },
                plugins: [valueLabelsPlugin2]
              });
            }
          } catch(_) {}
        }catch(_){ if(chartWrap) chartWrap.style.display='none'; }
      }
      try{
        const monthInput = document.getElementById('f5a-month');
        const monthVal = (monthInput && monthInput.value) ? monthInput.value : '';
        const toNumeric = (v)=>{ const s=String(v??''); const n=parseFloat(s.replace(/[^0-9.+-]/g,'')); return isNaN(n)?0:n; };
        let fromVal = '';
        let toVal = '';
        if (monthVal) {
          try{
            const [yy, mm] = monthVal.split('-');
            const firstDay = `${yy}-${mm}-01`;
            const lastDate = new Date(Number(yy), Number(mm), 0).getDate();
            const lastDay = `${yy}-${mm}-${String(lastDate).padStart(2,'0')}`;
            fromVal = firstDay; toVal = lastDay;
          }catch(_){ }
        }
        // Fetch once from the new single-source endpoint, then aggregate locally
        await f5aFetchAllOnce(monthVal, fromVal, toVal);
        const aggregated = f5aAggregate(F5A_RAW_ALL || [], fromVal, toVal);
        try{ LS.setJSON('f5a.cache', { month: monthVal, rows: aggregated, ts: Date.now() }); LS.set('f5a.lastUpdated', String(Date.now())); updateLastUpdatedNote('f5a-search','f5a.lastUpdated'); }catch(_){ }
        if (!aggregated.length){
          body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="11">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
          if (chartWrap) chartWrap.style.display = 'none';
          if (chartWrapMan) chartWrapMan.style.display = 'none';
            return;
          }
        const sorted = aggregated.slice().sort((a,b)=> Number(b["T·ªïng c√¥ng chu·∫©n"]||b.manhour||0) - Number(a["T·ªïng c√¥ng chu·∫©n"]||a.manhour||0));
        const html = sorted.map(item=>{
          // D√πng c√°c tr∆∞·ªùng theo ·∫£nh: Ph·ª• tr√°ch, T·ªïng ƒëi·ªÉm (ƒëang x·ª≠ l√Ω), S·ªë task ƒëang x·ª≠ l√Ω, T·ªïng ƒëi·ªÉm t·∫•t c·∫£, T·ªïng t√°c v·ª• ƒë√£ x·ª≠ l√Ω
          const name = item['Ph·ª• tr√°ch'] || item.name || '';
          const man = Number(((item['T·ªïng c√¥ng chu·∫©n'] ?? item['T·ªïng ƒëi·ªÉm (ƒëang x·ª≠ l√Ω)'] ?? item.manhour) || 0));
          const count = Number(((item['T·ªïng t√°c v·ª• ƒë√£ x·ª≠ l√Ω'] ?? item.count) || 0));
          const ahead = Number(item.ahead||0);
          const ontime = Number(item.ontime||0);
          const late = Number(item.late||0);
          const done = Number(item.doneCnt || (ahead + ontime + late));
          const rAhead = Number(item.rateAhead||0);
          const rOn = Number(item.rateOntime||0);
          const rLate = Number(item.rateLate||0);
          const need = f5aGetNeedManhour(name);
                return `
                  <tr>
                    <td class="px-3 py-2">${name}</td>
              <td class="px-3 py-2">${man.toFixed(2)}</td>
              <td class="px-3 py-2 cell-div">${need}</td>
              <td class="px-3 py-2">${count}</td>
              <td class="px-3 py-2">${done}</td>
              <td class="px-3 py-2">${ahead}</td>
              <td class="px-3 py-2">${ontime}</td>
              <td class="px-3 py-2">${late}</td>
              <td class="px-3 py-2">${rAhead.toFixed(0)}%</td>
              <td class="px-3 py-2">${rOn.toFixed(0)}%</td>
              <td class="px-3 py-2">${rLate.toFixed(0)}%</td>
                  </tr>`;
              }).join('');
              body.innerHTML = html;
              try{ enableTableDrag('f5a-body'); }catch(_){ }
        // Chart
        F5A_LAST_ROWS = sorted;
        renderStackedChart(sorted);
      }catch(err){
        body.innerHTML = `<tr><td colspan='11' class='px-3 py-3 text-center text-red-600'>L·ªói t·∫£i d·ªØ li·ªáu: ${String(err.message||err)}</td></tr>`;
        if (chartWrap) chartWrap.style.display = 'none';
      }
    }
    function restoreForm5FromCache(){
      try{
        const cached = LS.getJSON('f5a.cache');
        if (!cached || !Array.isArray(cached.rows) || !cached.rows.length) return false;
        updateLastUpdatedNote('f5a-search','f5a.lastUpdated');
        const body = document.getElementById('f5a-body');
        if (!body) return false;
        const sorted = cached.rows.slice().sort((a,b)=> Number(b["T·ªïng c√¥ng chu·∫©n"]||b.manhour||0) - Number(a["T·ªïng c√¥ng chu·∫©n"]||a.manhour||0));
        const html = sorted.map(item=>{
          const name = item['Ph·ª• tr√°ch'] || item.name || '';
          const man = Number(((item['T·ªïng c√¥ng chu·∫©n'] ?? item['T·ªïng ƒëi·ªÉm (ƒëang x·ª≠ l√Ω)'] ?? item.manhour) || 0));
          const count = Number(((item['T·ªïng t√°c v·ª• ƒë√£ x·ª≠ l√Ω'] ?? item.count) || 0));
          const ahead = Number(item.ahead||0);
          const ontime = Number(item.ontime||0);
          const late = Number(item.late||0);
          const done = Number(item.doneCnt || (ahead + ontime + late));
          const rAhead = Number(item.rateAhead||0);
          const rOn = Number(item.rateOntime||0);
          const rLate = Number(item.rateLate||0);
          const need = f5aGetNeedManhour(name);
          return `<tr>
              <td class="px-3 py-2">${name}</td>
              <td class="px-3 py-2">${man.toFixed(2)}</td>
              <td class="px-3 py-2 cell-div">${need}</td>
              <td class="px-3 py-2">${count}</td>
              <td class="px-3 py-2">${done}</td>
              <td class="px-3 py-2">${ahead}</td>
              <td class="px-3 py-2">${ontime}</td>
              <td class="px-3 py-2">${late}</td>
              <td class="px-3 py-2">${rAhead.toFixed(0)}%</td>
              <td class="px-3 py-2">${rOn.toFixed(0)}%</td>
              <td class="px-3 py-2">${rLate.toFixed(0)}%</td>
            </tr>`; }).join('');
        body.innerHTML = html;
        try{ enableTableDrag('f5a-body'); }catch(_){ }
        F5A_LAST_ROWS = sorted;
        try{ const chartWrap = document.getElementById('f5a-chart-container'); if(chartWrap) chartWrap.style.display='none'; }catch(_){ }
        return true;
      }catch(_){ return false; }
    }
    // N√∫t l√†m m·ªõi l·ª±a ch·ªçn bi·ªÉu ƒë·ªì Form 5
    (function initF5aRefresh(){
      const btn = document.getElementById('f5a-refresh');
      if (!btn) return;
      btn.addEventListener('click', (e)=>{ e.preventDefault(); try{ if (window.F5A_RENDER_CHART) { window.F5A_RENDER_CHART(); } else { try{ renderStackedChart(F5A_LAST_ROWS||[]); }catch(_){ } } }catch(_){ } });
    })();
    // Default Form 4 month = current month (ƒë√£ c√≥ ·ªü tr√™n)
    // Th√™m default cho Form 5 (All tasks)
    (function setDefaultF5aMonth(){
      const m = document.getElementById('f5a-month');
      if (!m) return;
      const d = new Date();
      const yy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      if (!m.value) m.value = `${yy}-${mm}`;
    })();
  </script>
</body>
</html>




