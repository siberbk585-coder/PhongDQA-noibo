<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>C·ªïng T√°c V·ª• DQA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'primary-blue': '#5aa9ff',
            'sidebar': '#0f172a',
            'sidebar-hover': '#1e293b',
            'muted': '#f8fafc'
          }
        }
      }
    }
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    .spinner{border:2px solid #e5e7eb;border-top:2px solid #3b82f6;border-radius:50%;width:16px;height:16px;animation:spin 1s linear infinite;display:inline-block;vertical-align:middle}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .header-container{background:linear-gradient(135deg,#2563eb 0%,#60a5fa 100%);position:relative;overflow:hidden}
    .header-container::before{content:"";position:absolute;inset:0;background-image:url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffffff' fill-opacity='0.08' fill-rule='evenodd'/%3E%3C/svg%3E");opacity:.4}
    .modal{position:fixed;inset:0;background:rgba(15,23,42,0.35);display:none;align-items:center;justify-content:center;padding:20px;z-index:1000}
    .section-title{display:flex;align-items:center;gap:8px}
    .section-title .badge{background:rgba(90,169,255,.15);color:#1e40af;border:1px solid rgba(90,169,255,.35);padding:2px 8px;border-radius:9999px;font-size:12px;font-weight:600}
    .submit-btn{background:linear-gradient(135deg,#3b82f6 0%,#60a5fa 100%);box-shadow:0 4px 6px rgba(37,99,235,.1),0 1px 3px rgba(37,99,235,.08);transition:transform .2s ease,box-shadow .2s ease,opacity .2s ease,filter .2s ease;border-radius:9999px;position:relative}
    .submit-btn:hover{transform:translateY(-1px);box-shadow:0 7px 14px rgba(37,99,235,.12),0 3px 6px rgba(37,99,235,.08);filter:brightness(1.03)}
    .submit-btn:active{transform:translateY(0);opacity:.95}
    .modal.open{display:flex}
    .toast{position:fixed;right:16px;bottom:16px;background:#0b1324;color:#fff;padding:10px 12px;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.15);opacity:0;transform:translateY(10px);transition:.2s}
    .toast.show{opacity:1;transform:translateY(0)}
  </style>
</head>
<body class="bg-muted min-h-screen flex text-gray-800" style="font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'">
  <!-- Sidebar -->
  <aside class="w-64 min-h-screen bg-sidebar text-white flex flex-col py-8 px-4 shadow-lg">
    <h1 class="text-xl font-bold tracking-wide pb-6 border-b border-blue-200 mb-4">C·ªïng T√°c V·ª• DQA</h1>
    <nav class="flex flex-col gap-2 mt-2">
      <button class="nav-btn py-2 px-4 rounded transition hover:bg-sidebar-hover text-left text-base" data-target="form1">Form 1 ¬∑ Tra c·ª©u t√°c v·ª•</button>
      <button class="nav-btn py-2 px-4 rounded transition hover:bg-sidebar-hover text-left text-base" data-target="form2">Form 2 ¬∑ Tr·∫£ form b√°o c√°o</button>
      <button class="nav-btn py-2 px-4 rounded transition hover:bg-sidebar-hover text-left text-base" data-target="form3">Form 3 ¬∑ Giao vi·ªác</button>
      <button class="nav-btn py-2 px-4 rounded transition hover:bg-sidebar-hover text-left text-base" data-target="form4">Form 4 ¬∑ B·∫£ng theo d√µi</button>
    </nav>
  </aside>

  <!-- Main -->
  <main class="flex-1 py-10 flex flex-col items-center min-h-screen overflow-y-auto">
    <div class="header-container relative w-full max-w-6xl rounded-xl overflow-hidden mb-8">
      <div class="relative z-10 p-8 md:p-10">
        <div class="flex items-center space-x-2 mb-3">
          <div class="inline-block px-3 py-1 rounded-full text-xs font-semibold text-white" style="background-color: rgba(255,255,255,0.15); backdrop-filter: blur(5px);">Ph√≤ng DQA</div>
        </div>
        <h2 class="text-2xl md:text-3xl lg:text-4xl font-bold text-white mb-1 tracking-tight">B·∫£ng ƒëi·ªÅu ph·ªëi c√¥ng vi·ªác</h2>
        <p class="text-blue-100 text-sm md:text-base">Tra c·ª©u, tr·∫£ form, tr·∫£ b√°o c√°o v√† giao vi·ªác.</p>
      </div>
    </div>

    <!-- Form 1 -->
    <section id="form1" class="w-full max-w-none bg-white p-6 rounded-lg shadow-md">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-blue-800">Form 1 ¬∑ Tra c·ª©u t√°c v·ª•</h2>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Ch·ªçn t√™n</label>
          <div class="flex gap-2">
            <select id="f1-name" class="flex-1 border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white">
              <option value="">‚Äî Ch·ªçn ng∆∞·ªùi ‚Äî</option>
            </select>
            <button id="f1-search" class="px-4 py-2 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105">Tra c·ª©u</button>
          </div>
          <p class="text-gray-500 text-xs mt-1">Ch·ªçn t√™n v√† nh·∫•n Tra c·ª©u ƒë·ªÉ g·ª≠i y√™u c·∫ßu v√† hi·ªÉn th·ªã t√°c v·ª•</p>
        </div>
      </div>
      <div class="mt-4 overflow-auto max-h-[60vh] border border-gray-200 rounded-lg">
        <table class="min-w-[1600px] w-full text-sm">
          <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
            <tr class="text-left text-gray-700">
              <th class="px-3 py-2 min-w-[160px]">Tr·∫£ b√°o c√°o</th>
              <th class="px-3 py-2 min-w-[140px]">T√¨nh tr·∫°ng</th>
              <th class="px-3 py-2 min-w-[140px]">M√£</th>
              <th class="px-3 py-2 min-w-[260px]">T√™n t√°c v·ª•</th>
              <th class="px-3 py-2 min-w-[160px]">Ng∆∞·ªùi y√™u c·∫ßu</th>
              <th class="px-3 py-2 min-w-[120px]">C√¥ng chu·∫©n</th>
              <th class="px-3 py-2 min-w-[140px]">Ng√†y y√™u c·∫ßu</th>
              <th class="px-3 py-2 min-w-[140px]">H·∫°n mong mu·ªën</th>
              <th class="px-3 py-2 min-w-[140px]">H·∫°n ƒë√°p ·ª©ng</th>
              <th class="px-3 py-2 min-w-[260px]">M·ª•c ƒë√≠ch ƒë√°nh gi√°</th>
              <th class="px-3 py-2 min-w-[240px]">Note</th>
              <th class="px-3 py-2 min-w-[240px]">Y√™u c·∫ßu test ƒë·∫∑c bi·ªát</th>
              <th class="px-3 py-2 min-w-[260px]">Form b√°o c√°o ƒë√°nh gi√°</th>
              <th class="px-3 py-2 min-w-[220px]">T√™n file ƒë√≠nh k√®m</th>
            </tr>
          </thead>
          <tbody id="f1-body" class="divide-y divide-gray-100">
            <tr><td class="px-3 py-3 text-center text-gray-500" colspan="14">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
          </tbody>
        </table>
      </div>
      <div id="f1-pager" class="mt-2 flex items-center justify-between" style="display:none">
        <div class="text-sm text-gray-600">
          <span id="f1-page-info">Trang 1/1 (0 d√≤ng)</span>
        </div>
        <div class="flex items-center gap-2">
          <label class="text-sm text-gray-600">Hi·ªÉn th·ªã</label>
          <select id="f1-size" class="border border-blue-300 rounded-lg bg-slate-100 p-1 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white">
            <option value="10" selected>10</option>
            <option value="20">20</option>
            <option value="50">50</option>
          </select>
          <button id="f1-prev" class="px-3 py-1 rounded-lg border border-gray-300 text-gray-700 bg-white hover:bg-gray-50">Tr∆∞·ªõc</button>
          <button id="f1-next" class="px-3 py-1 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105">Sau</button>
        </div>
      </div>

      <!-- ƒêi·ªÉm l∆∞u tr·ªØ file ƒë√≠nh k√®m -->
      <div class="mt-4">
        <a id="f1-storage-link" href="https://drive.google.com/drive/u/0/folders/1iVSNn6Ddv6jEun6lyMvOMcan2fpnFSpU" target="_blank" rel="noopener" title="Nh·∫•n ƒë·ªÉ m·ªü v√† t·ª± ƒë·ªông copy li√™n k·∫øt"
           class="inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-blue-200 bg-blue-50/30 text-primary-blue hover:bg-blue-50">
          ƒêi·ªÉm l∆∞u tr·ªØ file ƒë√≠nh k√®m
        </a>
        <p class="text-xs text-gray-500 mt-1">Nh·∫•n ƒë·ªÉ m·ªü v√† copy li√™n k·∫øt.</p>
      </div>
    </section>

    <!-- Form 2 -->
    <section id="form2" class="w-full max-w-7xl bg-white p-6 rounded-lg shadow-md hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-blue-800">Form 2 ¬∑ Tr·∫£ form b√°o c√°o</h2>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Ch·ªçn t√™n</label>
          <div class="flex gap-2">
            <select id="f2-name" class="flex-1 border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white">
              <option value="">‚Äî Ch·ªçn ng∆∞·ªùi ‚Äî</option>
            </select>
            <button id="f2-search" class="px-3 py-2 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105">Tra c·ª©u</button>
          </div>
          <p class="text-gray-500 text-xs mt-1">Ch·ªçn t√™n v√† nh·∫•n Tra c·ª©u ƒë·ªÉ hi·ªÉn th·ªã t√°c v·ª• c·∫ßn tr·∫£ form.</p>
        </div>
      </div>
      <div class="mt-4 overflow-x-auto border border-gray-200 rounded-lg">
        <table class="min-w-[900px] w-full text-sm">
          <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
            <tr class="text-left text-gray-700">
              <th class="px-3 py-2">Ng√†y y√™u c·∫ßu</th>
              <th class="px-3 py-2">H·∫°n mong mu·ªën</th>
              <th class="px-3 py-2">H·∫°n ƒë√°p ·ª©ng</th>
              <th class="px-3 py-2">M√£</th>
              <th class="px-3 py-2">T√™n t√°c v·ª•</th>
              <th class="px-3 py-2 min-w-[120px]">N√∫t Tr·∫£ form</th>
            </tr>
          </thead>
          <tbody id="f2-body" class="divide-y divide-gray-100">
            <tr><td class="px-3 py-3 text-center text-gray-500" colspan="6">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Form 3 -->
    <section id="form3" class="w-full max-w-4xl bg-white p-6 rounded-lg shadow-md hidden">
      <div class="flex items-center justify-between mb-4">
        <div class="section-title">
          <h2 class="text-xl font-semibold text-blue-800">Form 3 ¬∑ Giao vi·ªác</h2>
          <span class="badge">DQA n·ªôi b·ªô</span>
        </div>
      </div>
      <form id="assign-form" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Ng∆∞·ªùi y√™u c·∫ßu <span class="text-gray-400 text-xs">(b·∫Øt bu·ªôc)</span></label>
            <input id="rq-by" required type="text" placeholder="Nh·∫≠p t√™n ng∆∞·ªùi y√™u c·∫ßu" class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Th·ªùi gian y√™u c·∫ßu</label>
            <input id="rq-time" readonly type="text" class="w-full border border-blue-300 rounded-lg bg-gray-200 p-2 text-gray-600"/>
            <p class="text-gray-500 text-xs mt-1">C·ªë ƒë·ªãnh theo th·ªùi gian h·ªá th·ªëng</p>
          </div>
        </div>
      <div class="grid grid-cols-1 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">T√™n t√°c v·ª• <span class="text-gray-400 text-xs">(b·∫Øt bu·ªôc)</span></label>
          <input id="task-name" required type="text" placeholder="Nh·∫≠p t√™n t√°c v·ª•" class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
        </div>
      </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Ng∆∞·ªùi ƒë∆∞·ª£c giao <span class="text-gray-400 text-xs">(b·∫Øt bu·ªôc)</span></label>
            <select id="f3-assignee" required class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white">
              <option value="">‚Äî Ch·ªçn ng∆∞·ªùi ‚Äî</option>
            </select>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">C√¥ng chu·∫©n <span class="text-gray-400 text-xs">(b·∫Øt bu·ªôc)</span></label>
            <input id="man-hour" required type="number" step="0.01" min="0" inputmode="decimal" placeholder="VD: 2.50" class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
            <p class="text-gray-500 text-xs mt-1">Cho ph√©p nh·∫≠p 2 ch·ªØ s·ªë sau d·∫•u th·∫≠p ph√¢n</p>
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-1">ƒê·∫ßu ra c√¥ng vi·ªác <span class="text-gray-400 text-xs">(b·∫Øt bu·ªôc)</span></label>
            <input id="output" required type="text" placeholder="M√¥ t·∫£ ƒë·∫ßu ra" class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Deadline</label>
            <input id="deadline" type="date" class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">M√£ Odoo/Jira</label>
            <input id="odoo-jira" type="text" placeholder="VD: ODOO-123 ho·∫∑c JIRA-456" class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">T√†i li·ªáu ƒë√≠nh k√®m</label>
            <input id="attach" type="file" class="block w-full text-sm file:mr-2 file:py-1 file:px-3 file:rounded-full file:border-0 file:bg-primary-blue file:text-white"/>
            <div id="f3-upload-list" class="mt-2 text-sm"></div>
          </div>
        </div>
        <div class="pt-2 flex items-center gap-3">
          <button type="submit" class="submit-btn px-6 py-2 text-white font-semibold transition">Giao vi·ªác</button>
        </div>
      </form>
    </section>
  </main>

  <!-- Form 4 -->
  <section id="form4" class="w-full max-w-5xl bg-white p-6 rounded-lg shadow-md hidden">
    <div class="flex items-center justify-between mb-4">
      <div class="section-title">
        <h2 class="text-xl font-semibold text-blue-800">Form 4 ¬∑ B·∫£ng Doing</h2>
        <span class="badge">Doing</span>
      </div>
      <button id="f4-search" class="submit-btn px-4 py-2 text-white font-semibold transition">Tra c·ª©u</button>
    </div>
    <div class="overflow-x-auto border border-gray-200 rounded-lg">
      <table class="min-w-[480px] w-full text-sm">
        <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
          <tr class="text-left text-gray-700">
            <th class="px-3 py-2">Nh√¢n vi√™n</th>
            <th class="px-3 py-2">C√¥ng chu·∫©n hi·ªán t·∫°i</th>
          </tr>
        </thead>
        <tbody id="f4-body" class="divide-y divide-gray-100">
          <tr><td class="px-3 py-3 text-center text-gray-500" colspan="2">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- Upload Modal -->
  <div id="upload-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="upload-title">
    <div class="w-full max-w-lg bg-white rounded-xl border border-gray-200 shadow-xl overflow-hidden">
      <div class="px-4 py-3 bg-gradient-to-b from-blue-50 to-white border-b border-gray-200">
        <h3 id="upload-title" class="text-base font-semibold text-gray-800">G·ª≠i b√°o c√°o</h3>
      </div>
      <div class="p-4 space-y-3">
        <div class="flex flex-wrap gap-2 text-sm">
          <span class="px-3 py-1 rounded-full bg-blue-50 border border-blue-200">Ng∆∞·ªùi n·ªôp: <b class="ml-1" id="uploader-name"></b></span>
          <span class="px-3 py-1 rounded-full bg-blue-50 border border-blue-200">M√£: <b class="ml-1" id="uploader-code"></b></span>
          <span class="px-3 py-1 rounded-full bg-blue-50 border border-blue-200">T√°c v·ª•: <b class="ml-1" id="uploader-task"></b></span>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Ch·ªçn t·ªáp b√°o c√°o</label>
          <input id="upload-file" type="file" class="block w-full text-sm file:mr-2 file:py-1 file:px-3 file:rounded-full file:border-0 file:bg-primary-blue file:text-white"/>
          <p class="text-xs text-gray-500 mt-1">T·ªáp s·∫Ω g·ª≠i k√®m timestamp t·∫°i th·ªùi ƒëi·ªÉm g·ª≠i.</p>
        </div>
        <div id="bps-option" class="flex items-center gap-2">
          <input id="upload-bps" type="checkbox" class="h-4 w-4" checked>
          <label for="upload-bps" class="text-sm text-gray-700 select-none">Tr·∫£ b√°o c√°o BPS</label>
        </div>
      </div>
      <div class="px-4 py-3 border-t border-gray-200 flex justify-end gap-2">
        <button id="btn-cancel" class="px-4 py-2 rounded-lg bg-slate-100 text-gray-800">Hu·ª∑</button>
        <button id="btn-send" class="px-4 py-2 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105">G·ª≠i b√°o c√°o</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // Constants
    const WEBHOOK_URL = "https://phongdqakrd.app.n8n.cloud/webhook/ddc1264c-85be-4b63-98a6-267103685117";
    const FORM1_UPLOAD_URL = "https://phongdqakrd.app.n8n.cloud/webhook/b2817307-6647-4e68-ae35-88118dfa657c";
    const FORM2_LOOKUP_URL = "https://phongdqakrd.app.n8n.cloud/webhook/e067ccfb-f59b-43f0-b779-b9d1286549f9";
    const FORM2_UPLOAD_URL = "https://phongdqakrd.app.n8n.cloud/webhook/2e394d3e-da1a-4577-9063-359a70518527";
    // Endpoints for Form 3 (match index.html)
    const SHEETDB_API_URL = "https://sheetdb.io/api/v1/n9g1hj5bhqymg";
    const UPLOAD_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxCijAALPkXShSLSUELoVhtEGDGMUwe4ZPl_jqE-xi7le_WGN5s0IOv0o5FVYpZaNmc/exec";

    // Sidebar navigation
    const navBtns = document.querySelectorAll('.nav-btn');
    const sections = ['form1','form2','form3','form4'].map(id=>document.getElementById(id));
    function showSection(id){ sections.forEach(s=>s.classList.toggle('hidden', s.id!==id)); }
    navBtns.forEach((btn)=>{
      btn.onclick=()=>{
        navBtns.forEach(b=>b.classList.remove('bg-primary-blue','font-bold'));
        btn.classList.add('bg-primary-blue','font-bold');
        showSection(btn.getAttribute('data-target'));
      }
    });
    // Default
    navBtns[0].classList.add('bg-primary-blue','font-bold');
    showSection(navBtns[0].getAttribute('data-target'));

    // Names
    const FORM1_NAMES = [
      "B√πi ƒê·∫∑ng Qu·ªëc Huy","ƒê√†o Tu·∫•n K·ª≥","ƒê·ªó Quang Long","ƒê·ªó Th·∫ø C∆∞·ªùng","H√† M·ªπ Linh","L·∫°i Qu·ªëc L·ªôc",
      "L√™ Ng·ªçc √Ånh","L√™ Th·ªã Thanh Nh√†n","L√™ Th·ªã Th·∫£o","L√™ VƒÉn S∆°n","Nguy·ªÖn H·ªØu Th·ªãnh","Nguy·ªÖn Th·ªã Hi·ªÅn",
      "Ph·∫°m Th√†nh Trung Ki√™n","Ph·∫°m Th·ªã Minh","Th√°i Th·ªã Giang","Tr·∫ßn Hi·∫øu Nghƒ©a","V≈© Th·ªã H·∫±ng","V≈© Th·ªã Thanh Hi·ªÅn"
    ];
    const FORM2_NAMES = FORM1_NAMES;

    // D·ªØ li·ªáu t√°c v·ª• (kh·ªüi t·∫°o r·ªóng; s·∫Ω n·ªëi ngu·ªìn th·∫≠t sau)
    const demoTasksForm1 = {};
    const demoTasksForm2 = {};

    // Fill selects
    function fillSelect(sel, arr){ arr.forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; sel.appendChild(o); }); }
    fillSelect(document.getElementById('f1-name'), FORM1_NAMES);
    fillSelect(document.getElementById('f2-name'), FORM2_NAMES);
    const f3AssigneeSel = document.getElementById('f3-assignee');
    if (f3AssigneeSel) fillSelect(f3AssigneeSel, FORM1_NAMES);

    // Toast
    const toastEl = document.getElementById('toast');
    function showToast(msg,type='info'){
      toastEl.textContent = msg;
      toastEl.style.background = type==='success' ? '#137a39' : (type==='error' ? '#b42318' : '#0b1324');
      toastEl.classList.add('show');
      setTimeout(()=>toastEl.classList.remove('show'), 2600);
    }

    // Upload modal
    const modal = document.getElementById('upload-modal');
    const fileInput = document.getElementById('upload-file');
    const uploaderName = document.getElementById('uploader-name');
    const uploaderCode = document.getElementById('uploader-code');
    const uploaderTask = document.getElementById('uploader-task');
    let uploadContext = null;
    let isModalSubmitting = false;
    let lastOpenTrigger = null;
    function openUploadModal(ctx){
      uploadContext = ctx || {};
      uploaderName.textContent = ctx?.name || '';
      uploaderCode.textContent = ctx?.code || '';
      uploaderTask.textContent = ctx?.taskName || '';
      // Hide Ng∆∞·ªùi n·ªôp pill for Form 2 per request
      try {
        const namePill = uploaderName && uploaderName.parentElement && uploaderName.parentElement.parentElement ? uploaderName.parentElement.parentElement : null;
        if (namePill) namePill.style.display = (ctx && ctx.form === 'Form 2') ? 'none' : '';
        const bpsOption = document.getElementById('bps-option');
        const bpsCheckbox = document.getElementById('upload-bps');
        if (bpsOption) bpsOption.style.display = (ctx && ctx.form === 'Form 2') ? 'none' : '';
        if (bpsCheckbox) bpsCheckbox.checked = (ctx && ctx.form === 'Form 1') ? true : false;
      } catch(_) {}
      fileInput.value = '';
      modal.classList.add('open');
      modal.setAttribute('aria-hidden','false');
    }
    function closeUploadModal(){
      modal.classList.remove('open');
      modal.setAttribute('aria-hidden','true');
      // Re-enable last trigger and reset submit button state
      if (lastOpenTrigger) {
        try {
          lastOpenTrigger.disabled = false;
          if (lastOpenTrigger.classList) lastOpenTrigger.classList.remove('opacity-50','pointer-events-none');
        } catch(_) {}
        lastOpenTrigger = null;
      }
      const sendBtn = document.getElementById('btn-send');
      if (sendBtn) {
        sendBtn.disabled = false;
        sendBtn.textContent = 'G·ª≠i b√°o c√°o';
      }
      isModalSubmitting = false;
    }
    document.getElementById('btn-cancel').onclick = closeUploadModal;
    modal.addEventListener('click', (e)=>{ if(e.target===modal) closeUploadModal(); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && modal.classList.contains('open')) closeUploadModal(); });

    document.getElementById('btn-send').onclick = async ()=>{
      if (isModalSubmitting) return;
      if(!fileInput.files || fileInput.files.length===0){ showToast('Vui l√≤ng ch·ªçn t·ªáp b√°o c√°o.','error'); return; }
      const btn = document.getElementById('btn-send');
      isModalSubmitting = true;
      if (btn) { btn.disabled = true; btn.innerHTML = "<span class='spinner mr-2'></span>ƒêang g·ª≠i..."; }
      const fd = new FormData();
      fd.append('file', fileInput.files[0]);
      fd.append('file_name', fileInput.files[0].name || '');
      fd.append('timestamp', new Date().toISOString());
      if(uploadContext){
        fd.append('nguoi_nop', uploadContext.name||'');
        fd.append('ma_tac_vu', uploadContext.code||'');
        fd.append('ten_tac_vu', uploadContext.taskName||'');
        fd.append('form', uploadContext.form||'');
      }
      const bpsCheckbox = document.getElementById('upload-bps');
      if (bpsCheckbox) { fd.append('is_bps', bpsCheckbox.checked ? '1' : '0'); }
      const targetUpload = (uploadContext && uploadContext.form === 'Form 2') ? FORM2_UPLOAD_URL : FORM1_UPLOAD_URL;
      try{
        await fetch(targetUpload,{method:'POST',body:fd, mode: 'no-cors'});
        showToast('ƒê√£ g·ª≠i b√°o c√°o.','success');
        closeUploadModal();
      }
      catch(e){
        console.error(e);
        showToast('G·ª≠i th·∫•t b·∫°i.','error');
        isModalSubmitting = false;
        if (btn) { btn.disabled = false; btn.textContent = 'G·ª≠i b√°o c√°o'; }
      }
    };

    // Helpers for tables
    function addTd(tr, text){ const td=document.createElement('td'); td.className='px-3 py-2 align-top'; td.textContent=text; tr.appendChild(td); }

    // Form 1: fetch via webhook with query for headers/fields
    let F1_ALL_ROWS = [];
    let F1_PAGE = 1;
    let F1_SIZE = 10;
    function applyForm1Paging(){
      const body = document.getElementById('f1-body');
      const pager = document.getElementById('f1-pager');
      const total = F1_ALL_ROWS.length;
      if(total === 0){
        body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="12">Kh√¥ng c√≥ t√°c v·ª•</td></tr>';
        pager.style.display = 'none';
        return;
      }
      pager.style.display = '';
      const maxPage = Math.max(1, Math.ceil(total / F1_SIZE));
      if(F1_PAGE > maxPage) F1_PAGE = maxPage;
      const start = (F1_PAGE - 1) * F1_SIZE;
      const end = Math.min(total, start + F1_SIZE);
      const slice = F1_ALL_ROWS.slice(start, end);
      const pageInfo = document.getElementById('f1-page-info');
      if(pageInfo) pageInfo.textContent = `Trang ${F1_PAGE}/${maxPage} (${total} d√≤ng)`;
      const prev = document.getElementById('f1-prev');
      const next = document.getElementById('f1-next');
      if(prev) prev.disabled = (F1_PAGE <= 1);
      if(next) next.disabled = (F1_PAGE >= maxPage);
      // render rows
      body.innerHTML = '';
      slice.forEach(tr => body.appendChild(tr));
    }

    async function renderForm1(){
      const name = (document.getElementById('f1-name').value || '').trim();
      const body = document.getElementById('f1-body');
      if(!name){ body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="12">Vui l√≤ng ch·ªçn t√™n</td></tr>'; return; }
      body.innerHTML = "<tr><td colspan='12' class='px-3 py-3 text-center text-gray-500'><span class='spinner mr-2'></span>ƒêang t·∫£i...</td></tr>";
      try{
          const headerMapF1 = {
          header_btn: 'N√∫t nh·∫≠p g·ª≠i b√°o c√°o',
          header_requester: 'Ng∆∞·ªùi y√™u c·∫ßu',
          header_requestDate: 'Ng√†y y√™u c·∫ßu',
          header_wishDue: 'H·∫°n mong mu·ªën',
          header_actualDue: 'H·∫°n ƒë√°p ·ª©ng',
          header_code: 'M√£',
          header_taskName: 'T√™n t√°c v·ª•',
            header_manHour: 'C√¥ng chu·∫©n',
          header_purpose: 'M·ª•c ƒë√≠ch ƒë√°nh gi√°',
          header_note: 'Note',
          header_specialTest: 'Y√™u c·∫ßu test ƒë·∫∑c bi·ªát',
          header_reportForm: 'Form b√°o c√°o ƒë√°nh gi√°',
          header_status: 'Tr·∫°ng th√°i',
          header_attachmentFileName: 'T√™n file ƒë√≠nh k√®m',
          field_requester: 'requester',
          field_requestDate: 'requestDate',
          field_wishDue: 'wishDue',
          field_actualDue: 'actualDue',
          field_code: 'code',
          field_taskName: 'taskName',
            field_manHour: 'manHour',
          field_purpose: 'purpose',
          field_note: 'note',
          field_specialTest: 'specialTest',
          field_reportForm: 'reportForm',
          field_status: 'status',
          field_attachmentFileName: 'attachmentFileName'
        };
        const params = new URLSearchParams({
          ...headerMapF1,
          action: 'form1_lookup',
          person_name: name,
          timestamp: new Date().toISOString()
        });
        const testUrl = `${WEBHOOK_URL}?${params.toString()}`;
        async function fetchJson(url){
          const r = await fetch(url, { method: 'GET' });
          const text = await r.text();
          if(!r.ok) throw new Error(text || `HTTP ${r.status}`);
          let parsed = null; try{ parsed = JSON.parse(text); }catch{ parsed = null; }
          return { parsed, raw: text };
        }
        let data = null; let firstErr = null;
        try{
          const { parsed, raw } = await fetchJson(testUrl);
          if (parsed && parsed.code === 0 && /could not be started/i.test(String(parsed.message||''))) {
            throw new Error('WEBHOOK_TEST_INACTIVE');
          }
          data = parsed ?? raw;
        } catch (e) {
          firstErr = e;
          // Fallback sang production webhook khi test webhook ch∆∞a b·∫≠t l·∫Øng nghe
          const prodUrl = testUrl.replace('/webhook-test/', '/webhook/');
          const { parsed, raw } = await fetchJson(prodUrl);
          data = parsed ?? raw;
        }
        function pickRows(json){
          if (!json) return [];
          if (Array.isArray(json)) return json;
          const candidates = ['data','rows','result','records','items','list'];
          for (const k of candidates){ if (Array.isArray(json?.[k])) return json[k]; }
          // Deep search first array of objects
          try{
            const queue = [json];
            const seen = new Set();
            while(queue.length){
              const cur = queue.shift();
              if (!cur || typeof cur !== 'object' || seen.has(cur)) continue;
              seen.add(cur);
              for (const v of Object.values(cur)){
                if (Array.isArray(v) && v.length && typeof v[0] === 'object') return v;
                if (v && typeof v === 'object') queue.push(v);
              }
            }
          }catch(_){ }
          return [];
        }
        const rows = pickRows(data);
        if(!rows.length){ body.innerHTML = "<tr><td colspan='14' class='px-3 py-3 text-center text-gray-500'>Kh√¥ng c√≥ t√°c v·ª•</td></tr>"; return; }
        const getV = (obj, keys)=>{
          const lower = Object.keys(obj||{}).reduce((acc,k)=>{ acc[k.toLowerCase()] = obj[k]; return acc; },{});
          for(const k of keys){ const v = lower[k.toLowerCase()]; if(v!==undefined) return v; }
          return '';
        };
        F1_ALL_ROWS = [];
        rows.forEach(item=>{
          const tr=document.createElement('tr');
          const tdBtn=document.createElement('td'); tdBtn.className='px-3 py-2';
          const code = getV(item,['code','ma','taskcode','m√£']);
          const tname = getV(item,['taskname','ten_tac_vu','ten','name','title','t√™n t√°c v·ª•']);
          // X√°c ƒë·ªãnh tr·∫°ng th√°i ƒë·ªÉ quy·∫øt ƒë·ªãnh cho ph√©p g·ª≠i b√°o c√°o hay kh√¥ng
          const statusText = getV(item,['status','trangthai','trang_thai','tr·∫°ng th√°i']);
          const statusLower = (statusText||'').toLowerCase();
          const isDone = statusLower.includes('ho√†n') || statusLower.includes('done');
          const isCancelled = statusLower.includes('cancel') || statusLower.includes('h·ªßy') || statusLower.includes('hu·ª∑');
          const isEmptyStatus = statusLower.trim()==='';
          const isLocked = isDone || isCancelled || isEmptyStatus;
          // T·∫°o input file ·∫©n cho m·ªói h√†ng + n√∫t Tr·∫£ b√°o c√°o
          const inputId = `f1-upload-${Math.random().toString(36).slice(2)}`;
          const fileInput = document.createElement('input');
          fileInput.type = 'file';
          fileInput.id = inputId;
          fileInput.className = 'hidden';
          const labelBtn = document.createElement('label');
          labelBtn.htmlFor = inputId;
          if (isLocked) {
            fileInput.disabled = true;
            labelBtn.className = 'px-3 py-1 inline-block rounded-lg bg-gray-300 text-gray-500 cursor-not-allowed opacity-60 pointer-events-none';
            labelBtn.textContent = isCancelled ? 'ƒê√£ h·ªßy' : (isDone ? 'ƒê√£ ho√†n th√†nh' : 'Kh√¥ng th·ªÉ g·ª≠i');
            labelBtn.title = isCancelled ? 'T√°c v·ª• ƒë√£ h·ªßy, kh√¥ng th·ªÉ g·ª≠i b√°o c√°o' : (isDone ? 'T√°c v·ª• ƒë√£ ho√†n th√†nh, kh√¥ng th·ªÉ g·ª≠i b√°o c√°o' : 'Tr·∫°ng th√°i tr·ªëng, kh√¥ng th·ªÉ g·ª≠i b√°o c√°o');
          } else {
            labelBtn.className = 'px-3 py-1 inline-block rounded-lg text-white bg-primary-blue hover:brightness-105 cursor-pointer';
            labelBtn.textContent = 'Tr·∫£ b√°o c√°o';
            // M·ªü modal nh∆∞ Form 2 khi nh·∫•n ·ªü Form 1 (ch·ªëng double-click)
            labelBtn.onclick = (e)=>{
              e.preventDefault();
              if (labelBtn.disabled) return;
              labelBtn.disabled = true;
              labelBtn.classList.add('opacity-50','pointer-events-none');
              lastOpenTrigger = labelBtn;
              openUploadModal({ form: 'Form 1', name, code, taskName: tname });
            };
          }
          // V·ªõi c√°ch m·ªü modal, kh√¥ng c·∫ßn input file ·∫©n cho Form 1 n·ªØa
          tdBtn.appendChild(labelBtn);
          tr.appendChild(tdBtn);
          // T√¨nh tr·∫°ng, M√£, T√™n t√°c v·ª•, Ng∆∞·ªùi y√™u c·∫ßu, Ng√†y y√™u c·∫ßu, H·∫°n mong mu·ªën, H·∫°n ƒë√°p ·ª©ng, M·ª•c ƒë√≠ch ƒë√°nh gi√°, Note, Y√™u c·∫ßu test ƒë·∫∑c bi·ªát, Form b√°o c√°o ƒë√°nh gi√°
          const tdStatus=document.createElement('td'); tdStatus.className='px-3 py-2';
          const s=(statusText||'').toLowerCase();
          const badge=document.createElement('span'); badge.className='px-2 py-1 rounded text-xs ' + (s.includes('ho√†n')||s.includes('done')
            ? 'bg-green-100 text-green-800'
            : (s.includes('cancel')||s.includes('h·ªßy')||s.includes('hu·ª∑')||s.includes('ch·ªù')||s.includes('pending'))
              ? 'bg-yellow-100 text-yellow-800'
              : 'bg-blue-100 text-blue-800');
          badge.textContent=statusText||''; tdStatus.appendChild(badge); tr.appendChild(tdStatus);
          addTd(tr, code);
          addTd(tr, tname);
          addTd(tr, getV(item,['requester','nguoiyeucau','nguoi_yeu_cau','assigner','ng∆∞·ªùi y√™u c·∫ßu']));
          // C√¥ng chu·∫©n (gi·ªØa T√™n t√°c v·ª• v√† Ng√†y y√™u c·∫ßu)
          addTd(tr, getV(item,[
            'manhour','man_hour','congchuan','cong_chuan','workload','sogio','sogiocong','c√¥ng chu·∫©n'
          ]));
          addTd(tr, getV(item,['requestdate','ngayyeucau','ngay_yeu_cau','submissiondate','ngaygui','ng√†y y√™u c·∫ßu']));
          addTd(tr, getV(item,['wishdue','hanmongmuon','han_mong_muon','desireddue','h·∫°n mong mu·ªën']));
          addTd(tr, getV(item,['actualdue','handapung','han_dap_ung','completiondate','h·∫°n ƒë√°p ·ª©ng']));
          addTd(tr, getV(item,['purpose','mucdich','muc_dich','m·ª•c ƒë√≠ch ƒë√°nh gi√°','muc dich danh gia','mucdichdanhgia']));
          addTd(tr, getV(item,['note','ghi_chu','ghichu']));
          addTd(tr, getV(item,['specialtest','yeucau_test_dac_biet','yeu_cau_test_dac_biet']));
          addTd(tr, getV(item,['reportform','form_bao_cao','form_bao_cao_danh_gia']));
          // T√™n file ƒë√≠nh k√®m (n·∫øu backend cung c·∫•p)
          addTd(tr, getV(item,[
            'attachmentfilename','file_name','filename','tenfile','ten_file','t√™n file','t√™n file ƒë√≠nh k√®m','attachment','file'
          ]));
          F1_ALL_ROWS.push(tr);
        });
        applyForm1Paging();
      }catch(err){
        body.innerHTML = `<tr><td colspan='12' class='px-3 py-3 text-center text-red-600'>L·ªói t·∫£i d·ªØ li·ªáu: ${String(err.message||err)}</td></tr>`;
      }
    }
    document.getElementById('f1-name').onchange = ()=>{};
    const f1SearchBtn = document.getElementById('f1-search');
    if (f1SearchBtn) {
      let f1Busy = false;
      f1SearchBtn.onclick = async (e)=>{
        e.preventDefault();
        if (f1Busy) return;
        f1Busy = true;
        f1SearchBtn.disabled = true;
        const prev = f1SearchBtn.textContent;
        f1SearchBtn.innerHTML = "<span class='spinner mr-2'></span>ƒêang t·∫£i...";
        try { await renderForm1(); }
        finally {
          f1Busy = false;
          f1SearchBtn.disabled = false;
          f1SearchBtn.textContent = prev;
        }
      };
    }
    // Pagination events
    const f1Prev = document.getElementById('f1-prev');
    const f1Next = document.getElementById('f1-next');
    const f1Size = document.getElementById('f1-size');
    if (f1Prev) f1Prev.onclick = (e)=>{ e.preventDefault(); if(F1_PAGE>1){ F1_PAGE--; applyForm1Paging(); } };
    if (f1Next) f1Next.onclick = (e)=>{ e.preventDefault(); F1_PAGE++; applyForm1Paging(); };
    if (f1Size) f1Size.onchange = (e)=>{ F1_SIZE = parseInt(e.target.value||'10',10)||10; F1_PAGE=1; applyForm1Paging(); };

    // Form 2 rendering
    async function renderForm2(){
      const name = (document.getElementById('f2-name').value || '').trim();
      const body = document.getElementById('f2-body');
      if(!name){ body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="6">Vui l√≤ng ch·ªçn t√™n</td></tr>'; return; }
      body.innerHTML = "<tr><td colspan='6' class='px-3 py-3 text-center text-gray-500'><span class='spinner mr-2'></span>ƒêang t·∫£i...</td></tr>";
      try{
        const headerMapF2 = {
          header_requestDate: 'Ng√†y y√™u c·∫ßu',
          header_wishDue: 'H·∫°n mong mu·ªën',
          header_actualDue: 'H·∫°n ƒë√°p ·ª©ng',
          header_code: 'M√£',
          header_taskName: 'T√™n t√°c v·ª•',
          field_requestDate: 'requestDate',
          field_wishDue: 'wishDue',
          field_actualDue: 'actualDue',
          field_code: 'code',
          field_taskName: 'taskName'
        };
        const params = new URLSearchParams({
          ...headerMapF2,
          action: 'form2_lookup',
          person_name: name,
          timestamp: new Date().toISOString()
        });
        const url = `${FORM2_LOOKUP_URL}?${params.toString()}`;
        const resp = await fetch(url, { method: 'GET' });
        const text = await resp.text();
        if(!resp.ok) throw new Error(text || `HTTP ${resp.status}`);
        let data = null; try{ data = JSON.parse(text);}catch{ data = null; }
        function pickRows(json){
          if (!json) return [];
          if (Array.isArray(json)) return json;
          const candidates = ['data','rows','result','records','items','list'];
          for (const k of candidates){ if (Array.isArray(json?.[k])) return json[k]; }
          try{
            const queue=[json]; const seen=new Set();
            while(queue.length){ const cur=queue.shift(); if(!cur||typeof cur!=='object'||seen.has(cur)) continue; seen.add(cur); for(const v of Object.values(cur)){ if(Array.isArray(v)&&v.length&&typeof v[0]==='object') return v; if(v&&typeof v==='object') queue.push(v);} }
          }catch(_){ }
          return [];
        }
        const rows = pickRows(data);
        if(!rows.length){ body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="6">Kh√¥ng c√≥ t√°c v·ª•.</td></tr>'; return; }
        const getV = (obj, keys)=>{
          const lower = Object.keys(obj||{}).reduce((acc,k)=>{ acc[k.toLowerCase()] = obj[k]; return acc; },{});
          for(const k of keys){ const v = lower[k.toLowerCase()]; if(v!==undefined) return v; }
          return '';
        };
        body.innerHTML='';
        rows.forEach(item=>{
          const tr=document.createElement('tr');
          const requestDate = getV(item,['requestdate','ngayyeucau','ngay_yeu_cau','submissiondate','ngaygui','ng√†y y√™u c·∫ßu']);
          const wishDue = getV(item,['wishdue','hanmongmuon','han_mong_muon','desireddue','h·∫°n mong mu·ªën']);
          const actualDue = getV(item,['actualdue','handapung','han_dap_ung','completiondate','h·∫°n ƒë√°p ·ª©ng']);
          const code = getV(item,['code','ma','taskcode','m√£']);
          const taskName = getV(item,['taskname','ten_tac_vu','ten','name','title','t√™n t√°c v·ª•']);
          addTd(tr, requestDate);
          addTd(tr, wishDue);
          addTd(tr, actualDue);
          addTd(tr, code);
          addTd(tr, taskName);
          const tdBtn=document.createElement('td'); tdBtn.className='px-3 py-2';
          const btn=document.createElement('button'); btn.className='px-3 py-1 rounded-lg text-white bg-primary-blue hover:brightness-105'; btn.textContent='Tr·∫£ form';
          btn.onclick=(e)=>{
            e.preventDefault();
            if (btn.disabled) return;
            btn.disabled = true;
            btn.classList.add('opacity-50','pointer-events-none');
            lastOpenTrigger = btn;
            openUploadModal({form:'Form 2', name, code, taskName});
          };
          tdBtn.appendChild(btn); tr.appendChild(tdBtn);
          body.appendChild(tr);
        });
      }catch(err){
        body.innerHTML = `<tr><td colspan='6' class='px-3 py-3 text-center text-red-600'>L·ªói t·∫£i d·ªØ li·ªáu: ${String(err.message||err)}</td></tr>`;
      }
    }
    document.getElementById('f2-name').onchange = ()=>{};
    const f2SearchBtn = document.getElementById('f2-search');
    if (f2SearchBtn) {
      let f2Busy = false;
      f2SearchBtn.onclick = async (e)=>{
        e.preventDefault();
        if (f2Busy) return;
        f2Busy = true;
        f2SearchBtn.disabled = true;
        const prev = f2SearchBtn.textContent;
        f2SearchBtn.innerHTML = "<span class='spinner mr-2'></span>ƒêang t·∫£i...";
        try { await renderForm2(); }
        finally {
          f2Busy = false;
          f2SearchBtn.disabled = false;
          f2SearchBtn.textContent = prev;
        }
      };
    }
    // Clear button removed per request

    // Form 3 logic
    function setRqTime(){ const d=new Date(); const pad=n=>String(n).padStart(2,'0'); document.getElementById('rq-time').value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`; }
    setRqTime();

    // Form 3: upload to Google Drive via Apps Script (as in index.html)
    (function setupForm3Upload(){
      const fileInput = document.getElementById('attach');
      const list = document.getElementById('f3-upload-list');
      if (!fileInput || !list) return;
      list.innerHTML = '';
      fileInput.addEventListener('change', async function(){
        if (!this.files || this.files.length === 0) return;
        const file = this.files[0];
        const row = document.createElement('div');
        row.className = "flex items-center justify-between p-2 bg-blue-50 rounded";
        row.innerHTML = `<span>üìÑ<span class="ml-2">${file.name}</span></span><span class="spinner"></span>`;
        list.innerHTML = '';
        list.appendChild(row);
        try{
          const url = await new Promise((resolve, reject)=>{
            const reader = new FileReader();
            reader.onload = async ()=>{
              try{
                const base64 = reader.result.split(',')[1];
                const form = new URLSearchParams();
                form.append('filedata', base64);
                form.append('filename', file.name);
                form.append('mimetype', file.type);
                const resp = await fetch(UPLOAD_SCRIPT_URL, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                  body: form.toString()
                });
                if(!resp.ok) throw new Error('Upload failed');
                const raw = await resp.text();
                let parsedUrl = '';
                try{
                  const j = JSON.parse(raw);
                  parsedUrl = j.url || j.fileUrl || j.public_url || j.link || (j.data && j.data[0] && j.data[0].url) || '';
                }catch(_){
                  const match = (raw || '').match(/https?:\/\/[^\s"']+/);
                  parsedUrl = match ? match[0] : '';
                }
                resolve(parsedUrl || '#');
              }catch(err){ reject(err); }
            };
            reader.onerror = ()=>reject(new Error('File read error'));
            reader.readAsDataURL(file);
          });
          row.innerHTML = `
            <span>üìÑ<span class="ml-2">${file.name}</span></span>
            <span class="flex items-center gap-3">
              <span class="text-green-700 bg-green-100 px-2 py-0.5 rounded text-xs">ƒê√£ t·∫£i l√™n</span>
              <a href="${url}" target="_blank" class="text-primary-blue underline">Xem</a>
            </span>
          `;
        }catch(err){
          const spinnerEl = row.querySelector('.spinner');
          if (spinnerEl) spinnerEl.outerHTML = `<span class="text-red-600">Th·∫•t b·∫°i</span>`;
          setTimeout(()=>{ try{ list.removeChild(row);}catch(_){} }, 2000);
        }
        this.value = '';
      });
    })();

    // Submit Form 3 to SheetDB with required mapping
    document.getElementById('assign-form').onsubmit = async (e)=>{
      e.preventDefault();
      const requester = document.getElementById('rq-by').value.trim();
      const taskName = (document.getElementById('task-name')?.value || '').trim();
      const rqTime = document.getElementById('rq-time').value;
      const manHourRaw = document.getElementById('man-hour').value;
      const output = document.getElementById('output').value.trim();
      const assignee = (document.getElementById('f3-assignee').value || '').trim();
      const deadline = document.getElementById('deadline').value;
      const odooJira = document.getElementById('odoo-jira').value.trim();

      if(!requester || !taskName || !output || !manHourRaw || !assignee){ showToast('Vui l√≤ng ƒëi·ªÅn ƒë·ªß tr∆∞·ªùng b·∫Øt bu·ªôc.','error'); return; }
      if(!/^\d+(\.\d{1,2})?$/.test(manHourRaw)){ showToast('C√¥ng chu·∫©n t·ªëi ƒëa 2 ch·ªØ s·ªë th·∫≠p ph√¢n.','error'); return; }

      const btn = e.target.querySelector('button[type="submit"]');
      const prev = btn ? btn.textContent : '';
      if (btn) { btn.disabled = true; btn.innerHTML = "<span class='spinner mr-2'></span>ƒêang g·ª≠i..."; }

      const mapped = {
        requesterName: requester,
        requestDate: (rqTime || '').slice(0, 10),
        itemName: taskName,
        Score: String(manHourRaw || '').trim(),
        changeReq: output,
        Assignee: assignee,
        desiredDate: String(deadline || '').trim(),
        Odoojira: odooJira,
        deptRequest: 'DQA'
      };
      const body = { data: [mapped] };

      try{
        const resp = await fetch(SHEETDB_API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
          body: JSON.stringify(body)
        });
        if (!resp.ok) {
          const t = await resp.text();
          throw new Error(t || `HTTP ${resp.status}`);
        }
        showToast('ƒê√£ giao vi·ªác v√† g·ª≠i d·ªØ li·ªáu.','success');
        e.target.reset();
        setRqTime();
      }catch(err){
        console.error(err);
        showToast('G·ª≠i th·∫•t b·∫°i.','error');
      }finally{
        if (btn) { btn.disabled = false; btn.textContent = prev || 'Giao vi·ªác'; }
      }
    };

    // Form 4 logic: GET Doing data and render two columns
    async function renderForm4(){
      const body = document.getElementById('f4-body');
      body.innerHTML = "<tr><td colspan='2' class='px-3 py-3 text-center text-gray-500'><span class='spinner mr-2'></span>ƒêang t·∫£i...</td></tr>";
      try{
        const urlTest = 'https://phongdqakrd.app.n8n.cloud/webhook/9cdcf54b-f98f-42b8-ab15-824d5b6da050';
        const urlProd = urlTest.replace('/webhook-test/', '/webhook/');
        const params = new URLSearchParams();
        params.append('status', 'Doing');
        // Query mapping for 2 output columns
        params.append('header_employee', 'Nh√¢n vi√™n');
        params.append('header_current_manhour', 'C√¥ng chu·∫©n hi·ªán t·∫°i');
        params.append('field_employee', 'employee');
        params.append('field_current_manhour', 'manhour');
        params.append('_ts', Date.now().toString());
        // Debug: log the exact URL being requested
        try { console.log('Form4 GET (test):', `${urlTest}?${params.toString()}`); } catch(_) {}

        async function fetchJson(url){
          const r = await fetch(url, { method: 'GET' });
          const text = await r.text();
          let parsed = null; try { parsed = JSON.parse(text); } catch { parsed = null; }
          return { ok: r.ok, ct: r.headers.get('content-type')||'', parsed, raw: text, status: r.status };
        }

        let first = await fetchJson(`${urlTest}?${params.toString()}`);
        // Fallback to production webhook if test not active or server error like n8n "Can't determine which item to use"
        if (!first.ok || /could not be started/i.test(String(first.parsed?.message||'')) || /Can‚Äôt determine which item to use|Can't determine which item to use/i.test(first.raw||'')){
          try { console.warn('Form4 GET fallback -> prod'); } catch(_){ }
          first = await fetchJson(`${urlProd}?${params.toString()}`);
        }
        if(!first.ok){
          throw new Error(first.raw || `HTTP ${first.status}`);
        }
        const data = Array.isArray(first.parsed) || first.parsed ? first.parsed : (first.raw ? JSON.parse(first.raw) : null);
        function pickRowsDeep(json){
          if (!json) return [];
          if (Array.isArray(json) && json.length && typeof json[0] === 'object') return json;
          const candidates = ['data','rows','result','records','items','list'];
          for (const k of candidates){ if (Array.isArray(json?.[k]) && json[k].length && typeof json[k][0] === 'object') return json[k]; }
          try{
            const queue=[json]; const seen=new Set();
            while(queue.length){
              const cur = queue.shift();
              if (!cur || typeof cur !== 'object' || seen.has(cur)) continue;
              seen.add(cur);
              for (const v of Object.values(cur)){
                if (Array.isArray(v) && v.length && typeof v[0] === 'object') return v;
                if (v && typeof v === 'object') queue.push(v);
              }
            }
          }catch(_){ }
          return [];
        }
        const rows = pickRowsDeep(data);
        if(!rows.length){ body.innerHTML = "<tr><td colspan='2' class='px-3 py-3 text-center text-gray-500'>Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>"; return; }
        const getV = (obj, keys)=>{
          const lower = Object.keys(obj||{}).reduce((acc,k)=>{ acc[k.toLowerCase()] = obj[k]; return acc; },{});
          for(const k of keys){ const v = lower[k.toLowerCase()]; if(v!==undefined) return v; }
          return '';
        };
        const normalized = rows.map(r=>{
          const name = getV(r,['field_employee','employee','nhanvien','nhan_vien','user','name','nh√¢n vi√™n']).toString().trim();
          const manRaw = getV(r,['field_current_manhour','manhour','current_manhour','congchuan','cong_chuan','hours','c√¥ng chu·∫©n hi·ªán t·∫°i']);
          const man = Number(manRaw);
          return { name: name || '-', manhour: isNaN(man) ? 0 : man };
        }).filter(x=>x.name && x.name !== '-');
        if (!normalized.length) { body.innerHTML = "<tr><td colspan='2' class='px-3 py-3 text-center text-gray-500'>Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>"; return; }
        const normalizedSorted = normalized.slice().sort((a,b)=> b.manhour - a.manhour);
        const html = normalizedSorted.map(x=>
          `<tr><td class=\"px-3 py-2\">${x.name}</td><td class=\"px-3 py-2\">${x.manhour.toFixed(2)}</td></tr>`
        ).join('');
        body.innerHTML = html;
      }catch(err){
        body.innerHTML = `<tr><td colspan='2' class='px-3 py-3 text-center text-red-600'>L·ªói t·∫£i d·ªØ li·ªáu: ${String(err.message || err)}</td></tr>`;
      }
    }
    // Copy on click and open link for storage (Form 1)
    const f1StorageLink = document.getElementById('f1-storage-link');
    if (f1StorageLink) {
      f1StorageLink.addEventListener('click', async ()=>{
        const url = f1StorageLink.getAttribute('href') || '';
        try { await navigator.clipboard.writeText(url); showToast('ƒê√£ copy li√™n k·∫øt.','success'); }
        catch(_) { /* ignore copy error to not block open */ }
      });
    }
    // Trigger fetch only when nh·∫•n Tra c·ª©u ·ªü Form 4
    const f4Btn = document.getElementById('f4-search');
    if (f4Btn) {
      f4Btn.addEventListener('click', (e)=>{ e.preventDefault(); renderForm4(); });
    }
  </script>
</body>
</html>







